[{"title": "无我编程的 10 条戒律", "url": "http://blog.jobbole.com/111796/", "url_object_id": "ba6118e0816d19137e375492919002d7", "create_date": "2017/07/12 ·", "front_image_url": ["http://wx2.sinaimg.cn/large/7cc829d3gy1fhh7jbexxkj20fa0akwjc.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 4, "tags": "职场,Code Review,程序员", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/tecla\">tecla</a> 翻译，<a href=\"http://www.jobbole.com/members/upanblack\">Panblack</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://blog.codinghorror.com/the-ten-commandments-of-egoless-programming/\">Jeff Atwood</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>【伯乐在线导读】：无我编程（Egoless Programming）是一种编程风格，不是代码规范，旨在把代码评审中的人为因素最小化，应当在一个友好、合议方式进行，个人感情放一边，从而提高代码质量。</p>\n<p>在《<a href=\"https://www.amazon.cn/gp/product/B00Z7D9GYG/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00Z7D9GYG&amp;linkCode=as2&amp;tag=vastwork-23\" target=\"_blank\">The Psychology of Computer Programming | 程序开发心理学</a>》书中，温伯格首次提出了无我编程十诫。本文则是 Stack Overflow 联合创始人 Jeff Atwood 对这十诫的注解。程序员普遍很自我（ego），都应该看看本文，时刻提醒自己。</p>\n<p><img id=\"pic\" class=\"aligncenter\" src=\"http://wx2.sinaimg.cn/large/7cc829d3gy1fhh7jbexxkj20fa0akwjc.jpg\"></p>\n<h3>1. 理解并接受这个事实：人都会犯错</h3>\n<p>关键是在错误引入到产品前，尽早发现。幸运的是，在我们的行业中，除了那些在喷气推进实验室（JPL）开发火箭导航软件的人来说，大多数错误并不要命，所以我们可以并且应该从错误中学习，一笑了之然后向前看。</p>\n<h3>2. 你和你的代码是两回事</h3>\n<p>切记，审查代码是为了找出问题，问题当然会被发现。当发现问题时，别有情绪，别往心里去。</p>\n<h3>3. 天外有天，人外有人</h3>\n<p>三人行必有我师焉。寻求并且接受其他人的意见，特别是当你认为不必要的时候。</p>\n<h3>4. 不要盲目地重写代码</h3>\n<p>修改代码和重写代码，两者有明确的界限。搞清楚区别，通过代码审查，改变代码风格，而不是做一个孤独的执行者。</p>\n<h3>5. 以尊重、敬意、耐心对待非技术人员</h3>\n<p>经常和程序员打交道的非技术人员普遍认为程序员充其量不过是一群自负的人，还是爱哭的娇气包。不要用生气和不耐烦强化这种偏见。</p>\n<h3>6. 惟有改变方永恒</h3>\n<p>以开放的态度对待改变并用微笑接受改变。将每一次需求、平台、工具的改变看作一个新挑战，而不是一些要反对的麻烦。</p>\n<h3>7. 真正且唯一的权威来自知识，不是地位</h3>\n<p>知识带来权威，权威带来尊敬。所以如果想在无我的环境里获得尊敬，那么请增长知识。</p>\n<h3>8. 为信仰战斗，但也要优雅地接受失败</h3>\n<p>要清楚，有时候你的想法会被否定。即使结果证明你是对的，不要报复，或者最多说几次‘我早就告诉过你’，不要让你过去的想法成为殉道者或者战斗口号。</p>\n<h3>9. 不要做个死宅</h3>\n<p>不要成为一直在小黑屋里编程，只在买可乐时出现的人。这样的人不与人接触，不被重视，不受控制并且不能融入开放合作的环境。</p>\n<h3>10. 对事不对人</h3>\n<p>要批评的是代码，不是写代码的人。尽可能让评论正面，并且只关注于提升代码。评论只涉及内部标准、编程规范、提升性能等等方面。</p>\n<p> </p>\n<p>软件的人性标准是永不过时的，《<a href=\"https://www.amazon.cn/gp/product/B00Z7D9GYG/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=536&amp;creative=3200&amp;creativeASIN=B00Z7D9GYG&amp;linkCode=as2&amp;tag=vastwork-23\" target=\"_blank\">The Psychology of Computer Programming | 程序开发心理学</a>》英文版早在 1971 年出版了，正好是我出生后第二年。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111796\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111796votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111796\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 4 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/tecla\">tecla</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/tecla\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2017/05/e7e39d569b983a82c96dbebcc426da0f.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            喜欢逻辑，虽然不是很精通，喜欢英语，虽然不是都能完全理解。不是聪明人，但是希望能成为快乐的奋斗人。        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/tecla\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/tecla/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/tecla/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 10</a> · <a title=\"QQ：1942295950\" target=\"_blank\" href=\"#\"><i class=\"fa fa-qq\"></i></a> <a title=\"个人微信：ting-lyu\" target=\"_blank\" href=\"#\"><i class=\"fa fa-weixin\"></i></a> <a title=\"GitHub主页\" target=\"_blank\" href=\"https://github.com/xiangshang\"><i class=\"fa fa-github\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "基本性能分析，省了几百万美元", "url": "http://blog.jobbole.com/111795/", "url_object_id": "0dbf4fb8252c1bca8522a5a4e287459b", "create_date": "2017/07/13 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2015/11/c2c78bab3b02ee8a549bd9d5fdfd58d8.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 3, "tags": "IT技术,PostgreSQL,性能,数据库", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/zhj318\">飞哥的咖啡</a> 翻译，<a href=\"http://www.jobbole.com/members/hanxiaomax\">艾凌风</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://blog.heapanalytics.com/basic-performance-analysis-saved-us-millions/\">Michael Malis</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>本文是关于我如何应用基本性能分析技术，借助火焰图做了一处小改进，使得我们 Postgres 计算机集群的 CPU 状况获得了 10 倍的改善，并在第二年帮助 Heap 节省了几百万刀。</p>\n<h2>针对用户分析的索引数据</h2>\n<p>Heap 是一个用户分析工具，它自动捕捉每个用户与网站或应用进行的交互行为。成功安装于网站后，Heap 会自动追踪每个页面的浏览量、点击量、表单提交等信息。这样每个网站拥有者可以针对不同子集的原始数据，使用 Heap 来执行不同种类的聚合。</p>\n<p>为了能够对无意义的原始数据有所洞见，Heap 能让用户根据原始数据自定义事件。“登陆”就是一个例子，可以定义为“在 <code>/login</code> 页面进行表单提交”。</p>\n<p>为了加快分析速度，我们用了一个非常规的索引策略，它基于 Postgres 的部分索引特性。部分索引就像一个普通的 Postgres 索引，不同点在于它只包含了满足特定谓词 (predicate) 的行，你可以把它想象成带有 <code>WHERE</code> 条件的常规索引。针对每个用户创建的事件定义，我们根据用户的原始事件数据，创造了一个部分索引，并将其绑定在满足定义的行上。每当我们的 <code>events</code> 表格中插入一条新行，Postgres 会自动将它与表内现存的每条部分索引的谓词进行测试，并将其加入匹配的索引中。</p>\n<p>针对每个事件定义，对应的部分索引能让它快速获得所有的匹配事件，因为索引恰恰包含了满足定义的事件。你应该阅读我们<a href=\"https://blog.heapanalytics.com/running-10-million-postgresql-indexes-in-production/\">这篇关于如何索引数据的博客</a>，它更加深入地介绍了部分索引的相关内容。</p>\n<h2>问题初显：异常的高 CPU 占用率</h2>\n<p>当我们第一次运用这条索引策略时，对比之前的策略，我们的 CPU 占用率有了大幅上升。我们认为这是正常的现象，因为我们最大的客户有着成千上万条索引，而为了支持基于 CSS 选择器的过滤器，大部分的部分索引都包含了一个正则表达式过滤器。我们认为由于正则表达式的求值极其耗时耗力，而每个插入的事件都要经过上千条正则表达式的测试，这就成了高 CPU 占用率的唯一合理解释。尽管没有明显的证据表明这就是原因，但每个使用 Heap 的人都慢慢将它当作了 CPU 占用率过高的合理解释。它被看作是新索引策略带来的根本妥协。</p>\n<p>十月左右，随着数据量的持续增长，问题开始出现：高峰时间无法消化所有信息。有时候新事件需要花费数小时才能显示在 Heap 仪表板上，而这对一个实时分析工具而言完全不可理喻。抛开通过花钱解决问题的常规路线，我想动手尝试优化 Heap 的信息吞吐量问题。</p>\n<h2>用火焰图对 CPU 占用情况可视化</h2>\n<p>此前我鲜有调试此类性能问题的经验。在搜索了一阵后，我看到了大牛 <a href=\"http://www.brendangregg.com/bio.html\">Brendan Gregg</a> 写的一篇关于<a href=\"http://www.brendangregg.com/flamegraphs.html\" target=\"_blank\">火焰图</a>的文章。火焰图是 Brendan Gregg 发明的一种可视化方法，用于快速查看哪些部分正在占用 CPU。创建火焰图的第一步是使用 Linux <code>perf</code> 工具从进程堆栈中取样：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd6db9c70d598470659\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nperf record -p $(pid of process) -F 99 -g -- sleep 60</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd6db9c70d598470659-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd6db9c70d598470659-1\"><span class=\"crayon-e\">perf </span><span class=\"crayon-v\">record</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">pid </span><span class=\"crayon-e\">of </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">F</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">99</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">g</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">sleep</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">60</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>它会对指定的进程堆栈以每秒 99 次的速度，进行持续一分钟的取样，并将数据写入 perf.data 数据文件中。这样，你就可以从 <a href=\"https://github.com/brendangregg/FlameGraph\">Brendan Gregg 的火焰图数据库</a>中运行以下命令，对文件进行分析并生成火焰图：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd6db9c71f308414802\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nperf script | ./stackcollapse-perf.pl &gt; out.perf-folded ./flamegraph.pl out.perf-folded &gt; flame-graph.svg</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd6db9c71f308414802-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd6db9c71f308414802-1\"><span class=\"crayon-e\">perf </span><span class=\"crayon-v\">script</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">stackcollapse</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">perf</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">pl</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">perf</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">folded</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">flamegraph</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">pl </span><span class=\"crayon-v\">out</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">perf</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">folded</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flame</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">graph</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">svg</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>我最初创建的火焰图之一是 Postgres 的后端进程。因为我们使用了连接池，一个简单的后端进程要服务多项请求。由于我们运行的最多的请求是 <code>INSERT</code>s，Postgres 后端进程的火焰图能够让我们清楚地看到，事件插入数据库时的 CPU 占用情况。在 pid 中对来自 <code>pg_stat_activity</code> 的 Postgres 进程运行以上命令后，我获得了下面这张火焰图：</p>\n<p><a href=\"https://blog.heapanalytics.com/wp-content/uploads/2017/05/blog_post_before.svg\" target=\"_blank\" rel=\"noopener noreferrer\"><img class=\"alignnone size-full wp-image-1658\" src=\"https://blog.heapanalytics.com/wp-content/uploads/2017/05/blog_post_before.svg\" alt=\"\"></a><br>\n<span style=\"color: #339966;\">（单击在新标签中打开上图，然后点击方形框来放大。鼠标停留在方形框上将显示对应信息）</span></p>\n<p>对于新手而言，火焰图可能非常难以理解。Brendan Gregg 给出以下解释帮助我们理解一张火焰图：</p>\n<blockquote><p><i></i>X 轴显示堆栈剖面群体，以字母顺序排序（而不是时间的流逝），Y 轴显示堆栈深度。每个方块框代表了一个堆栈帧。帧越宽，代表了它在堆栈中出现的频率越高。顶端显示了 CPU 正在运行的进程，下面是历史进程。颜色通常而言并不重要，它们是随机分配的，用来区分不同的框架。</p></blockquote>\n<p>从火焰图中可以清楚地看到，大约 55% 的 CPU 时间花在了 <code>ExecOpenIndices</code> 上（图中行右侧区域的大黄色条）。视线上移一点，可以看到大部分的时间被两个不同的功能所消耗，它们是 <code>BuildIndexInfo</code> 和 <code>index_open</code>。<code>BuildIndexInfo</code> 调用了 <code>RelationGetIndexPredicate</code>，而后者花费了 ~20% 的总 CPU 时间。这样来看，大部分时间都花在了 <code>RelationGetIndexPredicate</code> 上。</p>\n<p>仔细查看 <a href=\"https://github.com/postgres/postgres/blob/REL9_5_STABLE/src/backend/utils/cache/relcache.c?ts=4#L4109-L4176\">RelationGetIndexPredicate 的源代码</a>，它的作用是解析和优化部分索引谓词。这就解释了为什么 <code>RelationGetIndexPredicate</code> 耗费了如此大量的时间，因为相比对已解析表达式进行求值，解析二进制表达式要更加困难。</p>\n<p>现在我们再看看剩下花在 <code>ExecOpenIndices</code> 上的时间。其中大部分剩余时间花在了 <code>index_open</code> 上。看上去 <code>index_open</code> 先调用了 <code>relation_open</code>，后者又调用了 <code>RelationIdGetRelation</code>。从 <a href=\"https://github.com/postgres/postgres/blob/REL9_5_STABLE/src/backend/utils/cache/relcache.c?ts=4#L1715-L1772\">RelationIdGetRelation 的源代码文件</a>中，可以看到它的作用是查找不同关系的元数据（本次问题中它主要用于查找部分索引）。根据 <code>RelationGetIndexPredicate</code> 和 <code>RelationIdGetRelation</code> 消耗的时间，看起来 Postgres 花费了更多的时间用于获取和解析部分索引谓词，而不是对其求值。</p>\n<h2>实施修复</h2>\n<p>看了不同函数的源代码，可以发现存在着大量的缓存。在 <code>RelationGetIndexPredicate </code>中，Postfres 先检测是否已抽取谓词并立即返回它。</p>\n<p><code>RelationIdGetRelation</code> 先使用 <a href=\"https://github.com/postgres/postgres/blob/ee6922112e9b3c02b995bd1d838c9a261f060133/src/backend/utils/cache/relcache.c?ts=4#L202-L212\">RelationIdCacheLookup</a> 来检查关系源数据是否已经过计算并缓存。通常情况下，索引元数据只需要经历一次获取和解析，剩下的时间都是从缓存中读取。</p>\n<p>不幸的是，因为我们每次将一个事件写入数以万计的不同表格，缓存出了问题。Postgres 有一个服务请求的进程池，并且每个进程都有单独的缓存。这些进程对每次插入都分配了轮询 (round-robin)。由于共享的模式中现存上万张基础表格，每次插入事件时，很有可能将两次事件插入同一进程的同一张表中，也就是说索引元数据几乎无法在执行插入时进行缓存。因此，Postgres 几乎每次都需要在插入事件时，获取并解析目的表格的索引元数据。</p>\n<p>根据这一点，我们可以做一个简单的改进：<strong>与其将每个事件单独插入表格，我们可以对需要插入相同表格的事件进行一次批量插入</strong>。通过运行一个简单的命令来批量插入事件，Postgres 就只需要在每次批处理时获取和解析索引元数据。我们之前本想进行批量插入以减少执行计数，但不是出于节省 CPU 资源的目的，因为我们假设所有的 CPU 都要用于对索引谓词求值。</p>\n<p>批量插入的初始基准显示 CPU 占用率得到了 10x 的缩减。得知了这一结果，我们开始在生产中测试批量插入。最终，通过对平均大小在 ~50 的事件进行批量插入，我们的吞吐量获得了 10x 的提高。这是对不同 Kafka 部分的吞吐量传输延迟时间，进行批处理前后的对比：左边的单位是延迟时间 (latency time)。我们能够在几分钟内清理完一个小时的积压 (backlog)。</p>\n<p><img class=\"alignnone wp-image-1667\" src=\"https://blog.heapanalytics.com/wp-content/uploads/2017/05/blog_post_latency-300x105.png\" alt=\"\" width=\"703\" height=\"246\"></p>\n<p>在实行批处理后，我又生成了一张插入事件的火焰图：</p>\n<p><a href=\"https://blog.heapanalytics.com/wp-content/uploads/2017/04/backend_after_nestloop.svg\" target=\"_blank\" rel=\"noopener noreferrer\"><img class=\"alignnone size-full wp-image-1655\" src=\"https://blog.heapanalytics.com/wp-content/uploads/2017/04/backend_after_nestloop.svg\" alt=\"\"></a></p>\n<p>这一次图上显示大部分的时间都归于 <code>ExecQual</code>（中间的红条），而根据<a href=\"https://github.com/postgres/postgres/blob/REL9_5_STABLE/src/backend/executor/execQual.c?ts=4#L5242-L5332\">源码</a>，而它是作用是对部分索引谓词进行求值，也就是说这一次 Postgres 将大量的 CPU 用在了正途上。</p>\n<p>我在半年前发现了这个问题。自此，我们不需要给集群增加额外的 CPU，而且看起来以后的几个月也不用这样做。我只是运用了基本的性能分析就有如此成效，没花什么力气就获得了 10 倍的收益。</p>\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111795\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111795votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111795\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318\">飞哥的咖啡</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2016/09/9667abaa540914200edd449974fb5538.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            我见青山多妩媚，料青山见我应如是        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/zhj318\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/zhj318/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 27</a> · <a title=\"QQ：574375911\" target=\"_blank\" href=\"#\"><i class=\"fa fa-qq\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "如何做到“恰好一次”地传递数十亿条消息", "url": "http://blog.jobbole.com/111809/", "url_object_id": "2b13e3e5df22fd0e812a87b4e135b363", "create_date": "2017/07/12 ·", "front_image_url": ["http://dl2.iteye.com/upload/attachment/0125/9374/0805a15e-51e6-3eb3-b3dc-4a687849ed1c.png"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 4, "tags": "其他,kafka,分布式", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://segment.com/blog/exactly-once-delivery/\">Amir Abu Shareb</a>   译文出处：<a target=\"_blank\" href=\"http://www.iteye.com/news/32533\">ITeye-雁惊寒</a>   </div><p><em>译者注：在分布式领域中存在着三种类型的消息投递语义，分别是：最多一次（at-most-once）、至少一次（at-least-once）和恰好一次（exactly-once）。本文作者介绍了一个利用Kafka和RocksDB来构建的“恰好一次”消息去重系统的实现原理。以下是译文。</em></p>\n<p>对任何一个数据流水线的唯一要求就是不能丢失数据。数据通常可以被延迟或重新排序，但不能丢失。</p>\n<p>为了满足这一要求，大多数的分布式系统都能够保证“<a href=\"http://www.cloudcomputingpatterns.org/at_least_once_delivery/\" target=\"_blank\">至少一次</a>”的投递消息技术。实现“至少一次”的投递技术通常就是：“重试、重试、再重试”。在你收到消费者的确认消息之前，你永远不要认为消息已经投递过去。</p>\n<p>但“至少一次”的投递并不是用户想要的。用户希望消息被投递一次，并且仅有一次。</p>\n<p>然而，<a href=\"http://bravenewgeek.com/you-cannot-have-exactly-once-delivery/\" target=\"_blank\">实现“恰好一次”的投递需要完美的设计</a>。每种投递失败的情况都必须认真考虑，并设计到架构中去，因此它不能在事后“挂到”现有的实现上去。即使这样，“只有一次”的投递消息几乎是不可能的。</p>\n<p>在过去的三个月里，我们构建了一个全新的去重系统，以便在面对各种故障时能让系统尽可能实现“恰好一次”的投递。</p>\n<p>新系统能够跟踪旧系统100倍的消息数量，并且可靠性也得到了提高，而付出的代价却只有一点点。下面我们就开始介绍这个新系统。</p>\n<p><strong>问题所在</strong></p>\n<p>Segment内部的大部分系统都是通过重试、消息重新投递、锁定和<a href=\"https://en.wikipedia.org/wiki/Two-phase_commit_protocol\" target=\"_blank\">两阶段提交</a>来优雅地处理故障。但是，有一个特例，那就是将数据直接发送到公共API的客户端程序。</p>\n<p>客户端（特别是移动客户端）经常会发生网络问题，有时候发送了数据，却没有收到API的响应。</p>\n<p>想象一下，某天你乘坐公共汽车，在iPhone上使用HotelTonight软件预订房间。该应用程序将数据上传到了Segment的服务器上，但汽车突然进入了隧道并失去了网络连接。你发送的某些数据在服务器上已经被处理，但客户端却无法收到服务器的响应消息。</p>\n<p>在这种情况下，即使服务器在技术上已经收到了这些确切的消息，但客户端也会进行重试并将相同的消息重新发送给Segment的API。</p>\n<p>从我们服务器的统计数据来看，在四个星期的窗口时间内，大约有0.6％的消息似乎是我们已经收到过的重复消息。</p>\n<p>这个错误率听起来可能并不是很高。但是，对于一个能创造数十亿美元效益的电子商务应用程序来说，0.6％的出入可能意味着盈利和数百万美元损失之间的差别。</p>\n<p><strong>对消息进行去重</strong></p>\n<p>现在，我们认识到问题的症结了，我们必须删除发送到API的重复消息。但是，该怎么做呢？</p>\n<p>最简单的思路就是使用针对任何类型的去重系统的高级API。在Python中，我们可以将其表示为：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596be62037fe9712259615\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndef dedupe(stream):  \r\n  for message in stream:  \r\n    if has_seen(message.id):   \r\n      discard(message)  \r\n    else:  \r\n      publish_and_commit(message)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596be62037fe9712259615-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62037fe9712259615-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596be62037fe9712259615-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62037fe9712259615-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596be62037fe9712259615-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62037fe9712259615-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596be62037fe9712259615-1\"><span class=\"crayon-e\">def </span><span class=\"crayon-e\">dedupe</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">stream</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62037fe9712259615-2\"><span class=\"crayon-h\">  </span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">message </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">stream</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62037fe9712259615-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">has_seen</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">   </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62037fe9712259615-4\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">discard</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62037fe9712259615-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62037fe9712259615-6\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">publish_and_commit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>对于数据流中的每个消息，首先要把他的id（假设是唯一的）作为主键，检查是否曾经见过这个特定的消息。如果以前见过这个消息，则丢弃它。如果没有，则是新的，我们应重新发布这个消息并以原子的方式提交消息。</p>\n<p>为了避免存储所有的消息，我们会设置“去重窗口”这个参数，这个参数定义了在消息过期之前key存储的时长。只要消息落在窗口时间之外，我们就认为它已过期失效。我们要保证在窗口时间内某个给定ID的消息只发送一次。</p>\n<p>这个行为很容易描述，但有两个方面需要特别注意：读/写性能和正确性。</p>\n<p>我们希望系统能够低延迟和低成本的对通过流水线的数十亿个事件进行去重。更重要的是，我们要确保所有的事件都能够被持久化，以便可以从崩溃中恢复出来，并且不会输出重复的消息。</p>\n<p><strong>架构</strong></p>\n<p>为了实现这一点，我们创建了一个“两阶段”架构，它读入Kafka的数据，并且在四个星期的时间窗口内对接收到的所有事件进行去重。</p>\n<div><img class=\"magplus aligncenter\" title=\"点击查看原始大小图片\" src=\"http://dl2.iteye.com/upload/attachment/0125/9374/0805a15e-51e6-3eb3-b3dc-4a687849ed1c.png\" width=\"649\" height=\"363\"></div>\n<div style=\"text-align: center\">去重系统的高级架构图</div>\n<div style=\"text-align: center\"></div>\n<p><strong>Kafka的拓扑结构</strong></p>\n<p>要了解其工作原理，首先看一下<a href=\"https://kafka.apache.org/\" target=\"_blank\">Kafka</a>的流拓扑结构。所有传入消息的API调用都将作为单独的消息进行分离，并读入到Kafka输入主题（input topic）中。</p>\n<p>首先，每个传入的消息都有一个由客户端生成的具有唯一性的messageId标记。在大多数情况下，这是一个UUIDv4（我们考虑切换到<a href=\"https://segment.com/blog/a-brief-history-of-the-uuid/\" target=\"_blank\">ksuids</a>）。 如果客户端不提供messageId，我们会在API层自动分配一个。</p>\n<p>我们不使用矢量时钟或序列号，因为我们希望能降低客户端的复杂性。使用UUID可以让任何人轻松地将数据发送到我们的API上来，因为几乎所有的主要语言都支持它。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596be62037ff4139128504\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n{  \r\n  \"messageId\": \"ajs-65707fcf61352427e8f1666f0e7f6090\",  \r\n  \"anonymousId\": \"e7bd0e18-57e9-4ef4-928a-4ccc0b189d18\",  \r\n  \"timestamp\": \"2017-06-26T14:38:23.264Z\",  \r\n  \"type\": \"page\"  \r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596be62037ff4139128504-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62037ff4139128504-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596be62037ff4139128504-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62037ff4139128504-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596be62037ff4139128504-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62037ff4139128504-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596be62037ff4139128504-1\"><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62037ff4139128504-2\"><span class=\"crayon-h\">  </span><span class=\"crayon-s\">\"messageId\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"ajs-65707fcf61352427e8f1666f0e7f6090\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62037ff4139128504-3\"><span class=\"crayon-h\">  </span><span class=\"crayon-s\">\"anonymousId\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"e7bd0e18-57e9-4ef4-928a-4ccc0b189d18\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62037ff4139128504-4\"><span class=\"crayon-h\">  </span><span class=\"crayon-s\">\"timestamp\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"2017-06-26T14:38:23.264Z\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62037ff4139128504-5\"><span class=\"crayon-h\">  </span><span class=\"crayon-s\">\"type\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"page\"</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62037ff4139128504-6\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>为了能够将消息持久化，并能够重新发送，一个个的消息被保存到Kafka中。消息以messageId进行分区，这样就可以保证具有相同messageId的消息能够始终由同一个消费者处理。</p>\n<p>这对于数据处理来说是一件很重要的事情。我们可以通过路由到正确的分区来查找键值，而不是在整个中央数据库的数百亿条消息中查找，这种方法极大地缩小了查找范围。</p>\n<p>去重“worker”（worker：工人。译者注，这里表示的是某个进程。为防止引起歧义，下文将直接使用worker）是一个Go程序，它的功能是从Kafka输入分区中读入数据，检查消息是否有重复，如果是新的消息，则发送到Kafka输出主题中。</p>\n<p>根据我们的经验，worker和Kafka拓扑结构都非常容易掌握。我们无需使用一组遇到故障时需要切换到副本的庞大的<a href=\"https://memcached.org/\" target=\"_blank\">Memcached</a>实例。相反，我们只需使用零协同的嵌入式<a href=\"http://rocksdb.org/\" target=\"_blank\">RocksDB</a>数据库，并以非常低的成本来获得持久化存储。</p>\n<p><strong>RocksDB的worker进程</strong></p>\n<p>每一个worker都会在本地EBS硬盘上存放了一个RocksDB数据库。 RocksDB是由<a href=\"https://www.facebook.com/notes/facebook-engineering/under-the-hood-building-and-open-sourcing-rocksdb/10151822347683920/\" target=\"_blank\">Facebook开发的嵌入式键值存储系统</a>，它的性能非常高。</p>\n<p>每当从输入主题中过来的消息被消费时，消费者通过查询RocksDB来确定我们之前是否见过该事件的messageId。</p>\n<p>如果RocksDB中不存在该消息，我们就将其添加到RocksDB中，然后将消息发布到Kafka输出主题。</p>\n<p>如果消息已存在于RocksDB，则worker不会将其发布到输出主题，而是更新输入分区的偏移，确认已处理过该消息。</p>\n<p><strong>性能</strong></p>\n<p>为了让我们的数据库获得高性能，我们必须对过来的每个事件满足三种查询模式：</p>\n<ul>\n<li>检测随机key的存在性，这可能不存在于我们的数据库中，但会在key空间中的任何地方找到。</li>\n<li>高速写入新的key</li>\n<li>老化那些超出了“去重窗口”的旧的key</li>\n</ul>\n<p>实际上，我们必须不断地检索整个数据库，追加新的key，老化旧的key。在理想情况下，这些发生在同一数据模型中。</p>\n<div><img class=\"magplus aligncenter\" title=\"点击查看原始大小图片\" src=\"http://dl2.iteye.com/upload/attachment/0125/9376/72903fab-cccf-3cad-865c-1ff55f16cc47.png\" width=\"650\" height=\"346\"></div>\n<div style=\"text-align: center\">我们的数据库必须满足三种独立的查询模式</div>\n<div style=\"text-align: center\"></div>\n<p>一般来说，这些性能大部分取决于我们数据库的性能，所以应该了解一下RocksDB的内部机制来提高它的性能。</p>\n<p>RocksDB是一个<a href=\"https://en.wikipedia.org/wiki/Log-structured_merge-tree\" target=\"_blank\">日志结构合并树（log-structured-merge-tree， 简称LSM）</a>数据库，这意味着它会不断地将新的key附加到磁盘上的预写日志（write-ahead-log）中，并把排序过的key存放在内存中作为memtable的一部分。</p>\n<div style=\"text-align: center\"><img class=\"magplus aligncenter\" title=\"点击查看原始大小图片\" src=\"http://dl2.iteye.com/upload/attachment/0125/9378/c8ba4f20-2a19-3d7d-9757-35a21939ad9b.png\" width=\"650\" height=\"316\"><br>\nkey存放在内存中作为memtable的一部分</div>\n<div></div>\n<div>写入key是一个非常快速的过程。新的消息以追加的方式直接保存到磁盘上，并且数据条目在内存中进行排序，以提供快速的搜索和批量写入。</div>\n<div>每当写入到memtable的条目达到一定数量时，这些条目就会被作为SSTable（排序的字符串表）持久化到磁盘上。由于字符串已经在内存中排过序了，所以可以将它们直接写入磁盘。</div>\n<div><img class=\"magplus aligncenter\" title=\"点击查看原始大小图片\" src=\"http://dl2.iteye.com/upload/attachment/0125/9380/51764a44-a86b-3b2b-a51f-e3d76fb99e0d.png\" width=\"650\" height=\"442\"></div>\n<div style=\"text-align: center\">当前的memtable零级写入磁盘</div>\n<div style=\"text-align: center\"></div>\n<p>以下是在我们的生产日志中写入的示例：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596be62037ffb836720706\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n[JOB 40] Syncing log #655020  \r\n[default] [JOB 40] Flushing memtable with next log file: 655022  \r\n[default] [JOB 40] Level-0 flush table #655023: started  \r\n[default] [JOB 40] Level-0 flush table #655023: 15153564 bytes OK  \r\n[JOB 40] Try to delete WAL files size 12238598, prev total WAL file size 24346413, number of live WAL files 3.</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596be62037ffb836720706-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62037ffb836720706-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596be62037ffb836720706-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62037ffb836720706-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596be62037ffb836720706-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596be62037ffb836720706-1\"><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">40</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Syncing </span><span class=\"crayon-v\">log</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#655020  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62037ffb836720706-2\"><span class=\"crayon-sy\">[</span><span class=\"crayon-st\">default</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">40</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Flushing </span><span class=\"crayon-e\">memtable </span><span class=\"crayon-e\">with </span><span class=\"crayon-e\">next </span><span class=\"crayon-e\">log </span><span class=\"crayon-v\">file</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">655022</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62037ffb836720706-3\"><span class=\"crayon-sy\">[</span><span class=\"crayon-st\">default</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">40</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Level</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">flush </span><span class=\"crayon-v\">table</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#655023: started  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62037ffb836720706-4\"><span class=\"crayon-sy\">[</span><span class=\"crayon-st\">default</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">40</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Level</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">flush </span><span class=\"crayon-v\">table</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#655023: 15153564 bytes OK  </span></div><div class=\"crayon-line\" id=\"crayon-596be62037ffb836720706-5\"><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">40</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">Try</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete </span><span class=\"crayon-e\">WAL </span><span class=\"crayon-e\">files </span><span class=\"crayon-i\">size</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">12238598</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">prev </span><span class=\"crayon-e\">total </span><span class=\"crayon-e\">WAL </span><span class=\"crayon-e\">file </span><span class=\"crayon-i\">size</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">24346413</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">number </span><span class=\"crayon-e\">of </span><span class=\"crayon-e\">live </span><span class=\"crayon-e\">WAL </span><span class=\"crayon-i\">files</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3.</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0021 seconds] -->\r\n<p>每个SSTable是不可变的，一旦创建，永远不会改变。这是什么写入新的键这么快的原因。无需更新文件，无需写入扩展。相反，在带外压缩阶段，同一级别的多个SSTable可以合并成一个新的文件。</p>\n<div><img class=\"magplus aligncenter\" title=\"点击查看原始大小图片\" src=\"http://dl2.iteye.com/upload/attachment/0125/9382/50bf7dc4-1153-30fb-b263-d3d887451cec.png\" width=\"650\" height=\"422\"></div>\n<p> </p>\n<p>当在同一级别的SSTables压缩时，它们的key会合并在一起，然后将新的文件升级到下一个更高的级别。</p>\n<p>看一下我们生产的日志，可以看到这些压缩作业的示例。在这种情况下，作业41正在压缩4个0级文件，并将它们合并为单个较大的1级文件。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596be62038000209898755\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/data/dedupe.db$ head -1000 LOG | grep \"JOB 41\"  \r\n[JOB 41] Compacting 4@0 + 4&lt;a href=\"http://www.jobbole.com/members/yaowei729\"&gt;@1&lt;/a&gt; files to L1, score 1.00  \r\n[default] [JOB 41] Generated table #655024: 1550991 keys, 69310820 bytes  \r\n[default] [JOB 41] Generated table #655025: 1556181 keys, 69315779 bytes  \r\n[default] [JOB 41] Generated table #655026: 797409 keys, 35651472 bytes  \r\n[default] [JOB 41] Generated table #655027: 1612608 keys, 69391908 bytes  \r\n[default] [JOB 41] Generated table #655028: 462217 keys, 19957191 bytes  \r\n[default] [JOB 41] Compacted 4@0 + 4&lt;a href=\"http://www.jobbole.com/members/yaowei729\"&gt;@1&lt;/a&gt; files to L1 =&gt; 263627170 bytes</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596be62038000209898755-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038000209898755-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596be62038000209898755-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038000209898755-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596be62038000209898755-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038000209898755-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596be62038000209898755-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038000209898755-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596be62038000209898755-1\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dedupe</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">db</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">head</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1000</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">LOG</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">grep</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"JOB 41\"</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038000209898755-2\"><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">41</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Compacting</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">4</span><span class=\"crayon-sy\">@</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">4</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-i\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">href</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"http://www.jobbole.com/members/yaowei729\"</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">@</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">a</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">files </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">L1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">score</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.00</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038000209898755-3\"><span class=\"crayon-sy\">[</span><span class=\"crayon-st\">default</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">41</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Generated </span><span class=\"crayon-v\">table</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#655024: 1550991 keys, 69310820 bytes  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038000209898755-4\"><span class=\"crayon-sy\">[</span><span class=\"crayon-st\">default</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">41</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Generated </span><span class=\"crayon-v\">table</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#655025: 1556181 keys, 69315779 bytes  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038000209898755-5\"><span class=\"crayon-sy\">[</span><span class=\"crayon-st\">default</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">41</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Generated </span><span class=\"crayon-v\">table</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#655026: 797409 keys, 35651472 bytes  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038000209898755-6\"><span class=\"crayon-sy\">[</span><span class=\"crayon-st\">default</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">41</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Generated </span><span class=\"crayon-v\">table</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#655027: 1612608 keys, 69391908 bytes  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038000209898755-7\"><span class=\"crayon-sy\">[</span><span class=\"crayon-st\">default</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">41</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Generated </span><span class=\"crayon-v\">table</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#655028: 462217 keys, 19957191 bytes  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038000209898755-8\"><span class=\"crayon-sy\">[</span><span class=\"crayon-st\">default</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-i\">JOB</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">41</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Compacted</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">4</span><span class=\"crayon-sy\">@</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">4</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-i\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">href</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"http://www.jobbole.com/members/yaowei729\"</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">@</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">a</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">files </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">L1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">263627170</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">bytes</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0035 seconds] -->\r\n<p>压缩完成后，新合并的SSTables将成为最终的数据库记录集，旧的SSTables将被取消链接。</p>\n<p>如果我们登录到生产实例，我们可以看到正在更新的预写日志以及正在写入、读取和合并的单个SSTable。</p>\n<div><img class=\"magplus aligncenter\" title=\"点击查看原始大小图片\" src=\"http://dl2.iteye.com/upload/attachment/0125/9384/58c26daf-e386-397d-a70d-e0b929f02bb5.jpg\" width=\"650\" height=\"425\"></div>\n<div style=\"text-align: center\">日志和最近占用I/O的SSTable</div>\n<div style=\"text-align: center\"></div>\n<p>下面生产的SSTable统计数据中，可以看到一共有四个“级别”的文件，并且一个级别比一个级别的文件大。</p>\n<div><img class=\"magplus aligncenter\" title=\"点击查看原始大小图片\" src=\"http://dl2.iteye.com/upload/attachment/0125/9386/be0b7a4d-2501-3a32-8767-29ebfffb90ae.png\" width=\"650\" height=\"243\"></div>\n<p>RocksDB保存了索引和存储在SSTable的特定SSTables的<a href=\"https://en.wikipedia.org/wiki/Bloom_filter\" target=\"_blank\">布隆过滤器</a>，并将这些加载到内存中。通过查询这些过滤器和索引可以找到特定的key，然后将完整的SSTable作为LRU基础的一部分加载到内存中。</p>\n<p>在绝大多数情况下，我们就可以看到新的消息了，这使得我们的去重系统成为教科书中的布隆过滤器案例。</p>\n<p>布隆过滤器会告诉我们某个键“可能在集合中”，或者“绝对在集合中”。要做到这一点，布隆过滤器保存了已经见过的任何元素的多种哈希函数的设置位。如果设置了散列函数的所有位，则过滤器将返回消息“可能在集合中”。</p>\n<div><img class=\"magplus aligncenter\" title=\"点击查看原始大小图片\" src=\"http://dl2.iteye.com/upload/attachment/0125/9388/865a6b99-4181-3dc8-8400-5c9afab2d7b5.png\" width=\"650\" height=\"225\"></div>\n<p> </p>\n<p>我们的集合包含{x，y，z}，在布隆过滤器中查询w，则布隆过滤器会返回“不在集合中”，因为其中有一位没有设置。</p>\n<p>如果返回“可能在集合中”，则RocksDB可以从SSTables中查询到原始数据，以确定该项是否在该集合中实际存在。但在大多数情况下，我们不需查询任何SSTables，因为过滤器将返回“绝对不在集合”的响应。</p>\n<p>在我们查询RocksDB时，我们会为所有要查询的相关的messageId发出一个MultiGet。基于性能考虑，我们会批量地发布出去，以避免太多的并发锁定操作。它还允许我们批量处理来自Kafka的数据，这是为了实现顺序写入，而不是随机写入。</p>\n<p>以上回答了为什么读/写工作负载性能这么好的问题，但仍然存在如何老化数据这个问题。</p>\n<p><strong>删除：按大小来限制，而不是按时间来限制</strong></p>\n<p>在我们的去重过程中，我们必须要确定是否要将我们的系统限制在严格的“去重窗口”内，或者是通过磁盘上的总数据库大小来限制。</p>\n<p>为了避免系统突然崩溃导致去重系统接收到所有客户端的消息，我们决定按照大小来限制接收到消息数量，而不是按照设定的时间窗口来限制。这允许我们为每个RocksDB实例设置最大的大小，以能够处理突然的负载增加。但是其副作用是可能会将去重窗口降低到24小时以下。</p>\n<p>我们会定期在RocksDB中老化旧的key，使其不会增长到无限大小。为此，我们根据序列号保留key的第二个索引，以便我们可以先删除最早接收到的key。</p>\n<p>我们使用每个插入的key的序列号来删除对象，而不是使用RocksDB TTL（这需要在打开数据库的时候设置一个固定的TTL值）来删除。</p>\n<p>因为序列号是第二索引，所以我们可以快速地查询，并将其标记为已删除。下面是根据序列号进行删除的示例代码：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596be62038007796238778\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nfunc (d *DB) delete(n int) error {  \r\n        // open a connection to RocksDB  \r\n        ro := rocksdb.NewDefaultReadOptions()  \r\n        defer ro.Destroy()  \r\n  \r\n        // find our offset to seek through for writing deletes  \r\n        hint, err := d.GetBytes(ro, []byte(\"seek_hint\"))  \r\n        if err != nil {  \r\n                return err  \r\n        }  \r\n  \r\n        it := d.NewIteratorCF(ro, d.seq)  \r\n        defer it.Close()  \r\n  \r\n        // seek to the first key, this is a small  \r\n        // optimization to ensure we don't use `.SeekToFirst()`  \r\n        // since it has to skip through a lot of tombstones.  \r\n        if len(hint) &gt; 0 {  \r\n                it.Seek(hint)  \r\n        } else {  \r\n                it.SeekToFirst()  \r\n        }  \r\n  \r\n        seqs := make([][]byte, 0, n)  \r\n        keys := make([][]byte, 0, n)  \r\n  \r\n        // look through our sequence numbers, counting up  \r\n        // append any data keys that we find to our set to be  \r\n        // deleted  \r\n        for it.Valid() &amp;&amp; len(seqs) &lt; n {  \r\n                k, v := it.Key(), it.Value()  \r\n                key := make([]byte, len(k.Data()))  \r\n                val := make([]byte, len(v.Data()))  \r\n  \r\n                copy(key, k.Data())  \r\n                copy(val, v.Data())  \r\n                seqs = append(seqs, key)  \r\n                keys = append(keys, val)  \r\n  \r\n                it.Next()  \r\n                k.Free()  \r\n                v.Free()  \r\n        }  \r\n  \r\n        wb := rocksdb.NewWriteBatch()  \r\n        wo := rocksdb.NewDefaultWriteOptions()  \r\n        defer wb.Destroy()  \r\n        defer wo.Destroy()  \r\n  \r\n        // preserve next sequence to be deleted.  \r\n        // this is an optimization so we can use `.Seek()`  \r\n        // instead of letting `.SeekToFirst()` skip through lots of tombstones.  \r\n        if len(seqs) &gt; 0 {  \r\n                hint, err := strconv.ParseUint(string(seqs[len(seqs)-1]), 10, 64)  \r\n                if err != nil {  \r\n                        return err  \r\n                }  \r\n  \r\n                buf := []byte(strconv.FormatUint(hint+1, 10))  \r\n                wb.Put([]byte(\"seek_hint\"), buf)  \r\n        }  \r\n  \r\n        // we not only purge the keys, but the sequence numbers as well  \r\n        for i := range seqs {  \r\n                wb.DeleteCF(d.seq, seqs[i])  \r\n                wb.Delete(keys[i])  \r\n        }  \r\n  \r\n        // finally, we persist the deletions to our database  \r\n        err = d.Write(wo, wb)  \r\n        if err != nil {  \r\n                return err  \r\n        }  \r\n  \r\n        return it.Err()  \r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-596be62038007796238778-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be62038007796238778-76\">76</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-1\"><span class=\"crayon-e\">func</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">d *</span><span class=\"crayon-v\">DB</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">n</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-2\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// open a connection to RocksDB  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">ro</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">rocksdb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">NewDefaultReadOptions</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-4\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">defer </span><span class=\"crayon-v\">ro</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Destroy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-5\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// find our offset to seek through for writing deletes  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">hint</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">d</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetBytes</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ro</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-t\">byte</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"seek_hint\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">nil</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-9\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">err</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-11\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">it</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">d</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">NewIteratorCF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ro</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">d</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">seq</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">defer </span><span class=\"crayon-v\">it</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Close</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-14\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// seek to the first key, this is a small  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// optimization to ensure we don't use `.SeekToFirst()`  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// since it has to skip through a lot of tombstones.  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">len</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hint</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-19\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">it</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Seek</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hint</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-21\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">it</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SeekToFirst</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-23\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">seqs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">make</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-t\">byte</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">keys</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">make</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-t\">byte</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-26\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// look through our sequence numbers, counting up  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// append any data keys that we find to our set to be  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// deleted  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">it</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Valid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">len</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">seqs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">n</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-31\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">v</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">it</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Key</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">it</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Value</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-32\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">key</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">make</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-t\">byte</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">len</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Data</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-33\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">val</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">make</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-t\">byte</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">len</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">v</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Data</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-34\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-35\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">copy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Data</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-36\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">copy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">v</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Data</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-37\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">seqs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">seqs</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-38\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">keys</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">keys</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-39\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-40\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">it</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Next</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-41\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-42\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">v</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-44\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-45\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">wb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">rocksdb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">NewWriteBatch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-46\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">wo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">rocksdb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">NewDefaultWriteOptions</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-47\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">defer </span><span class=\"crayon-v\">wb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Destroy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-48\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">defer </span><span class=\"crayon-v\">wo</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Destroy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-49\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// preserve next sequence to be deleted.  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-51\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// this is an optimization so we can use `.Seek()`  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-52\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// instead of letting `.SeekToFirst()` skip through lots of tombstones.  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-53\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">len</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">seqs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-54\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">hint</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">strconv</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ParseUint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">seqs</span><span class=\"crayon-sy\">[</span><span class=\"crayon-e\">len</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">seqs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">64</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-55\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">nil</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-56\"><span class=\"crayon-h\">                        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">err</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-57\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-58\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-59\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">buf</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-t\">byte</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">strconv</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">FormatUint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hint</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-60\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">wb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Put</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-t\">byte</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"seek_hint\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">buf</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-61\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-62\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-63\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// we not only purge the keys, but the sequence numbers as well  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-64\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">range</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">seqs</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-65\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">wb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">DeleteCF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">d</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">seq</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">seqs</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-66\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">wb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">keys</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-67\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-68\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-69\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// finally, we persist the deletions to our database  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-70\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">d</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">wo</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-71\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">nil</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-72\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">err</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-73\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-74\"><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596be62038007796238778-75\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">it</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Err</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be62038007796238778-76\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0121 seconds] -->\r\n<p>为了保证写入速度，RocksDB不会立即返回并删除一个键（记住，这些SSTable是不可变的！）。相反，RocksDB将添加一个“墓碑”，等到压缩时再进行删除。因此，我们可以通过顺序写入来快速地老化，避免因为删除旧项而破坏内存数据。</p>\n<p><strong>确保正确性</strong></p>\n<p>我们已经讨论了如何确保数十亿条消息投递的速度、规模和低成本的搜索。最后一个部分将讲述各种故障情况下我们如何确保数据的正确性。</p>\n<p><strong>EBS快照和附件</strong></p>\n<p>为了确保RocksDB实例不会因为错误的代码推送或潜在的EBS停机而损坏，我们会定期保存每个硬盘驱动器的快照。虽然EBS已经在底层进行了复制，但是这一步可以防止数据库受到某些底层机制的破坏。</p>\n<p>如果我们想要启用一个新实例，则可以先暂停消费者，将相关联的EBS驱动器分开，然后重新附加到新的实例上去。只要我们保证分区ID相同，重新分配磁盘是一个轻松的过程，而且也能保证数据的正确性。</p>\n<p>如果worker发生崩溃，我们依靠RocksDB内置的预写日志来确保不会丢失消息。消息不会从输入主题提交，除非RocksDB已经将消息持久化在日志中。</p>\n<p><strong>读取输出主题</strong></p>\n<p>你可能会注意到，本文直到这里都没有提到“原子”步骤，以使我们能够确保只投递一次消息。我们的worker有可能在任何时候崩溃，不如：写入RocksDB时、发布到输出主题时，或确认输入消息时。</p>\n<p>我们需要一个原子的“提交”点，并覆盖所有这些独立系统的事务。对于输入的数据，需要某个“事实来源”：输出主题。</p>\n<p>如果去重worker因为某些原因发生崩溃，或者遇到Kafka的某个错误，则系统在重新启动时，会首先查阅这个“事实来源”，输出主题，来判断事件是否已经发布出去。</p>\n<p>如果在输出主题中找到消息，而不是RocksDB（反之亦然），则去重worker将进行必要的修复工作以保持数据库和RocksDB之间的同步。实际上，我们使用输出主题作为我们的预写入日志和最终的事实来源，让RocksDB进行检查和校验。</p>\n<p><strong>在生产环境中</strong></p>\n<p>我们的去重系统已经在生产运行了3个月，对其运行的结果我们感到非常满意。我们有以下这些数据：</p>\n<ul>\n<li>在RocksDB中，有1.5TB的key存储在磁盘上</li>\n<li>在老化旧的key之前，有一个四个星期的去重窗口</li>\n<li>RocksDB实例中存储了大约600亿个key</li>\n<li>通过去重系统的消息达到2000亿条</li>\n</ul>\n<p>该系统快速、高效、容错性强，也非常容易理解。</p>\n<p>特别是我们的v2版本系统相比旧的去重系统有很多优点。</p>\n<p>以前我们将所有的key存储在Memcached中，并使用Memcached的原子CAS（check-and-set）操作来设置key。 Memcached起到了提交点和“原子”地发布key的作用。</p>\n<p>虽然这个功能很好，但它需要有大量的内存来支撑所有的key。此外，我们必须能够接受偶尔的Memcached故障，或者将用于高速内存故障切换的支出加倍。</p>\n<p>Kafka/RocksDB的组合相比旧系统有如下几个优势：</p>\n<p><strong>数据存储在磁盘上</strong>：在内存中保存所有的key或完整的索引，其代价是非常昂贵的。通过将更多的数据转移到磁盘，并利用多种不同级别的文件和索引，能够大幅削减成本。对于故障切换，我们能够使用冷备（EBS），而不用运行其他的热备实例。</p>\n<p><strong>分区</strong>：为了缩小key的搜索范围，避免在内存中加载太多的索引，我们需要保证某个消息能够路由到正确的worker。在Kafka中对上游进行分区可以对这些消息进行路由，从而更有效地缓存和查询。</p>\n<p><strong>显式地进行老化处理</strong>：在使用Memcached的时候，我们在每个key上设置一个TTL来标记是否超时，然后依靠Memcached进程来对超时的key进行处理。这使得我们在面对大量数据时，可能会耗尽内存，并且在丢弃大量超时消息时，Memcached的CPU使用率会飙升。而通过让客户端来处理key的删除，使得我们可以通过缩短去重窗口来优雅地处理。</p>\n<p><strong>将Kafka作为事实来源</strong>：为了真正地避免对多个提交点进行消息去重，我们必须使用所有下游消费者都常见的事实来源。使用Kafka作为“事实来源”是最合适的。在大多数失败的情况下（除了Kafka失败之外），消息要么会被写入Kafka，要么不会。使用Kafka可以确保按顺序投递消息，并在多台计算机之间进行磁盘复制，而不需要在内存中保留大量的数据。</p>\n<p><strong>批量读写</strong>：通过Kafka和RocksDB的批量I/O调用，我们可以通过利用顺序读写来获得更好的性能。与之前在Memcached中使用的随机访问不同，我们能够依靠磁盘的性能来达到更高的吞吐量，并只在内存中保留索引。</p>\n<p>总的来说，我们对自己构建的去重系统非常满意。使用Kafka和RocksDB作为流媒体应用的原语开始变得越来越普遍。我们很高兴能继续在这些原语之上构建新的分布式应用程序。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111809\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111809votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111809\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 4 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "DB 分库分表的基本思想和切分策略", "url": "http://blog.jobbole.com/111855/", "url_object_id": "7aa6fa98cd3ee2601bef9126f83c34d6", "create_date": "2017/07/15 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/03/4bae6998d00f180d42c7da716e3d0bb2.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 3, "tags": "IT技术,分片,数据库", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.csdn.net/bluishglc/article/details/6161475\">Laurence的技术博客</a>   </div><p>本文着重介绍sharding的基本思想和理论上的切分策略，关于更加细致的实施策略和参考事例请参考我的另一篇博文：<a href=\"http://blog.jobbole.com/111860/\" target=\"_blank\">DB 分库分表（1）： 拆分实施策略和示例演示 </a></p>\n<p><strong>一、基本思想</strong></p>\n<p>Sharding的基本思想就要把一个数据库切分成多个部分放到不同的数据库(server)上，从而缓解单一数据库的性能问题。不太严格的讲，对于海量数据的数据库，如果是因为表多而数据多，这时候适合使用垂直切分，即把关系紧密（比如同一模块）的表切分出来放在一个server上。如果表并不多，但每张表的数据非常多，这时候适合水平切分，即把表的数据按某种规则（比如按ID散列）切分到多个数据库(server)上。当然，现实中更多是这两种情况混杂在一起，这时候需要根据实际情况做出选择，也可能会综合使用垂直与水平切分，从而将原有数据库切分成类似矩阵一样可以无限扩充的数据库(server)阵列。下面分别详细地介绍一下垂直切分和水平切分.</p>\n<p>垂直切分的最大特点就是规则简单，实施也更为方便，尤其适合各业务之间的耦合度非常低，相互影响很小，业务逻辑非常清晰的系统。在这种系统中，可以很容易做到将不同业务模块所使用的表分拆到不同的数据库中。根据不同的表来进行拆分，对应用程序的影响也更小，拆分规则也会比较简单清晰。（这也就是所谓的”share nothing”）。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2ce8c1ca0a46de6603bda931b3e3160b.jpg\" alt=\"\"></p>\n<p>水平切分于垂直切分相比，相对来说稍微复杂一些。因为要将同一个表中的不同数据拆分到不同的数据库中，对于应用程序来说，拆分规则本身就较根据表名来拆分更为复杂，后期的数据维护也会更为复杂一些。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/100ee97139152eb7b822efab51d05dbf.jpg\" alt=\"\"></p>\n<p>让我们从普遍的情况来考虑数据的切分：一方面，一个库的所有表通常不可能由某一张表全部串联起来，这句话暗含的意思是，水平切分几乎都是针对一小搓一小搓（实际上就是垂直切分出来的块）关系紧密的表进行的，而不可能是针对所有表进行的。另一方面，一些负载非常高的系统，即使仅仅只是单个表都无法通过单台数据库主机来承担其负载，这意味着单单是垂直切分也不能完全解决问明。因此多数系统会将垂直切分和水平切分联合使用，先对系统做垂直切分，再针对每一小搓表的情况选择性地做水平切分。从而将整个数据库切分成一个分布式矩阵。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/f54969b3b128512a0464502cd1300aad.jpg\" alt=\"\"></p>\n<p><strong>二、切分策略</strong></p>\n<p>如前面所提到的，切分是按先垂直切分再水平切分的步骤进行的。垂直切分的结果正好为水平切分做好了铺垫。垂直切分的思路就是分析表间的聚合关系，把关系紧密的表放在一起。多数情况下可能是同一个模块，或者是同一“聚集”。这里的“聚集”正是领域驱动设计里所说的聚集。在垂直切分出的表聚集内，找出“根元素”（这里的“根元素”就是领域驱动设计里的“聚合根”），按“根元素”进行水平切分，也就是从“根元素”开始，把所有和它直接与间接关联的数据放入一个shard里。这样出现跨shard关联的可能性就非常的小。应用程序就不必打断既有的表间关联。比如：对于社交网站，几乎所有数据最终都会关联到某个用户上，基于用户进行切分就是最好的选择。再比如论坛系统，用户和论坛两个模块应该在垂直切分时被分在了两个shard里，对于论坛模块来说，Forum显然是聚合根，因此按Forum进行水平切分，把Forum里所有的帖子和回帖都随Forum放在一个shard里是很自然的。</p>\n<p>对于共享数据数据，如果是只读的字典表，每个shard里维护一份应该是一个不错的选择，这样不必打断关联关系。如果是一般数据间的跨节点的关联，就必须打断。</p>\n<p><strong>      需要特别说明的是：当同时进行垂直和水平切分时，切分策略会发生一些微妙的变化。比如：在只考虑垂直切分的时候，被划分到一起的表之间可以保持任意的关联关系，因此你可以按“功能模块”划分表格，但是一旦引入水平切分之后，表间关联关系就会受到很大的制约，通常只能允许一个主表（以该表ID进行散列的表）和其多个次表之间保留关联关系，也就是说：当同时进行垂直和水平切分时，在垂直方向上的切分将不再以“功能模块”进行划分，而是需要更加细粒度的垂直切分，而这个粒度与领域驱动设计中的“聚合”概念不谋而合，甚至可以说是完全一致，每个shard的主表正是一个聚合中的聚合根！这样切分下来你会发现数据库分被切分地过于分散了（shard的数量会比较多，但是shard里的表却不多），为了避免管理过多的数据源，充分利用每一个数据库服务器的资源，可以考虑将业务上相近，并且<strong><strong>具有相近数据增长速率（主表数据量在同一数量级上）的</strong></strong>两个或多个shard放到同一个数据源里，每个shard依然是独立的，它们有各自的主表，并使用各自主表ID进行散列，不同的只是它们的散列取模（即节点数量）必需是一致的。</strong></p>\n<p>1.事务问题：<br>\n解决事务问题目前有两种可行的方案：分布式事务和通过应用程序与数据库共同控制实现事务下面对两套方案进行一个简单的对比。<br>\n方案一：使用分布式事务<br>\n优点：交由数据库管理，简单有效<br>\n缺点：性能代价高，特别是shard越来越多时<br>\n方案二：由应用程序和数据库共同控制<br>\n原理：将一个跨多个数据库的分布式事务分拆成多个仅处于单个数据库上面的小事务，并通过应用程序来总控各个小事务。<br>\n优点：性能上有优势<br>\n缺点：需要应用程序在事务控制上做灵活设计。如果使用了spring的事务管理，改动起来会面临一定的困难。</p>\n<p>2.跨节点Join的问题<br>\n只要是进行切分，跨节点Join的问题是不可避免的。但是良好的设计和切分却可以减少此类情况的发生。解决这一问题的普遍做法是分两次查询实现。在第一次查询的结果集中找出关联数据的id,根据这些id发起第二次请求得到关联数据。</p>\n<p>3.跨节点的count,order by,group by以及聚合函数问题<br>\n这些是一类问题，因为它们都需要基于全部数据集合进行计算。多数的代理都不会自动处理合并工作。解决方案：与解决跨节点join问题的类似，分别在各个节点上得到结果后在应用程序端进行合并。和join不同的是每个结点的查询可以并行执行，因此很多时候它的速度要比单一大表快很多。但如果结果集很大，对应用程序内存的消耗是一个问题。</p>\n<p><strong>关于垂直切分Vertical Sharding的粒度</strong></p>\n<p>垂直切分的粒度指的是在做垂直切分时允许几级的关联表放在一个shard里．这个问题对应用程序和sharding实现有着很大的影响．</p>\n<p>关联打断地越多，则受影响的join操作越多，应用程序为此做出的妥协就越大，但单表的路由会越简单，与业务的关联性会越小，就越容易使用统一机制处理．在此方向上的极端方案是：打断所有连接，每张表都配有路由规则，可以使用统一机制或框架自动处理．比如amoeba这样的框架，它的路由能且仅能通过SQL的特征（比如某个表的id）进行路由．</p>\n<p>反之，若关联打断地越少，则join操作的受到的限制就小，应用程序需要做出的妥协就越小，但是表的路由就会变复杂，与业务的关联性就越大，就越难使用统一机制处理，需要针对每个数据请求单独实现路由．在此方向上的极端方案是：所有表都在一个shard里，也就是没有垂直切分，这样就没有关联被打断．当然这是非常极端的，除非整个数据库很简单，表的数量很少．</p>\n<p>实际的粒度掌控需要结合“业务紧密程度”和“表格数据量”两个因素综合考虑，一般来说：</p>\n<ul>\n<li>若划归到一起的表格关系紧密，且数据量并不大，增速也非常缓慢，则适宜放在一个shard里，不需要再进行水平切分;</li>\n</ul>\n<ul>\n<li>若划归到一起的表格数据量巨大且增速迅猛，则势必要在垂直切分的基础上再进行水平切分，水平切分就意味着原单一shard会被细分成多个更小的shard，每一个shard存在一个主表（即会以该表ID进行散列的表）和多个相之相关的关联表。</li>\n</ul>\n<p>总之，垂直切分的粒度在两个相反的方向上呈现优势与劣势并存并相互博弈的局面．架构师需要做的是结合项目的实际情况在两者之间取得收益最大化的平衡．</p>\n<p>参考资料：</p>\n<p>《MySQL性能调优与架构设计》</p>\n<p>注：本文图片摘自《MySQL性能调优与架构设计》一书</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111855\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111855votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111855\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "Linux - 请允许我静静地后台运行", "url": "http://blog.jobbole.com/111850/", "url_object_id": "a5b15948fdca33a7e5a22f9c857c1ff3", "create_date": "2017/07/14 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2016/11/59d49abe8909a122bc2c9aa43b71e3bb.png"], "praise_nums": "1", "comment_nums": 1, "fav_nums": 2, "tags": "IT技术,Linux", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/zhenbianshu/p/7152327.html\">枕边书</a>   </div><h3 id=\"toc_0\">前言</h3>\n<p>常在 linux 下玩耍的开发者肯定会经常遇到需要对进程调度的情况，在 windows 中点击 <code>最小化</code> 去干别的就 OK 了，那么在 linux 下怎么办呢。</p>\n<p>可能有的小伙伴会说，再开一个终端窗口不就好了么。可是开很多窗口管理会很不方便，还有万一手贱点了x，或者长时间不操作，远程终端断开了连接，进程停止了，再次打开，又是一番折腾。</p>\n<p>今天来介绍几个命令，帮大家系统地梳理一下 linux 的进程调度，并附上一些自己的使用心得和踩过的坑。</p>\n<h3 id=\"toc_1\">名词</h3>\n<p>在此之前，我们必须（当然也不是必须，但了解原理有利于理解和解决错误）先弄懂几个名词。</p>\n<h4 id=\"toc_2\">进程组</h4>\n<p>进程组是一个或多个进程的集合，进程组方便了对多个进程的控制，在进程数较多的情况下，向进程组发送信号就行了。</p>\n<p>它的 ID 由它的组长进程的进程 ID 决定。组长进程创建了进程组，但它并不能决定进程组的存活时间，只要进程组内还有一个进程存在，进程就存在，与组长进程是否已终止无关。</p>\n<h4 id=\"toc_3\">会话</h4>\n<p>会话(session)是一个或多个进程组的集合，它开始于用户登陆终端，结束于用户退出登陆。其义如其名，就是指用户与系统的一次对话的全程。</p>\n<p>会话包括控制进程（与终端建立连接的领头进程），一个前台进程组和任意后台进程组。一个会话只能有一个控制终端，通常是登录到其上的终端设备或伪终端设备，产生在控制终端上的输入和信号将发送给会话的前台进程组中的所有进程。</p>\n<h4 id=\"toc_4\">控制终端</h4>\n<p>每当我们使用终端工具打开一个本地或远程 shell，我们便打开了一个控制终端，通过 <code>ps</code> 命令可以查看到 command 为 <code>ttyn</code> 的就是它对应的进程了，同时它对应 linux <code>/dev/</code> 目录下的一个文件。</p>\n<h4 id=\"toc_5\">作业</h4>\n<p>作业的概念与进程组类似，同样由一个或多个进程组成，它分为前台作业和后台作业，一个会话会有一个前台作业和多个后台作业，与进程组不同的是，作业内的某个进程产生的子进程并不属于这个作业。</p>\n<h4 id=\"toc_6\">类比</h4>\n<p>以上几个概念可以类比为我们一次通过 QQ 聊天的全程，控制终端就是 QQ软件，关闭了此软件代表着聊天结束。聊天时发送的每一条信息都是一个进程，作业或进程组就是我们在聊的某一件事，它由很多条相互的信息构成。而会话则是我们指我们从开始聊天到结束聊天的全过程，可能会聊很多个事。</p>\n<p>它们之间的相关图如下所示：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/799c79770f8239cea9ebad6ddab63472.png\" alt=\"\"></p>\n<h3 id=\"toc_7\">后台执行</h3>\n<p>我们每次在终端窗口执行命令的时候，进程总会一直占用着终端，走到进程结束，这段时间内，我们在终端的输入是没有用的。而且，当终端窗口关闭或网络连接失败后，再次打开终端，会发现进程已经中断了。这是因为用户注销或者网络断开时，<code>SIGHUP</code>信号会被发送到会话所属的子进程，而此 <code>SIGHUP</code> 的默认处理方式是终止收到该信号的进程。所以若程序中没有捕捉该信号，当终端关闭后，会话所属进程就会退出。</p>\n<p>我们要实现后台执行的目的，实际上是要完成如下两个目标：</p>\n<ul>\n<li>使进程让出前台终端，让我们可以继续通过终端与系统进行交互。</li>\n<li>使进程不再受终端关闭的影响，即系统在终端关闭后不再向进程发送 <code>SIGHUP</code> 信号或即使发送了信号程序也不会退出。</li>\n</ul>\n<p>以下的命令就围绕着这两个目标来实现。</p>\n<h4 id=\"toc_8\">&amp;</h4>\n<p>首先是我们最经常遇到的符号 <code>&amp;</code>，将它附在命令后面可以使进程在后台执行，不会占用前台界面。它实际上是在会话中开启了一个后台作业，对作业的操作我们后面再说。</p>\n<p>但我们会发现，如果此时终端被关闭后，进程还是会退出。这是因为，<code>&amp;</code> 符号只有让进程让出前台终端的功能，无法让进程不受 <code>SIGHUP</code> 信号的影响。</p>\n<h4 id=\"toc_9\">nohup</h4>\n<p><code>nohup</code> 应该是另外一个我们常用的命令了，它的作用如其字面意思，使进程不受 <code>SIGHUP</code> 信号的影响。但我们在使用 <code>nohup php test.php</code> 后会发现，进程还会一直占用前台终端，但即使终端被关闭或连接断开了，程序还是会执行，另外我们会发现在当前文件夹下多了个名为 <code>nohup.out</code> 的文件。</p>\n<p>这是因为 nohup 的功能仅仅是让进程不受 <code>SIGHUP</code> 信号的影响，并不会让出前台终端，而且它还会在命令执行目录下建立 <code>nohup.out</code> 用以存储进程的输出。如果进程不需要输出，且不想让 nohup 创建文件，可以将标准输出和标准错误输出重定向。</p>\n<p>我们常将 <code>nohup</code> 和 <code>&amp;</code> 搭配到一块使用，执行命令如下 <code>nohup command &gt;/dev/null 2&gt;&amp;1 &amp;</code> 这样，就可以放心的等待进程运行结果了。</p>\n<h4 id=\"toc_10\">setsid</h4>\n<p>setsid 是另一个让进程在后台执行的命令，它的作用是让进程打开一个新的会话并运行进程，使用方式为 <code>setsid command</code>。</p>\n<p>根据上面的概念我们得知终端关闭后进程退出是因为会话首进程向进程发送了 <code>SIGHUP</code> 信号，setsid 就厉害了，它直接打开一个新的会话来执行命令，那么原会话的终端的状态就再也不会影响到此进程了。</p>\n<p>我们使用 <code>pstree</code> 来查看使用 <code>setsid</code> 和 <code>nohup ... &amp;</code> 两种命令来运行进程时的进程树状态。</p>\n<ul>\n<li><code>nohup php test.php &amp;</code></li>\n</ul>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c7b889e430867720359\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npstree -a |grep -C 6 test\r\n  |-sshd\r\n  |   `-sshd\r\n  |       `-sshd\r\n  |           `-bash\r\n  |               `-sudo -s\r\n  |                   `-bash\r\n  |                       |-grep -C 6 test\r\n  |                       |-php test.php\r\n  |                       `-pstree -a</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c7b889e430867720359-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e430867720359-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e430867720359-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e430867720359-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e430867720359-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e430867720359-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e430867720359-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e430867720359-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e430867720359-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e430867720359-10\">10</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c7b889e430867720359-1\"><span class=\"crayon-v\">pstree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-v\">grep</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">C</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">6</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">test</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e430867720359-2\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">sshd</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e430867720359-3\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">   </span><span class=\"crayon-sy\">`</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">sshd</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e430867720359-4\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">       </span><span class=\"crayon-sy\">`</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">sshd</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e430867720359-5\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">           </span><span class=\"crayon-sy\">`</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">bash</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e430867720359-6\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">               </span><span class=\"crayon-sy\">`</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">sudo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">s</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e430867720359-7\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">                   </span><span class=\"crayon-sy\">`</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">bash</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e430867720359-8\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">                       </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">grep</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">C</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">6</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">test</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e430867720359-9\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">                       </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">php </span><span class=\"crayon-v\">test</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">php</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e430867720359-10\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">                       </span><span class=\"crayon-sy\">`</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">pstree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">a</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0020 seconds] -->\r\n\n</div>\n<p>我是用 ssh 远程登陆的机器，所以 test.php 进程是挂在 sshd 进程下的。正常情况下，一旦 sshd 进程结束，则 test.php也无法幸免。</p>\n<ul>\n<li><code>setsid php test.php</code></li>\n</ul>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c7b889e43e553838353\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npstree -a |grep -C 6 test \r\n  |-{nscd}\r\n  |-php test.php\r\n  |-php-fpm\r\n --\r\n  |-sshd\r\n  |   `-sshd</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c7b889e43e553838353-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e43e553838353-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e43e553838353-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e43e553838353-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e43e553838353-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e43e553838353-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e43e553838353-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c7b889e43e553838353-1\"><span class=\"crayon-v\">pstree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-v\">grep</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">C</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">6</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">test</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e43e553838353-2\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">nscd</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e43e553838353-3\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">php </span><span class=\"crayon-v\">test</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">php</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e43e553838353-4\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">php</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">fpm</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e43e553838353-5\"><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e43e553838353-6\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">sshd</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e43e553838353-7\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">   </span><span class=\"crayon-sy\">`</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">sshd</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n\n</div>\n<p>使用了 setsid 后，test.php 进程已经与 sshd 进程同级，属于 init 进程的子进程了。</p>\n<p>但是 setsid 并没有为进程分配一个输出终端，所以进程还是会输出到当前终端上。</p>\n<h5 id=\"toc_11\">setsid的坑</h5>\n<p>另外，setsid 有个略坑的地方： 在终端中直接使用 <code>setsid command</code> 运行进程时，终端前台并不会被影响，command 会在后台默默运行。而在 shell 脚本中，我们会发现运行 setsid 的进程会一直阻塞住，直到 command 进程执行结束。</p>\n<p>这是因为，setsid 在其是进程组长时会 <code>fork()</code> 一个进程，但它不会 <code>wait()</code> 它的子进程，而是立刻退出，所以在终端内直接使用 setsid 时，setsid 作为进程组长不会占用终端界面。</p>\n<p>而在 shell 脚本内，setsid 不是进程组长，它不会 <code>fork()</code> 子进程，而是由 bash 来<code>fork()</code> 一个子进程，而 bash 会 <code>wait()</code> 子进程，所以表现得像 setsid 在 <code>wait()</code> 子进程一样。</p>\n<p>要解决这个问题，有两个办法：</p>\n<ul>\n<li>使用上面介绍的 <code>&amp;</code>符号，使 setsid 强行到后台执行。</li>\n<li>使用 <code>.</code> 或 <code>source</code> 命令由终端执行 setsid；</li>\n</ul>\n<h4 id=\"toc_12\">其他</h4>\n<p>除了上面介绍的命令，还有 screen 和 tmux 等会话工具，他们都有自己的一套规范，也比较复杂，掌握本文的命令已经足够你驰骋 linux 进程控制了。当然有想了解新知识的可以查询学习一下，应该会比基础命令好用。</p>\n<h3 id=\"toc_13\">作业命令</h3>\n<p>使用上面的后台执行命令时可能还会遇到一些小状况：</p>\n<ul>\n<li>被我们放在后台的进程执行时间过长，而我们又忘记使用 nohup 命令，那么终端一旦断开，进程又需要被重新执行。</li>\n<li>我们直接开启了某个进程，又想在不中断进程的情况下让它让出前台终端；</li>\n</ul>\n<p>这些都要牵涉到今天的第二个模块–作业；</p>\n<p>我们在终端里运行的命令都可以理解为一个作业，有的占用前台终端，有的在后台默默执行，下面的命令就是为了调度这些作业。</p>\n<h4 id=\"toc_14\">jobs</h4>\n<p>jobs 是作业的基础命令，用它可以查看正在运行的作业的信息，其输出如下：</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c7b889e444653623033\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\njobs\r\n[1]-  Running                 php test.php &amp;\r\n[2]+  Stopped                 php test.php</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c7b889e444653623033-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e444653623033-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e444653623033-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c7b889e444653623033-1\"><span class=\"crayon-i\">jobs</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e444653623033-2\"><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">Running                 </span><span class=\"crayon-e\">php </span><span class=\"crayon-v\">test</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">php</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e444653623033-3\"><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">+</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">Stopped                 </span><span class=\"crayon-e\">php </span><span class=\"crayon-v\">test</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">php</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n\n</div>\n<p>前面<code>[ ]</code>内的数字是作业 ID，也是后面我们要操作作业的标识，然后是作业状态和命令。</p>\n<h4 id=\"toc_15\">ctrl+z</h4>\n<p><code>ctrl+z</code> 严格来说并是作业命令，它只是向当前进程发送一个 <code>SIGSTOP</code> 信号，促使进程进入暂停(stopped)状态，此状态下，进程状态会被系统保存，此进程会被放置到作业队列中去，而让出进程终端。</p>\n<p>使用它，我们可以暂停正在占用终端的进程而不停止它，从而让我们使用终端命令来操作此进程。</p>\n<h4 id=\"toc_16\">bg</h4>\n<p>bg是 <code>backgroud</code> 的缩写，顾名思义，<code>bg %id</code> 把作业放到后台进程中执行。</p>\n<p>结合 <code>ctrl+z</code> 和 <code>bg</code> 命令，我们可以解决上面提出的第一个问题，不停止地将正在占用终端的进程放到后台执行。</p>\n<h4 id=\"toc_17\">fg</h4>\n<p>fg 与 bg 相对，使用它可以把作业放到前台来执行。</p>\n<h4 id=\"toc_18\">disown</h4>\n<p>disown 用来将作业从作业列表中移除，即使它 <code>不属于</code> 会话，这样终端关闭后不再向此作业发送 <code>SIGHUP</code> 信号，以阻止终端对进程的影响。</p>\n<p>使用 disown 我们可以解决上面提出的第二个问题，不重新执行将一个没使用 nohup 命令的进程不受终端关闭影响。</p>\n<h3 id=\"toc_19\">守护进程</h3>\n<p>以上介绍的都是一些临时进程的处理，后台运行的进程的最终方法是将进程变成守护进程。</p>\n<h4 id=\"toc_20\">守护进程</h4>\n<blockquote><p>守护进程(daemon)是生存期较长的一种进程，一般在系统启动时启动，系统关闭时停止，没有控制终端，也不会输出。如我们的服务器、fpm 等进程就是以守护进程的形式存在的。</p></blockquote>\n<h4 id=\"toc_21\">创建过程</h4>\n<p>要创建一个守护进程，步骤为：</p>\n<p>必选项</p>\n<ol>\n<li><code>fork</code> 子进程，退出父进程，子进程作为孤儿进程被 init 进程收养；</li>\n<li>使用 <code>setsid</code>, 打开新会话，进程成为会话组长，正式脱离终端控制；</li>\n<li>设置信号处理（特别是子进程退出处理）；可选项：</li>\n<li>使用 <code>chdir</code> 改变进程工作目录，一般到根目录下，防止占用可卸载文件系统；</li>\n<li>用 <code>umask</code> 重设文件权限掩码，不再继承父进程的文件权限设置；</li>\n<li>关闭父进程打开的文件描述符；</li>\n</ol>\n<h4 id=\"toc_22\">代码</h4>\n<p>以下是 php 创建守护进程的伪代码，另外我的另一篇博客 <a href=\"http://www.cnblogs.com/zhenbianshu/p/5676822.html\">初探PHP多进程</a> 也稍微介绍了一些相关内容：</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c7b889e44c929853353\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$pid = pcntl_fork();\r\nif ($pid &gt; 0) {\r\n    exit; // 父进程直接退出\r\n} elseif ($pid &lt; 0) {\r\n throw_error(); // 进程创建失败\r\n}\r\n\r\nposix_setsid(); // setsid成为会话领导进程\r\nchdir($dir); // 切换目录\r\numask(0); // 重置文件权限mask\r\nclose_fd(); // 关闭父进程的文件描述符\r\npcntl_signal($signal, $func); // 注册信号处理函数\r\n\r\nwhile (true) {\r\n do_job(); // 处理进程任务\r\n pcntl_signal_dispatch(); // 分发信号处理\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c7b889e44c929853353-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e44c929853353-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e44c929853353-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e44c929853353-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e44c929853353-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e44c929853353-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e44c929853353-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e44c929853353-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e44c929853353-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e44c929853353-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e44c929853353-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e44c929853353-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e44c929853353-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e44c929853353-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e44c929853353-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7b889e44c929853353-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c7b889e44c929853353-17\">17</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c7b889e44c929853353-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">pcntl_fork</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e44c929853353-2\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e44c929853353-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">exit</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 父进程直接退出</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e44c929853353-4\"><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">elseif</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e44c929853353-5\"><span class=\"crayon-h\"> </span><span class=\"crayon-e\">throw_error</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 进程创建失败</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e44c929853353-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e44c929853353-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e44c929853353-8\"><span class=\"crayon-e\">posix_setsid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// setsid成为会话领导进程</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e44c929853353-9\"><span class=\"crayon-e\">chdir</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dir</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 切换目录</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e44c929853353-10\"><span class=\"crayon-e\">umask</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 重置文件权限mask</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e44c929853353-11\"><span class=\"crayon-e\">close_fd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 关闭父进程的文件描述符</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e44c929853353-12\"><span class=\"crayon-e\">pcntl_signal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">signal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">func</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 注册信号处理函数</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e44c929853353-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e44c929853353-14\"><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e44c929853353-15\"><span class=\"crayon-h\"> </span><span class=\"crayon-e\">do_job</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 处理进程任务</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7b889e44c929853353-16\"><span class=\"crayon-h\"> </span><span class=\"crayon-e\">pcntl_signal_dispatch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 分发信号处理</span></div><div class=\"crayon-line\" id=\"crayon-596c7b889e44c929853353-17\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0023 seconds] -->\r\n\n</div>\n<h3 id=\"toc_23\">总结</h3>\n<p>linux 是开发者的基础技能，而进程的调度更是我们常用的功能，希望读完本文的同学们能有所收获。</p>\n<p>又有大半个月没发博客了，最近鼓捣着重构代码，经常会在一个点上纠结半天，不知不觉就加了个班。而且这个是个没法精确度量工作量和目标的活儿，优化没有尽头嘛。不过由于要更多地考虑一下代码的抽象、效率和扩展，对自己也是个挑战，算是乐在其中吧~</p>\n<p>最近可能会考虑写一个守护进程和 cron 进程调度器，嗯，希望给我算到工作量里，哈哈~想写的太多了，只怨自己还不够强大。。。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111850\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111850votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111850\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 1 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "小团队管理与大团队管理", "url": "http://blog.jobbole.com/111484/", "url_object_id": "6d15dbaaf727b966d37bd068bb39aa2a", "create_date": "2017/07/17 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2014/01/7062164f8b12cab9bb7cfd7920176dc7.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 0, "tags": "IT技术,团队,管理,职场", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/liulun/p/7159705.html\">liulun</a>   </div><p>我们公司和大部分传统软件公司一样，随着业务的发展和新领域的开拓，公司的管理风格越来越像华为，这是不是最佳的演进路线，我觉得值得探讨，以下是我的思考，希望跟大家讨论。</p>\n<h2>一个问题</h2>\n<p>前段时间跟一个创业的朋友聊天，说起他们最近在做的一个项目，这是一个教育行业的管理系统，业务非常复杂，牵涉到的决策人，需要对接的系统也非常多，最后问到他们做了多久完成这个项目，朋友告诉我2个多月，6个人，其中还括一个美工，一个项目经理；剩下的都是开发人员，没有测试，没有前端开发；朋友问我，如果这个项目给你们做，你们需要做多久；我想了想说，这个项目如果交给我们做，顺利的话，至少要半年。</p>\n<p><strong>为什么差异这么大呢？</strong></p>\n<p>我们一个一个环节来分析一下，朋友的团队跟客户沟通需求的时候，功能性需求只用一个原型草图，非功能性需求就一个excel表格；如果我们公司做的话，至少要做需求调研报告，需求规格说明书；这个阶段的负责人甚至不会画原型，要到设计阶段才有人能画原型；</p>\n<p>到设计阶段，朋友的团队几乎没有什么技术设计，业务按模块给开发人员分一下，各人设计好自己的数据库模型，汇总起来给项目经理看一下，没问题就进入开发阶段了，界面设计花的时间比较久，跟客户反复确认了两三次；如果我们公司做的话，至少要产出原型设计（低保真描述功能的设计稿，高保真描述界面的设计稿），概要设计，详细设计（技术设计、架构设计、网络设计）等等，而且几乎每个设计都要经历评审环节，组织评审就要协调人员，要等大家都有时间的时候再做评审，这都是损耗；</p>\n<p>到开发测试阶段，朋友的团队几个开发人员从前端到后端，从开发到测试，都是这几个人做；如果我们公司来做的话，后台开发人员不做前端（不做复杂的前端页面，普通的前端工作还是要做的），质量保证要测试人员保证，测试把BUG提交到BUG管理工具，开发再去BUG管理工具查阅属于自己的BUG，修改完成之后，再关闭BUG，测试再做回归测试；这些流程看起来琐碎，但却损耗了大量的资源；</p>\n<p>验收上线阶段，朋友的团队所有人都铺在项目现场，有问题，当场解决；我们公司要收集问题，让测试工程师验证问题，再由开发解决，解决之后再验证，再发布版本给现场的实施工程师，实施工程师再更新上线，给客户验证。</p>\n<p>这个问题很明显：规模大的团队和规模小的团队工作方式的差异非常大，组织资源的方式也有明显的区别；我们抽象一下，把这两种模式称为：大军团模式和小编队模式，再看这两种模式的具体区别：</p>\n<h2>大军团模式</h2>\n<p>之前有一种理论，要完成一项超大规模的工程，往往需要成百上千人，有组织有纪律的协作才能完成；</p>\n<p>这样就需要制定一系列的规章、制度、流程、KPI来约束这些人，</p>\n<p>把这些人变成一个庞大机器的零部件，保证结果的达成，避免产生差错；</p>\n<p>这是一种非常常见的大组织的运作模式，</p>\n<p>不但在软件行业普遍存在（华为、惠普、IBM），</p>\n<p>在造桥、修路、航天、汽车等工业领域也十分常见，</p>\n<p>这种模式非常“稳”，他能保证目标的稳定达成，并且能使目标达成的过程清晰、可控。</p>\n<h2>小编队模式</h2>\n<p>第三次工业革命（信息技术革命）以来，小编队的运作模式发展越来越好，我司IPCC产品的核心：开源语音通信软件FreeSwitch，核心开发者也不过6个人；（说这个开源软件养活了半个呼叫中心行业的开发者都不足为过）； 这种例子在软件行业不胜枚举，比如：git源码管理系统、linux操作系统、JavaScript语言等等。</p>\n<p>甚至有些产品是一个人在短时间内完成的，这就是英雄；</p>\n<p>有很多大规模的公司，比如谷歌、Facebook、国内的百度也在内部推行小编队的运作模式；</p>\n<p>这种模式非常“快”，他能保证目标的快速达成，并且能使目标达成的效率非常高；</p>\n<h2>大军团的不足</h2>\n<h3>效率低下</h3>\n<p>大军团强调集体的智慧，</p>\n<p>个体想推动一项事务向正确的方向推进十分困难，</p>\n<p>个体的决策往往会受到质疑或排斥</p>\n<p>诸如：流程、规范、计划、考核、文档、评审、调研等词</p>\n<p>都是为了保证目标的稳定达成所衍生出来的东西，</p>\n<p>它们都是团队快速前进的束缚和绊脚石！</p>\n<h3>阻碍创新</h3>\n<p>大军团鼓励墨守成规、照章办事的氛围，</p>\n<p>大军团强调分工，把员工看作螺丝钉，希望员工各司其职，不是职责范围内的事务尽量不要碰，因为你不专业，你可能会出错，大军团最害怕出错；</p>\n<p>只有这样才能使目标达成的过程清晰可控；</p>\n<p>然而创新却需要不拘一格的思想，需要独立自主的工作空间，需要组织具备容错性，这和大军团的工作方式是格格不入的；</p>\n<h3>资源浪费</h3>\n<p>为了使目标的达成过程清晰可控；</p>\n<p>大军团制定了很多流程和制度来约束个体的行为；</p>\n<p>他把每一项事务都拆分成很多环节；</p>\n<p>又给每个环节制定了很多关卡；</p>\n<p>而且每个环节都要留下数据，使过程有迹可寻；</p>\n<p>因为大军团要做到每项事务都可以复盘，产生问题之后要可以追溯问题根源；</p>\n<p>这样确实保证了目标达成过程的清晰可控，但却浪费了大量的资源；</p>\n<h2>小编队的优势</h2>\n<h3>小编队也适合做大项目</h3>\n<p>有很多很庞大复杂的软件系统，都是以小编队的方式完成的；</p>\n<p>比如操作系统linux，大数据分析系统hadoop，我们这个行业的freeSwitch等；</p>\n<p>如果一个项目大到一定的规模，需要不同角色的人参与，那么也应该是有更多的小编队来做这一块事情；甚至更极端的做法，就是一个项目在建设之初，就考虑到会有很多小编队或个人参与到项目建设过程中，预留了多人、多团队协作的支撑工具，比如说nodejs的NPM，go语言和rust语言也有相应的规划；</p>\n<h3>小编队有很强的执行力</h3>\n<p>小编队不会说这个事情需要做个评审；</p>\n<p>小编队不会说这个事情安排的资源不够，需要协调更多的资源；</p>\n<p>小编队会把这个事情当成自己的事情，不会像大军团一样，把这个事情当成大家的事情来对待；</p>\n<p>我们来看个图：</p>\n<p>（图片遗失，暂不补充）</p>\n<h3>小编队有很强的创新力</h3>\n<p>软件行业不像建筑行业，90%以上的优秀软件一开始都是个人或者小编队创造出来的；很少见一个优秀软件是一个大规模的组织创造出来的。</p>\n<h2>一个案例</h2>\n<p>张小龙曾经说过一段话：</p>\n<p>好的工具就不应该黏人，应该帮助用户非常高效率完成任务，而不是说用完了还要拿到手里玩一会儿、多用一会儿，那不是一个很高效的表现。但是对这样的一些想法的话，我特别希望它能够根植到大家意识里，时刻想一下什么是我们做的对用户有价值的事情；</p>\n<p>假设你是马化腾，你会怎么给张小龙定KPI呢？考核微信的日活吗？……</p>\n<p>无论你制定什么KPI，都会导致团队去围绕着那个KPI去完成任务；</p>\n<p>KPI考核准则里有一项原则就是“可度量”，当你提出一项纯数据目标的时候，团队就会围绕着那个数字去工作。而偏离了做好产品的初心。</p>\n<p>一个团队工作的目的不应该是完成KPI，工作的目的应该是做好产品，完成KPI只不过是做好产品这件事情的副产物，就像一个人好好工作的目的不应该是为了赚钱，他好好工作的副产物是赚了很多钱；</p>\n<p>所以你制定了一系列的kpi考核制度，只能导致员工工作的动机更不纯粹。</p>\n<h2>最后</h2>\n<p>一个组织只要发展良好，总是会吸引更多的资源，所以组织规模的扩大是无可避免的，但如果一个组织规模已经超过500人了，那么你应该把他看作是50~100个小团队来对待，而不是把他当作一个500人的大团队来对待；</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111484\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111484votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111484\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "DB 分库分表（1）：拆分实施策略和示例演示", "url": "http://blog.jobbole.com/111860/", "url_object_id": "b299e9cd2dda0c69c7c1c010f60074f4", "create_date": "2017/07/15 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2012/03/database-logo.png"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "IT技术,分库分表,数据库", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.csdn.net/bluishglc/article/details/7696085\">Laurence的技术博客</a>   </div><p><strong>第一部分：实施策略</strong></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4d96fb1fcbf89962346119fdae9e9584.jpg\" alt=\"\"></p>\n<p style=\"text-align: center\"><strong>图1.数据库分库分表(sharding)实施策略图解(<a href=\"http://ww1.sinaimg.cn/large/67a6a651gw1ducq4lmzyzj.jpg\">点击查看大图</a>)</strong></p>\n<p><strong>1.准备阶段</strong></p>\n<p>对数据库进行分库分表(Sharding化)前，需要开发人员充分了解系统业务逻辑和数据库schema.一个好的建议是绘制一张数据库ER图或领域模型图，以这类图为基础划分shard,直观易行，可以确保开发人员始终保持清醒思路。对于是选择数据库ER图还是领域模型图要根据项目自身情况进行选择。如果项目使用数据驱动的开发方式，团队以数据库ER图作为业务交流的基础，则自然会选择数据库ER图，如果项目使用的是领域驱动的开发方式，并通过OR-Mapping构建了一个良好的领域模型，那么领域模型图无疑是最好的选择。就我个人来说，更加倾向使用领域模型图，因为进行切分时更多的是以业务为依据进行分析判断，领域模型无疑更加清晰和直观。</p>\n<p><strong>2.分析阶段</strong></p>\n<p>1. 垂直切分<br>\n垂直切分的依据原则是：将业务紧密，表间关联密切的表划分在一起，例如同一模块的表。结合已经准备好的数据库ER图或领域模型图，仿照活动图中的泳道概念，一个泳道代表一个shard，把所有表格划分到不同的泳道中。下面的分析示例会展示这种做法。当然，你也可以在打印出的ER图或模型图上直接用铅笔圈，一切取决于你自己的喜好。</p>\n<p><strong>2. 水平切分</strong><br>\n垂直切分后，需要对shard内表格的数据量和增速进一步分析，以确定是否需要进行水平切分。</p>\n<p><strong>2.1</strong>若划分到一起的表格数据增长缓慢，在产品上线后可遇见的足够长的时期内均可以由单一数据库承载，则不需要进行水平切分，所有表格驻留同一shard,所有表间关联关系会得到最大限度的保留，同时保证了书写SQL的自由度，不易受join、group by、order by等子句限制。</p>\n<p><strong>2.2</strong> 若划分到一起的表格数据量巨大，增速迅猛，需要进一步进行水平分割。进一步的水平分割就这样进行：</p>\n<p><strong>2.2.1</strong>.结合业务逻辑和表间关系，将当前shard划分成多个更小的shard,通常情况下，这些更小的shard每一个都只包含一个主表（将以该表ID进行散列的表）和多个与其关联或间接关联的次表。这种一个shard一张主表多张次表的状况是水平切分的必然结果。这样切分下来，shard数量就会迅速增多。如果每一个shard代表一个独立的数据库，那么管理和维护数据库将会非常麻烦，而且这些小shard往往只有两三张表，为此而建立一个新库，利用率并不高，因此，在水平切分完成后可再进行一次“反向的Merge”,即：将业务上相近，并且具有相近数据增长速率（主表数据量在同一数量级上）的两个或多个shard放到同一个数据库上，在逻辑上它们依然是独立的shard，有各自的主表，并依据各自主表的ID进行散列，不同的只是它们的散列取模（即节点数量）必需是一致的。这样，每个数据库结点上的表格数量就相对平均了。</p>\n<p><strong>2.2.2. </strong>所有表格均划分到合适的shard之后，所有跨越shard的表间关联都必须打断，在书写sql时，跨shard的join、group by、order by都将被禁止，需要在应用程序层面协调解决这些问题。</p>\n<p>特别想提一点：经水平切分后，shard的粒度往往要比只做垂直切割的粒度要小，原单一垂直shard会被细分为一到多个以一个主表为中心关联或间接关联多个次表的shard，此时的shard粒度与领域驱动设计中的“聚合”概念不谋而合，甚至可以说是完全一致，每个shard的主表正是一个聚合中的聚合根！</p>\n<p><strong>3.实施阶段</strong><br>\n如果项目在开发伊始就决定进行分库分表，则严格按照分析设计方案推进即可。如果是在中期架构演进中实施，除搭建实现sharding逻辑的基础设施外(关于该话题会在下篇文章中进行阐述)，还需要对原有SQL逐一过滤分析，修改那些因为sharding而受到影响的sql.</p>\n<p><strong>第二部分：示例演示</strong></p>\n<p>本文选择一个人尽皆知的应用：jpetstore来演示如何进行分库分表(sharding)在分析阶段的工作。由于一些个人原因，演示使用的jpetstore来自原ibatis官方的一个Demo版本，SVN地址为：http://mybatis.googlecode.com/svn/tags/java_release_2.3.4-726/jpetstore-5。关于jpetstore的业务逻辑这里不再介绍，这是一个非常简单的电商系统原型，其领域模型如下图：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bc2711a69bd224bbf973fa03cbf4e5a9.jpg\" alt=\"\" width=\"888\" height=\"371\"></p>\n<p style=\"text-align: center\"><strong>图2. jpetstore领域模型</strong></p>\n<p>由于系统较简单，我们很容易从模型上看出，其主要由三个模块组成：用户，产品和订单。那么垂直切分的方案也就出来了。接下来看水平切分，如果我们从一个实际的宠物店出发考虑，可能出现数据激增的单表应该是Account和Order,因此这两张表需要进行水平切分。对于Product模块来说，如果是一个实际的系统，Product和Item的数量都不会很大，因此只做垂直切分就足够了，也就是（Product，Category，Item，Iventory，Supplier）五张表在一个数据库结点上（没有水平切分，不会存在两个以上的数据库结点）。<strong>但是作为一个演示，我们假设产品模块也有大量的数据需要我们做水平切分</strong>，那么分析来看，这个模块要拆分出两个shard:一个是（Product（主），Category），另一个是（Item（主），Iventory，Supplier），<strong>同时，我们认为：这两个shard在数据增速上应该是相近的，且在业务上也很紧密</strong>，那么我们可以<strong>把这两个shard放在同一个数据库节点上，Item和Product数据在散列时取一样的模</strong>。根据前文介绍的图纸绘制方法，我们得到下面这张sharding示意图：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/883e27937895e73700b2f78bb4106a31.jpg\" alt=\"\" width=\"867\" height=\"365\"></p>\n<p style=\"text-align: center\"><strong>图3. jpetstore sharding示意图</strong></p>\n<p>对于这张图再说明几点：<br>\n<strong>1.使用泳道表示物理shard（一个数据库结点）</strong></p>\n<p><strong>2.若<strong>垂直切分出的shard进行了进一步的水平切分，但公用一个物理shard的话，则用虚线框住，表示其在逻辑上是一个独立的shard。</strong><br>\n</strong></p>\n<p><strong>3.深色实体表示主表</strong></p>\n<p><strong>4.X表示需要打断的表间关联</strong></p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111860\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111860votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111860\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "记一次 MySQL 主从复制延迟的踩坑", "url": "http://blog.jobbole.com/111853/", "url_object_id": "df601b45a5e7f03fd66ac73fba2d5733", "create_date": "2017/07/16 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2016/04/6813e861d7765d2cf8c1f7f313083944.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 0, "tags": "IT技术,MySQL,数据库", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文作者： <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/hector\">hoohack</a> 。未经作者许可，禁止转载！<br>欢迎加入伯乐在线 <a href=\"http://blog.jobbole.com/99322\" target=\"_blank\">专栏作者</a>。</div><p>最近开发中遇到的一个 MySQL 主从延迟的坑，记录并总结，避免再次犯同样的错误。</p>\n<h3>情景</h3>\n<p>一个活动信息需要审批，审批之后才能生效。因为之后活动要编辑，编辑后也可能触发审批，审批中展示的是编辑前的活动内容，考虑到字段比较多，也要保存审批活动的内容，因此设计采用了一张临时表，审批中的活动写进审批表(activity_tmp)，审批通过之后才把真正的活动内容写进活动表(activity)。表的简要设计如下，这里将活动内容字段合并为content展示：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596be297ace84787435170\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nactivity_tmp（）\r\nid\r\nstatus // 审批状态    \r\ncontent //  审批阶段提交的活动内容\r\n\r\nactivity\r\nid\r\ncontent // 审批通过后真正展示的活动内容</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596be297ace84787435170-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be297ace84787435170-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596be297ace84787435170-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be297ace84787435170-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596be297ace84787435170-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be297ace84787435170-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596be297ace84787435170-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be297ace84787435170-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596be297ace84787435170-1\"><span class=\"crayon-v\">activity</span><span class=\"crayon-sy\">_</span>tmp（）</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be297ace84787435170-2\"><span class=\"crayon-e\">id</span></div><div class=\"crayon-line\" id=\"crayon-596be297ace84787435170-3\"><span class=\"crayon-v\">status</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 审批状态    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be297ace84787435170-4\"><span class=\"crayon-v\">content</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//  审批阶段提交的活动内容</span></div><div class=\"crayon-line\" id=\"crayon-596be297ace84787435170-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be297ace84787435170-6\"><span class=\"crayon-e\">activity</span></div><div class=\"crayon-line\" id=\"crayon-596be297ace84787435170-7\"><span class=\"crayon-e\">id</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be297ace84787435170-8\"><span class=\"crayon-v\">content</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 审批通过后真正展示的活动内容</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p></p>\n<h3>遇到的问题</h3>\n<p>当时是有编辑触发审批的情况，发现审批通过之后活动内容是空的，于是开始追查问题的原因。这里说一句，当程序出问题的时候，95%都是代码的问题，先不要去怀疑环境出问题。好好的查日志，然后看看你的代码吧。</p>\n<h3>追查问题回溯</h3>\n<p>1、查activity_tmp表，发现当时提交审批的活动内容是正常的，而且状态也更新为审批通过了，怀疑是写入activity表失败 2、查activity表，发现审批后的内容确实没有写入，怀疑是代码问题 3、查看代码，代码逻辑没看出问题，怀疑数据库操作失败，查看日志 4、日志显示，有一句insert语句的活动内容为空，活动内容来自上一个mysql执行的是select语句，把该select语句拿出来放到线上的备库查询，发现活动内容是存在的。运行时查询为空，执行完毕后查询时内容存在，初步怀疑是主从延迟问题。 5、报错只是部分失败，确定是主从延迟的问题。</p>\n<h3>当时的问题代码</h3>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596be297ace96717800302\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$intStatus = $arrInput[‘status’];\r\n$this-&gt;objActTmp-&gt;updateInfoByAId($intActId, $intStatus);\r\n// 更新后，马上查\r\n$arrActContent = $this-&gt;objActTmp-&gt;getActByStatus($intStatus);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596be297ace96717800302-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be297ace96717800302-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596be297ace96717800302-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be297ace96717800302-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596be297ace96717800302-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">intStatus</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">arrInput</span><span class=\"crayon-sy\">[</span>‘<span class=\"crayon-i\">status</span>’<span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be297ace96717800302-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">objActTmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">updateInfoByAId</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">intActId</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">intStatus</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be297ace96717800302-3\"><span class=\"crayon-c\">// 更新后，马上查</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be297ace96717800302-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">arrActContent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">objActTmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getActByStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">intStatus</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p>这就是主从延迟出现的地方，update后，马上get，这是主从复制架构上开发的一个大忌。</p>\n<h3>解决方案</h3>\n<p>这类问题的解决方案有两种：</p>\n<ul>\n<li>修改代码逻辑</li>\n<li>修改系统架构</li>\n</ul>\n<p>对于修改代码逻辑，鄙人有两点见解：</p>\n<ul>\n<li>如果第二步获取的数据不需要第一步更新的status字段，那就先读，然后再更新</li>\n<li>如果第二步获取的数据需要依赖第一步的status字段，那就在读出来的时候先判断是否为空，如果是空的，报错，下一次重试。</li>\n</ul>\n<h3>总结</h3>\n<p>其实之前也听到过这样的例子，但是由于没有亲身经历，所以只保留了一种理论上的记忆，实际上印象不深，经历了这么一次踩坑后，印象特别深刻，现在看到别人写这样的代码也能马上发现并指出。还是自己亲身去踩坑印象最深。</p>\n<p>日志很重要，详细的日志更重要。日志要记录有用的信息，方便追查问题的时候去追溯问题的本质原因。我觉得日志就应该尽量做成飞机中的黑匣子，帮助我们保存“事故“发生时的所有相关信息。</p>\n<article><!-- JiaThis Button END --></article>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我写出更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏作者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我写出更多好文章，谢谢！</h4>\n                <p>任选一种支付方式</p>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/05/7aa70eaa311d5a5dec82ca0d49624741.png\">\n            \n                            <img src=\"http://jbcdn2.b0.upaiyun.com/2016/05/1a4b335ec981d013f4002205a23fedd0.jpg\">\n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111853\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111853votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111853\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/hector\">hoohack</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/hector\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/df22a501f19a5bba1b3331e2001f8ec2.jpeg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            一个正在努力的菜鸟        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/hector\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/hector/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/hector/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 25</a> · <a title=\"我的网站\" target=\"_blank\" href=\"http://www.hoohack.me\"><i class=\"fa fa-link\"></i></a> <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/u/2388493434?is_all=1\"><i class=\"fa fa-weibo\"></i></a> <a title=\"QQ：914099943\" target=\"_blank\" href=\"#\"><i class=\"fa fa-qq\"></i></a> <a title=\"个人微信：hhq8307231\" target=\"_blank\" href=\"#\"><i class=\"fa fa-weixin\"></i></a> <a title=\"GitHub主页\" target=\"_blank\" href=\"https://github.com/hoohack\"><i class=\"fa fa-github\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "DB 分库分表（2）：全局主键生成策略", "url": "http://blog.jobbole.com/111866/", "url_object_id": "d374f2fc6bd013a58513687fe2fe4e97", "create_date": "2017/07/16 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/03/4bae6998d00f180d42c7da716e3d0bb2.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 0, "tags": "IT技术,分库分表,数据库", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.csdn.net/bluishglc/article/details/7710738\">Laurence的技术博客</a>   </div><p>本文将主要介绍一些常见的全局主键生成策略，然后重点介绍flickr使用的一种非常优秀的全局主键生成方案。关于分库分表(sharding)的拆分策略和实施细则，请参考该系列的前一篇文章：<a href=\"http://blog.jobbole.com/111860/\" target=\"_blank\">DB 分库分表（1）：拆分实施策略和示例演示</a></p>\n<p><strong>第一部分：一些常见的主键生成策略</strong></p>\n<p>一旦<a class=\"replace_word\" title=\"MySQL知识库\" href=\"http://lib.csdn.net/base/14\" target=\"_blank\">数据库</a>被切分到多个物理结点上，我们将不能再依赖数据库自身的主键生成机制。一方面，某个分区数据库自生成的ID无法保证在全局上是唯一的；另一方面，应用程序在插入数据之前需要先获得ID,以便进行SQL路由。目前几种可行的主键生成策略有：<br>\n1. UUID：使用UUID作主键是最简单的方案，但是缺点也是非常明显的。由于UUID非常的长，除占用大量存储空间外，最主要的问题是在索引上，在建立索引和基于索引进行查询时都存在性能问题。<br>\n2. 结合数据库维护一个Sequence表：此方案的思路也很简单，在数据库中建立一个Sequence表，表的结构类似于：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd6a3dfdd9258231390\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nCREATE TABLE `SEQUENCE` (  \r\n    `tablename` varchar(30) NOT NULL,  \r\n    `nextid` bigint(20) NOT NULL,  \r\n    PRIMARY KEY (`tablename`)  \r\n) ENGINE=InnoDB</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd6a3dfdd9258231390-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd6a3dfdd9258231390-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd6a3dfdd9258231390-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd6a3dfdd9258231390-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd6a3dfdd9258231390-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd6a3dfdd9258231390-1\"><span class=\"crayon-e\">CREATE </span><span class=\"crayon-i\">TABLE</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">SEQUENCE</span><span class=\"crayon-sy\">`</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd6a3dfdd9258231390-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">tablename</span><span class=\"crayon-sy\">`</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">varchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">30</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596bd6a3dfdd9258231390-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">nextid</span><span class=\"crayon-sy\">`</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bigint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">20</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd6a3dfdd9258231390-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">PRIMARY </span><span class=\"crayon-e\">KEY</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">tablename</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-596bd6a3dfdd9258231390-5\"><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ENGINE</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">InnoDB</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0015 seconds] -->\r\n<p>每当需要为某个表的新纪录生成ID时就从Sequence表中取出对应表的nextid,并将nextid的值加1后更新到数据库中以备下次使用。此方案也较简单，但缺点同样明显：由于所有插入任何都需要访问该表，该表很容易成为系统性能瓶颈，同时它也存在单点问题，一旦该表数据库失效，整个应用程序将无法工作。有人提出使用Master-Slave进行主从同步，但这也只能解决单点问题，并不能解决读写比为1:1的访问压力问题。</p>\n<p>除此之外，还有一些方案，像对每个数据库结点分区段划分ID,以及网上的一些ID生成算法，因为缺少可操作性和实践检验，本文并不推荐。实际上，接下来，我们要介绍的是Fickr使用的一种主键生成方案，这个方案是目前我所知道的最优秀的一个方案，并且经受了实践的检验，可以为大多数应用系统所借鉴。</p>\n<p><strong>第二部分：一种极为优秀的主键生成策略</strong></p>\n<p>flickr开发团队在2010年撰文介绍了flickr使用的一种主键生成测策略，同时表示该方案在flickr上的实际运行效果也非常令人满意，原文连接：<a href=\"http://code.flickr.com/blog/2010/02/08/ticket-servers-distributed-unique-primary-keys-on-the-cheap/\" target=\"_blank\">Ticket Servers: Distributed Unique Primary Keys on the Cheap </a>这个方案是我目前知道的最好的方案，它与一般Sequence表方案有些类似，但却很好地解决了性能瓶颈和单点问题，是一种非常可靠而高效的全局主键生成方案。</p>\n<p align=\"center\"><img src=\"http://ww1.sinaimg.cn/large/67a6a651gw1dujgqcx9ncj.jpg\" alt=\"\"></p>\n<p align=\"center\"><strong>图1. flickr采用的sharding主键生成方案示意图</strong>(<a href=\"http://ww1.sinaimg.cn/large/67a6a651gw1dujgqcx9ncj.jpg\" target=\"_blank\">点击查看大图</a>)</p>\n<p>flickr这一方案的整体思想是：建立两台以上的数据库ID生成服务器，每个服务器都有一张记录各表当前ID的Sequence表，但是Sequence中ID增长的步长是服务器的数量，起始值依次错开，这样相当于把ID的生成散列到了每个服务器节点上。例如：如果我们设置两台数据库ID生成服务器，那么就让一台的Sequence表的ID起始值为1,每次增长步长为2,另一台的Sequence表的ID起始值为2,每次增长步长也为2，那么结果就是奇数的ID都将从第一台服务器上生成，偶数的ID都从第二台服务器上生成，这样就将生成ID的压力均匀分散到两台服务器上，同时配合应用程序的控制，当一个服务器失效后，系统能自动切换到另一个服务器上获取ID，从而保证了系统的容错。</p>\n<p>关于这个方案，有几点细节这里再说明一下：</p>\n<p>1. flickr的数据库ID生成服务器是专用服务器，服务器上只有一个数据库，数据库中表都是用于生成Sequence的，这也是因为auto-increment-offset和auto-increment-increment这两个数据库变量是数据库实例级别的变量。<br>\n2. flickr的方案中表格中的stub字段只是一<code>个char(1) NOT NULL存根字段，并非表名，因此，一般来说，一个Sequence表只有一条纪录，可以同时为多张表生成ID，如果需要表的ID是有连续的，需要为该表单独建立<code>Sequence表</code>。</code></p>\n<p>3. 方案使用了<a class=\"replace_word\" title=\"MySQL知识库\" href=\"http://lib.csdn.net/base/14\" target=\"_blank\">MySQL</a>的LAST_INSERT_ID()函数，这也决定了Sequence表只能有一条记录。<br>\n4. 使用REPLACE INTO插入数据，这是很讨巧的作法，主要是希望利用mysql自身的机制生成ID,不仅是因为这样简单，更是因为我们需要ID按照我们设定的方式(初值和步长)来生成。</p>\n<p>5. SELECT LAST_INSERT_ID()必须要于REPLACE INTO语句在同一个数据库连接下才能得到刚刚插入的新ID，否则返回的值总是0<br>\n6. 该方案中Sequence表使用的是<strong>MyISAM</strong>引擎，以获取更高的性能，注意：MyISAM引擎使用的是表级别的锁，<strong>MyISAM对表的读写是串行的</strong>，因此不必担心在并发时两次读取会得到同一个ID(另外，应该程序也不需要同步，每个请求的线程都会得到一个新的connection,不存在需要同步的共享资源)。经过实际对比测试，使用一样的Sequence表进行ID生成，MyISAM引擎要比InnoDB表现高出很多！</p>\n<p>7. 可使用纯JDBC实现对Sequence表的操作，以便获得更高的效率，实验表明，即使只使用<a class=\"replace_word\" title=\"Java EE知识库\" href=\"http://lib.csdn.net/base/17\" target=\"_blank\">spring</a> JDBC性能也不及纯JDBC来得快！</p>\n<p>实现该方案，应用程序同样需要做一些处理，主要是两方面的工作：<br>\n1. 自动均衡数据库ID生成服务器的访问<br>\n2. 确保在某个数据库ID生成服务器失效的情况下，能将请求转发到其他服务器上执行。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111866\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111866votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111866\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "MySQL 主从复制原理探索", "url": "http://blog.jobbole.com/111865/", "url_object_id": "3a27b353b7aca708e99d62dc9d86734b", "create_date": "2017/07/16 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2016/04/582271a95a4505dff985ffc837868976.png"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 0, "tags": "IT技术,MySQL,主从复制,数据库", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文作者： <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/hector\">hoohack</a> 。未经作者许可，禁止转载！<br>欢迎加入伯乐在线 <a href=\"http://blog.jobbole.com/99322\" target=\"_blank\">专栏作者</a>。</div><p><a href=\"http://blog.jobbole.com/111853/\" target=\"_blank\">上一篇文章</a>里面，讲到了遇到mysql主从延迟的坑，对于这次的坑多说两句，以前也看过这样的例子，也知道不能够写完之后马上更新，但是真正开发的时候还是没有注意到这一点，道理大家都懂，但是还是会犯错，只有等到自己亲生体验到该错误之后，才真正的掌握到该道理。</p>\n<p>经历过一次mysql主从延迟之后，就开始思考，主从复制是什么东西？它是怎么实现的呢？它的原理是什么？于是乎就开始查阅资料、文章，现将自己理解到的内容总结在此，加深印象。</p>\n<h3>为什么要做主从复制？</h3>\n<p>1、在业务复杂的系统中，有这么一个情景，有一句sql语句需要锁表，导致暂时不能使用读的服务，那么就很影响运行中的业务，使用主从复制，让主库负责写，从库负责读，这样，即使主库出现了锁表的情景，通过读从库也可以保证业务的正常运作。</p>\n<p>2、做数据的热备</p>\n<p>3、架构的扩展。业务量越来越大，I/O访问频率过高，单机无法满足，此时做多库的存储，降低磁盘I/O访问的频率，提高单个机器的I/O性能。</p>\n<h3>mysql主从复制的原理是什么？</h3>\n<p>binlog: binary log，主库中保存所有更新事件日志的二进制文件。</p>\n<p>主从复制的基础是主库记录数据库的所有变更记录到binlog。binlog是数据库服务器启动的那一刻起，保存所有修改数据库结构或内容的一个文件。</p>\n<p>mysql主从复制是一个异步的复制过程，主库发送更新事件到从库，从库读取更新记录，并执行更新记录，使得从库的内容与主库保持一致。</p>\n<p>在主库里，只要有更新事件出现，就会被依次地写入到binlog里面，之后会推到从库中作为从库进行复制的数据源。</p>\n<p><strong>binlog输出线程。</strong>每当有从库连接到主库的时候，主库都会创建一个线程然后发送binlog内容到从库。 对于每一个即将发送给从库的sql事件，binlog输出线程会将其锁住。一旦该事件被线程读取完之后，该锁会被释放，即使在该事件完全发送到从库的时候，该锁也会被释放。</p>\n<p>在从库里，当复制开始的时候，从库就会创建两个线程进行处理：</p>\n<p><strong>从库I/O线程。</strong>当START SLAVE语句在从库开始执行之后，从库创建一个I/O线程，该线程连接到主库并请求主库发送binlog里面的更新记录到从库上。 从库I/O线程读取主库的binlog输出线程发送的更新并拷贝这些更新到本地文件，其中包括relay log文件。</p>\n<p><strong>从库的SQL线程。</strong>从库创建一个SQL线程，这个线程读取从库I/O线程写到relay log的更新事件并执行。</p>\n<p>可以知道，对于每一个主从复制的连接，都有三个线程。拥有多个从库的主库为每一个连接到主库的从库创建一个binlog输出线程，每一个从库都有它自己的I/O线程和SQL线程。</p>\n<p>从库通过创建两个独立的线程，使得在进行复制时，从库的读和写进行了分离。因此，即使负责执行的线程运行较慢，负责读取更新语句的线程并不会因此变得缓慢。比如说，如果从库有一段时间没运行了，当它在此启动的时候，尽管它的SQL线程执行比较慢，它的I/O线程可以快速地从主库里读取所有的binlog内容。这样一来，即使从库在SQL线程执行完所有读取到的语句前停止运行了，I/O线程也至少完全读取了所有的内容，并将其安全地备份在从库本地的relay log，随时准备在从库下一次启动的时候执行语句。</p>\n<h3>查看主从复制的状态</h3>\n<p>当主从复制正在进行中时，如果想查看从库两个线程运行状态，可以通过执行在从库里执行”show slave status\\G”语句，以下的字段可以给你想要的信息：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c77c94eade936897675\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nMaster_Log_File — 上一个从主库拷贝过来的binlog文件\r\nRead_Master_Log_Pos — 主库的binlog文件被拷贝到从库的relay log中的位置\r\nRelay_Master_Log_File — SQL线程当前处理中的relay log文件\r\nExec_Master_Log_Pos — 当前binlog文件正在被执行的语句的位置</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c77c94eade936897675-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c77c94eade936897675-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c77c94eade936897675-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c77c94eade936897675-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c77c94eade936897675-1\"><span class=\"crayon-v\">Master_Log</span><span class=\"crayon-sy\">_</span>File<span class=\"crayon-h\"> </span>—<span class=\"crayon-h\"> </span>上一个从主库拷贝过来的<span class=\"crayon-i\">binlog</span>文件</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c77c94eade936897675-2\"><span class=\"crayon-v\">Read_Master_Log</span><span class=\"crayon-sy\">_</span>Pos<span class=\"crayon-h\"> </span>—<span class=\"crayon-h\"> </span>主库的<span class=\"crayon-i\">binlog</span>文件被拷贝到从库的<span class=\"crayon-e\">relay </span><span class=\"crayon-i\">log</span>中的位置</div><div class=\"crayon-line\" id=\"crayon-596c77c94eade936897675-3\"><span class=\"crayon-v\">Relay_Master_Log</span><span class=\"crayon-sy\">_</span>File<span class=\"crayon-h\"> </span>—<span class=\"crayon-h\"> </span><span class=\"crayon-i\">SQL</span>线程当前处理中的<span class=\"crayon-e\">relay </span><span class=\"crayon-i\">log</span>文件</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c77c94eade936897675-4\"><span class=\"crayon-v\">Exec_Master_Log</span><span class=\"crayon-sy\">_</span>Pos<span class=\"crayon-h\"> </span>—<span class=\"crayon-h\"> </span>当前<span class=\"crayon-i\">binlog</span>文件正在被执行的语句的位置</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p>整个主从复制的流程可以通过以下图示理解：</p>\n<p><img src=\"http://7u2eqw.com1.z0.glb.clouddn.com/DB%20replication.png\" alt=\"DB Replication\"></p>\n<ul>\n<li>步骤一：主库db的更新事件(update、insert、delete)被写到binlog</li>\n<li>步骤二：从库发起连接，连接到主库</li>\n<li>步骤三：此时主库创建一个binlog dump thread，把binlog的内容发送到从库</li>\n<li>步骤四：从库启动之后，创建一个I/O线程，读取主库传过来的binlog内容并写入到relay log</li>\n<li>步骤五：还会创建一个SQL线程，从relay log里面读取内容，从<strong>Exec_Master_Log_Pos</strong>位置开始执行读取到的更新事件，将更新内容写入到slave的db</li>\n</ul>\n<p class=\"lang:default decode:true brush: default; gutter: true\"><code>注：上面的解释是解释每一步做了什么，整个mysql主从复制是异步的，不是按照上面的步骤执行的。 </code></p>\n<h3>其他</h3>\n<p>关于主从复制架构的搭建，可以参考网上更多的文档，文笔有限，不做更多的介绍。</p>\n<p>作为一名开发，这些基础的mysql知识还是需要多多学习。</p>\n<h3>参考资料</h3>\n<ul>\n<li><a href=\"http://dbadiaries.com/what-is-mysql-replication-and-how-does-it-work\">What is MySQL Replication and How Does It Work?</a></li>\n<li><a href=\"https://dev.mysql.com/doc/refman/5.6/en/replication-implementation-details.html\">Replication Implementation Details</a></li>\n</ul>\n<p>原创文章，文笔有限，才疏学浅，文中若有不正之处，万望告知。</p>\n<p><!-- JiaThis Button END --></p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我写出更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏作者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我写出更多好文章，谢谢！</h4>\n                <p>任选一种支付方式</p>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/05/7aa70eaa311d5a5dec82ca0d49624741.png\">\n            \n                            <img src=\"http://jbcdn2.b0.upaiyun.com/2016/05/1a4b335ec981d013f4002205a23fedd0.jpg\">\n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111865\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111865votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111865\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/hector\">hoohack</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/hector\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/df22a501f19a5bba1b3331e2001f8ec2.jpeg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            一个正在努力的菜鸟        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/hector\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/hector/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/hector/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 25</a> · <a title=\"我的网站\" target=\"_blank\" href=\"http://www.hoohack.me\"><i class=\"fa fa-link\"></i></a> <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/u/2388493434?is_all=1\"><i class=\"fa fa-weibo\"></i></a> <a title=\"QQ：914099943\" target=\"_blank\" href=\"#\"><i class=\"fa fa-qq\"></i></a> <a title=\"个人微信：hhq8307231\" target=\"_blank\" href=\"#\"><i class=\"fa fa-weixin\"></i></a> <a title=\"GitHub主页\" target=\"_blank\" href=\"https://github.com/hoohack\"><i class=\"fa fa-github\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "如何理解并正确使用 MySQL 索引", "url": "http://blog.jobbole.com/111845/", "url_object_id": "cf623c10941d938ad5c7aceb01b0e9f3", "create_date": "2017/07/14 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2015/11/e78e36715813f49e9e62fe0c6050075c.png"], "praise_nums": "1", "comment_nums": 1, "fav_nums": 3, "tags": "IT技术,MySQL,数据库,索引", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://my.oschina.net/feinik/blog/1305784\">FEINIK</a>   </div><h1>1、概述</h1>\n<div>\n<p>索引是存储引擎用于快速查找记录的一种数据结构，通过合理的使用数据库索引可以大大提高系统的访问性能，接下来主要介绍在MySql数据库中索引类型，以及如何创建出更加合理且高效的索引技巧。</p>\n<blockquote><p>注：这里主要针对的是InnoDB存储引擎的B+Tree索引数据结构</p></blockquote>\n<h1>2、索引的优点</h1>\n<p>1、大大减轻了服务器需要扫描的数据量，从而提高了数据的检索速度</p>\n<p>2、帮助服务器避免排序和临时表</p>\n<p>3、可以将随机I/O变为顺序I/O</p>\n<h1>3、索引的创建</h1>\n<p><strong>3.1、主键索引</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f5e051921478\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nALTER TABLE 'table_name' ADD PRIMARY KEY 'index_name' ('column');</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f5e051921478-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f5e051921478-1\"><span class=\"crayon-e\">ALTER </span><span class=\"crayon-i\">TABLE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'table_name'</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ADD </span><span class=\"crayon-e\">PRIMARY </span><span class=\"crayon-i\">KEY</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'index_name'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'column'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p><strong>3.2、唯一索引</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f69431444408\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nALTER TABLE 'table_name' ADD UNIQUE 'index_name' ('column');</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f69431444408-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f69431444408-1\"><span class=\"crayon-e\">ALTER </span><span class=\"crayon-i\">TABLE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'table_name'</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ADD </span><span class=\"crayon-i\">UNIQUE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'index_name'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'column'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p><strong>3.3、普通索引</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f6d968993799\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nALTER TABLE 'table_name' ADD INDEX 'index_name' ('column');</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f6d968993799-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f6d968993799-1\"><span class=\"crayon-e\">ALTER </span><span class=\"crayon-i\">TABLE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'table_name'</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ADD </span><span class=\"crayon-i\">INDEX</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'index_name'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'column'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p><strong>3.4、全文索引</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f79801591481\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nALTER TABLE 'table_name' ADD FULLTEXT 'index_name' ('column');</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f79801591481-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f79801591481-1\"><span class=\"crayon-e\">ALTER </span><span class=\"crayon-i\">TABLE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'table_name'</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ADD </span><span class=\"crayon-i\">FULLTEXT</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'index_name'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'column'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p><strong>3.5、组合索引</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f7c740704218\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nALTER TABLE 'table_name' ADD INDEX 'index_name' ('column1', 'column2', ...);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f7c740704218-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f7c740704218-1\"><span class=\"crayon-e\">ALTER </span><span class=\"crayon-i\">TABLE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'table_name'</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ADD </span><span class=\"crayon-i\">INDEX</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'index_name'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'column1'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'column2'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p></p>\n<h1>4、B+Tree的索引规则</h1>\n<p>创建一个测试的用户表</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f80546305791\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nDROP TABLE IF EXISTS user_test;\r\nCREATE TABLE user_test(\r\n\tid int AUTO_INCREMENT PRIMARY KEY,\r\n\tuser_name varchar(30) NOT NULL,\r\n\tsex bit(1) NOT NULL DEFAULT b'1',\r\n\tcity varchar(50) NOT NULL,\r\n\tage int NOT NULL\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f80546305791-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005f80546305791-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005f80546305791-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005f80546305791-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005f80546305791-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005f80546305791-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005f80546305791-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005f80546305791-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f80546305791-1\"><span class=\"crayon-e\">DROP </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-st\">IF</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">EXISTS </span><span class=\"crayon-v\">user_test</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005f80546305791-2\"><span class=\"crayon-e\">CREATE </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-e\">user_test</span><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-596c43d005f80546305791-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">id </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AUTO_INCREMENT </span><span class=\"crayon-e\">PRIMARY </span><span class=\"crayon-v\">KEY</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005f80546305791-4\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">user_name </span><span class=\"crayon-e\">varchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">30</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596c43d005f80546305791-5\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">sex </span><span class=\"crayon-e\">bit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">DEFAULT</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">b</span><span class=\"crayon-s\">'1'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005f80546305791-6\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">city </span><span class=\"crayon-e\">varchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">50</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596c43d005f80546305791-7\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">age </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005f80546305791-8\"><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ENGINE</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">InnoDB </span><span class=\"crayon-st\">DEFAULT</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CHARSET</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">utf8</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p>创建一个组合索引： ALTER TABLE user_test ADD INDEX idx_user(user_name , city , age);</p>\n<h2>4.1、索引有效的查询</h2>\n<h3><strong>4.1.1、全值匹配</strong></h3>\n<p>全值匹配指的是和索引中的所有列进行匹配，如：以上面创建的索引为例，在where条件后可同时查询（user_name，city，age）为条件的数据。</p>\n<blockquote><p>注：与where后查询条件的顺序无关，这里是很多同学容易误解的一个地方</p></blockquote>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f83791021678\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT * FROM user_test WHERE user_name = 'feinik' AND age = 26 AND city = '广州';</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f83791021678-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f83791021678-1\"><span class=\"crayon-e \">SELECT *</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'feinik'</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">AND</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">age</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">26</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">AND</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'广州'</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p></p>\n<h3><strong>4.1.2、匹配最左前缀</strong></h3>\n<p>匹配最左前缀是指优先匹配最左索引列，如：上面创建的索引可用于查询条件为：（user_name ）、（user_name, city）、（user_name , city , age）</p>\n<blockquote><p>注：满足最左前缀查询条件的顺序与索引列的顺序无关，如：（city, user_name）、（age, city, user_name）</p></blockquote>\n<h3><strong>4.1.3、匹配列前缀</strong></h3>\n<p>指匹配列值的开头部分，如：查询用户名以feinik开头的所有用户</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f87859662034\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT * FROM user_test WHERE user_name LIKE 'feinik%';</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f87859662034-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f87859662034-1\"><span class=\"crayon-e \">SELECT *</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-e\">user_name </span><span class=\"crayon-i\">LIKE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'feinik%'</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p></p>\n<h3><strong>4.1.4、匹配范围值</strong></h3>\n<p>如：查询用户名以feinik开头的所有用户，这里使用了索引的第一列</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f8a999641862\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT * FROM user_test WHERE user_name LIKE 'feinik%';</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f8a999641862-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f8a999641862-1\"><span class=\"crayon-e \">SELECT *</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-e\">user_name </span><span class=\"crayon-i\">LIKE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'feinik%'</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p>\n<h2>4.2、索引的限制</h2>\n<p>1、where查询条件中不包含索引列中的最左索引列，则无法使用到索引查询，如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f8d794302500\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT * FROM user_test WHERE city = '广州';</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f8d794302500-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f8d794302500-1\"><span class=\"crayon-e \">SELECT *</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-v\">city</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'广州'</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>或</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f94381196955\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT * FROM user_test WHERE age= 26;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f94381196955-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f94381196955-1\"><span class=\"crayon-e \">SELECT *</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-v\">age</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">26</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>或</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f98002134370\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT * FROM user_test WHERE city = '广州' AND age = '26';</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f98002134370-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f98002134370-1\"><span class=\"crayon-e \">SELECT *</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-v\">city</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'广州'</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">AND</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">age</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'26'</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>2、即使where的查询条件是最左索引列，也无法使用索引查询用户名以feinik结尾的用户</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f9b760453974\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT * FROM user_test WHERE user_name like '%feinik';</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f9b760453974-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f9b760453974-1\"><span class=\"crayon-e \">SELECT *</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-e\">user_name </span><span class=\"crayon-i\">like</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'%feinik'</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>3、如果where查询条件中有某个列的范围查询，则其右边的所有列都无法使用索引优化查询，如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005f9e026540301\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT * FROM user_test WHERE user_name = 'feinik' AND city LIKE '广州%' AND age = 26;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005f9e026540301-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005f9e026540301-1\"><span class=\"crayon-e \">SELECT *</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'feinik'</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">AND</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">city </span><span class=\"crayon-i\">LIKE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'广州%'</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">AND</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">age</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">26</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p></p>\n<h1>5、高效的索引策略</h1>\n<h2>5.1、索引列不能是表达式的一部分，也不能作为函数的参数，否则无法使用索引查询。</h2>\n<p>SELECT * FROM user_test WHERE user_name = concat(user_name, ‘fei’);</p>\n<h2>5.2、前缀索引</h2>\n<p>有时候需要索引很长的字符列，这会增加索引的存储空间以及降低索引的效率，一种策略是可以使用哈希索引，还有一种就是可以使用前缀索引，前缀索引是选择字符列的前n个字符作为索引，这样可以大大节约索引空间，从而提高索引效率。</p>\n<h3><strong>5.2.1、前缀索引的选择性</strong></h3>\n<p>前缀索引要选择足够长的前缀以保证高的选择性，同时又不能太长，我们可以通过以下方式来计算出合适的前缀索引的选择长度值：</p>\n<p>（1）</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fa2217406940\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT COUNT(DISTINCT index_column)/COUNT(*) FROM table_name; -- index_column代表要添加前缀索引的列</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fa2217406940-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fa2217406940-1\"><span class=\"crayon-e\">SELECT </span><span class=\"crayon-e\">COUNT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">DISTINCT </span><span class=\"crayon-v\">index_column</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">COUNT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">table_name</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">_</span>column代表要添加前缀索引的列</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p></p>\n<blockquote><p>注：通过以上方式来计算出前缀索引的选择性比值，比值越高说明索引的效率也就越高效。</p></blockquote>\n<p>（2）</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fa5931675270\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT\r\n\r\nCOUNT(DISTINCT LEFT(index_column,1))/COUNT(*),\r\n\r\nCOUNT(DISTINCT LEFT(index_column,2))/COUNT(*),\r\n\r\nCOUNT(DISTINCT LEFT(index_column,3))/COUNT(*)\r\n\r\n...\r\n\r\nFROM table_name;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fa5931675270-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fa5931675270-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fa5931675270-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fa5931675270-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fa5931675270-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fa5931675270-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fa5931675270-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fa5931675270-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fa5931675270-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fa5931675270-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fa5931675270-11\">11</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fa5931675270-1\"><span class=\"crayon-e\">SELECT</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fa5931675270-2\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fa5931675270-3\"><span class=\"crayon-e\">COUNT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">DISTINCT </span><span class=\"crayon-e\">LEFT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">index_column</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">COUNT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fa5931675270-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fa5931675270-5\"><span class=\"crayon-e\">COUNT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">DISTINCT </span><span class=\"crayon-e\">LEFT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">index_column</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">COUNT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fa5931675270-6\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fa5931675270-7\"><span class=\"crayon-e\">COUNT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">DISTINCT </span><span class=\"crayon-e\">LEFT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">index_column</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">COUNT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fa5931675270-8\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fa5931675270-9\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fa5931675270-10\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fa5931675270-11\"><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">table_name</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p></p>\n<blockquote><p>注：通过以上语句逐步找到最接近于（1）中的前缀索引的选择性比值，那么就可以使用对应的字符截取长度来做前缀索引了</p></blockquote>\n<h3>5.2.2、前缀索引的创建</h3>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fa8347304694\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nALTER TABLE table_name ADD INDEX index_name (index_column(length));</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fa8347304694-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fa8347304694-1\"><span class=\"crayon-e\">ALTER </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-e\">table_name </span><span class=\"crayon-e\">ADD </span><span class=\"crayon-e\">INDEX </span><span class=\"crayon-e\">index_name</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">index_column</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">length</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p></p>\n<h3>5.2.3、使用前缀索引的注意点</h3>\n<p>前缀索引是一种能使索引更小，更快的有效办法，但是MySql无法使用前缀索引做ORDER BY 和 GROUP BY以及使用前缀索引做覆盖扫描。</p>\n<h2>5.3、选择合适的索引列顺序</h2>\n<p>在组合索引的创建中索引列的顺序非常重要，正确的索引顺序依赖于使用该索引的查询方式，对于组合索引的索引顺序可以通过经验法则来帮助我们完成：将选择性最高的列放到索引最前列，该法则与前缀索引的选择性方法一致，但并不是说所有的组合索引的顺序都使用该法则就能确定，还需要根据具体的查询场景来确定具体的索引顺序。</p>\n<h2>5.4 聚集索引与非聚集索引</h2>\n<p><strong>1、聚集索引</strong></p>\n<p>聚集索引决定数据在物理磁盘上的物理排序，一个表只能有一个聚集索引，如果定义了主键，那么InnoDB会通过主键来聚集数据，如果没有定义主键，InnoDB会选择一个唯一的非空索引代替，如果没有唯一的非空索引，InnoDB会隐式定义一个主键来作为聚集索引。</p>\n<p>聚集索引可以很大程度的提高访问速度，因为聚集索引将索引和行数据保存在了同一个B-Tree中，所以找到了索引也就相应的找到了对应的行数据，但在使用聚集索引的时候需注意避免随机的聚集索引（一般指主键值不连续，且分布范围不均匀），如使用UUID来作为聚集索引性能会很差，因为UUID值的不连续会导致增加很多的索引碎片和随机I/O，最终导致查询的性能急剧下降。</p>\n<p><strong>2、非聚集索引</strong></p>\n<p>与聚集索引不同的是非聚集索引并不决定数据在磁盘上的物理排序，且在B-Tree中包含索引但不包含行数据，行数据只是通过保存在B-Tree中的索引对应的指针来指向行数据，如：上面在（user_name，city, age）上建立的索引就是非聚集索引。</p>\n<h2>5.5、覆盖索引</h2>\n<p>如果一个索引（如：组合索引）中包含所有要查询的字段的值，那么就称之为覆盖索引，如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fad010344904\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT user_name, city, age FROM user_test WHERE user_name = 'feinik' AND age &gt; 25;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fad010344904-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fad010344904-1\"><span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">age </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'feinik'</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">AND</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">age</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">25</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>因为要查询的字段（user_name, city, age）都包含在组合索引的索引列中，所以就使用了覆盖索引查询，查看是否使用了覆盖索引可以通过执行计划中的Extra中的值为Using index则证明使用了覆盖索引，覆盖索引可以极大的提高访问性能。</p>\n<h2>5.6、如何使用索引来排序</h2>\n<p>在排序操作中如果能使用到索引来排序，那么可以极大的提高排序的速度，要使用索引来排序需要满足以下两点即可。</p>\n<ul>\n<li>1、ORDER BY子句后的列顺序要与组合索引的列顺序一致，且所有排序列的排序方向（正序/倒序）需一致</li>\n<li>2、所查询的字段值需要包含在索引列中，及满足覆盖索引</li>\n</ul>\n<p><strong>通过例子来具体分析</strong></p>\n<p>在user_test表上创建一个组合索引</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fb3720898992\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nALTER TABLE user_test ADD INDEX index_user(user_name , city , age);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fb3720898992-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fb3720898992-1\"><span class=\"crayon-e\">ALTER </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">ADD </span><span class=\"crayon-e\">INDEX </span><span class=\"crayon-e\">index_user</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">_</span>name<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">city</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">age</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>可以使用到索引排序的案例</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fb6306571836\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n1、SELECT user_name, city, age FROM user_test ORDER BY user_name;\r\n\r\n2、SELECT user_name, city, age FROM user_test ORDER BY user_name, city;\r\n\r\n3、SELECT user_name, city, age FROM user_test ORDER BY user_name DESC, city DESC;\r\n\r\n4、SELECT user_name, city, age FROM user_test WHERE user_name = 'feinik' ORDER BY city;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fb6306571836-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fb6306571836-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fb6306571836-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fb6306571836-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fb6306571836-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fb6306571836-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fb6306571836-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fb6306571836-1\"><span class=\"crayon-cn\">1</span>、<span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">age </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">ORDER </span><span class=\"crayon-e\">BY </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fb6306571836-2\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fb6306571836-3\"><span class=\"crayon-cn\">2</span>、<span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">age </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">ORDER </span><span class=\"crayon-e\">BY </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fb6306571836-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fb6306571836-5\"><span class=\"crayon-cn\">3</span>、<span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">age </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">ORDER </span><span class=\"crayon-e\">BY </span><span class=\"crayon-e\">user_name </span><span class=\"crayon-v\">DESC</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">city </span><span class=\"crayon-v\">DESC</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fb6306571836-6\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fb6306571836-7\"><span class=\"crayon-cn\">4</span>、<span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">age </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'feinik'</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ORDER </span><span class=\"crayon-e\">BY </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0019 seconds] -->\r\n<p></p>\n<blockquote><p>注：第4点比较特殊一点，如果where查询条件为索引列的第一列，且为常量条件，那么也可以使用到索引</p></blockquote>\n<p>无法使用索引排序的案例</p>\n<p>1、sex不在索引列中</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fba563982211\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT user_name, city, age FROM user_test ORDER BY user_name, sex;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fba563982211-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fba563982211-1\"><span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">age </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">ORDER </span><span class=\"crayon-e\">BY </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sex</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>2、排序列的方向不一致</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fc2396380692\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT user_name, city, age FROM user_test ORDER BY user_name ASC, city DESC;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fc2396380692-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fc2396380692-1\"><span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">age </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">ORDER </span><span class=\"crayon-e\">BY </span><span class=\"crayon-e\">user_name </span><span class=\"crayon-v\">ASC</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">city </span><span class=\"crayon-v\">DESC</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>3、所要查询的字段列sex没有包含在索引列中</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fc5053255343\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT user_name, city, age, sex FROM user_test ORDER BY user_name;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fc5053255343-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fc5053255343-1\"><span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">age</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sex </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">ORDER </span><span class=\"crayon-e\">BY </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>4、where查询条件后的user_name为范围查询，所以无法使用到索引的其他列</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fc8879050689\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT user_name, city, age FROM user_test WHERE user_name LIKE 'feinik%' ORDER BY city;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fc8879050689-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fc8879050689-1\"><span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">age </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-e\">user_test </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-e\">user_name </span><span class=\"crayon-i\">LIKE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'feinik%'</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ORDER </span><span class=\"crayon-e\">BY </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>5、多表连接查询时，只有当ORDER BY后的排序字段都是第一个表中的索引列（需要满足以上索引排序的两个规则）时，方可使用索引排序。如：再创建一个用户的扩展表user_test_ext，并建立uid的索引。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fd8190693632\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nDROP TABLE IF EXISTS user_test_ext;\r\n\r\nCREATE TABLE user_test_ext(\r\n\r\n    id int AUTO_INCREMENT PRIMARY KEY,\r\n\r\n    uid int NOT NULL,\r\n\r\n    u_password VARCHAR(64) NOT NULL\r\n\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\r\n\r\nALTER TABLE user_test_ext ADD INDEX index_user_ext(uid);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fd8190693632-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fd8190693632-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fd8190693632-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fd8190693632-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fd8190693632-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fd8190693632-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fd8190693632-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fd8190693632-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fd8190693632-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fd8190693632-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fd8190693632-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c43d005fd8190693632-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c43d005fd8190693632-13\">13</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fd8190693632-1\"><span class=\"crayon-e\">DROP </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-st\">IF</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">EXISTS </span><span class=\"crayon-v\">user_test_ext</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fd8190693632-2\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fd8190693632-3\"><span class=\"crayon-e\">CREATE </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-e\">user_test_ext</span><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fd8190693632-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fd8190693632-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">id </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AUTO_INCREMENT </span><span class=\"crayon-e\">PRIMARY </span><span class=\"crayon-v\">KEY</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fd8190693632-6\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fd8190693632-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">uid </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fd8190693632-8\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fd8190693632-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">u_password </span><span class=\"crayon-e\">VARCHAR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">64</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fd8190693632-10\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fd8190693632-11\"><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ENGINE</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">InnoDB </span><span class=\"crayon-st\">DEFAULT</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CHARSET</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">utf8</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c43d005fd8190693632-12\"> </div><div class=\"crayon-line\" id=\"crayon-596c43d005fd8190693632-13\"><span class=\"crayon-e\">ALTER </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-e\">user_test_ext </span><span class=\"crayon-e\">ADD </span><span class=\"crayon-e\">INDEX </span><span class=\"crayon-e\">index_user_ext</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">uid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0015 seconds] -->\r\n<p>走索引排序</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fde364875232\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT user_name, city, age FROM user_test u LEFT JOIN user_test_ext ue ON u.id = ue.uid ORDER BY u.user_name;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fde364875232-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fde364875232-1\"><span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">age </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">_</span>test<span class=\"crayon-h\"> </span><span class=\"crayon-i\">u</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">LEFT </span><span class=\"crayon-e\">JOIN </span><span class=\"crayon-e\">user_test_ext </span><span class=\"crayon-e\">ue </span><span class=\"crayon-i\">ON</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">u</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ue</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">uid </span><span class=\"crayon-e\">ORDER </span><span class=\"crayon-i\">BY</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">u</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>不走索引排序</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c43d005fe2169562262\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT user_name, city, age FROM user_test u LEFT JOIN user_test_ext ue ON u.id = ue.uid ORDER BY ue.uid;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c43d005fe2169562262-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c43d005fe2169562262-1\"><span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">user_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">city</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">age </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">_</span>test<span class=\"crayon-h\"> </span><span class=\"crayon-i\">u</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">LEFT </span><span class=\"crayon-e\">JOIN </span><span class=\"crayon-e\">user_test_ext </span><span class=\"crayon-e\">ue </span><span class=\"crayon-i\">ON</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">u</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ue</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">uid </span><span class=\"crayon-e\">ORDER </span><span class=\"crayon-e\">BY </span><span class=\"crayon-v\">ue</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">uid</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p></p>\n<h1>6、总结</h1>\n<p>本文主要讲了B+Tree树结构的索引规则，不同索引的创建，以及如何正确的创建出高效的索引技巧来尽可能的提高查询速度，当然了关于索引的使用技巧不单单只有这些，关于索引的更多技巧还需平时不断的积累相关经验。</p>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111845\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111845votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111845\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 1 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "Linux 内核驱动中对文件的读写", "url": "http://blog.jobbole.com/111837/", "url_object_id": "0652cdaecb237b8b1ccdb84d87bdf60c", "create_date": "2017/07/13 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2016/11/59d49abe8909a122bc2c9aa43b71e3bb.png"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "IT技术,Linux,内核", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.chinaunix.net/uid-13059007-id-5766941.html\">niuyimail</a>   </div><p>有时候需要在<a class=\"keyword_link\" href=\"http://www.chinabyte.com/keyword/Linux/\" target=\"_blank\">Linux</a> kernel–大多是在需要调试的驱动程序–中读写文件数据。在kernel中操作文件没有标准库可用，需要利用kernel的一些函数，这些函数主 要有： filp_open() filp_close(), vfs_read() vfs_write()，set_fs()，get_fs()等，这些函数在linux/fs.h和asm/uaccess.h头文件中声明。下面介绍主要步骤</p>\n<h3>1. 打开文件</h3>\n<p>filp_open()在kernel中可以打开文件，其原形如下：</p>\n<p>strcut file* filp_open(const char* filename, int open_mode, int mode);</p>\n<p>该函数返回strcut file*结构指针，供后继函数操作使用，该返回值用IS_ERR()来检验其有效性。</p>\n<h4>参数说明</h4>\n<p>filename： 表明要打开或创建文件的名称(包括路径部分)。在内核中打开的文件时需要注意打开的时机，很容易出现需要打开文件的驱动很早就加载并打开文件，但需要打开的文件所在设备还不有挂载到文件系统中，而导致打开失败。</p>\n<p>open_mode： 文件的打开方式，其取值与标准库中的open相应参数类似，可以取O_CREAT,O_RDWR,O_RDONLY等。</p>\n<p>mode： 创建文件时使用，设置创建文件的读写权限，其它情况可以匆略设为0</p>\n<h3>2. 读写文件</h3>\n<p>kernel中文件的读写操作可以使用vfs_read()和vfs_write，在使用这两个函数前需要说明一下get_fs()和 set_fs()这两个函数。</p>\n<p>vfs_read() vfs_write()两函数的原形如下：</p>\n<p>ssize_t vfs_read(struct file* filp, char __user* buffer, size_t len, loff_t* pos);</p>\n<p>ssize_t vfs_write(struct file* filp, const char __user* buffer, size_t len, loff_t* pos);</p>\n<p>注意这两个函数的第二个参数buffer，前面都有__user修饰符，这就要求这两个buffer指针都应该指向用户空间的内存，如果对该参数传 递kernel空间的指针，这两个函数都会返回失败-EFAULT。但在Kernel中，我们一般不容易生成用户空间的指针，或者不方便独立使用用户空间 内存。要使这两个读写函数使用kernel空间的buffer指针也能正确工作，需要使用set_fs()函数或宏(set_fs()可能是宏定义)，如 果为函数，其原形如下：</p>\n<p>void set_fs(mm_segment_t fs);</p>\n<p>该函数的作用是改变kernel对内存地址检查的处理方式，其实该函数的参数fs只有两个取值：USER_DS，KERNEL_DS，分别代表 用户空间和内核空间，默认情况下，kernel取值为USER_DS，即对用户空间地址检查并做变换。那么要在这种对内存地址做检查变换的函数中使用内核 空间地址，就需要使用set_fs(KERNEL_DS)进行设置。get_fs()一般也可能是宏定义，它的作用是取得当前的设置，这两个函数的一般用 法为：</p>\n<p>mm_segment_t old_fs;</p>\n<p>old_fs = get_fs();</p>\n<p>set_fs(KERNEL_DS);</p>\n<p>…… //与内存有关的操作</p>\n<p>set_fs(old_fs);</p>\n<p>还有一些其它的内核函数也有用__user修饰的参数，在kernel中需要用kernel空间的内存代替时，都可以使用类似办法。</p>\n<p>使用vfs_read()和vfs_write()最后需要注意的一点是最后的参数loff_t * pos，pos所指向的值要初始化，表明从文件的什么地方开始读写。</p>\n<h3>3. 关闭读写文件</h3>\n<p>int filp_close(struct file*filp, fl_owner_t id);</p>\n<p>该函数的使用很简单，第二个参数一般传递NULL值，也有用current-&gt;files作为实参的。</p>\n<p>使用以上函数的其它注意点：</p>\n<p>1. 其实Linux Kernel组成员不赞成在kernel中独立的读写文件(这样做可能会影响到策略和安全问题)，对内核需要的文件内容，最好由应用层配合完成。</p>\n<p>2. 在可加载的kernel module中使用这种方式读写文件可能使<a class=\"keyword_link\" href=\"http://www.chinabyte.com/keyword/%E6%A8%A1%E5%9D%97/\" target=\"_blank\">模块</a>加载失败，原因是内核可能没有EXPORT你所需要的所有这些函数。</p>\n<p>3. 分析以上某些函数的参数可以看出，这些函数的正确运行需要依赖于进程环境，因此，有些函数不能在中断的handle或Kernel中不属于任可进程的代码 中执行，否则可能出现崩溃，要避免这种情况发生，可以在kernel中创建内核线程，将这些函数放在线程环境下执行(创建内核线程的方式请参数 kernel_thread()函数)。</p>\n<p>在VFS的支持下，用户态进程读写 任何类型的文件系统都可以使用read和write着两个系统调用，但是在linux内核中没有这样的系统调用我们如何操作文件呢？我们知道read和 write在进入内核态之后，实际执行的是sys_read和sys_write，但是查看内核源代码，发现这些操作文件的函数都没有导出(使用 EXPORT_SYMBOL导出)，也就是说在内核模块中是不能使用的，那如何是好？</p>\n<p>通过查看sys_open的源码我 们发现，其主要使用了do_filp_open()函数，该函数在fs/namei.c中，而在改文件中，filp_open函数也是调用了 do_filp_open函数，并且接口和sys_open函数极为相似，调用参数也和sys_open一样，并且使用EXPORT_SYMBOL导出 了，所以我们猜想该函数可以打开文件，功能和open一样。使用同样的查找方法，我们找出了一组在内核中操作文件的函数，如下：</p>\n<table border=\"1\" cellspacing=\"0\" cellpadding=\"5\">\n<tbody>\n<tr>\n<td align=\"center\">功能</td>\n<td align=\"center\">函数原型</td>\n</tr>\n<tr>\n<td>打开文件</td>\n<td><strong>struct</strong> file *filp_open(<strong>const</strong> <strong>char</strong> *filename, <strong>int</strong> flags, <strong>int</strong> mode)</td>\n</tr>\n<tr>\n<td>读取文件</td>\n<td><strong>ssize_t</strong> vfs_read(<strong>struct</strong> file *file, <strong>char</strong> __user *buf, <strong>size_t</strong> count, loff_t *pos)</td>\n</tr>\n<tr>\n<td>写文件</td>\n<td><strong>ssize_t</strong> vfs_write(<strong>struct</strong> file *file, <strong>const</strong> <strong>char</strong> __user *buf, <strong>size_t</strong> count, loff_t *pos)</td>\n</tr>\n<tr>\n<td>关闭文件</td>\n<td><strong>int</strong> filp_close(<strong>struct</strong> file *filp, fl_owner_t id)</td>\n</tr>\n</tbody>\n</table>\n<p>我们注意到在vfs_read和vfs_write函数中，其参数buf指向的用户空间的内存地址，如果我们直接使用内核空间的指针，则会返回-EFALUT。所以我们需要使用</p>\n<p>set_fs()和get_fs()宏来改变内核对内存地址检查的处理方式，所以在内核空间对文件的读写流程为：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596be2ee12169732834766\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmm_segment_t fs = get_fs();\r\nset_fs(KERNEL_FS);\r\n//vfs_write();\r\nvfs_read();\r\nset_fs(fs);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596be2ee12169732834766-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12169732834766-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12169732834766-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12169732834766-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12169732834766-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596be2ee12169732834766-1\"><span class=\"crayon-e\">mm_segment_t </span><span class=\"crayon-v\">fs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_fs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12169732834766-2\"><span class=\"crayon-e\">set_fs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">KERNEL_FS</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12169732834766-3\"><span class=\"crayon-c\">//vfs_write();</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12169732834766-4\"><span class=\"crayon-e\">vfs_read</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12169732834766-5\"><span class=\"crayon-e\">set_fs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>下面为一个在内核中对文件操作的例子：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596be2ee12174681297766\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#include &lt;linux/module.h&gt;\r\n#include &lt;linux/init.h&gt;\r\n#include &lt;linux/fs.h&gt;\r\n#include &lt;linux/uaccess.h&gt;\r\nstatic char buf[] = \"你好\";\r\nstatic char buf1[10];\r\n \r\nint __init hello_init(void)\r\n{\r\n    struct file *fp;\r\n    mm_segment_t fs;\r\n    loff_t pos;\r\n    printk(\"hello enter\\n\");\r\n    fp = filp_open(\"/home/niutao/kernel_file\", O_RDWR | O_CREAT, 0644);\r\n    if (IS_ERR(fp)) {\r\n        printk(\"create file error\\n\");\r\n        return -1;\r\n    }\r\n    fs = get_fs();\r\n    set_fs(KERNEL_DS);\r\n    pos = 0;\r\n    vfs_write(fp, buf, sizeof(buf), &amp;pos);\r\n    pos = 0;\r\n    vfs_read(fp, buf1, sizeof(buf), &amp;pos);\r\n    printk(\"read: %s\\n\", buf1);\r\n    filp_close(fp, NULL);\r\n    set_fs(fs);\r\n    return 0;\r\n}\r\nvoid __exit hello_exit(void)\r\n{\r\n    printk(\"hello exit\\n\");\r\n}\r\n \r\nmodule_init(hello_init);\r\nmodule_exit(hello_exit);\r\n \r\nMODULE_LICENSE(\"GPL\");</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596be2ee12174681297766-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596be2ee12174681297766-38\">38</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-1\"><span class=\"crayon-p\">#include &lt;linux/module.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-2\"><span class=\"crayon-p\">#include &lt;linux/init.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-3\"><span class=\"crayon-p\">#include &lt;linux/fs.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-4\"><span class=\"crayon-p\">#include &lt;linux/uaccess.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-5\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">buf</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"你好\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-6\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">buf1</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-7\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-8\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__init </span><span class=\"crayon-e\">hello_init</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">void</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-9\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">file *</span><span class=\"crayon-v\">fp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">mm_segment_t </span><span class=\"crayon-v\">fs</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">loff_t </span><span class=\"crayon-v\">pos</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">printk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"hello enter\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">fp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">filp_open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/home/niutao/kernel_file\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">O_RDWR</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">O_CREAT</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0644</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IS_ERR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"create file error\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">fs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_fs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">set_fs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">KERNEL_DS</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">pos</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">vfs_write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">buf</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sizeof</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">buf</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">pos</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">pos</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">vfs_read</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">buf1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sizeof</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">buf</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">pos</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">printk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"read: %s\\n\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">buf1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">filp_close</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">set_fs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-29\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-30\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__exit </span><span class=\"crayon-e\">hello_exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">void</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-31\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">printk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"hello exit\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-33\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-34\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-35\"><span class=\"crayon-e\">module_init</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hello_init</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-36\"><span class=\"crayon-e\">module_exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hello_exit</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596be2ee12174681297766-37\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596be2ee12174681297766-38\"><span class=\"crayon-e\">MODULE_LICENSE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"GPL\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0045 seconds] -->\r\n<p></p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111837\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111837votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111837\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "LevelDB 实现分析", "url": "http://blog.jobbole.com/111792/", "url_object_id": "345014f87e74ee252ce7be279d54c7b4", "create_date": "2017/07/10 ·", "front_image_url": ["https://gw.alicdn.com/tfs/TB1R1S4SXXXXXaRXpXXXXXXXXXX-900-500.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 2, "tags": "IT技术,LevelDB,数据库", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://taobaofed.org/blog/2017/07/04/leveldb-analysis/\">胡帅</a>   </div><p><img class=\"aligncenter\" src=\"https://gw.alicdn.com/tfs/TB1R1S4SXXXXXaRXpXXXXXXXXXX-900-500.jpg\" alt=\"LevelDB 实现分析\"></p>\n<h3 id=\"LevelDB-介绍\">LevelDB 介绍</h3>\n<p>LevelDB 是由 Google 开发的 key-value 非关系型数据库存储系统，是基于 LSM(Log-Structured-Merge Tree) 的典型实现，LSM 的原理是：当读写数据库时，首先纪录读写操作到 Op log 文件中，然后再操作内存数据库，当达到 checkpoint 时，则写入磁盘，同时删除相应的 Op log 文件，后续重新生成新的内存文件和 Op log 文件。</p>\n<p>LevelDB 内部采用了内存缓存机制，也就是在写数据库时，首先会存储在内存中，内存的存储结构采用了 skip list 结构，待达到 checkpoint 时，才进行落盘操作，保证了数据库的高效运转。</p>\n<h3 id=\"LevelDB-总体架构\">LevelDB 总体架构</h3>\n<p><img class=\"aligncenter\" src=\"https://gw.alicdn.com/tfs/TB1AMqNSXXXXXczXFXXXXXXXXXX-851-479.png\" alt=\"resources structure\"></p>\n<p>如上图所示，整个 LevelDB 由以下几部分组成：</p>\n<ol>\n<li>Write(k,v)，对外的接口</li>\n<li>Op log，操作日志记录文件</li>\n<li>memtable，数据库存储的内存结构</li>\n<li>Immutable memtable，待落盘的数据库内存数据</li>\n<li>sstable，落盘后的磁盘存储结构</li>\n<li>manifest，LevelDB 元信息清单，包括数据库的配置信息和中间使用的文件列表</li>\n<li>current，当前正在使用的文件清单</li>\n</ol>\n<p>整体结构清晰紧凑，非常容易理解。</p>\n<h3 id=\"对外接口\">对外接口</h3>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c0b110f7de918239821\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nDB() { };\r\nvirtual ~DB();\r\nstatic Status Open(const Options&amp; options,\r\n                   const std::string&amp; name,\r\n                   DB** dbptr);\r\nvirtual Status Put(const WriteOptions&amp; options,\r\n                   const Slice&amp; key,\r\n                   const Slice&amp; value) = 0;\r\nvirtual Status Delete(const WriteOptions&amp; options, const Slice&amp; key) = 0;\r\nvirtual Status Write(const WriteOptions&amp; options, WriteBatch* updates) = 0;\r\nvirtual Status Get(const ReadOptions&amp; options,\r\n                   const Slice&amp; key, std::string* value) = 0;\r\nvirtual Iterator* NewIterator(const ReadOptions&amp; options) = 0;\r\nvirtual const Snapshot* GetSnapshot() = 0;\r\nvirtual void ReleaseSnapshot(const Snapshot* snapshot) = 0;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7de918239821-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7de918239821-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7de918239821-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7de918239821-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7de918239821-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7de918239821-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7de918239821-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7de918239821-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7de918239821-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7de918239821-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7de918239821-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7de918239821-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7de918239821-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7de918239821-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7de918239821-15\">15</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c0b110f7de918239821-1\"><span class=\"crayon-e\">DB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7de918239821-2\"><span class=\"crayon-v\">virtual</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-e\">DB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c0b110f7de918239821-3\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Status </span><span class=\"crayon-e\">Open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Options</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7de918239821-4\"><span class=\"crayon-h\">                   </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">std</span><span class=\"crayon-o\">::</span><span class=\"crayon-t\">string</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596c0b110f7de918239821-5\"><span class=\"crayon-h\">                   </span><span class=\"crayon-e \">DB*</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dbptr</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7de918239821-6\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-e\">Status </span><span class=\"crayon-e\">Put</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">WriteOptions</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596c0b110f7de918239821-7\"><span class=\"crayon-h\">                   </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Slice</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7de918239821-8\"><span class=\"crayon-h\">                   </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Slice</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c0b110f7de918239821-9\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-e\">Status </span><span class=\"crayon-e\">Delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">WriteOptions</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Slice</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7de918239821-10\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-e\">Status </span><span class=\"crayon-e\">Write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">WriteOptions</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">WriteBatch*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">updates</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c0b110f7de918239821-11\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-e\">Status </span><span class=\"crayon-e\">Get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ReadOptions</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7de918239821-12\"><span class=\"crayon-h\">                   </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Slice</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">std</span><span class=\"crayon-o\">::</span><span class=\"crayon-t\">string</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c0b110f7de918239821-13\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-e \">Iterator*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NewIterator</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ReadOptions</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7de918239821-14\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">Snapshot*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">GetSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c0b110f7de918239821-15\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ReleaseSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">Snapshot*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">snapshot</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0039 seconds] -->\r\n<p>整体接口分为：</p>\n<p>数据库创建和删除</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c0b110f7e8830161428\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nDB() { };\r\nvirtual ~DB();</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7e8830161428-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7e8830161428-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c0b110f7e8830161428-1\"><span class=\"crayon-e\">DB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7e8830161428-2\"><span class=\"crayon-v\">virtual</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-e\">DB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>数据库打开</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c0b110f7ec922499364\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic Status Open(const Options&amp; options,\r\n                   const std::string&amp; name,\r\n                   DB** dbptr);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7ec922499364-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7ec922499364-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7ec922499364-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c0b110f7ec922499364-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Status </span><span class=\"crayon-e\">Open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Options</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7ec922499364-2\"><span class=\"crayon-h\">                   </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">std</span><span class=\"crayon-o\">::</span><span class=\"crayon-t\">string</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596c0b110f7ec922499364-3\"><span class=\"crayon-h\">                   </span><span class=\"crayon-e \">DB*</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dbptr</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>数据库读写删除操作</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c0b110f7f0932737225\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nvirtual Status Put(const WriteOptions&amp; options,\r\n                   const Slice&amp; key,\r\n                   const Slice&amp; value) = 0;\r\nvirtual Status Delete(const WriteOptions&amp; options, const Slice&amp; key) = 0;\r\nvirtual Status Get(const ReadOptions&amp; options,\r\n                   const Slice&amp; key, std::string* value) = 0;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7f0932737225-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7f0932737225-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7f0932737225-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7f0932737225-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7f0932737225-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7f0932737225-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c0b110f7f0932737225-1\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-e\">Status </span><span class=\"crayon-e\">Put</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">WriteOptions</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7f0932737225-2\"><span class=\"crayon-h\">                   </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Slice</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596c0b110f7f0932737225-3\"><span class=\"crayon-h\">                   </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Slice</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7f0932737225-4\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-e\">Status </span><span class=\"crayon-e\">Delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">WriteOptions</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Slice</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c0b110f7f0932737225-5\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-e\">Status </span><span class=\"crayon-e\">Get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ReadOptions</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7f0932737225-6\"><span class=\"crayon-h\">                   </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Slice</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">std</span><span class=\"crayon-o\">::</span><span class=\"crayon-t\">string</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0019 seconds] -->\r\n<p>数据库批处理操作</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c0b110f7f3637491665\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nvirtual Status Write(const WriteOptions&amp; options, WriteBatch* updates) = 0;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7f3637491665-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c0b110f7f3637491665-1\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-e\">Status </span><span class=\"crayon-e\">Write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">WriteOptions</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">WriteBatch*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">updates</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>数据库遍历操作</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c0b110f7f6473829408\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nvirtual Iterator* NewIterator(const ReadOptions&amp; options) = 0;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7f6473829408-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c0b110f7f6473829408-1\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-e \">Iterator*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NewIterator</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ReadOptions</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>获取快照操作</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c0b110f7f9390443068\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nvirtual const Snapshot* GetSnapshot() = 0;\r\nvirtual void ReleaseSnapshot(const Snapshot* snapshot) = 0;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c0b110f7f9390443068-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c0b110f7f9390443068-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c0b110f7f9390443068-1\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">Snapshot*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">GetSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c0b110f7f9390443068-2\"><span class=\"crayon-e\">virtual </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ReleaseSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">Snapshot*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">snapshot</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p></p>\n<h4 id=\"Op-log结构分析\">Op log结构分析</h4>\n<p>LevelDB 使用的 Op log 日志采用了文件记录的方式，且文件使用了 mmap 方式操作，以提高效率。</p>\n<p>Op log 存储切分为 32KB 大小的数据块，每个 32KB 数据块存储着 Op log，每 个Op log 格式如下：</p>\n<p><img src=\"https://gw.alicdn.com/tfs/TB1IRGFSXXXXXbsXVXXXXXXXXXX-405-79.png\" alt=\"resources structure\"></p>\n<p>其中：</p>\n<ol>\n<li>CRC32 为 crc 校验码，保证数据的完整性</li>\n<li>Length，为 Op log 的数据长度</li>\n<li>Log Type，Op log 的类型，之所以会有类型，是由于 32KB 可能存不下一条 Op log，Op log 有可能跨数据块，类型分为：\n<ul>\n<li>FULL：代表 Data 包含了所有的数据</li>\n<li>FIRST：代表该 Data 是 Op log 的开始数据</li>\n<li>MIDDLE：代表该 Data 是 Op log 的中间数据</li>\n<li>LAST: 代表该 Data 是 Op log 的结束数据</li>\n</ul>\n</li>\n<li>Data，为 Op log 的实际数据</li>\n</ol>\n<h4 id=\"memtable-结构分析\">memtable 结构分析</h4>\n<p>memtable 是 LevelDB 数据库的内存存储结构，采用了 skip list 结构存储，如下图所示：</p>\n<blockquote><p>skip list 是一种可以代替平衡树的存储结构，它采用概率的方式来保证平衡，而平衡树则是采用严格的旋转树结构来保证平衡，复杂度会高一些。<br>\n对于 skip list，会有 n 层链表，其中 0 层保存所有的值，越往上层，保存的值越少。每当插入一个值时，会通过概率计算该值需要插入的最高层级 k，然后从 0~k-1 层，分别插入该值。</p></blockquote>\n<p><img src=\"https://gw.alicdn.com/tfs/TB1aoiISXXXXXX4XVXXXXXXXXXX-941-359.png\" alt=\"resources structure\"></p>\n<p>其中每个表项的存储结构如下：</p>\n<p>key_size | key_value | sequence_num&amp;type | value_size | value</p>\n<p>其中：</p>\n<p>sequence_num：表示操作的序列号，每一个数据项都会带有一个序列号，用以表示数据的新旧程度。</p>\n<p>type：表示数据的类型，分为：</p>\n<ul>\n<li>kTypeValue：表明数据有效</li>\n<li>kTypeDeletion：表明数据已经失效，在数据进行 delete 操作时会打上该标识</li>\n</ul>\n<h4 id=\"sstable-结构分析\">sstable 结构分析</h4>\n<p>sstable 作为落盘的存储结构，每个 sstable 最大 2MB，从宏观来看，它属于分层的结构，即：</p>\n<ul>\n<li>level 0：最多存储 4 个 sstable</li>\n<li>level 1：存储不超过 10MB 大小的 sstable</li>\n<li>level 2：存储不超过 100MB 大小的 sstable</li>\n</ul>\n<p>level 3 及之后：存储大小不超过上一级大小的 10 倍</p>\n<p>之所以这样分层，是为了提高查找效率，也是 LevelDB 名称的由来。当每一层超过限制时，会进行 compaction 操作，合并到上一层，递归进行。</p>\n<p>从微观的角度看，每个 sstable 文件结构入下图所示：</p>\n<p><img src=\"https://gw.alicdn.com/tfs/TB1n.yuSXXXXXacaXXXXXXXXXXX-345-228.png\" alt=\"resources structure\"></p>\n<p>其中：</p>\n<ul>\n<li>Data Block 存储具体的 k-v 数据</li>\n<li>Meta Block 存储索引过滤信息，用于快速定位 key 是否存在于 Data Block 中</li>\n<li>Meta Index Block 存储 Meta Block 的偏移位置及大小</li>\n<li>Index Block 存储 Data Block 的偏移位置及大小</li>\n<li>Footer 则存储 Meta Index Block 和 Index Block 的偏移位置及大小，相当于二级索引，Footer 的结构如下：<br>\n<img src=\"https://gw.alicdn.com/tfs/TB1C9DXSXXXXXcyXXXXXXXXXXXX-197-140.png\" alt=\"resources structure\"></li>\n</ul>\n<p>另外 Data Block 及 Meta Block 的存储格式是统一的，都是如下格式：</p>\n<p><img src=\"https://gw.alicdn.com/tfs/TB1X9qPSXXXXXbwXFXXXXXXXXXX-435-67.png\" alt=\"resources structure\"></p>\n<p>其中 type 表示是否是压缩存储，目前 LevelDB 支持 key 值的 snappy 压缩或者不压缩。</p>\n<p>而上图中的 Block data 的格式则为：</p>\n<p><img src=\"https://gw.alicdn.com/tfs/TB11UGqSXXXXXaEaXXXXXXXXXXX-819-359.png\" alt=\"resources structure\"></p>\n<p>上图有几点要说明：</p>\n<ol>\n<li>对于 Block data 中的第一项总是不压缩存储的，不压缩存储的项称为 restarts，会被记录在上图的最尾部，同时每隔 k 个值（k 值可定制），都会存储一个不压缩的项，这些都称为 restarts，都会被记录在最尾部。</li>\n<li>每个 restarts 表项会作为索引项存储。</li>\n<li>除了 restarts 表项以外，其它的表项则基于该 restarts 项，计算跟他相同部分和不同部分，上图中的 shared_bytes 和 unshared_bytes 记录了相同部分长度和不同部分的长度，key_delta 则记录了不同的部分的值，value_length 和 value 则记录了 value 部分的值。</li>\n<li>压不压缩是可选的，默认会进行 snappy 压缩。</li>\n</ol>\n<p>对于 Meta Block 来说，它保存了用于快速定位 key 是否在 Data Block 中的信息，具体方法是：</p>\n<ol>\n<li>采用了 bloom filter 的过滤机制，bloom filter 是一种 hash 机制，它对每一个 key，会计算 k 个 hash 值，然后在 k 个 bit 位记录为 1。当查找时，相应计算出 k 个 hash 值，然后比对 k 个 bit 位是否为 1，只要有一个不为 1，则不存在。</li>\n<li>对于每一个 Data Block，所有的 key 值会传入进行 bloom filter 的 hash 计算，每个 key 存储 k 个 bit 位值。</li>\n</ol>\n<h4 id=\"版本管理\">版本管理</h4>\n<p>对于 LevelDB 来说，它采用了简单的 sequence num 机制来管理，具体为：</p>\n<ol>\n<li>对于 Op log 文件，每一个 Op log 文件名中会包含一个唯一的 sequence num，每创建一个新的 Op log 文件，sequence num 则加 1，sequence num 越大，则表示文件越新，同时最新的 sequence num 会记录下来。</li>\n<li>对于每个 key-value 对，也会对应一个 sequence num，对于同一个 key，如果后续更新值时，sequence num 也会相应更新，这样就可以根据 sequence num 的大小，找到最新的 key-value 对</li>\n</ol>\n<h4 id=\"新增特性\">新增特性</h4>\n<ol>\n<li>支持模糊查询该功能支持 key 以模糊规则匹配的方式进行数据库查询，支持＊和？两种模糊规则查询。</li>\n<li>支持 JSON 格式数据存储该功能支持 k-v 中，v以json格式传入，后续可以通过关键字，查询json里面的数据。</li>\n</ol>\n<h4 id=\"结束语\">结束语</h4>\n<p>LevelDB 短小精悍，代码运行效率高效，且通俗易懂，是一个非常不错的 k-v 存储系统。</p>\n<p>注：图片来源于网络</p>\n<blockquote><p>题图：<a href=\"https://unsplash.com/photos/9wwF-VmSOrY\" target=\"_blank\" rel=\"external\">https://unsplash.com/photos/9wwF-VmSOrY</a> By @eberhard grossgasteiger</p></blockquote>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111792\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111792votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111792\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "人人都能读懂的设计模式（2）：结构型模式", "url": "http://blog.jobbole.com/111798/", "url_object_id": "52be25117b0479b1012ef04dcc262667", "create_date": "2017/07/16 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/03/1503a298ec77047d9314ddceef5e4ff7.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 0, "tags": "IT技术,设计模式", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/justin_ygg\">Justin_YGG</a> 翻译。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://github.com/kamranahmedse/design-patterns-for-humans/blob/master/README.md#structural-design-patterns\">kamranahmedse</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>用最简单的语言，解释设计模式。</p>\n<p>虽然示例代码是用 PHP7 实现的，但因为概念是一样的，所以语言并不会阻碍大家理解设计模式。</p>\n<p>《<a href=\"http://blog.jobbole.com/111799/\" target=\"_blank\">人人都能读懂的设计模式（1）：创建型模式</a>》</p>\n<h3>结构型设计模式</h3>\n<h4>概述</h4>\n<p>结构型设计模式主要关注对象组合，换句话说，关注实体之间如何互相使用。 或者还有另外一个解释，结构型设计模式有助于回答“如何构建软件组件？”</p>\n<h4>维基百科</h4>\n<p>在软件工程中，结构型设计模式是借由一以贯之的方式来了解元件间的关系，从而简化设计的一种设计模式。</p>\n<p><strong>分类</strong></p>\n<ul>\n<li>适配器模式</li>\n<li>桥接模式</li>\n<li>组合模式</li>\n<li>修饰模式</li>\n<li>外观模式</li>\n<li>享元模式</li>\n<li>代理模式</li>\n</ul>\n<h3>🔌 适配器模式</h3>\n<h4>现实生活示例</h4>\n<p>考虑这样一个场景，你的存储卡中有一些照片，你需要将其传输到计算机。为此，你需要某种与计算机端口兼容的适配器，以便将存储卡连接到计算机上。在这种情况下，读卡器就是适配器。另外一个例子就是大名鼎鼎的电源适配器：一个三脚插头不能连接到双插头插座，需要使用电源适配器使其与双插头插座兼容。另外一个例子是译者将一个人说的话翻译给另一个人。</p>\n<h4>概述</h4>\n<p>适配器模式可以将不兼容的对象包装成适配器来适配其它类。</p>\n<h4>维基百科</h4>\n<p>在软件工程中，适配器模式是允许将现有类的接口用作另一个类接口的软件设计模式。它通常用于现有类与其他类的协作，而无需修改现有类的代码。</p>\n<p><strong>程序示例</strong></p>\n<p>考虑一个游戏场景，有一个猎人，他狩猎狮子。</p>\n<p>首先给出 <code>Lion</code> 接口，所有种类的狮子都要实现这个接口。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e0ffb687788204\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface Lion\r\n{\r\n    public function roar();\r\n}\r\n\r\nclass AfricanLion implements Lion\r\n{\r\n    public function roar()\r\n    {\r\n    }\r\n}\r\n\r\nclass AsianLion implements Lion\r\n{\r\n    public function roar()\r\n    {\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e0ffb687788204-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e0ffb687788204-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e0ffb687788204-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e0ffb687788204-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e0ffb687788204-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e0ffb687788204-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e0ffb687788204-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e0ffb687788204-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e0ffb687788204-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e0ffb687788204-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e0ffb687788204-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e0ffb687788204-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e0ffb687788204-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e0ffb687788204-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e0ffb687788204-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e0ffb687788204-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e0ffb687788204-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e0ffb687788204-18\">18</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e0ffb687788204-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Lion</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e0ffb687788204-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e0ffb687788204-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">roar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e0ffb687788204-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e0ffb687788204-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e0ffb687788204-6\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AfricanLion</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Lion</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e0ffb687788204-7\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e0ffb687788204-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">roar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e0ffb687788204-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e0ffb687788204-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e0ffb687788204-11\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e0ffb687788204-12\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e0ffb687788204-13\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AsianLion</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Lion</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e0ffb687788204-14\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e0ffb687788204-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">roar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e0ffb687788204-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e0ffb687788204-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e0ffb687788204-18\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p>猎人希望可以狩猎任何实现 <code>Lion</code> 接口的狮子</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e1006619368311\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass Hunter\r\n{\r\n    public function hunt(Lion $lion)\r\n    {\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1006619368311-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1006619368311-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1006619368311-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1006619368311-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1006619368311-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1006619368311-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e1006619368311-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Hunter</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1006619368311-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1006619368311-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">hunt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Lion</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lion</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1006619368311-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1006619368311-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1006619368311-6\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>现在我们假定猎人在游戏中也可以狩猎<code>野狗</code>。但是目前我们无法实现，因为狗是通过其他接口实现。为了让猎人可以狩猎野狗，我们需要创建一个适配器，来兼容这种情况。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e100a925274416\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n// This needs to be added to the game\r\nclass WildDog\r\n{\r\n    public function bark()\r\n    {\r\n    }\r\n}\r\n\r\n// Adapter around wild dog to make it compatible with our game\r\nclass WildDogAdapter implements Lion\r\n{\r\n    protected $dog;\r\n\r\n    public function __construct(WildDog $dog)\r\n    {\r\n        $this-&gt;dog = $dog;\r\n    }\r\n\r\n    public function roar()\r\n    {\r\n        $this-&gt;dog-&gt;bark();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100a925274416-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100a925274416-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100a925274416-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100a925274416-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100a925274416-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100a925274416-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100a925274416-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100a925274416-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100a925274416-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100a925274416-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100a925274416-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100a925274416-23\">23</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-1\"><span class=\"crayon-c\">// This needs to be added to the game</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100a925274416-2\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WildDog</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100a925274416-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bark</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100a925274416-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-7\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100a925274416-8\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-9\"><span class=\"crayon-c\">// Adapter around wild dog to make it compatible with our game</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100a925274416-10\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WildDogAdapter</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Lion</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-11\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100a925274416-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dog</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100a925274416-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">WildDog</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dog</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100a925274416-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">dog</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dog</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100a925274416-18\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">roar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100a925274416-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">dog</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">bark</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100a925274416-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e100a925274416-23\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0020 seconds] -->\r\n<p>这样，在游戏中通过 <code>WildDogAdapter</code> 就可以使用 <code>WildDog</code></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e100d428832975\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">PHP</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$wildDog = new WildDog();\r\n$wildDogAdapter = new WildDogAdapter($wildDog);\r\n\r\n$hunter = new Hunter();\r\n$hunter-&gt;hunt($wildDogAdapter);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100d428832975-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100d428832975-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100d428832975-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e100d428832975-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e100d428832975-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e100d428832975-1\"><span class=\"crayon-v\">$wildDog</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WildDog</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100d428832975-2\"><span class=\"crayon-v\">$wildDogAdapter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WildDogAdapter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">$wildDog</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e100d428832975-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e100d428832975-4\"><span class=\"crayon-v\">$hunter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Hunter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e100d428832975-5\"><span class=\"crayon-v\">$hunter</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">hunt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">$wildDogAdapter</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p></p>\n<h3>🚡 桥接模式</h3>\n<h4>现实生活示例</h4>\n<p>假如你有一个网站，上面有不同的网页，并且允许用户更改主题。你会如何实现呢？是为每个页面的各个主题创建多个副本，还是创建单独的主题，并根据用户的偏好来加载主题呢？桥接模式可以帮你实现后者。</p>\n<p>不使用桥接模式</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/04/4b4f6fd843a5bfc7ee4880c5c9a71146.png\"><img src=\"http://jbcdn2.b0.upaiyun.com/2017/04/4b4f6fd843a5bfc7ee4880c5c9a71146-300x221.png\" alt=\"2\"></a> <a href=\"http://jbcdn2.b0.upaiyun.com/2017/04/6b0ea9d009344ad2311de1dfcdadcec0.png\"><img src=\"http://jbcdn2.b0.upaiyun.com/2017/04/6b0ea9d009344ad2311de1dfcdadcec0-300x221.png\" alt=\"1\"></a></p>\n<p>使用桥接模式</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/04/4b4f6fd843a5bfc7ee4880c5c9a71146.png\"><img src=\"http://jbcdn2.b0.upaiyun.com/2017/04/4b4f6fd843a5bfc7ee4880c5c9a71146-300x221.png\" alt=\"2\"></a></p>\n<h4>概述</h4>\n<p>桥接模式主打的是组合优于继承。实现细节从对象的层次结构推送给具有单独层次结构的另一个对象。</p>\n<h4>维基百科</h4>\n<p>桥接模式是软件工程中使用的设计模式，旨在“将抽象与实现分离，使得两者可以独立变化”</p>\n<p><strong>程序示例</strong></p>\n<p>以上面提到的网页为例，下面是 <code>WebPage</code> 的结构</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e1012869999548\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface WebPage\r\n{\r\n    public function __construct(Theme $theme);\r\n    public function getContent();\r\n}\r\n\r\nclass About implements WebPage\r\n{\r\n    protected $theme;\r\n\r\n    public function __construct(Theme $theme)\r\n    {\r\n        $this-&gt;theme = $theme;\r\n    }\r\n\r\n    public function getContent()\r\n    {\r\n        return \"About page in \" . $this-&gt;theme-&gt;getColor();\r\n    }\r\n}\r\n\r\nclass Careers implements WebPage\r\n{\r\n    protected $theme;\r\n\r\n    public function __construct(Theme $theme)\r\n    {\r\n        $this-&gt;theme = $theme;\r\n    }\r\n\r\n    public function getContent()\r\n    {\r\n        return \"Careers page in \" . $this-&gt;theme-&gt;getColor();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1012869999548-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1012869999548-35\">35</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebPage</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Theme</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">theme</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getContent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-6\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-7\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">About</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebPage</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-8\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">theme</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-10\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Theme</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">theme</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">theme</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">theme</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getContent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"About page in \"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">theme</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getColor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-20\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-22\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Careers</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebPage</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-23\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">theme</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-25\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Theme</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">theme</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">theme</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">theme</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-30\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getContent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Careers page in \"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">theme</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getColor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1012869999548-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1012869999548-35\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0036 seconds] -->\r\n<p>独立的 <code>主题</code> 结构</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e1018857582317\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface Theme\r\n{\r\n    public function getColor();\r\n}\r\n\r\nclass DarkTheme implements Theme\r\n{\r\n    public function getColor()\r\n    {\r\n        return 'Dark Black';\r\n    }\r\n}\r\nclass LightTheme implements Theme\r\n{\r\n    public function getColor()\r\n    {\r\n        return 'Off white';\r\n    }\r\n}\r\nclass AquaTheme implements Theme\r\n{\r\n    public function getColor()\r\n    {\r\n        return 'Light blue';\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1018857582317-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1018857582317-26\">26</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Theme</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getColor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-6\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DarkTheme</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Theme</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-7\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getColor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Dark Black'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-13\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">LightTheme</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Theme</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-14\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getColor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Off white'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-19\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-20\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AquaTheme</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Theme</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-21\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getColor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Light blue'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1018857582317-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1018857582317-26\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0021 seconds] -->\r\n<p>都是两层结构</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e101b460917291\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$darkTheme = new DarkTheme();\r\n\r\n$about = new About($darkTheme);\r\n$careers = new Careers($darkTheme);\r\n\r\necho $about-&gt;getContent(); // \"About page in Dark Black\";\r\necho $careers-&gt;getContent(); // \"Careers page in Dark Black\";</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101b460917291-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101b460917291-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101b460917291-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101b460917291-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101b460917291-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101b460917291-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101b460917291-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e101b460917291-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">darkTheme</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DarkTheme</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101b460917291-2\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e101b460917291-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">about</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">About</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">darkTheme</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101b460917291-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">careers</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Careers</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">darkTheme</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101b460917291-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101b460917291-6\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">about</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getContent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// \"About page in Dark Black\";</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101b460917291-7\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">careers</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getContent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// \"Careers page in Dark Black\";</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p></p>\n<h3>🌿 组合模式</h3>\n<h4>现实生活示例</h4>\n<p>每个公司都是由员工组成，每个员工都有一些共同特征比如薪资以及所承担的某些责任，会或者不会向其他人汇报工作，有或者没有下属等。</p>\n<h4>概述</h4>\n<p>组合模式让客户端以统一的方式对待各个对象。</p>\n<h4>维基百科</h4>\n<p>在软件工程中，组合模式是一种分治设计模式。组合模式对待一组对象的处理方式与对待对象的单个实例相同。组合的意图是将对象“组合”成树状结构以呈现<strong>部分-整体</strong>的层次结构。实现组合模式可以使客户端能够均匀地处理单个对象和组合。</p>\n<p><strong>程序示例</strong></p>\n<p>以上面提到的员工为例，下面是不同的员工类型</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e101f037134973\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface Employee\r\n{\r\n    public function __construct(string $name, float $salary);\r\n    public function getName(): string;\r\n    public function setSalary(float $salary);\r\n    public function getSalary(): float;\r\n    public function getRoles(): array;\r\n}\r\n\r\nclass Developer implements Employee\r\n{\r\n    protected $salary;\r\n    protected $name;\r\n\r\n    public function __construct(string $name, float $salary)\r\n    {\r\n        $this-&gt;name = $name;\r\n        $this-&gt;salary = $salary;\r\n    }\r\n\r\n    public function getName(): string\r\n    {\r\n        return $this-&gt;name;\r\n    }\r\n\r\n    public function setSalary(float $salary)\r\n    {\r\n        $this-&gt;salary = $salary;\r\n    }\r\n\r\n    public function getSalary(): float\r\n    {\r\n        return $this-&gt;salary;\r\n    }\r\n\r\n    public function getRoles(): array\r\n    {\r\n        return $this-&gt;roles;\r\n    }\r\n}\r\n\r\nclass Designer implements Employee\r\n{\r\n    protected $salary;\r\n    protected $name;\r\n\r\n    public function __construct(string $name, float $salary)\r\n    {\r\n        $this-&gt;name = $name;\r\n        $this-&gt;salary = $salary;\r\n    }\r\n\r\n    public function getName(): string\r\n    {\r\n        return $this-&gt;name;\r\n    }\r\n\r\n    public function setSalary(float $salary)\r\n    {\r\n        $this-&gt;salary = $salary;\r\n    }\r\n\r\n    public function getSalary(): float\r\n    {\r\n        return $this-&gt;salary;\r\n    }\r\n\r\n    public function getRoles(): array\r\n    {\r\n        return $this-&gt;roles;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e101f037134973-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e101f037134973-72\">72</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Employee</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">setSalary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSalary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getRoles</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-8\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-10\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Developer</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Employee</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-11\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-14\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">salary</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-20\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-25\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">setSalary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">salary</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-30\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSalary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-35\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-36\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getRoles</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-37\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-38\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">roles</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-39\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-40\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-41\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-42\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Designer</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Employee</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-43\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-44\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-45\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-46\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-47\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-48\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-49\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">salary</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-51\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-52\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-53\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-54\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-55\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-56\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-57\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-58\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">setSalary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-59\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-60\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">salary</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-61\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-62\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-63\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSalary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-64\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-65\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">salary</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-66\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-67\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-68\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getRoles</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-69\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-70\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">roles</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e101f037134973-71\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e101f037134973-72\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0083 seconds] -->\r\n<p><span style=\"font-weight: normal\">包含几种不同类型员工的公司</span></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e1023459588875\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass Organization\r\n{\r\n    protected $employees;\r\n\r\n    public function addEmployee(Employee $employee)\r\n    {\r\n        $this-&gt;employees[] = $employee;\r\n    }\r\n\r\n    public function getNetSalaries(): float\r\n    {\r\n        $netSalary = 0;\r\n\r\n        foreach ($this-&gt;employees as $employee) {\r\n            $netSalary += $employee-&gt;getSalary();\r\n        }\r\n\r\n        return $netSalary;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1023459588875-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1023459588875-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1023459588875-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1023459588875-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1023459588875-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1023459588875-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1023459588875-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1023459588875-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1023459588875-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1023459588875-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1023459588875-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1023459588875-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1023459588875-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1023459588875-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1023459588875-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1023459588875-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1023459588875-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1023459588875-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1023459588875-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1023459588875-20\">20</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e1023459588875-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Organization</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1023459588875-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1023459588875-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">employees</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1023459588875-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1023459588875-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">addEmployee</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Employee</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">employee</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1023459588875-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1023459588875-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">employees</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">employee</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1023459588875-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1023459588875-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1023459588875-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getNetSalaries</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1023459588875-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1023459588875-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">netSalary</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1023459588875-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1023459588875-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">foreach</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">employees </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">employee</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1023459588875-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">netSalary</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">employee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getSalary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1023459588875-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1023459588875-17\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1023459588875-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">netSalary</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1023459588875-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1023459588875-20\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0023 seconds] -->\r\n<p>然后可以这样调用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e1029245276548\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n// Prepare the employees\r\n$john = new Developer('John Doe', 12000);\r\n$jane = new Designer('Jane Doe', 15000);\r\n\r\n// Add them to organization\r\n$organization = new Organization();\r\n$organization-&gt;addEmployee($john);\r\n$organization-&gt;addEmployee($jane);\r\n\r\necho \"Net salaries: \" . $organization-&gt;getNetSalaries(); // Net Salaries: 27000</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1029245276548-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1029245276548-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1029245276548-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1029245276548-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1029245276548-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1029245276548-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1029245276548-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1029245276548-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1029245276548-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1029245276548-10\">10</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e1029245276548-1\"><span class=\"crayon-c\">// Prepare the employees</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1029245276548-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">john</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Developer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'John Doe'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">12000</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1029245276548-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jane</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Designer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Jane Doe'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">15000</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1029245276548-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1029245276548-5\"><span class=\"crayon-c\">// Add them to organization</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1029245276548-6\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">organization</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Organization</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1029245276548-7\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">organization</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">addEmployee</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">john</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1029245276548-8\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">organization</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">addEmployee</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jane</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1029245276548-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1029245276548-10\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Net salaries: \"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">organization</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getNetSalaries</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Net Salaries: 27000</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0018 seconds] -->\r\n<p></p>\n<h3>☕ 装饰器模式</h3>\n<h4>现实生活示例</h4>\n<p>想象一下，你在经营一家提供多种服务的汽车服务站。现在如何计算收费帐单呢？选择一项服务，并动态地向其添加价格，直到获得最终成本。这里每种类型的服务就是装饰器。</p>\n<h4>概述</h4>\n<p>通过将对象包装在装饰器类的对象中，装饰器模式可以在运行时动态地更改对象的行为。</p>\n<h4>维基百科</h4>\n<p>装饰器模式，是面向对象编程领域中，一种动态地或静态地往一个类中添加新行为而不影响相同类中其他对象的设计模式。装饰器模式对于遵守单一责任原则通常是有用的，因为它允许在具有独特领域的类之间划分功能。</p>\n<p><strong>程序示例</strong></p>\n<p>我们以咖啡为例，首先我们通过咖啡接口实现一个简单咖啡</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e102d451258859\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface Coffee\r\n{\r\n    public function getCost();\r\n    public function getDescription();\r\n}\r\n\r\nclass SimpleCoffee implements Coffee\r\n{\r\n    public function getCost()\r\n    {\r\n        return 10;\r\n    }\r\n\r\n    public function getDescription()\r\n    {\r\n        return 'Simple coffee';\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e102d451258859-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e102d451258859-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e102d451258859-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e102d451258859-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e102d451258859-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e102d451258859-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e102d451258859-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e102d451258859-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e102d451258859-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e102d451258859-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e102d451258859-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e102d451258859-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e102d451258859-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e102d451258859-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e102d451258859-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e102d451258859-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e102d451258859-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e102d451258859-18\">18</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e102d451258859-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Coffee</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e102d451258859-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e102d451258859-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e102d451258859-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e102d451258859-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e102d451258859-6\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e102d451258859-7\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SimpleCoffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Coffee</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e102d451258859-8\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e102d451258859-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e102d451258859-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e102d451258859-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e102d451258859-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e102d451258859-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e102d451258859-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e102d451258859-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e102d451258859-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Simple coffee'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e102d451258859-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e102d451258859-18\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p>我们希望代码可扩展，以允许选项在需要时进行修改。 增加一些附加项（装饰器）</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e103b963805305\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass MilkCoffee implements Coffee\r\n{\r\n    protected $coffee;\r\n\r\n    public function __construct(Coffee $coffee)\r\n    {\r\n        $this-&gt;coffee = $coffee;\r\n    }\r\n\r\n    public function getCost()\r\n    {\r\n        return $this-&gt;coffee-&gt;getCost() + 2;\r\n    }\r\n\r\n    public function getDescription()\r\n    {\r\n        return $this-&gt;coffee-&gt;getDescription() . ', milk';\r\n    }\r\n}\r\n\r\nclass WhipCoffee implements Coffee\r\n{\r\n    protected $coffee;\r\n\r\n    public function __construct(Coffee $coffee)\r\n    {\r\n        $this-&gt;coffee = $coffee;\r\n    }\r\n\r\n    public function getCost()\r\n    {\r\n        return $this-&gt;coffee-&gt;getCost() + 5;\r\n    }\r\n\r\n    public function getDescription()\r\n    {\r\n        return $this-&gt;coffee-&gt;getDescription() . ', whip';\r\n    }\r\n}\r\n\r\nclass VanillaCoffee implements Coffee\r\n{\r\n    protected $coffee;\r\n\r\n    public function __construct(Coffee $coffee)\r\n    {\r\n        $this-&gt;coffee = $coffee;\r\n    }\r\n\r\n    public function getCost()\r\n    {\r\n        return $this-&gt;coffee-&gt;getCost() + 3;\r\n    }\r\n\r\n    public function getDescription()\r\n    {\r\n        return $this-&gt;coffee-&gt;getDescription() . ', vanilla';\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e103b963805305-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e103b963805305-59\">59</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MilkCoffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Coffee</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Coffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-14\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">', milk'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-19\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-20\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-21\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WhipCoffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Coffee</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-22\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-24\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Coffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-29\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">5</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-33\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-34\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-36\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-37\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">', whip'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-38\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-39\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-40\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-41\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">VanillaCoffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Coffee</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-42\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-43\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-44\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-45\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Coffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-46\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-47\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-48\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-49\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-50\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-51\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-52\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-53\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-54\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-55\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-56\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">coffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">', vanilla'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e103b963805305-58\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e103b963805305-59\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0063 seconds] -->\r\n<p>下面我们来做杯咖啡吧</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e1040259997216\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$someCoffee = new SimpleCoffee();\r\necho $someCoffee-&gt;getCost(); // 10\r\necho $someCoffee-&gt;getDescription(); // Simple Coffee\r\n\r\n$someCoffee = new MilkCoffee($someCoffee);\r\necho $someCoffee-&gt;getCost(); // 12\r\necho $someCoffee-&gt;getDescription(); // Simple Coffee, milk\r\n\r\n$someCoffee = new WhipCoffee($someCoffee);\r\necho $someCoffee-&gt;getCost(); // 17\r\necho $someCoffee-&gt;getDescription(); // Simple Coffee, milk, whip\r\n\r\n$someCoffee = new VanillaCoffee($someCoffee);\r\necho $someCoffee-&gt;getCost(); // 20\r\necho $someCoffee-&gt;getDescription(); // Simple Coffee, milk, whip, vanilla</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1040259997216-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1040259997216-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1040259997216-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1040259997216-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1040259997216-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1040259997216-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1040259997216-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1040259997216-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1040259997216-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1040259997216-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1040259997216-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1040259997216-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1040259997216-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1040259997216-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1040259997216-15\">15</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e1040259997216-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SimpleCoffee</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1040259997216-2\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 10</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1040259997216-3\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Simple Coffee</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1040259997216-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1040259997216-5\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MilkCoffee</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1040259997216-6\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 12</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1040259997216-7\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Simple Coffee, milk</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1040259997216-8\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1040259997216-9\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WhipCoffee</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1040259997216-10\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 17</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1040259997216-11\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Simple Coffee, milk, whip</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1040259997216-12\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1040259997216-13\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">VanillaCoffee</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1040259997216-14\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getCost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// 20</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1040259997216-15\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">someCoffee</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Simple Coffee, milk, whip, vanilla</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0031 seconds] -->\r\n<p></p>\n<h3>📦 外观模式</h3>\n<h4>现实生活示例</h4>\n<p>请问你会如何打开计算机呢？你会回答：“按电源键就行！”。你会这样想是因为你在使用计算机对外提供的简易接口，但是在内部，计算机完成了很多工作后才得以启动，这种复杂子系统的简单接口就是外观模式。</p>\n<h4>概述</h4>\n<p>外观模式提供了一个简化复杂系统的简单接口。</p>\n<h4>维基百科</h4>\n<p>外观模式是指针对像类库这种大体积代码提供简化接口的对象。</p>\n<p><strong>程序示例</strong></p>\n<p>以上面提到的计算机为例，给出计算机类</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e1047765457970\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass Computer\r\n{\r\n    public function getElectricShock()\r\n    {\r\n        echo \"Ouch!\";\r\n    }\r\n\r\n    public function makeSound()\r\n    {\r\n        echo \"Beep beep!\";\r\n    }\r\n\r\n    public function showLoadingScreen()\r\n    {\r\n        echo \"Loading..\";\r\n    }\r\n\r\n    public function bam()\r\n    {\r\n        echo \"Ready to be used!\";\r\n    }\r\n\r\n    public function closeEverything()\r\n    {\r\n        echo \"Bup bup bup buzzzz!\";\r\n    }\r\n\r\n    public function sooth()\r\n    {\r\n        echo \"Zzzzz\";\r\n    }\r\n\r\n    public function pullCurrent()\r\n    {\r\n        echo \"Haaah!\";\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1047765457970-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1047765457970-37\">37</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Computer</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getElectricShock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Ouch!\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">makeSound</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Beep beep!\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-12\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">showLoadingScreen</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Loading..\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-17\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bam</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Ready to be used!\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-22\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">closeEverything</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Bup bup bup buzzzz!\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-27\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sooth</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Zzzzz\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-32\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-33\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">pullCurrent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Haaah!\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1047765457970-36\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1047765457970-37\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0031 seconds] -->\r\n<p>下面是计算机的外观</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e104b780541843\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass ComputerFacade\r\n{\r\n    protected $computer;\r\n\r\n    public function __construct(Computer $computer)\r\n    {\r\n        $this-&gt;computer = $computer;\r\n    }\r\n\r\n    public function turnOn()\r\n    {\r\n        $this-&gt;computer-&gt;getElectricShock();\r\n        $this-&gt;computer-&gt;makeSound();\r\n        $this-&gt;computer-&gt;showLoadingScreen();\r\n        $this-&gt;computer-&gt;bam();\r\n    }\r\n\r\n    public function turnOff()\r\n    {\r\n        $this-&gt;computer-&gt;closeEverything();\r\n        $this-&gt;computer-&gt;pullCurrent();\r\n        $this-&gt;computer-&gt;sooth();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104b780541843-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104b780541843-24\">24</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ComputerFacade</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">computer</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Computer</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">computer</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">computer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">computer</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">turnOn</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">computer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getElectricShock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">computer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">makeSound</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">computer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">showLoadingScreen</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">computer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">bam</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-17\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">turnOff</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">computer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">closeEverything</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">computer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">pullCurrent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">computer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sooth</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e104b780541843-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104b780541843-24\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0031 seconds] -->\r\n<p>可以这样使用外观模式</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e104f368846957\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$computer = new ComputerFacade(new Computer());\r\n$computer-&gt;turnOn(); // Ouch! Beep beep! Loading.. Ready to be used!\r\n$computer-&gt;turnOff(); // Bup bup buzzz! Haah! Zzzzz</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104f368846957-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e104f368846957-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e104f368846957-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e104f368846957-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">computer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ComputerFacade</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Computer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e104f368846957-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">computer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">turnOn</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Ouch! Beep beep! Loading.. Ready to be used!</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e104f368846957-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">computer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">turnOff</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Bup bup buzzz! Haah! Zzzzz</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p></p>\n<h3>🍃 享元模式</h3>\n<h4>现实生活示例</h4>\n<p>你是否在某个摊位上喝过茶？店主总是会多做一些茶，以预留给其他顾客，以此来节省资源比如燃气。享元模式所讲的就是共享。</p>\n<h4>概述</h4>\n<p>享元模式通过相似对象之间尽可能的资源共享，来最小化内存使用或计算开销。</p>\n<h4>维基百科</h4>\n<p>在计算机编程中，享元模式是一种软件设计模式。享元模式是通过与其他类似对象共享尽可能多的数据来最小化内存使用的对象; 当简单的重复对象过多占用内存时，可以通过享元模式来处理大量相似对象的情况。</p>\n<p><strong>程序示例</strong></p>\n<p>以茶为例，首先定义茶的种类及茶具</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e1053872722701\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n// Anything that will be cached is flyweight.\r\n// Types of tea here will be flyweights.\r\nclass KarakTea\r\n{\r\n}\r\n\r\n// Acts as a factory and saves the tea\r\nclass TeaMaker\r\n{\r\n    protected $availableTea = [];\r\n\r\n    public function make($preference)\r\n    {\r\n        if (empty($this-&gt;availableTea[$preference])) {\r\n            $this-&gt;availableTea[$preference] = new KarakTea();\r\n        }\r\n\r\n        return $this-&gt;availableTea[$preference];\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1053872722701-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1053872722701-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1053872722701-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1053872722701-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1053872722701-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1053872722701-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1053872722701-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1053872722701-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1053872722701-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1053872722701-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1053872722701-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1053872722701-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1053872722701-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1053872722701-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1053872722701-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1053872722701-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1053872722701-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1053872722701-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1053872722701-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1053872722701-20\">20</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e1053872722701-1\"><span class=\"crayon-c\">// Anything that will be cached is flyweight.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1053872722701-2\"><span class=\"crayon-c\">// Types of tea here will be flyweights.</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1053872722701-3\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">KarakTea</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1053872722701-4\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1053872722701-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1053872722701-6\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1053872722701-7\"><span class=\"crayon-c\">// Acts as a factory and saves the tea</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1053872722701-8\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TeaMaker</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1053872722701-9\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1053872722701-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">availableTea</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1053872722701-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1053872722701-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">make</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">preference</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1053872722701-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1053872722701-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">empty</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">availableTea</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">preference</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1053872722701-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">availableTea</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">preference</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">KarakTea</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1053872722701-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1053872722701-17\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1053872722701-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">availableTea</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">preference</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1053872722701-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1053872722701-20\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0023 seconds] -->\r\n<p>然后定义茶店来接单及提供服务</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e1056001195066\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass TeaShop\r\n{\r\n    protected $orders;\r\n    protected $teaMaker;\r\n\r\n    public function __construct(TeaMaker $teaMaker)\r\n    {\r\n        $this-&gt;teaMaker = $teaMaker;\r\n    }\r\n\r\n    public function takeOrder(string $teaType, int $table)\r\n    {\r\n        $this-&gt;orders[$table] = $this-&gt;teaMaker-&gt;make($teaType);\r\n    }\r\n\r\n    public function serve()\r\n    {\r\n        foreach ($this-&gt;orders as $table =&gt; $tea) {\r\n            echo \"Serving tea to table# \" . $table;\r\n        }\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1056001195066-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1056001195066-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1056001195066-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1056001195066-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1056001195066-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1056001195066-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1056001195066-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1056001195066-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1056001195066-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1056001195066-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1056001195066-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1056001195066-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1056001195066-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1056001195066-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1056001195066-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1056001195066-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1056001195066-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1056001195066-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1056001195066-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1056001195066-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1056001195066-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1056001195066-22\">22</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e1056001195066-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TeaShop</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1056001195066-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1056001195066-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">orders</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1056001195066-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">teaMaker</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1056001195066-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1056001195066-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">TeaMaker</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">teaMaker</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1056001195066-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1056001195066-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">teaMaker</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">teaMaker</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1056001195066-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1056001195066-10\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1056001195066-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">takeOrder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">teaType</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">table</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1056001195066-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1056001195066-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">orders</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">table</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">teaMaker</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">make</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">teaType</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1056001195066-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1056001195066-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1056001195066-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">serve</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1056001195066-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1056001195066-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">foreach</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">orders </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">table</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">tea</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1056001195066-19\"><span class=\"crayon-h\">            </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Serving tea to table# \"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">table</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1056001195066-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1056001195066-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1056001195066-22\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0031 seconds] -->\r\n<p>下面可以这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e105a017976163\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$teaMaker = new TeaMaker();\r\n$shop = new TeaShop($teaMaker);\r\n\r\n$shop-&gt;takeOrder('less sugar', 1);\r\n$shop-&gt;takeOrder('more milk', 2);\r\n$shop-&gt;takeOrder('without sugar', 5);\r\n\r\n$shop-&gt;serve();\r\n// Serving tea to table# 1\r\n// Serving tea to table# 2\r\n// Serving tea to table# 5</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105a017976163-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105a017976163-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105a017976163-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105a017976163-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105a017976163-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105a017976163-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105a017976163-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105a017976163-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105a017976163-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105a017976163-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105a017976163-11\">11</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e105a017976163-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">teaMaker</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TeaMaker</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105a017976163-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">shop</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TeaShop</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">teaMaker</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105a017976163-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105a017976163-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">shop</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">takeOrder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'less sugar'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105a017976163-5\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">shop</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">takeOrder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'more milk'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105a017976163-6\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">shop</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">takeOrder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'without sugar'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">5</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105a017976163-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105a017976163-8\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">shop</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">serve</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105a017976163-9\"><span class=\"crayon-c\">// Serving tea to table# 1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105a017976163-10\"><span class=\"crayon-c\">// Serving tea to table# 2</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105a017976163-11\"><span class=\"crayon-c\">// Serving tea to table# 5</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p></p>\n<h3>🎱 代理模式</h3>\n<h4>现实生活示例</h4>\n<p>有没有过使用门禁卡进门的经历呢？打开门的方法有多种，既可以使用门禁卡，也可以按下门上的安全按钮。门的主要功能是打开，但在其上添加一个代理，便可以给门添加一些功能。下面的代码示例可以给出更好的解释。</p>\n<h4>概述</h4>\n<p>使用代理模式，一个类可以代理另外一个类的功能。</p>\n<h4>维基百科</h4>\n<p>一个代理，其最一般的形式，是一个作为其他类接口的类。代理是由客户端调用的包装器或代理对象，用来访问幕后的真实服务对象。使用代理可以简单地向真实对象做转发，或者可以提供额外的逻辑。在代理模式中，可以提供额外的功能，例如当在真实对象上的操作是资源密集型时进行缓存，或者在调用真实对象的操作之前进行预处理。</p>\n<p><strong>程序示例</strong></p>\n<p>以安全门为例，首先给出安全门接口及实现</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e105e695817389\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface Door\r\n{\r\n    public function open();\r\n    public function close();\r\n}\r\n\r\nclass LabDoor implements Door\r\n{\r\n    public function open()\r\n    {\r\n        echo \"Opening lab door\";\r\n    }\r\n\r\n    public function close()\r\n    {\r\n        echo \"Closing the lab door\";\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105e695817389-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105e695817389-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105e695817389-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105e695817389-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105e695817389-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105e695817389-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105e695817389-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105e695817389-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105e695817389-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105e695817389-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105e695817389-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105e695817389-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105e695817389-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105e695817389-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105e695817389-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105e695817389-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e105e695817389-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e105e695817389-18\">18</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e105e695817389-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Door</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105e695817389-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105e695817389-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105e695817389-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">close</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105e695817389-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105e695817389-6\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e105e695817389-7\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">LabDoor</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Door</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105e695817389-8\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105e695817389-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105e695817389-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105e695817389-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Opening lab door\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105e695817389-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105e695817389-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105e695817389-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">close</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105e695817389-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105e695817389-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Closing the lab door\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e105e695817389-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e105e695817389-18\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p>然后使用代理来确保门的安全</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e1061307281197\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass Security\r\n{\r\n    protected $door;\r\n\r\n    public function __construct(Door $door)\r\n    {\r\n        $this-&gt;door = $door;\r\n    }\r\n\r\n    public function open($password)\r\n    {\r\n        if ($this-&gt;authenticate($password)) {\r\n            $this-&gt;door-&gt;open();\r\n        } else {\r\n            echo \"Big no! It ain't possible.\";\r\n        }\r\n    }\r\n\r\n    public function authenticate($password)\r\n    {\r\n        return $password === '$ecr@t';\r\n    }\r\n\r\n    public function close()\r\n    {\r\n        $this-&gt;door-&gt;close();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1061307281197-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1061307281197-28\">28</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Security</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Door</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">door</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">password</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">authenticate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">password</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-13\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">door</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Big no! It ain't possible.\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-18\"> </div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">authenticate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">password</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">password</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'$ecr@t'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-23\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">close</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">door</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">close</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1061307281197-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1061307281197-28\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0032 seconds] -->\r\n<p>可以这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c28e8e1065380845497\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$door = new Security(new LabDoor());\r\n$door-&gt;open('invalid'); // Big no! It ain't possible.\r\n\r\n$door-&gt;open('$ecr@t'); // Opening lab door\r\n$door-&gt;close(); // Closing lab door</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1065380845497-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1065380845497-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1065380845497-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c28e8e1065380845497-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c28e8e1065380845497-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c28e8e1065380845497-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Security</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">LabDoor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1065380845497-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'invalid'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Big no! It ain't possible.</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1065380845497-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c28e8e1065380845497-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'$ecr@t'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Opening lab door</span></div><div class=\"crayon-line\" id=\"crayon-596c28e8e1065380845497-5\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">close</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Closing lab door</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p>另一个例子是实现某种数据映射器。例如，我最近使用这种模式为 MongoDB 做了一个 ODM（对象数据映射器），其中我使用魔术方法<code>__call（）</code> 在 mongo 类上编写代理。所有的方法调用被代理到原始的 mongo 类，并且检索的结果原样返回，但如果调用 <code>find</code> 或 <code>findOne</code> ，数据会被映射到所需的类对象，并且返回了对象而不是<code>Cursor</code>。</p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/06/a9e67955472c1afcad111aa202984192.jpg\">\n            \n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111798\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111798votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111798\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/justin_ygg\">Justin_YGG</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/justin_ygg\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2016/06/4302cabf679254e36d325f1d9185b6c72.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            Python工程师一枚，对go、docker感兴趣，还在成长ing~~        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/justin_ygg\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/justin_ygg/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/justin_ygg/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 15</a>        </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "DB 分库分表（3）：关于使用框架还是自主开发以及 sharding 实现层面的考量", "url": "http://blog.jobbole.com/111869/", "url_object_id": "268ed36a9d88d05b0a9312d6a01644d8", "create_date": "2017/07/17 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2012/03/database-logo.png"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "IT技术,分库分表,数据库", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.csdn.net/bluishglc/article/details/7766508\">Laurence的技术博客</a>   </div><p>当团队对系统业务和数据库进行了细致的梳理，确定了切分方案后，接下来的问题就是如何去实现切分方案了，目前在sharding方面有不少的开源框架和产品可供参考，同时很多团队也会选择自主开发实现，而不管是选择框架还是自主开发，都会面临一个在哪一层上实现sharding逻辑的问题，本文会对这一系列的问题逐一进行分析和考量。<br>\n一、sharding逻辑的实现层面</p>\n<p>从一个系统的程序架构层面来看，sharding逻辑可以在DAO层、JDBC API层、介于DAO与JDBC之间的Spring数据访问封装层(各种spring的template)以及介于应用服务器与数据库之间的sharding代理服务器四个层面上实现。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/90c47aa9156611bbeb56a649c14a6337.jpg\" alt=\"\"></p>\n<p style=\"text-align: center\">图1. Sharding实现层面与相关框架/产品</p>\n<div>\n<ul>\n<li>在DAO层实现</li>\n</ul>\n</div>\n<p>当团队决定自行实现sharding的时候，DAO层可能是嵌入sharding逻辑的首选位置，因为在这个层面上，每一个DAO的方法都明确地知道需要访问的数据表以及查询参数，借助这些信息可以直接定位到目标shard上，而不必像框架那样需要对SQL进行解析然后再依据配置的规则进行路由。另一个优势是不会受ORM框架的制约。由于现在的大多数应用在数据访问层上会依赖某种ORM框架，而多数的shrading框架往往无法支持或只能支持一种orm框架，这使得在选择和应用框架时受到了很大的制约，而自行实现sharding完全没有这方面的问题，甚至不同的shard使用不同的orm框架都可以在一起协调工作。比如现在的java应用大多使用hibernate，但是当下还没有非常令人满意的基于hibernate的sharding框架，（关于hibernate hards会在下文介绍），因此很多团队会选择自行实现sharding。</p>\n<p>简单总结一下，在DAO层自行实现sharding的优势在于：不受ORM框架的制约、实现起来较为简单、易于根据系统特点进行灵活的定制、无需SQL解析和路由规则匹配，性能上表现会稍好一些;劣势在于：有一定的技术门槛，工作量比依靠框架实现要大(反过来看，框架会有学习成本)、不通用，只能在特定系统里工作。当然，在DAO层同样可以通过XML配置或是注解将sharding逻辑抽离到“外部”，形成一套通用的框架. 不过目前还没有出现此类的框架。</p>\n<ul>\n<li>在ORM框架层实现</li>\n</ul>\n<p>在ORM框架层实现sharding有两个方向，一个是在实现O-R Mapping的前提下同时提供sharding支持，从而定位为一种分布式的数据访问框架，这一类类型的框架代表就是<a href=\"http://code.google.com/p/guzz/\" target=\"_blank\">guzz</a>另一个方向是通过对既有ORM框架进行修改增强来加入sharding机制。此类型的代表产品是<a href=\"http://www.hibernate.org/subprojects/shards.html\" target=\"_blank\">hibernate shard</a>. 应该说以hibernate这样主流的地位，行业对于一款面向hibernate的sharding框架的需求是非常迫切的，但是就目前的hibernate shards来看，表现还算不上令人满意，主要是它对使用hibernate的限制过多，比如它对HQL的支持就非常有限。在mybatis方面，目前还没有成熟的相关框架产生。有人提出利用mybatis的插件机制实现sharding,但是遗憾的是，mybatis的插件机制控制不到多数据源的连接层面，另一方面，离开插件层又失去了对sql进行集中解析和路由的机会，因此在mybatis框架上，目前还没有可供借鉴的框架，团队可能要在DAO层或Spring模板类上下功夫了。</p>\n<ul>\n<li>在JDBC API层实现</li>\n</ul>\n<p>JDBC API层是很多人都会想到的一个实现sharding的绝佳场所，如果我们能提供一个实现了sharding逻辑的JDBC API实现，那么sharding对于整个应用程序来说就是完全透明的，而这样的实现可以直接作为通用的sharding产品了。但是这种方案的技术门槛和工作量显然不是一般团队能做得来的，因此基本上没有团队会在这一层面上实现sharding,甚至也没有此类的开源产品。笔者知道的只有一款商业产品<a href=\"http://www.dbshards.com/\" target=\"_blank\">dbShards</a>采用的是这一方案。</p>\n<ul>\n<li>在介于DAO与JDBC之间的Spring数据访问封装层实现</li>\n</ul>\n<p>在springd大行其道的今天，几乎没有哪个java平台上构建的应用不使用spring，在DAO与JDBC之间，spring提供了各种template来管理资源的创建与释放以及与事务的同步，大多数基于spring的应用都会使用template类做为数据访问的入口，这给了我们另一个嵌入sharding逻辑的机会，就是通过提供一个嵌入了sharding逻辑的template类来完成sharding工作.这一方案在效果上与基于JDBC API实现的方案基本一致，同样是对上层代码透明，在进行sharding改造时可以平滑地过度，但它的实现却比基于JDBC API的方式简单，因此成为了不少框架的选择，阿里集团研究院开源的<a href=\"http://write.blog.csdn.net/postedit/code.alibabatech.com/wiki/display/CobarClient/Home\" target=\"_blank\">Cobar Client</a>就是这类方案的一种实现。</p>\n<ul>\n<li>在应用服务器与数据库之间通过代理实现</li>\n</ul>\n<p>在应用服务器与数据库之间加入一个代理，应用程序向数据发出的数据请求会先通过代理，代理会根据配置的路由规则，对SQL进行解析后路由到目标shard，因为这种方案对应用程序完全透明，通用性好，所以成为了很多sharding产品的选择。在这方面较为知名的产品是mysql官方的代理工具：<a href=\"http://dev.mysql.com/doc/refman/5.6/en/mysql-proxy.html\" target=\"_blank\">Mysql Proxy</a>和一款国人开发的产品:<a href=\"http://code.google.com/p/amoeba/\" target=\"_blank\">amoeba</a>。mysql proxy本身并没有实现任何sharding逻辑，它只是作为一种面向mysql数据库的代理，给开发人员提供了一个嵌入sharding逻辑的场所，它使用lua作为编程语言，这对很多团队来说是需要考虑的一个问题。amoeba则是专门实现读写分离与sharding的代理产品，它使用非常简单，不使用任何编程语言，只需要通过xml进行配置。不过amoeba不支持事务(从应用程序发出的包含事务信息的请求到达amoeba时，事务信息会被抹去，因此，即使是单点数据访问也不会有事务存在)一直是个硬伤。当然，这要看产品的定位和设计理念，我们只能说对于那些对事务要求非常高的系统，amoeba是不适合的。</p>\n<p>二、使用框架还是自主开发？</p>\n<p>前面的讨论中已经罗列了很多开源框架与产品，这里再整理一下：基于代理方式的有MySQL Proxy和Amoeba，基于Hibernate框架的是Hibernate Shards，通过重写spring的ibatis template类是Cobar Client，这些框架各有各的优势与短板，架构师可以在深入调研之后结合项目的实际情况进行选择，但是总的来说，我个人对于框架的选择是持谨慎态度的。一方面多数框架缺乏成功案例的验证，其成熟性与稳定性值得怀疑。另一方面，一些从成功商业产品开源出框架（如阿里和淘宝的一些开源项目）是否适合你的项目是需要架构师深入调研分析的。当然，最终的选择一定是基于项目特点、团队状况、技术门槛和学习成本等综合因素考量确定的。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111869\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111869votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111869\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "人人都能读懂的设计模式（1）：创建型模式", "url": "http://blog.jobbole.com/111799/", "url_object_id": "f9e2bacb3eaf303d2c4a39b8317c2d02", "create_date": "2017/07/14 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/01/31cb3a52c5acdbdd13fd045f07cabb23.jpg"], "praise_nums": "3", "comment_nums": 0, "fav_nums": 2, "tags": "IT技术,设计模式", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/justin_ygg\">Justin_YGG</a> 翻译。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://github.com/kamranahmedse/design-patterns-for-humans\">kamranahmedse</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><h3>简介</h3>\n<p>设计模式用于解决反复出现的问题，是解决特定问题的指导方针。设计模式不是在应用中引用的类、package 或者库，而是在某些特定场景下解决特定问题的指导方针。</p>\n<p>设计模式用于解决反复出现的问题，是解决某些特定问题的指导方针。</p>\n<p>维基百科中这样描述设计模式：</p>\n<blockquote><p>在软件工程中，设计模式是针对软件设计中普遍存在（反复出现）的各种问题，所提出的可复用型解决方案。设计模式并不直接完成代码的编写，而是描述在不同情况下如何解决问题。</p></blockquote>\n<h3>注意</h3>\n<ul>\n<li>设计模式并非解决所有问题的银弹。</li>\n<li>不要强制使用设计模式，否则结果可能适得其反。谨记：设计模式是用来解决问题的，而不是来寻找问题的，不要过度思考。</li>\n<li>如果在对的地方对的时机使用设计模式，它会是你的救世主。反之，将会一团糟。</li>\n</ul>\n<p>另注：下面的示例代码是用 PHP7 实现的，因为概念是一样的，所以语言并不会阻碍你理解设计模式。其他语言版本的实现正在进行中。</p>\n<h3>设计模式分类</h3>\n<ul>\n<li>创建型模式</li>\n<li>结构型模式</li>\n<li>行为型模式</li>\n</ul>\n<h3>创建型模式</h3>\n<h4>概述</h4>\n<p>创建型模式专注于如何初始化对象 。</p>\n<h4>维基百科</h4>\n<p>在软件工程中，创建型模式是处理对象创建的设计模式，试图根据实际情况使用合适的方式创建对象。基本的对象创建方式可能会导致设计上的问题，或增加设计的复杂度。创建型模式通过以某种方式控制对象的创建来解决这些问题。</p>\n<p><strong>分类</strong></p>\n<ul>\n<li>简单工厂模式</li>\n<li>工厂方法模式</li>\n<li>抽象工厂模式</li>\n<li>生成器模式</li>\n<li>原型模式</li>\n<li>单例模式</li>\n</ul>\n<h3>🏠 简单工厂模式</h3>\n<h4>现实生活示例</h4>\n<p>想象一下，你正在建造一座房子而且需要几扇房门，如果每次需要房门的时候，不是用工厂制造的房门，而是穿上木匠服，然后开始自己制造房门，将会搞得一团糟。</p>\n<h4>概述</h4>\n<p>简单工厂模式只是为客户端创建实例，而不将任何实例化逻辑暴露给客户端。</p>\n<h4>维基百科</h4>\n<p>在面向对象程序设计中，工厂通常是一个用来创建其他对象的对象。通常来讲，工厂是指某个功能或方法，此功能或方法返回不同类型的对象或者类的某个方法调用，返回的东西看起来是「新的」。</p>\n<p><strong>程序示例</strong></p>\n<p>首先是<code>房门</code>的接口和实现</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8adf366317378\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">PHP</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface Door\r\n{\r\n    public function getWidth(): float;\r\n    public function getHeight(): float;\r\n}\r\n\r\nclass WoodenDoor implements Door\r\n{\r\n    protected $width;\r\n    protected $height;\r\n\r\n    public function __construct(float $width, float $height)\r\n    {\r\n        $this-&gt;width = $width;\r\n        $this-&gt;height = $height;\r\n    }\r\n\r\n    public function getWidth(): float\r\n    {\r\n        return $this-&gt;width;\r\n    }\r\n\r\n    public function getHeight(): float\r\n    {\r\n        return $this-&gt;height;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8adf366317378-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8adf366317378-27\">27</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Door</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getWidth</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getHeight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-6\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-7\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WoodenDoor</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Door</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-8\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$width</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$height</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$width</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$height</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">$this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-i\">width</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$width</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">$this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-i\">height</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$height</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-17\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getWidth</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-k \">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-i\">width</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-22\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getHeight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-k \">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-i\">height</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8adf366317378-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8adf366317378-27\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0039 seconds] -->\r\n<p>然后是生产房门的工厂</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8aeb013374657\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass DoorFactory\r\n{\r\n    public static function makeDoor($width, $height): Door\r\n    {\r\n        return new WoodenDoor($width, $height);\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8aeb013374657-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8aeb013374657-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8aeb013374657-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8aeb013374657-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8aeb013374657-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8aeb013374657-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8aeb013374657-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8aeb013374657-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoorFactory</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8aeb013374657-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8aeb013374657-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">makeDoor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">width</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">height</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Door</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8aeb013374657-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8aeb013374657-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WoodenDoor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">width</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">height</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8aeb013374657-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8aeb013374657-7\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p>这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8aef142217502\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$door = DoorFactory::makeDoor(100, 200);\r\necho 'Width: ' . $door-&gt;getWidth();\r\necho 'Height: ' . $door-&gt;getHeight();</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8aef142217502-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8aef142217502-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8aef142217502-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8aef142217502-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DoorFactory</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">makeDoor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">100</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8aef142217502-2\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Width: '</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getWidth</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8aef142217502-3\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Height: '</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getHeight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p><strong>何时使用？</strong></p>\n<p>如果创建对象不仅仅是一些变量的初始化，还涉及某些逻辑，那么将其封装到一个专用工厂中取代随处使用的重复代码是有意义的。</p>\n<h3>🏭 工厂方法模式</h3>\n<h4>现实生活示例</h4>\n<p>考虑招聘经理的情况。一个人不可能应付所有职位的面试，对于空缺职位，招聘经理必须委派不同的人去面试。</p>\n<h4>概述</h4>\n<p>工厂方法模式提供了一种将实例化逻辑委托给子类的方法。</p>\n<h4>维基百科</h4>\n<p>在基于类的编程中，工厂方法模式是一种使用了工厂方法的创建型设计模式，在不指定对象具体类型的情况下，处理创建对象的问题。创建对象不是通过调用构造器而是通过调用工厂方法（在接口中指定工厂方法并在子类中实现或者在基类中实现，随意在派生类中重写）来完成。</p>\n<p><strong>程序示例</strong></p>\n<p>以上述招聘经理为例，首先给出一个面试官接口及实现</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8af5674612024\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface Interviewer\r\n{\r\n    public function askQuestions();\r\n}\r\n\r\nclass Developer implements Interviewer\r\n{\r\n    public function askQuestions()\r\n    {\r\n        echo 'Asking about design patterns!';\r\n    }\r\n}\r\n\r\nclass CommunityExecutive implements Interviewer\r\n{\r\n    public function askQuestions()\r\n    {\r\n        echo 'Asking about community building';\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af5674612024-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af5674612024-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af5674612024-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af5674612024-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af5674612024-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af5674612024-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af5674612024-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af5674612024-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af5674612024-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af5674612024-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af5674612024-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af5674612024-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af5674612024-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af5674612024-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af5674612024-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af5674612024-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af5674612024-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af5674612024-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af5674612024-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af5674612024-20\">20</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8af5674612024-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Interviewer</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af5674612024-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af5674612024-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">askQuestions</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af5674612024-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af5674612024-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af5674612024-6\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Developer</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Interviewer</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af5674612024-7\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af5674612024-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">askQuestions</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af5674612024-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af5674612024-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Asking about design patterns!'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af5674612024-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af5674612024-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af5674612024-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af5674612024-14\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">CommunityExecutive</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Interviewer</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af5674612024-15\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af5674612024-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">askQuestions</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af5674612024-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af5674612024-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Asking about community building'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af5674612024-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af5674612024-20\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p>然后创建 <code>HiringManager</code></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8af9610858654\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nabstract class HiringManager\r\n{\r\n\r\n    // Factory method\r\n    abstract public function makeInterviewer(): Interviewer;\r\n\r\n    public function takeInterview()\r\n    {\r\n        $interviewer = $this-&gt;makeInterviewer();\r\n        $interviewer-&gt;askQuestions();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af9610858654-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af9610858654-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af9610858654-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af9610858654-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af9610858654-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af9610858654-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af9610858654-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af9610858654-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af9610858654-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af9610858654-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8af9610858654-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8af9610858654-12\">12</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8af9610858654-1\"><span class=\"crayon-m\">abstract</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HiringManager</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af9610858654-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af9610858654-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af9610858654-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">// Factory method</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af9610858654-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">abstract</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">makeInterviewer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Interviewer</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af9610858654-6\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8af9610858654-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">takeInterview</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af9610858654-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af9610858654-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">interviewer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">makeInterviewer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af9610858654-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">interviewer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">askQuestions</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8af9610858654-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8af9610858654-12\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0015 seconds] -->\r\n<p>现在，任何子类都可以继承 <code>HiringManager</code> 并委派相应的<code>面试官</code></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8afd060305772\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass DevelopmentManager extends HiringManager\r\n{\r\n    public function makeInterviewer(): Interviewer\r\n    {\r\n        return new Developer();\r\n    }\r\n}\r\n\r\nclass MarketingManager extends HiringManager\r\n{\r\n    public function makeInterviewer(): Interviewer\r\n    {\r\n        return new CommunityExecutive();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8afd060305772-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8afd060305772-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8afd060305772-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8afd060305772-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8afd060305772-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8afd060305772-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8afd060305772-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8afd060305772-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8afd060305772-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8afd060305772-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8afd060305772-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8afd060305772-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8afd060305772-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8afd060305772-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8afd060305772-15\">15</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8afd060305772-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DevelopmentManager</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">extends</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HiringManager</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8afd060305772-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8afd060305772-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">makeInterviewer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Interviewer</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8afd060305772-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8afd060305772-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Developer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8afd060305772-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8afd060305772-7\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8afd060305772-8\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8afd060305772-9\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MarketingManager</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">extends</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HiringManager</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8afd060305772-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8afd060305772-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">makeInterviewer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Interviewer</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8afd060305772-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8afd060305772-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">CommunityExecutive</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8afd060305772-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8afd060305772-15\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p>这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b00019263282\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$devManager = new DevelopmentManager();\r\n$devManager-&gt;takeInterview(); // Output: Asking about design patterns\r\n\r\n$marketingManager = new MarketingManager();\r\n$marketingManager-&gt;takeInterview(); // Output: Asking about community building.</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b00019263282-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b00019263282-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b00019263282-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b00019263282-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b00019263282-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b00019263282-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">devManager</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DevelopmentManager</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b00019263282-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">devManager</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">takeInterview</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Output: Asking about design patterns</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b00019263282-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b00019263282-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">marketingManager</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MarketingManager</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b00019263282-5\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">marketingManager</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">takeInterview</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Output: Asking about community building.</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p><strong>何时使用？</strong></p>\n<p>类中的一些常见处理需要在运行时动态决定所需的子类，换句话说，当客户端不知道可能需要的确切子类时，使用工厂方法模式。</p>\n<h3>🔨 抽象工厂模式</h3>\n<h4>现实生活示例</h4>\n<p>扩展一下<code>简单工厂模式</code>中的房门例子。基于所需，你可能需要从木门店获取木门，从铁门店获取铁门或者从相关的门店获取 PVC 门。进一步讲，你可能需要不同种类的专家来安装房门，比如木匠安装木门，焊接工安装铁门等等。正如你所料，房门有了依赖，木门需要木匠，铁门需要焊接工。</p>\n<h4>概述</h4>\n<p>一组工厂的工厂：将相关或者互相依赖的单个工厂聚集在一起，而不指定这些工厂的具体类。</p>\n<h4>维基百科</h4>\n<p>抽象工厂模式提供了一种方式，这种方式可以封装一组具有共同主题的个体工厂，而不指定这些工厂的具体类。</p>\n<p><strong>编程示例</strong></p>\n<p>以上述房门为例，首先给出 <code>Door</code> 接口和一些实现</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b04145101773\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface Door\r\n{\r\n    public function getDescription();\r\n}\r\n\r\nclass WoodenDoor implements Door\r\n{\r\n    public function getDescription()\r\n    {\r\n        echo 'I am a wooden door';\r\n    }\r\n}\r\n\r\nclass IronDoor implements Door\r\n{\r\n    public function getDescription()\r\n    {\r\n        echo 'I am an iron door';\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b04145101773-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b04145101773-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b04145101773-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b04145101773-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b04145101773-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b04145101773-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b04145101773-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b04145101773-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b04145101773-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b04145101773-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b04145101773-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b04145101773-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b04145101773-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b04145101773-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b04145101773-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b04145101773-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b04145101773-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b04145101773-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b04145101773-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b04145101773-20\">20</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b04145101773-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Door</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b04145101773-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b04145101773-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b04145101773-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b04145101773-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b04145101773-6\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WoodenDoor</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Door</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b04145101773-7\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b04145101773-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b04145101773-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b04145101773-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'I am a wooden door'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b04145101773-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b04145101773-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b04145101773-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b04145101773-14\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IronDoor</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Door</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b04145101773-15\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b04145101773-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b04145101773-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b04145101773-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'I am an iron door'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b04145101773-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b04145101773-20\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p>然后根据每种房门类型给出对应的安装专家</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b08690644324\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface DoorFittingExpert\r\n{\r\n    public function getDescription();\r\n}\r\n\r\nclass Welder implements DoorFittingExpert\r\n{\r\n    public function getDescription()\r\n    {\r\n        echo 'I can only fit iron doors';\r\n    }\r\n}\r\n\r\nclass Carpenter implements DoorFittingExpert\r\n{\r\n    public function getDescription()\r\n    {\r\n        echo 'I can only fit wooden doors';\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b08690644324-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b08690644324-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b08690644324-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b08690644324-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b08690644324-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b08690644324-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b08690644324-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b08690644324-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b08690644324-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b08690644324-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b08690644324-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b08690644324-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b08690644324-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b08690644324-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b08690644324-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b08690644324-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b08690644324-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b08690644324-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b08690644324-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b08690644324-20\">20</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b08690644324-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoorFittingExpert</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b08690644324-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b08690644324-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b08690644324-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b08690644324-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b08690644324-6\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Welder</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoorFittingExpert</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b08690644324-7\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b08690644324-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b08690644324-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b08690644324-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'I can only fit iron doors'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b08690644324-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b08690644324-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b08690644324-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b08690644324-14\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Carpenter</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoorFittingExpert</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b08690644324-15\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b08690644324-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b08690644324-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b08690644324-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'I can only fit wooden doors'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b08690644324-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b08690644324-20\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p>现在抽象工厂可以将相关的对象组建在一起，也就是说，木门工厂会生成木门并提供木门安装专家，铁门工厂会生产铁门并提供铁门安装专家。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b0d598056911\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface DoorFactory\r\n{\r\n    public function makeDoor(): Door;\r\n    public function makeFittingExpert(): DoorFittingExpert;\r\n}\r\n\r\n// Wooden factory to return carpenter and wooden door\r\nclass WoodenDoorFactory implements DoorFactory\r\n{\r\n    public function makeDoor(): Door\r\n    {\r\n        return new WoodenDoor();\r\n    }\r\n\r\n    public function makeFittingExpert(): DoorFittingExpert\r\n    {\r\n        return new Carpenter();\r\n    }\r\n}\r\n\r\n// Iron door factory to get iron door and the relevant fitting expert\r\nclass IronDoorFactory implements DoorFactory\r\n{\r\n    public function makeDoor(): Door\r\n    {\r\n        return new IronDoor();\r\n    }\r\n\r\n    public function makeFittingExpert(): DoorFittingExpert\r\n    {\r\n        return new Welder();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b0d598056911-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b0d598056911-33\">33</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoorFactory</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">makeDoor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Door</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">makeFittingExpert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DoorFittingExpert</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-6\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-7\"><span class=\"crayon-c\">// Wooden factory to return carpenter and wooden door</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-8\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WoodenDoorFactory</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoorFactory</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-9\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">makeDoor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Door</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WoodenDoor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-14\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">makeFittingExpert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoorFittingExpert</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Carpenter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-19\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-20\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-21\"><span class=\"crayon-c\">// Iron door factory to get iron door and the relevant fitting expert</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-22\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IronDoorFactory</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoorFactory</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-23\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">makeDoor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Door</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IronDoor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-28\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">makeFittingExpert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoorFittingExpert</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-31\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Welder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b0d598056911-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b0d598056911-33\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0032 seconds] -->\r\n<p>这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b11041654614\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$woodenFactory = new WoodenDoorFactory();\r\n\r\n$door = $woodenFactory-&gt;makeDoor();\r\n$expert = $woodenFactory-&gt;makeFittingExpert();\r\n\r\n$door-&gt;getDescription();  // Output: I am a wooden door\r\n$expert-&gt;getDescription(); // Output: I can only fit wooden doors\r\n\r\n// Same for Iron Factory\r\n$ironFactory = new IronDoorFactory();\r\n\r\n$door = $ironFactory-&gt;makeDoor();\r\n$expert = $ironFactory-&gt;makeFittingExpert();\r\n\r\n$door-&gt;getDescription();  // Output: I am an iron door\r\n$expert-&gt;getDescription(); // Output: I can only fit iron doors</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b11041654614-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b11041654614-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b11041654614-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b11041654614-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b11041654614-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b11041654614-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b11041654614-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b11041654614-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b11041654614-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b11041654614-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b11041654614-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b11041654614-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b11041654614-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b11041654614-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b11041654614-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b11041654614-16\">16</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b11041654614-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">woodenFactory</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WoodenDoorFactory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b11041654614-2\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b11041654614-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">woodenFactory</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">makeDoor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b11041654614-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">expert</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">woodenFactory</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">makeFittingExpert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b11041654614-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b11041654614-6\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">// Output: I am a wooden door</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b11041654614-7\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">expert</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Output: I can only fit wooden doors</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b11041654614-8\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b11041654614-9\"><span class=\"crayon-c\">// Same for Iron Factory</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b11041654614-10\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">ironFactory</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IronDoorFactory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b11041654614-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b11041654614-12\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">ironFactory</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">makeDoor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b11041654614-13\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">expert</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">ironFactory</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">makeFittingExpert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b11041654614-14\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b11041654614-15\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">door</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">// Output: I am an iron door</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b11041654614-16\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">expert</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getDescription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Output: I can only fit iron doors</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0026 seconds] -->\r\n<p>正如你看到的，木门工厂将<code>木匠</code>和<code>木门</code>封装在一起，同样地，铁门工厂将<code>铁门</code>和<code>焊接工</code>封装在一起。这样就可以帮助我们确保，对于每一扇生产出来的门，都能搭配正确的安装工。</p>\n<p><strong>何时使用？</strong></p>\n<p>当存在相关的依赖并涉及到稍复杂的创建逻辑时，使用抽象工厂模式。</p>\n<h3>👷 生成器模式</h3>\n<h4>现实生活示例</h4>\n<p>想象一下你在 Hardee’s 餐厅点了某个套餐，比如「大 Hardee 套餐」，然后工作人员会正常出餐，这是简单工厂模式。但是在很多情况下，创建逻辑可能涉及到更多步骤。比如，你想要一个定制的 <code>Subway</code> 套餐，对于你的汉堡如何制作有几个选项可供选择，比如你想要什么类型的酱汁？你想要什么奶酪？ 在这种情况下，建造者模式便可以派上用场。</p>\n<h4>概述</h4>\n<p>允许创建不同风格的对象，同时避免构造器污染。当创建多种风格的对象时或者创建对象时涉及很多步骤，可以使用生成器模式。</p>\n<h4>维基百科</h4>\n<p>生成器模式是一种对象创建软件设计模式，其目的是找到重叠构造器反面模式的解决方案。</p>\n<p>既然提到了，那我就补充一下什么是<code>重叠构造器反面模式</code>。 我们时不时地会看到如下构造函数：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b15495897234\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npublic function __construct($size, $cheese = true, $pepperoni = true, $tomato = false, $lettuce = true)\r\n{\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b15495897234-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b15495897234-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b15495897234-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b15495897234-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">cheese</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">pepperoni</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">tomato</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lettuce</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b15495897234-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b15495897234-3\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>正如你看到的，构造器参数的数量可能会迅速失控，并且参数的排列可能让人难以理解。 如果将来要添加更多选项，此参数列表可能会不断增长，这被称为<code>重叠构造器反面模式</code>。</p>\n<p><strong>程序示例</strong></p>\n<p>理想之选是使用生成器模式，首先给出<code>汉堡类</code></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b19777689277\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass Burger\r\n{\r\n    protected $size;\r\n\r\n    protected $cheese = false;\r\n    protected $pepperoni = false;\r\n    protected $lettuce = false;\r\n    protected $tomato = false;\r\n\r\n    public function __construct(BurgerBuilder $builder)\r\n    {\r\n        $this-&gt;size = $builder-&gt;size;\r\n        $this-&gt;cheese = $builder-&gt;cheese;\r\n        $this-&gt;pepperoni = $builder-&gt;pepperoni;\r\n        $this-&gt;lettuce = $builder-&gt;lettuce;\r\n        $this-&gt;tomato = $builder-&gt;tomato;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b19777689277-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b19777689277-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b19777689277-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b19777689277-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b19777689277-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b19777689277-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b19777689277-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b19777689277-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b19777689277-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b19777689277-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b19777689277-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b19777689277-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b19777689277-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b19777689277-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b19777689277-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b19777689277-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b19777689277-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b19777689277-18\">18</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b19777689277-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Burger</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b19777689277-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b19777689277-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b19777689277-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b19777689277-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">cheese</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b19777689277-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">pepperoni</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b19777689277-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lettuce</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b19777689277-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">tomato</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b19777689277-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b19777689277-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">BurgerBuilder</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">builder</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b19777689277-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b19777689277-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">builder</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b19777689277-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">cheese</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">builder</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">cheese</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b19777689277-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">pepperoni</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">builder</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">pepperoni</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b19777689277-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lettuce</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">builder</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lettuce</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b19777689277-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">tomato</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">builder</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">tomato</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b19777689277-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b19777689277-18\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0029 seconds] -->\r\n<p>然后是 <code>builder</code></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b1e189493406\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass BurgerBuilder\r\n{\r\n    public $size;\r\n\r\n    public $cheese = false;\r\n    public $pepperoni = false;\r\n    public $lettuce = false;\r\n    public $tomato = false;\r\n\r\n    public function __construct(int $size)\r\n    {\r\n        $this-&gt;size = $size;\r\n    }\r\n\r\n    public function addPepperoni()\r\n    {\r\n        $this-&gt;pepperoni = true;\r\n        return $this;\r\n    }\r\n\r\n    public function addLettuce()\r\n    {\r\n        $this-&gt;lettuce = true;\r\n        return $this;\r\n    }\r\n\r\n    public function addCheese()\r\n    {\r\n        $this-&gt;cheese = true;\r\n        return $this;\r\n    }\r\n\r\n    public function addTomato()\r\n    {\r\n        $this-&gt;tomato = true;\r\n        return $this;\r\n    }\r\n\r\n    public function build(): Burger\r\n    {\r\n        return new Burger($this);\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b1e189493406-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b1e189493406-43\">43</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BurgerBuilder</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">cheese</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">pepperoni</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lettuce</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">tomato</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-14\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">addPepperoni</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">pepperoni</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-20\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">addLettuce</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lettuce</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-26\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">addCheese</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">cheese</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-32\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-33\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">addTomato</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">tomato</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-37\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-38\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-39\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">build</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Burger</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-40\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-41\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Burger</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b1e189493406-42\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b1e189493406-43\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0045 seconds] -->\r\n<p>这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b22910848840\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$burger = (new BurgerBuilder(14))\r\n                    -&gt;addPepperoni()\r\n                    -&gt;addLettuce()\r\n                    -&gt;addTomato()\r\n                    -&gt;build();</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b22910848840-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b22910848840-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b22910848840-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b22910848840-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b22910848840-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b22910848840-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">burger</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BurgerBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">14</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b22910848840-2\"><span class=\"crayon-h\">                    </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">addPepperoni</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b22910848840-3\"><span class=\"crayon-h\">                    </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">addLettuce</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b22910848840-4\"><span class=\"crayon-h\">                    </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">addTomato</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b22910848840-5\"><span class=\"crayon-h\">                    </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">build</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p><strong>何时使用？</strong></p>\n<p>当需要构建不同风格的对象，同时需要避免构造器重叠时使用生成器模式。与工厂模式的主要区别在于：当创建过程一步到位时，使用工厂模式，而当创建过程需要多个步骤时，使用生成器模式。</p>\n<h3>🐑 原型模式</h3>\n<h4>现实生活示例</h4>\n<p>还记得多莉吗？那只克隆羊。这里不深入细节，关键点在于克隆。</p>\n<h4>概述</h4>\n<p>基于现有对象通过克隆创建对象。</p>\n<h4>维基百科</h4>\n<p>在软件开发过程中，原型模式是一种创建型设计模式。当要创建的对象类型由原型实例确定时，将通过克隆原型实例生成新对象。</p>\n<p>简言之，原型模式允许你创建现有对象的副本并根据需要进行修改，而不是从头开始创建对象并进行设置。</p>\n<p><strong>编程示例</strong></p>\n<p>使用 PHP 的 <code>clone</code> 方法可以轻松实现</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b26800130871\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass Sheep\r\n{\r\n    protected $name;\r\n    protected $category;\r\n\r\n    public function __construct(string $name, string $category = 'Mountain Sheep')\r\n    {\r\n        $this-&gt;name = $name;\r\n        $this-&gt;category = $category;\r\n    }\r\n\r\n    public function setName(string $name)\r\n    {\r\n        $this-&gt;name = $name;\r\n    }\r\n\r\n    public function getName()\r\n    {\r\n        return $this-&gt;name;\r\n    }\r\n\r\n    public function setCategory(string $category)\r\n    {\r\n        $this-&gt;category = $category;\r\n    }\r\n\r\n    public function getCategory()\r\n    {\r\n        return $this-&gt;category;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b26800130871-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b26800130871-31\">31</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Sheep</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">category</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Mountain Sheep'</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">category</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">setName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-16\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">setCategory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">category</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-26\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getCategory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b26800130871-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b26800130871-31\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0035 seconds] -->\r\n<p>可以像下面这样克隆</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b2a890270308\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$original = new Sheep('Jolly');\r\necho $original-&gt;getName(); // Jolly\r\necho $original-&gt;getCategory(); // Mountain Sheep\r\n\r\n// Clone and modify what is required\r\n$cloned = clone $original;\r\n$cloned-&gt;setName('Dolly');\r\necho $cloned-&gt;getName(); // Dolly\r\necho $cloned-&gt;getCategory(); // Mountain sheep</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2a890270308-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2a890270308-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2a890270308-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2a890270308-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2a890270308-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2a890270308-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2a890270308-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2a890270308-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2a890270308-9\">9</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b2a890270308-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">original</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Sheep</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Jolly'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2a890270308-2\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">original</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Jolly</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2a890270308-3\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">original</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getCategory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Mountain Sheep</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2a890270308-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2a890270308-5\"><span class=\"crayon-c\">// Clone and modify what is required</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2a890270308-6\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">cloned</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">clone</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">original</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2a890270308-7\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">cloned</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">setName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Dolly'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2a890270308-8\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">cloned</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Dolly</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2a890270308-9\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">cloned</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getCategory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Mountain sheep</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0019 seconds] -->\r\n<p>此外，你可以使用魔术方法 <code>**clone</code> 来修改克隆行为。</p>\n<p><strong>何时使用</strong></p>\n<p>当需要创建一个与已有对象类似的对象，或者当创建对象的成本比克隆更高时，使用原型模式。</p>\n<h3>💍 单例模式</h3>\n<h4>现实生活示例</h4>\n<p>一个国家同一时间只能有一位总统。只要使命召唤，这个总统就必须采取行动。 这里的总统就是一个单例。</p>\n<h4>概述</h4>\n<p>确保特定类的对象只被创建一次。</p>\n<h4>维基百科</h4>\n<p>在软件工程中，单例模式是一种软件设计模式，用来限制类初始化为对象。当恰恰只需要一个对象来协调整个系统的功能时，单例模式非常有用。</p>\n<p>实际上，单例模式被认为是反模式，应该避免过度使用。 单例模式并非不好，可能有时候很有用，但应谨慎使用，因为它在你的应用程序中引入了全局状态，一处更改可能会影响其他地方，并且可能会变得很难调试。 另外不好的一点是单例模式会使代码紧耦合，单例也很难mock。</p>\n<p><strong>编程示例</strong></p>\n<p>要创建一个单例，需要将构造函数设为 <code>private</code>，禁用克隆，禁用扩展名，并创建静态变量来容纳实例</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b2e722906291\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nfinal class President\r\n{\r\n    private static $instance;\r\n\r\n    private function __construct()\r\n    {\r\n        // Hide the constructor\r\n    }\r\n\r\n    public static function getInstance(): President\r\n    {\r\n        if (!self::$instance) {\r\n            self::$instance = new self();\r\n        }\r\n\r\n        return self::$instance;\r\n    }\r\n\r\n    private function __clone()\r\n    {\r\n        // Disable cloning\r\n    }\r\n\r\n    private function __wakeup()\r\n    {\r\n        // Disable unserialize\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b2e722906291-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b2e722906291-28\">28</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-1\"><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">President</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">instance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// Hide the constructor</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getInstance</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">President</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-r\">self</span><span class=\"crayon-o\">::</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">instance</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-13\"><span class=\"crayon-h\">            </span><span class=\"crayon-r\">self</span><span class=\"crayon-o\">::</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">instance</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">self</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">self</span><span class=\"crayon-o\">::</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">instance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-18\"> </div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__clone</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// Disable cloning</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-23\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__wakeup</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// Disable unserialize</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b2e722906291-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b2e722906291-28\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0029 seconds] -->\r\n<p>这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c2563c8b34042154578\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$president1 = President::getInstance();\r\n$president2 = President::getInstance();\r\n\r\nvar_dump($president1 === $president2); // true</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b34042154578-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b34042154578-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c2563c8b34042154578-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c2563c8b34042154578-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c2563c8b34042154578-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">president1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">President</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">getInstance</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b34042154578-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">president2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">President</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">getInstance</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c2563c8b34042154578-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c2563c8b34042154578-4\"><span class=\"crayon-e\">var_dump</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">president1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">president2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// true</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p></p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/06/a9e67955472c1afcad111aa202984192.jpg\">\n            \n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111799\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111799votetotal\">3</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111799\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/justin_ygg\">Justin_YGG</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/justin_ygg\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2016/06/4302cabf679254e36d325f1d9185b6c72.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            Python工程师一枚，对go、docker感兴趣，还在成长ing~~        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/justin_ygg\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/justin_ygg/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/justin_ygg/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 15</a>        </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "如何最有效的编写SQL", "url": "http://blog.jobbole.com/111807/", "url_object_id": "206d408271cde72276773274eb31dfde", "create_date": "2017/07/12 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2016/01/970c5be7812066919173f6ec5ab052ce.png"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "IT技术,SQL,数据库", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://dzone.com/articles/the-most-effective-way-to-write-effective-sql-chan\">Emrah Mete</a>   译文出处：<a target=\"_blank\" href=\"http://www.iteye.com/news/32540\">ITeye-黑色巧克力</a>   </div><p><em>译者注：解决数据库级（SQL）工作上的问题，应该采用的是SET方法（整体的）而不是过程式的方法。下面来看看作者为什么这么说。</em></p>\n<p>编写有效的SQL查询是企业软件世界中最大的难题之一。</p>\n<p>每个公司在数据库开发项目中所面临的最根本的问题，在于开发环境中实现的性能不能在生产环境中实现。一般来说，存在性能损失是因为生产环境中的数据量要大得多。</p>\n<p>这些问题（运行缓慢的数据库操作）可能有各种各样的原因。本文将解释如何在编写查询时进行思考，如何思考是最基本的问题，也是解决此类问题的起点。</p>\n<p>观察发现SQL开发人员常使用过程方法编写查询。事实上，这是很自然的，因为用程序方法解决问题是最方便的人类逻辑解决方案。另一个方面，几乎所有的SQL开发人员都在同时编写Java、c#或其他编程语言的代码。Java、C#等可以用来训练开发人员以一种程序化的方式来培养他们的思维方式，因为当使用这些语言开发应用程序时，会使用很多类似的东西，比如IF .. THEN .. ELSE，FOR .. LOOP，WHILE .. DO， CASE .. WHEN。当然，在这种情况下，当将业务规则应用到一组数据时，意味着每个记录都是单独处理的(逐行处理)。这个过程方法在Java、c#等语言中使用。虽然使用语言开发软件是一种正确的方法，但在编写数据库级(SQL)的查询时，却不会产生同样的效果。</p>\n<p>下面用两种不同的方法来解决同一个示例问题，并将结果进行比较。看看CUSTOMERS表中对应的每个客户在SALES表中有多少条记录。</p>\n<p>过程式方法如下:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd700a4718960132214\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSET AUTOTRACE ON\r\nSELECT \r\n      c.cust_id,\r\n       (SELECT COUNT (*)\r\n          FROM sh.sales s\r\n         WHERE s.cust_id = c.cust_id)\r\n          sa_count\r\n  FROM SH.CUSTOMERS c;\r\nPlan hash value: 881374884\r\nStatistics\r\n----------------------------------------------------------\r\n          0  recursive calls\r\n          0  db block gets\r\n    2454756  consistent gets\r\n          0  physical reads\r\n          0  redo size\r\n     925474  bytes sent via SQL*Net to client\r\n      41104  bytes received via SQL*Net from client\r\n       3701  SQL*Net roundtrips to/from client\r\n          0  sorts (memory)\r\n          0  sorts (disk)\r\n      55500  rows processed</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd700a4718960132214-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4718960132214-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4718960132214-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4718960132214-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4718960132214-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4718960132214-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4718960132214-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4718960132214-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4718960132214-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4718960132214-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4718960132214-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4718960132214-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4718960132214-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4718960132214-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4718960132214-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4718960132214-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4718960132214-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4718960132214-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4718960132214-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4718960132214-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4718960132214-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4718960132214-22\">22</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd700a4718960132214-1\"><span class=\"crayon-e\">SET </span><span class=\"crayon-e\">AUTOTRACE </span><span class=\"crayon-e\">ON</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4718960132214-2\"><span class=\"crayon-i\">SELECT</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4718960132214-3\"><span class=\"crayon-h\">      </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4718960132214-4\"><span class=\"crayon-h\">       </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">SELECT </span><span class=\"crayon-e\">COUNT</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4718960132214-5\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">sh</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">sales</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">s</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4718960132214-6\"><span class=\"crayon-h\">         </span><span class=\"crayon-i\">WHERE</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4718960132214-7\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">sa_count</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4718960132214-8\"><span class=\"crayon-e\">  </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">SH</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">CUSTOMERS</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4718960132214-9\"><span class=\"crayon-e\">Plan </span><span class=\"crayon-e\">hash </span><span class=\"crayon-v\">value</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">881374884</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4718960132214-10\"><span class=\"crayon-v\">Statistics</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4718960132214-11\"><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4718960132214-12\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">recursive </span><span class=\"crayon-i\">calls</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4718960132214-13\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">db </span><span class=\"crayon-e\">block </span><span class=\"crayon-i\">gets</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4718960132214-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">2454756</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">consistent </span><span class=\"crayon-i\">gets</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4718960132214-15\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">physical </span><span class=\"crayon-i\">reads</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4718960132214-16\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">redo </span><span class=\"crayon-i\">size</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4718960132214-17\"><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">925474</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">sent </span><span class=\"crayon-e\">via </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4718960132214-18\"><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">41104</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">received </span><span class=\"crayon-e\">via </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-e\">from </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4718960132214-19\"><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">3701</span><span class=\"crayon-h\">  </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-e\">roundtrips </span><span class=\"crayon-st\">to</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">from </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4718960132214-20\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">sorts</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">memory</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4718960132214-21\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">sorts</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">disk</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4718960132214-22\"><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">55500</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">rows </span><span class=\"crayon-v\">processed</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0035 seconds] -->\r\n<p></p>\n<div><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/5c59d421762074b3cc17f430ca7ce714.png\"></div>\n<p>现在，采用基于SET的方法来编写查询。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd700a4722359705858\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSET AUTOTRACE ON\r\nSELECT \r\n        c.cust_id, COUNT (s.cust_id) jh_count\r\n    FROM SH.CUSTOMERS c, sh.sales s\r\n   WHERE c.cust_id = s.cust_id(+)\r\nGROUP BY c.cust_id;\r\nPlan hash value: 716053480\r\nStatistics\r\n----------------------------------------------------------\r\n          1  recursive calls\r\n          0  db block gets\r\n        742  consistent gets\r\n          0  physical reads\r\n          0  redo size\r\n     925474  bytes sent via SQL*Net to client\r\n      41104  bytes received via SQL*Net from client\r\n       3701  SQL*Net roundtrips to/from client\r\n          0  sorts (memory)\r\n          0  sorts (disk)\r\n      55500  rows processed</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd700a4722359705858-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4722359705858-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4722359705858-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4722359705858-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4722359705858-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4722359705858-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4722359705858-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4722359705858-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4722359705858-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4722359705858-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4722359705858-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4722359705858-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4722359705858-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4722359705858-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4722359705858-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4722359705858-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4722359705858-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4722359705858-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4722359705858-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4722359705858-20\">20</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd700a4722359705858-1\"><span class=\"crayon-e\">SET </span><span class=\"crayon-e\">AUTOTRACE </span><span class=\"crayon-e\">ON</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4722359705858-2\"><span class=\"crayon-i\">SELECT</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4722359705858-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">COUNT</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">jh_count</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4722359705858-4\"><span class=\"crayon-e\">    </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">SH</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">CUSTOMERS</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sh</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">sales</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">s</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4722359705858-5\"><span class=\"crayon-h\">   </span><span class=\"crayon-i\">WHERE</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">cust_id</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">+</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4722359705858-6\"><span class=\"crayon-e\">GROUP </span><span class=\"crayon-i\">BY</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4722359705858-7\"><span class=\"crayon-e\">Plan </span><span class=\"crayon-e\">hash </span><span class=\"crayon-v\">value</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">716053480</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4722359705858-8\"><span class=\"crayon-v\">Statistics</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4722359705858-9\"><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4722359705858-10\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">recursive </span><span class=\"crayon-i\">calls</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4722359705858-11\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">db </span><span class=\"crayon-e\">block </span><span class=\"crayon-i\">gets</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4722359705858-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">742</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">consistent </span><span class=\"crayon-i\">gets</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4722359705858-13\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">physical </span><span class=\"crayon-i\">reads</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4722359705858-14\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">redo </span><span class=\"crayon-i\">size</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4722359705858-15\"><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">925474</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">sent </span><span class=\"crayon-e\">via </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4722359705858-16\"><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">41104</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">received </span><span class=\"crayon-e\">via </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-e\">from </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4722359705858-17\"><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">3701</span><span class=\"crayon-h\">  </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-e\">roundtrips </span><span class=\"crayon-st\">to</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">from </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4722359705858-18\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">sorts</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">memory</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4722359705858-19\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">sorts</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">disk</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4722359705858-20\"><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">55500</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">rows </span><span class=\"crayon-v\">processed</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0037 seconds] -->\r\n<p></p>\n<div><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c68cc95938e0f52a457d15867b33b3fc.png\"></div>\n<p>可以看到在两个查询的consistent gets数量之间的差异（当检查缓冲区缓存读到的块数据时）是巨大的。使用两种不同方法编写的查询在运行时导致不同时间。这种差别可以用性能来解释。</p>\n<p>在另一个例子中，常见的习惯是在SQL语句中调用PL/SQL函数。作为过程式工作的例子，也是一种解决问题的方法。还有其他一些影响在SQL内调用PL/SQL代码性能的不利因素，但在本文中，不会提到性能问题。</p>\n<p>下面编写查找客户表中每个客户的购买金额的代码。</p>\n<p>过程方法:</p>\n<p>在第一步中，创建一个PL/SQL函数来计算每个客户的总数，然后在代码和输出中调用这个函数。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd700a4727494153879\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nCREATE OR REPLACE FUNCTION get_grand_total (\r\n   p_cust_id_in IN SH.CUSTOMERS.CUST_ID%TYPE)\r\n   RETURN NUMBER\r\nIS\r\n   r_grand_total   NUMBER;\r\nBEGIN\r\n   SELECT SUM (amount_sold)\r\n     INTO r_grand_total\r\n     FROM sh.sales\r\n    WHERE cust_id = p_cust_id_in;\r\n   RETURN r_grand_total;\r\nEND;\r\nSET AUTOTRACE ON\r\nSELECT cust_id, \r\n            get_grand_total (cust_id) grand_total \r\nFROM sh.customers;\r\nStatistics\r\n----------------------------------------------------------\r\n      55503  recursive calls\r\n          0  db block gets\r\n    3066293  consistent gets\r\n          0  physical reads\r\n          0  redo size\r\n     890447  bytes sent via SQL*Net to client\r\n      41104  bytes received via SQL*Net from client\r\n       3701  SQL*Net roundtrips to/from client\r\n          0  sorts (memory)\r\n          0  sorts (disk)\r\n      55500  rows processed</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a4727494153879-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a4727494153879-29\">29</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-1\"><span class=\"crayon-e\">CREATE </span><span class=\"crayon-st\">OR</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">REPLACE </span><span class=\"crayon-t\">FUNCTION</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_grand_total</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-2\"><span class=\"crayon-h\">   </span><span class=\"crayon-e\">p_cust_id_in </span><span class=\"crayon-st\">IN</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SH</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">CUSTOMERS</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">CUST_ID</span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">TYPE</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-3\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">RETURN</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NUMBER</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-4\"><span class=\"crayon-st\">IS</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-5\"><span class=\"crayon-h\">   </span><span class=\"crayon-e\">r_grand_total   </span><span class=\"crayon-v\">NUMBER</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-6\"><span class=\"crayon-e\">BEGIN</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-7\"><span class=\"crayon-e\">   </span><span class=\"crayon-e\">SELECT </span><span class=\"crayon-e\">SUM</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">amount_sold</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-8\"><span class=\"crayon-h\">     </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">r_grand_total</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-9\"><span class=\"crayon-e\">     </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">sh</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sales</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-10\"><span class=\"crayon-e\">    </span><span class=\"crayon-e\">WHERE </span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p_cust_id_in</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-11\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">RETURN</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">r_grand_total</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-12\"><span class=\"crayon-st\">END</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-13\"><span class=\"crayon-e\">SET </span><span class=\"crayon-e\">AUTOTRACE </span><span class=\"crayon-e\">ON</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-14\"><span class=\"crayon-e\">SELECT </span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">get_grand_total</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grand_total </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-16\"><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">sh</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">customers</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-17\"><span class=\"crayon-v\">Statistics</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-18\"><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-19\"><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">55503</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">recursive </span><span class=\"crayon-i\">calls</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-20\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">db </span><span class=\"crayon-e\">block </span><span class=\"crayon-i\">gets</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">3066293</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">consistent </span><span class=\"crayon-i\">gets</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-22\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">physical </span><span class=\"crayon-i\">reads</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-23\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">redo </span><span class=\"crayon-i\">size</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-24\"><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">890447</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">sent </span><span class=\"crayon-e\">via </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-25\"><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">41104</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">received </span><span class=\"crayon-e\">via </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-e\">from </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-26\"><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">3701</span><span class=\"crayon-h\">  </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-e\">roundtrips </span><span class=\"crayon-st\">to</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">from </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-27\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">sorts</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">memory</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a4727494153879-28\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">sorts</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">disk</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a4727494153879-29\"><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">55500</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">rows </span><span class=\"crayon-v\">processed</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0040 seconds] -->\r\n<p></p>\n<div><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/b2618277a22d514ec13ef9a857ab3ec9.png\"></div>\n<p>现在，采用基于SET的方法来编写查询。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd700a472b027352387\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSET AUTOTRACE ON\r\n  SELECT c.cust_id, SUM (amount_sold)\r\n    FROM SH.CUSTOMERS c, sh.sales s\r\n   WHERE c.cust_id = s.cust_id(+)\r\nGROUP BY c.cust_id;\r\nStatistics\r\n----------------------------------------------------------\r\n          1  recursive calls\r\n          0  db block gets\r\n       1841  consistent gets\r\n          0  physical reads\r\n          0  redo size\r\n     890452  bytes sent via SQL*Net to client\r\n      41104  bytes received via SQL*Net from client\r\n       3701  SQL*Net roundtrips to/from client\r\n          0  sorts (memory)\r\n          0  sorts (disk)\r\n      55500  rows processed</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd700a472b027352387-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a472b027352387-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a472b027352387-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a472b027352387-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a472b027352387-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a472b027352387-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a472b027352387-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a472b027352387-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a472b027352387-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a472b027352387-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a472b027352387-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a472b027352387-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a472b027352387-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a472b027352387-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a472b027352387-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a472b027352387-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd700a472b027352387-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd700a472b027352387-18\">18</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd700a472b027352387-1\"><span class=\"crayon-e\">SET </span><span class=\"crayon-e\">AUTOTRACE </span><span class=\"crayon-e\">ON</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a472b027352387-2\"><span class=\"crayon-e\">  </span><span class=\"crayon-i\">SELECT</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SUM</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">amount_sold</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a472b027352387-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">SH</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">CUSTOMERS</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sh</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">sales</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">s</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a472b027352387-4\"><span class=\"crayon-h\">   </span><span class=\"crayon-i\">WHERE</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">cust_id</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">+</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a472b027352387-5\"><span class=\"crayon-e\">GROUP </span><span class=\"crayon-i\">BY</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cust_id</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a472b027352387-6\"><span class=\"crayon-v\">Statistics</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a472b027352387-7\"><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a472b027352387-8\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">recursive </span><span class=\"crayon-i\">calls</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a472b027352387-9\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">db </span><span class=\"crayon-e\">block </span><span class=\"crayon-i\">gets</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a472b027352387-10\"><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">1841</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">consistent </span><span class=\"crayon-i\">gets</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a472b027352387-11\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">physical </span><span class=\"crayon-i\">reads</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a472b027352387-12\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">redo </span><span class=\"crayon-i\">size</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a472b027352387-13\"><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">890452</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">sent </span><span class=\"crayon-e\">via </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a472b027352387-14\"><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">41104</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">received </span><span class=\"crayon-e\">via </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-e\">from </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a472b027352387-15\"><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">3701</span><span class=\"crayon-h\">  </span><span class=\"crayon-e \">SQL*</span><span class=\"crayon-e\">Net </span><span class=\"crayon-e\">roundtrips </span><span class=\"crayon-st\">to</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">from </span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a472b027352387-16\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">sorts</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">memory</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd700a472b027352387-17\"><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">sorts</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">disk</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd700a472b027352387-18\"><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">55500</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">rows </span><span class=\"crayon-v\">processed</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0034 seconds] -->\r\n<p></p>\n<div><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c419b66138cea074ab015cdd55726c10.png\"></div>\n<p>在本例中，通过查看consistent GETS和递归调用输出，我们可以看到相同的情况。</p>\n<p>我们的查询也是生成更高效的数据库操作的第一步，它考虑的是批处理，而不是逐行思考。在进行数据库操作时，批处理的方法会让你在一天结束时消耗更少的资源，从而提高工作效率。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111807\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111807votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111807\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "Linux TCP GSO 和 TSO 实现", "url": "http://blog.jobbole.com/111668/", "url_object_id": "3c4107179d9db7fa5cdd457d1cd8fd80", "create_date": "2017/07/03 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2015/10/23426c26d6b88a782a1d894de8e89bca.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 0, "tags": "IT技术,Linux", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.chinaunix.net/uid-28541347-id-5763844.html\">lvyilong316</a>   </div><div>（注：kernel版本：linux 2.6.32）\n<h2>概念</h2>\n<p>TSO(TCP Segmentation Offload): 是一种利用网卡来对大数据包进行自动分段，降低CPU负载的技术。 其主要是延迟分段。</p>\n<p>GSO(Generic Segmentation Offload): GSO是协议栈是否推迟分段，在发送到网卡之前判断网卡是否支持TSO，如果网卡支持TSO则让网卡分段，否则协议栈分完段再交给驱动。 <b>如果TSO</b><b>开启，GSO</b><b>会自动开启。</b></p>\n<p>以下是TSO和GSO的组合关系：</p>\n<ul>\n<li>GSO开启， TSO开启: 协议栈推迟分段，并直接传递大数据包到网卡，让网卡自动分段</li>\n<li>GSO开启， TSO关闭: 协议栈推迟分段，在最后发送到网卡前才执行分段</li>\n<li>GSO关闭， TSO开启: 同GSO开启， TSO开启</li>\n<li>GSO关闭， TSO关闭: 不推迟分段，在tcp_sendmsg中直接发送MSS大小的数据包</li>\n</ul>\n<h2>开启GSO/TSO</h2>\n<p>驱动程序在注册网卡设备的时候默认开启GSO: NETIF_F_GSO</p>\n<p>驱动程序会根据网卡硬件是否支持来设置TSO: NETIF_F_TSO</p>\n<p>可以通过ethtool -K来开关GSO/TSO</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d9702124167591\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#define NETIF_F_SOFT_FEATURES (NETIF_F_GSO | NETIF_F_GRO)\r\nint register_netdevice(struct net_device *dev)\r\n{\r\n              ...\r\n              /* Transfer changeable features to wanted_features and enable\r\n               * software offloads (GSO and GRO).\r\n               */\r\n              dev-&gt;hw_features |= NETIF_F_SOFT_FEATURES;\r\n              dev-&gt;features |= NETIF_F_SOFT_FEATURES; //默认开启GRO/GSO\r\n              dev-&gt;wanted_features = dev-&gt;features &amp; dev-&gt;hw_features;\r\n              ...\r\n}\r\nstatic int ixgbe_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\n              ...\r\n              netdev-&gt;features = NETIF_F_SG |\r\n                                              NETIF_F_TSO |\r\n                                              NETIF_F_TSO6 |\r\n                                              NETIF_F_RXHASH |\r\n                                              NETIF_F_RXCSUM |\r\n                                              NETIF_F_HW_CSUM;\r\n              register_netdev(netdev);\r\n              ...\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9702124167591-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9702124167591-24\">24</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-1\"><span class=\"crayon-p\">#define NETIF_F_SOFT_FEATURES (NETIF_F_GSO | NETIF_F_GRO)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">register_netdevice</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">net_device *</span><span class=\"crayon-v\">dev</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-5\"><span class=\"crayon-h\">              </span><span class=\"crayon-c\">/* Transfer changeable features to wanted_features and enable</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-6\"><span class=\"crayon-c\">               * software offloads (GSO and GRO).</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-7\"><span class=\"crayon-c\">               */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-8\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hw_features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SOFT_FEATURES</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-9\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SOFT_FEATURES</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//默认开启GRO/GSO</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-10\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">wanted_features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hw_features</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-11\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-13\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ixgbe_probe</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">pci_dev *</span><span class=\"crayon-v\">pdev</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">pci_device_id *</span><span class=\"crayon-v\">ent</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-14\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-15\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-16\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">netdev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SG</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-17\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_TSO</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-18\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_TSO6</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-19\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_RXHASH</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-20\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_RXCSUM</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-21\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_HW_CSUM</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-22\"><span class=\"crayon-h\">              </span><span class=\"crayon-e\">register_netdev</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">netdev</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9702124167591-23\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9702124167591-24\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0029 seconds] -->\r\n<p></p>\n<h2>是否推迟分段</h2>\n<p>从上面我们知道GSO/TSO是否开启是保存在dev-&gt;features中，而设备和路由关联，当我们查询到路由后就可以把配置保存在sock中。</p>\n<p>比如在tcp_v4_connect和tcp_v4_syn_recv_sock都会调用sk_setup_caps来设置GSO/TSO配置。</p>\n<p>需要注意的是，只要开启了GSO，即使硬件不支持TSO，也会设置NETIF_F_TSO，使得sk_can_gso(sk)在GSO开启或者TSO开启的时候都返回true</p>\n<p>l  <b>sk_setup_caps</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d970c915964544\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#define NETIF_F_GSO_SOFTWARE (NETIF_F_TSO | NETIF_F_TSO_ECN | NETIF_F_TSO6)\r\n#define NETIF_F_TSO (SKB_GSO_TCPV4 &lt;&lt; NETIF_F_GSO_SHIFT)\r\n\r\nvoid sk_setup_caps(struct sock *sk, struct dst_entry *dst)\r\n{\r\n              __sk_dst_set(sk, dst);\r\n              sk-&gt;sk_route_caps = dst-&gt;dev-&gt;features;\r\n              if (sk-&gt;sk_route_caps &amp; NETIF_F_GSO) /*GSO默认都会开启*/\r\n                             sk-&gt;sk_route_caps |= NETIF_F_GSO_SOFTWARE; /*打开TSO*/\r\n              if (sk_can_gso(sk)) { /*对于tcp这里会成立*/\r\n                             if (dst-&gt;header_len) {\r\n                                           sk-&gt;sk_route_caps &amp;= ~NETIF_F_GSO_MASK;\r\n                             } else {\r\n                                           sk-&gt;sk_route_caps |= NETIF_F_SG | NETIF_F_HW_CSUM;\r\n                                           sk-&gt;sk_gso_max_size = dst-&gt;dev-&gt;gso_max_size; /*GSO_MAX_SIZE=65536*/\r\n                             }\r\n              }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d970c915964544-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d970c915964544-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d970c915964544-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d970c915964544-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d970c915964544-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d970c915964544-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d970c915964544-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d970c915964544-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d970c915964544-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d970c915964544-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d970c915964544-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d970c915964544-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d970c915964544-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d970c915964544-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d970c915964544-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d970c915964544-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d970c915964544-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d970c915964544-18\">18</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d970c915964544-1\"><span class=\"crayon-p\">#define NETIF_F_GSO_SOFTWARE (NETIF_F_TSO | NETIF_F_TSO_ECN | NETIF_F_TSO6)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d970c915964544-2\"><span class=\"crayon-p\">#define NETIF_F_TSO (SKB_GSO_TCPV4 &lt;&lt; NETIF_F_GSO_SHIFT)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d970c915964544-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d970c915964544-4\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_setup_caps</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">dst_entry *</span><span class=\"crayon-v\">dst</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d970c915964544-5\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d970c915964544-6\"><span class=\"crayon-h\">              </span><span class=\"crayon-e\">__sk_dst_set</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dst</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d970c915964544-7\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dst</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d970c915964544-8\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_GSO</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*GSO默认都会开启*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d970c915964544-9\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_GSO_SOFTWARE</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*打开TSO*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d970c915964544-10\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*对于tcp这里会成立*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d970c915964544-11\"><span class=\"crayon-h\">                             </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">dst</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">header_len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d970c915964544-12\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-v\">NETIF_F_GSO_MASK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d970c915964544-13\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d970c915964544-14\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SG</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_HW_CSUM</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d970c915964544-15\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_max_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dst</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_max_size</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*GSO_MAX_SIZE=65536*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d970c915964544-16\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d970c915964544-17\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d970c915964544-18\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0030 seconds] -->\r\n<p>从上面可以看出，如果设备开启了GSO，sock都会将TSO标志打开，但是注意这和硬件是否开启TSO无关，硬件的TSO取决于硬件自身特性的支持。下面看下sk_can_gso的逻辑。</p>\n<p>l  <b>sk_can_gso</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d9711458396785\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic inline int sk_can_gso(const struct sock *sk)\r\n{\r\n    /*对于tcp，在tcp_v4_connect中被设置：sk-&gt;sk_gso_type = SKB_GSO_TCPV4*/\r\n              return net_gso_ok(sk-&gt;sk_route_caps, sk-&gt;sk_gso_type);\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9711458396785-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9711458396785-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9711458396785-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9711458396785-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9711458396785-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d9711458396785-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inline </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9711458396785-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9711458396785-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/*对于tcp，在tcp_v4_connect中被设置：sk-&gt;sk_gso_type = SKB_GSO_TCPV4*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9711458396785-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">net_gso_ok</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_type</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9711458396785-5\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>l  <b>net_gso_ok</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d9714733124748\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic inline int net_gso_ok(int features, int gso_type)\r\n{\r\n              int feature = gso_type &lt;&lt; NETIF_F_GSO_SHIFT;\r\n              return (features &amp; feature) == feature;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9714733124748-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9714733124748-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9714733124748-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9714733124748-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9714733124748-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d9714733124748-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inline </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">net_gso_ok</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">features</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9714733124748-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9714733124748-3\"><span class=\"crayon-h\">              </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_GSO_SHIFT</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9714733124748-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9714733124748-5\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p>由于对于tcp 在sk_setup_caps中sk-&gt;sk_route_caps也被设置有SKB_GSO_TCPV4，所以整个sk_can_gso成立。</p>\n<h2>GSO的数据包长度</h2>\n<p>对紧急数据包或GSO/TSO都不开启的情况，才不会推迟发送， 默认使用当前MSS。开启GSO后，tcp_send_mss返回mss和单个skb的GSO大小，为mss的整数倍。</p>\n<p>l  <b>tcp_send_mss</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d9718737075035\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic int tcp_send_mss(struct sock *sk, int *size_goal, int flags)\r\n{\r\n              int mss_now;\r\n \r\n              mss_now = tcp_current_mss(sk);/*通过ip option，SACKs及pmtu确定当前的mss*/\r\n              *size_goal = tcp_xmit_size_goal(sk, mss_now, !(flags &amp; MSG_OOB));\r\n \r\n              return mss_now;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9718737075035-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9718737075035-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9718737075035-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9718737075035-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9718737075035-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9718737075035-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9718737075035-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9718737075035-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9718737075035-9\">9</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d9718737075035-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9718737075035-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9718737075035-3\"><span class=\"crayon-h\">              </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9718737075035-4\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9718737075035-5\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_current_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*通过ip option，SACKs及pmtu确定当前的mss*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9718737075035-6\"><span class=\"crayon-h\">              </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_xmit_size_goal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_OOB</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9718737075035-7\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9718737075035-8\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9718737075035-9\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p>l  <b>tcp_xmit_size_goal</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d971b491893279\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic unsigned int tcp_xmit_size_goal(struct sock *sk, u32 mss_now,\r\n                                                                int large_allowed)\r\n{\r\n              struct tcp_sock *tp = tcp_sk(sk);\r\n              u32 xmit_size_goal, old_size_goal;\r\n \r\n              xmit_size_goal = mss_now;\r\n    /*这里large_allowed表示是否是紧急数据*/\r\n              if (large_allowed &amp;&amp; sk_can_gso(sk)) { /*如果不是紧急数据且支持GSO*/\r\n                             xmit_size_goal = ((sk-&gt;sk_gso_max_size - 1) -\r\n                                                           inet_csk(sk)-&gt;icsk_af_ops-&gt;net_header_len -\r\n                                                           inet_csk(sk)-&gt;icsk_ext_hdr_len -\r\n                                                           tp-&gt;tcp_header_len);/*xmit_size_goal为gso最大分段大小减去tcp和ip头部长度*/\r\n \r\n                             xmit_size_goal = tcp_bound_to_half_wnd(tp, xmit_size_goal);/*最多达到收到的最大rwnd窗口通告的一半*/\r\n \r\n                             /* We try hard to avoid divides here */\r\n                             old_size_goal = tp-&gt;xmit_size_goal_segs * mss_now;\r\n \r\n                             if (likely(old_size_goal &lt;= xmit_size_goal &amp;&amp;\r\n                                              old_size_goal + mss_now &gt; xmit_size_goal)) {\r\n                                           xmit_size_goal = old_size_goal; /*使用老的xmit_size*/\r\n                             } else {\r\n                                           tp-&gt;xmit_size_goal_segs = xmit_size_goal / mss_now;\r\n                                           xmit_size_goal = tp-&gt;xmit_size_goal_segs * mss_now; /*使用新的xmit_size*/\r\n                             }\r\n              }\r\n \r\n              return max(xmit_size_goal, mss_now);\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971b491893279-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971b491893279-30\">30</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_xmit_size_goal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">u32 </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-2\"><span class=\"crayon-h\">                                                                </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">large_allowed</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">tcp_sock *</span><span class=\"crayon-v\">tp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-5\"><span class=\"crayon-h\">              </span><span class=\"crayon-e\">u32 </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-6\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-7\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/*这里large_allowed表示是否是紧急数据*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-9\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">large_allowed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*如果不是紧急数据且支持GSO*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-10\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_max_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-11\"><span class=\"crayon-h\">                                                           </span><span class=\"crayon-e\">inet_csk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">icsk_af_ops</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">net_header_len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-12\"><span class=\"crayon-h\">                                                           </span><span class=\"crayon-e\">inet_csk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">icsk_ext_hdr_len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-13\"><span class=\"crayon-h\">                                                           </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">tcp_header_len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*xmit_size_goal为gso最大分段大小减去tcp和ip头部长度*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-14\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-15\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_bound_to_half_wnd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*最多达到收到的最大rwnd窗口通告的一半*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-16\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-17\"><span class=\"crayon-h\">                             </span><span class=\"crayon-c\">/* We try hard to avoid divides here */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-18\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e \">xmit_size_goal_segs *</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-19\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-20\"><span class=\"crayon-h\">                             </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">likely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-21\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-22\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*使用老的xmit_size*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-23\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-24\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">xmit_size_goal_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-25\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e \">xmit_size_goal_segs *</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*使用新的xmit_size*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-26\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-27\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-28\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971b491893279-29\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971b491893279-30\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0049 seconds] -->\r\n<p>l  <b>tcp_sendmsg</b></p>\n<p>应用程序send()数据后，会在tcp_sendmsg中尝试在同一个skb，保存size_goal大小的数据，然后再通过tcp_push把这些包通过tcp_write_xmit发出去</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d971f485490991\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nint tcp_sendmsg(struct kiocb *iocb, struct socket *sock, struct msghdr *msg,\r\n                             size_t size)\r\n{\r\n    struct sock *sk = sock-&gt;sk;\r\n    struct iovec *iov;\r\n    struct tcp_sock *tp = tcp_sk(sk);\r\n    struct sk_buff *skb;\r\n    int iovlen, flags;\r\n    int mss_now, size_goal;\r\n    int err, copied;\r\n    long timeo;\r\n \r\n    lock_sock(sk);\r\n    TCP_CHECK_TIMER(sk);\r\n \r\n    flags = msg-&gt;msg_flags;\r\n    timeo = sock_sndtimeo(sk, flags &amp; MSG_DONTWAIT);\r\n \r\n    /* Wait for a connection to finish. */\r\n    if ((1 &lt;&lt; sk-&gt;sk_state) &amp; ~(TCPF_ESTABLISHED | TCPF_CLOSE_WAIT))\r\n        if ((err = sk_stream_wait_connect(sk, &amp;timeo)) != 0)\r\n             goto out_err;\r\n \r\n    /* This should be in poll */\r\n    clear_bit(SOCK_ASYNC_NOSPACE, &amp;sk-&gt;sk_socket-&gt;flags);\r\n    /* size_goal表示GSO支持的大小，为mss的整数倍，不支持GSO时则和mss相等 */\r\n    mss_now = tcp_send_mss(sk, &amp;size_goal, flags);/*返回值mss_now为真实mss*/\r\n \r\n    /* Ok commence sending. */\r\n    iovlen = msg-&gt;msg_iovlen;\r\n    iov = msg-&gt;msg_iov;\r\n    copied = 0;\r\n \r\n    err = -EPIPE;\r\n    if (sk-&gt;sk_err || (sk-&gt;sk_shutdown &amp; SEND_SHUTDOWN))\r\n        goto out_err;\r\n \r\n    while (--iovlen &gt;= 0) {\r\n        size_t seglen = iov-&gt;iov_len;\r\n        unsigned char __user *from = iov-&gt;iov_base;\r\n \r\n        iov++;\r\n \r\n        while (seglen &gt; 0) {\r\n            int copy = 0;\r\n            int max = size_goal; /*每个skb中填充的数据长度初始化为size_goal*/\r\n            /* 从sk-&gt;sk_write_queue中取出队尾的skb，因为这个skb可能还没有被填满 */\r\n            skb = tcp_write_queue_tail(sk);\r\n            if (tcp_send_head(sk)) { /*如果之前还有未发送的数据*/\r\n                if (skb-&gt;ip_summed == CHECKSUM_NONE) /*比如路由变更，之前的不支持TSO,现在的支持了*/\r\n                    max = mss_now; /*上一个不支持GSO的skb，继续不支持*/\r\n                copy = max - skb-&gt;len; /*copy为每次想skb中拷贝的数据长度*/\r\n            }\r\n           /*copy&lt;=0表示不能合并到之前skb做GSO*/\r\n           if (copy &lt;= 0) {\r\nnew_segment:\r\n               /* Allocate new segment. If the interface is SG,\r\n                * allocate skb fitting to single page.\r\n                */\r\n               /* 内存不足，需要等待 */\r\n               if (!sk_stream_memory_free(sk))\r\n                   goto wait_for_sndbuf;\r\n               /* 分配新的skb */\r\n               skb = sk_stream_alloc_skb(sk, select_size(sk), sk-&gt;sk_allocation);\r\n               if (!skb)\r\n                   goto wait_for_memory;\r\n \r\n               /*\r\n                * Check whether we can use HW checksum.\r\n                */\r\n               /*如果硬件支持checksum，则将skb-&gt;ip_summed设置为CHECKSUM_PARTIAL，表示由硬件计算校验和*/\r\n               if (sk-&gt;sk_route_caps &amp; NETIF_F_ALL_CSUM)\r\n                   skb-&gt;ip_summed = CHECKSUM_PARTIAL;\r\n               /*将skb加入sk-&gt;sk_write_queue队尾, 同时去掉skb的TCP_NAGLE_PUSH标记*/\r\n               skb_entail(sk, skb);\r\n               copy = size_goal; /*这里将每次copy的大小设置为size_goal，即GSO支持的大小*/\r\n               max = size_goal;\r\n           }\r\n \r\n           /* Try to append data to the end of skb. */\r\n           if (copy &gt; seglen)\r\n               copy = seglen;\r\n \r\n           /* Where to copy to? */\r\n           if (skb_tailroom(skb) &gt; 0) { /*如果skb的线性区还有空间，则先填充skb的线性区*/\r\n               /* We have some space in skb head. */\r\n               if (copy &gt; skb_tailroom(skb))\r\n                   copy = skb_tailroom(skb);\r\n               if ((err = skb_add_data(skb, from, copy)) != 0) /*copy用户态数据到skb线性区*/\r\n                   goto do_fault;\r\n           } else { /*否则尝试向SG的frags中拷贝*/\r\n               int merge = 0;\r\n               int i = skb_shinfo(skb)-&gt;nr_frags;\r\n               struct page *page = TCP_PAGE(sk);\r\n               int off = TCP_OFF(sk);\r\n \r\n               if (skb_can_coalesce(skb, i, page, off) &amp;&amp; off != PAGE_SIZE) {/*pfrag-&gt;page和frags[i-1]是否使用相同页，并且page_offset相同*/\r\n                   /* We can extend the last page\r\n                   * fragment. */\r\n                   merge = 1; /*说明和之前frags中是同一个page，需要merge*/\r\n               } else if (i == MAX_SKB_FRAGS || (!i &amp;&amp; !(sk-&gt;sk_route_caps &amp; NETIF_F_SG))) {\r\n                   /* Need to add new fragment and cannot\r\n                    * do this because interface is non-SG,\r\n                    * or because all the page slots are\r\n                    * busy. */\r\n                   /*如果设备不支持SG，或者非线性区frags已经达到最大，则创建新的skb分段*/\r\n                   tcp_mark_push(tp, skb); /*标记push flag*/\r\n                       goto new_segment;\r\n               } else if (page) {\r\n                   if (off == PAGE_SIZE) {\r\n                       put_page(page); /*增加page引用计数*/\r\n                       TCP_PAGE(sk) = page = NULL;\r\n                       off = 0;\r\n                   }\r\n              } else\r\n                  off = 0;\r\n                  if (copy &gt; PAGE_SIZE - off)\r\n                  copy = PAGE_SIZE - off;\r\n                  if (!sk_wmem_schedule(sk, copy))\r\n                      goto wait_for_memory;\r\n \r\n                 if (!page) {\r\n                     /* Allocate new cache page. */\r\n                     if (!(page = sk_stream_alloc_page(sk)))\r\n                     goto wait_for_memory;\r\n                 }\r\n \r\n                 err = skb_copy_to_page(sk, from, skb, page, off, copy); /*拷贝数据到page中*/\r\n                 if (err) {\r\n                     /* If this page was new, give it to the\r\n                      * socket so it does not get leaked.\r\n                      */\r\n                     if (!TCP_PAGE(sk)) {\r\n                         TCP_PAGE(sk) = page;\r\n                         TCP_OFF(sk) = 0;\r\n                     }\r\n                     goto do_error;\r\n                }\r\n \r\n                /* Update the skb. */\r\n                if (merge) { /*pfrag和frags[i - 1]是相同的*/\r\n                     skb_shinfo(skb)-&gt;frags[i - 1].size += copy;\r\n                } else {\r\n                    skb_fill_page_desc(skb, i, page, off, copy);\r\n                    if (TCP_PAGE(sk)) {\r\n                        get_page(page);\r\n                    } else if (off + copy &lt; PAGE_SIZE) {\r\n                        get_page(page);\r\n                        TCP_PAGE(sk) = page;\r\n                    }\r\n                }\r\n                TCP_OFF(sk) = off + copy;\r\n            }\r\n            if (!copied)\r\n                TCP_SKB_CB(skb)-&gt;flags &amp;= ~TCPCB_FLAG_PSH;\r\n \r\n            tp-&gt;write_seq += copy;\r\n            TCP_SKB_CB(skb)-&gt;end_seq += copy;\r\n            skb_shinfo(skb)-&gt;gso_segs = 0; /*清零tso分段数，让tcp_write_xmit去计算*/\r\n            from += copy;\r\n            copied += copy;\r\n            if ((seglen -= copy) == 0 &amp;&amp; iovlen == 0)\r\n                goto out;\r\n            /* 还有数据没copy，并且没有达到最大可拷贝的大小(注意这里max之前被赋值为size_goal，即GSO支持的大小)， 尝试往该skb继续添加数据*/\r\n            if (skb-&gt;len &lt; max || (flags &amp; MSG_OOB))\r\n                continue;\r\n            /*下面的逻辑就是：还有数据没copy，但是当前skb已经满了，所以可以发送了(但不是一定要发送)*/\r\n            if (forced_push(tp)) { /*超过最大窗口的一半没有设置push了*/\r\n                tcp_mark_push(tp, skb); /*设置push标记，更新pushed_seq*/\r\n                __tcp_push_pending_frames(sk, mss_now, TCP_NAGLE_PUSH); /*调用tcp_write_xmit马上发送*/\r\n            } else if (skb == tcp_send_head(sk)) /*第一个包，直接发送*/\r\n                tcp_push_one(sk, mss_now);\r\n                continue; /*说明发送队列前面还有skb等待发送，且距离之前push的包还不是非常久*/\r\nwait_for_sndbuf:\r\n                set_bit(SOCK_NOSPACE, &amp;sk-&gt;sk_socket-&gt;flags);\r\nwait_for_memory:\r\n                if (copied)/*先把copied的发出去再等内存*/\r\n                    tcp_push(sk, flags &amp; ~MSG_MORE, mss_now, TCP_NAGLE_PUSH);\r\n               /*阻塞等待内存*/\r\n               if ((err = sk_stream_wait_memory(sk, &amp;timeo)) != 0)\r\n                   goto do_error;\r\n               mss_now = tcp_send_mss(sk, &amp;size_goal, flags);\r\n          }\r\n      }\r\n \r\nout:\r\n      if (copied) /*所有数据都放到发送队列中了，调用tcp_push发送*/\r\n          tcp_push(sk, flags, mss_now, tp-&gt;nonagle);\r\n      TCP_CHECK_TIMER(sk);\r\n      release_sock(sk);\r\n      return copied;\r\n \r\ndo_fault:\r\n      if (!skb-&gt;len) {\r\n          tcp_unlink_write_queue(skb, sk);\r\n          /* It is the one place in all of TCP, except connection\r\n           * reset, where we can be unlinking the send_head.\r\n           */\r\n          tcp_check_send_head(sk, skb);\r\n          sk_wmem_free_skb(sk, skb);\r\n      }\r\n \r\ndo_error:\r\n      if (copied)\r\n          goto out;\r\nout_err:\r\n      err = sk_stream_error(sk, flags, err);\r\n      TCP_CHECK_TIMER(sk);\r\n      release_sock(sk);\r\n      return err;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-77\">77</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-78\">78</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-79\">79</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-80\">80</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-81\">81</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-82\">82</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-83\">83</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-84\">84</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-85\">85</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-86\">86</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-87\">87</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-88\">88</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-89\">89</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-90\">90</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-91\">91</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-92\">92</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-93\">93</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-94\">94</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-95\">95</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-96\">96</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-97\">97</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-98\">98</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-99\">99</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-100\">100</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-101\">101</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-102\">102</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-103\">103</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-104\">104</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-105\">105</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-106\">106</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-107\">107</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-108\">108</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-109\">109</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-110\">110</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-111\">111</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-112\">112</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-113\">113</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-114\">114</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-115\">115</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-116\">116</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-117\">117</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-118\">118</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-119\">119</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-120\">120</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-121\">121</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-122\">122</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-123\">123</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-124\">124</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-125\">125</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-126\">126</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-127\">127</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-128\">128</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-129\">129</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-130\">130</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-131\">131</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-132\">132</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-133\">133</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-134\">134</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-135\">135</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-136\">136</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-137\">137</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-138\">138</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-139\">139</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-140\">140</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-141\">141</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-142\">142</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-143\">143</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-144\">144</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-145\">145</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-146\">146</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-147\">147</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-148\">148</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-149\">149</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-150\">150</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-151\">151</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-152\">152</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-153\">153</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-154\">154</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-155\">155</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-156\">156</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-157\">157</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-158\">158</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-159\">159</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-160\">160</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-161\">161</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-162\">162</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-163\">163</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-164\">164</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-165\">165</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-166\">166</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-167\">167</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-168\">168</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-169\">169</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-170\">170</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-171\">171</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-172\">172</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-173\">173</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-174\">174</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-175\">175</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-176\">176</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-177\">177</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-178\">178</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-179\">179</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-180\">180</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-181\">181</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-182\">182</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-183\">183</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-184\">184</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-185\">185</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-186\">186</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-187\">187</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-188\">188</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-189\">189</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-190\">190</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-191\">191</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-192\">192</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-193\">193</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-194\">194</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-195\">195</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-196\">196</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-197\">197</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-198\">198</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-199\">199</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-200\">200</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-201\">201</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-202\">202</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-203\">203</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-204\">204</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-205\">205</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-206\">206</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-207\">207</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-208\">208</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-209\">209</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d971f485490991-210\">210</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d971f485490991-211\">211</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-1\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sendmsg</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">kiocb *</span><span class=\"crayon-v\">iocb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">socket *</span><span class=\"crayon-v\">sock</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">msghdr *</span><span class=\"crayon-v\">msg</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-2\"><span class=\"crayon-h\">                             </span><span class=\"crayon-e\">size_t </span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sock</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">iovec *</span><span class=\"crayon-v\">iov</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">tcp_sock *</span><span class=\"crayon-v\">tp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-12\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">lock_sock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">TCP_CHECK_TIMER</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-15\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msg</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">msg_flags</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">timeo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sock_sndtimeo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_DONTWAIT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-18\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* Wait for a connection to finish. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_state</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TCPF_ESTABLISHED</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCPF_CLOSE_WAIT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_wait_connect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-22\"><span class=\"crayon-h\">             </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out_err</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-23\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* This should be in poll */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">clear_bit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">SOCK_ASYNC_NOSPACE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_socket</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* size_goal表示GSO支持的大小，为mss的整数倍，不支持GSO时则和mss相等 */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*返回值mss_now为真实mss*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-28\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* Ok commence sending. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msg</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">msg_iovlen</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">iov</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msg</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">msg_iov</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">copied</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-33\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">EPIPE</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_shutdown</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SEND_SHUTDOWN</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out_err</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-37\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-38\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-39\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">size_t </span><span class=\"crayon-v\">seglen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iov</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">iov_len</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-40\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">__user *</span><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iov</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">iov_base</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-41\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-42\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">iov</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-43\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">seglen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-45\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-46\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*每个skb中填充的数据长度初始化为size_goal*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-47\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/* 从sk-&gt;sk_write_queue中取出队尾的skb，因为这个skb可能还没有被填满 */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-48\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_write_queue_tail</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-49\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*如果之前还有未发送的数据*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-50\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ip_summed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CHECKSUM_NONE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*比如路由变更，之前的不支持TSO,现在的支持了*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-51\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*上一个不支持GSO的skb，继续不支持*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-52\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*copy为每次想skb中拷贝的数据长度*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-54\"><span class=\"crayon-h\">           </span><span class=\"crayon-c\">/*copy&lt;=0表示不能合并到之前skb做GSO*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-55\"><span class=\"crayon-h\">           </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-56\"><span class=\"crayon-v\">new_segment</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-57\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* Allocate new segment. If the interface is SG,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-58\"><span class=\"crayon-c\">                * allocate skb fitting to single page.</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-59\"><span class=\"crayon-c\">                */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-60\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* 内存不足，需要等待 */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-61\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">sk_stream_memory_free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-62\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_sndbuf</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-63\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* 分配新的skb */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-64\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_alloc_skb</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">select_size</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_allocation</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-65\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-66\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-67\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-68\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-69\"><span class=\"crayon-c\">                * Check whether we can use HW checksum.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-70\"><span class=\"crayon-c\">                */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-71\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*如果硬件支持checksum，则将skb-&gt;ip_summed设置为CHECKSUM_PARTIAL，表示由硬件计算校验和*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-72\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_ALL_CSUM</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-73\"><span class=\"crayon-h\">                   </span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ip_summed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CHECKSUM_PARTIAL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-74\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*将skb加入sk-&gt;sk_write_queue队尾, 同时去掉skb的TCP_NAGLE_PUSH标记*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-75\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">skb_entail</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-76\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*这里将每次copy的大小设置为size_goal，即GSO支持的大小*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-77\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-78\"><span class=\"crayon-h\">           </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-79\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-80\"><span class=\"crayon-h\">           </span><span class=\"crayon-c\">/* Try to append data to the end of skb. */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-81\"><span class=\"crayon-h\">           </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">seglen</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-82\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">seglen</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-83\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-84\"><span class=\"crayon-h\">           </span><span class=\"crayon-c\">/* Where to copy to? */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-85\"><span class=\"crayon-h\">           </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">skb_tailroom</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*如果skb的线性区还有空间，则先填充skb的线性区*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-86\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* We have some space in skb head. */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-87\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_tailroom</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-88\"><span class=\"crayon-h\">                   </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_tailroom</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-89\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_add_data</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*copy用户态数据到skb线性区*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-90\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">do_fault</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-91\"><span class=\"crayon-h\">           </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*否则尝试向SG的frags中拷贝*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-92\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">merge</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-93\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">nr_frags</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-94\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">page *</span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-95\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TCP_OFF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-96\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-97\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">skb_can_coalesce</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">/*pfrag-&gt;page和frags[i-1]是否使用相同页，并且page_offset相同*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-98\"><span class=\"crayon-h\">                   </span><span class=\"crayon-c\">/* We can extend the last page</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-99\"><span class=\"crayon-c\">                   * fragment. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-100\"><span class=\"crayon-h\">                   </span><span class=\"crayon-v\">merge</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*说明和之前frags中是同一个page，需要merge*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-101\"><span class=\"crayon-h\">               </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAX_SKB_FRAGS</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SG</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-102\"><span class=\"crayon-h\">                   </span><span class=\"crayon-c\">/* Need to add new fragment and cannot</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-103\"><span class=\"crayon-c\">                    * do this because interface is non-SG,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-104\"><span class=\"crayon-c\">                    * or because all the page slots are</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-105\"><span class=\"crayon-c\">                    * busy. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-106\"><span class=\"crayon-h\">                   </span><span class=\"crayon-c\">/*如果设备不支持SG，或者非线性区frags已经达到最大，则创建新的skb分段*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-107\"><span class=\"crayon-h\">                   </span><span class=\"crayon-e\">tcp_mark_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*标记push flag*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-108\"><span class=\"crayon-h\">                       </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">new_segment</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-109\"><span class=\"crayon-h\">               </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-110\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-111\"><span class=\"crayon-h\">                       </span><span class=\"crayon-e\">put_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*增加page引用计数*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-112\"><span class=\"crayon-h\">                       </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-113\"><span class=\"crayon-h\">                       </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-114\"><span class=\"crayon-h\">                   </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-115\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-116\"><span class=\"crayon-h\">                  </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-117\"><span class=\"crayon-h\">                  </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-118\"><span class=\"crayon-h\">                  </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-119\"><span class=\"crayon-h\">                  </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">sk_wmem_schedule</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-120\"><span class=\"crayon-h\">                      </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-121\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-122\"><span class=\"crayon-h\">                 </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-123\"><span class=\"crayon-h\">                     </span><span class=\"crayon-c\">/* Allocate new cache page. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-124\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_alloc_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-125\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-126\"><span class=\"crayon-h\">                 </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-127\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-128\"><span class=\"crayon-h\">                 </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_copy_to_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*拷贝数据到page中*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-129\"><span class=\"crayon-h\">                 </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-130\"><span class=\"crayon-h\">                     </span><span class=\"crayon-c\">/* If this page was new, give it to the</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-131\"><span class=\"crayon-c\">                      * socket so it does not get leaked.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-132\"><span class=\"crayon-c\">                      */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-133\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-134\"><span class=\"crayon-h\">                         </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-135\"><span class=\"crayon-h\">                         </span><span class=\"crayon-e\">TCP_OFF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-136\"><span class=\"crayon-h\">                     </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-137\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">do_error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-138\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-139\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-140\"><span class=\"crayon-h\">                </span><span class=\"crayon-c\">/* Update the skb. */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-141\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">merge</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*pfrag和frags[i - 1]是相同的*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-142\"><span class=\"crayon-h\">                     </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">frags</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-143\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-144\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">skb_fill_page_desc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-145\"><span class=\"crayon-h\">                    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-146\"><span class=\"crayon-h\">                        </span><span class=\"crayon-e\">get_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-147\"><span class=\"crayon-h\">                    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-148\"><span class=\"crayon-h\">                        </span><span class=\"crayon-e\">get_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-149\"><span class=\"crayon-h\">                        </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-150\"><span class=\"crayon-h\">                    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-151\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-152\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">TCP_OFF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-153\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-154\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-155\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">TCP_SKB_CB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-v\">TCPCB_FLAG_PSH</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-156\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-157\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">write_seq</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-158\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">TCP_SKB_CB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">end_seq</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-159\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*清零tso分段数，让tcp_write_xmit去计算*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-160\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-161\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">copied</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-162\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">seglen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-163\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-164\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/* 还有数据没copy，并且没有达到最大可拷贝的大小(注意这里max之前被赋值为size_goal，即GSO支持的大小)， 尝试往该skb继续添加数据*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-165\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_OOB</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-166\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">continue</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-167\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/*下面的逻辑就是：还有数据没copy，但是当前skb已经满了，所以可以发送了(但不是一定要发送)*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-168\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">forced_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*超过最大窗口的一半没有设置push了*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-169\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">tcp_mark_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*设置push标记，更新pushed_seq*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-170\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">__tcp_push_pending_frames</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCP_NAGLE_PUSH</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*调用tcp_write_xmit马上发送*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-171\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*第一个包，直接发送*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-172\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">tcp_push_one</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-173\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">continue</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*说明发送队列前面还有skb等待发送，且距离之前push的包还不是非常久*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-174\"><span class=\"crayon-v\">wait_for_sndbuf</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-175\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">set_bit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">SOCK_NOSPACE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_socket</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-176\"><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-177\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">/*先把copied的发出去再等内存*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-178\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">tcp_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-v\">MSG_MORE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCP_NAGLE_PUSH</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-179\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*阻塞等待内存*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-180\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_wait_memory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-181\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">do_error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-182\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-183\"><span class=\"crayon-h\">          </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-184\"><span class=\"crayon-h\">      </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-185\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-186\"><span class=\"crayon-v\">out</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-187\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*所有数据都放到发送队列中了，调用tcp_push发送*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-188\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">tcp_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">nonagle</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-189\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">TCP_CHECK_TIMER</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-190\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">release_sock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-191\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-192\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-193\"><span class=\"crayon-v\">do_fault</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-194\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-195\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">tcp_unlink_write_queue</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-196\"><span class=\"crayon-h\">          </span><span class=\"crayon-c\">/* It is the one place in all of TCP, except connection</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-197\"><span class=\"crayon-c\">           * reset, where we can be unlinking the send_head.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-198\"><span class=\"crayon-c\">           */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-199\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">tcp_check_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-200\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">sk_wmem_free_skb</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-201\"><span class=\"crayon-h\">      </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-202\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-203\"><span class=\"crayon-v\">do_error</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-204\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-205\"><span class=\"crayon-h\">          </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-206\"><span class=\"crayon-v\">out_err</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-207\"><span class=\"crayon-h\">      </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_error</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-208\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">TCP_CHECK_TIMER</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-209\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">release_sock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d971f485490991-210\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d971f485490991-211\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0321 seconds] -->\r\n<p>最终会调用tcp_push发送skb，而tcp_push又会调用tcp_write_xmit。tcp_sendmsg已经把数据按照GSO最大的size，放到一个个的skb中， 最终调用tcp_write_xmit发送这些GSO包。tcp_write_xmit会检查当前的拥塞窗口，还有nagle测试，tsq检查来决定是否能发送整个或者部分的skb， 如果只能发送一部分，则需要调用tso_fragment做切分。最后通过tcp_transmit_skb发送， 如果发送窗口没有达到限制，skb中存放的数据将达到GSO最大值。</p>\n<p>l  <b>tcp_write_xmit</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d9728592230895\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic int tcp_write_xmit(struct sock *sk, unsigned int mss_now, int nonagle,\r\n                                             int push_one, gfp_t gfp)\r\n{\r\n    struct tcp_sock *tp = tcp_sk(sk);\r\n    struct sk_buff *skb;\r\n    unsigned int tso_segs, sent_pkts;\r\n    int cwnd_quota;\r\n    int result;\r\n \r\n    sent_pkts = 0;\r\n \r\n    if (!push_one) {\r\n        /* Do MTU probing. */\r\n        result = tcp_mtu_probe(sk);\r\n        if (!result) {\r\n            return 0;\r\n        } else if (result &gt; 0) {\r\n            sent_pkts = 1;\r\n        }\r\n    }\r\n    /*遍历发送队列*/\r\n    while ((skb = tcp_send_head(sk))) {\r\n        unsigned int limit;\r\n \r\n        tso_segs = tcp_init_tso_segs(sk, skb, mss_now); /*skb-&gt;len/mss，重新设置tcp_gso_segs，因为在tcp_sendmsg中被清零了*/\r\n        BUG_ON(!tso_segs);\r\n \r\n        cwnd_quota = tcp_cwnd_test(tp, skb);\r\n        if (!cwnd_quota)\r\n            break;\r\n \r\n        if (unlikely(!tcp_snd_wnd_test(tp, skb, mss_now)))\r\n            break;\r\n \r\n        if (tso_segs == 1) { /*tso_segs=1表示无需tso分段*/\r\n            /* 根据nagle算法，计算是否需要推迟发送数据 */\r\n            if (unlikely(!tcp_nagle_test(tp, skb, mss_now, (tcp_skb_is_last(sk, skb) ? /*last skb就直接发送*/\r\n                           nonagle : TCP_NAGLE_PUSH))))\r\n                break;\r\n        } else {/*有多个tso分段*/\r\n            if (!push_one /*push所有skb*/\r\n                 &amp;&amp; tcp_tso_should_defer(sk, skb))/*/如果发送窗口剩余不多，并且预计下一个ack将很快到来(意味着可用窗口会增加)，则推迟发送*/\r\n               break;\r\n        }\r\n        /*下面的逻辑是：不用推迟发送，马上发送的情况*/\r\n        limit = mss_now;\r\n        /*由于tso_segs被设置为skb-&gt;len/mss_now，所以开启gso时一定大于1*/\r\n        if (tso_segs &gt; 1 &amp;&amp; !tcp_urg_mode(tp)) /*tso分段大于1且非urg模式*/\r\n            limit = tcp_mss_split_point(sk, skb, mss_now, cwnd_quota);/*返回当前skb中可以发送的数据大小，通过mss和cwnd*/\r\n        /* 当skb的长度大于限制时，需要调用tso_fragment分片,如果分段失败则暂不发送 */\r\n        if (skb-&gt;len &gt; limit &amp;&amp;\r\n             unlikely(tso_fragment(sk, skb, limit, mss_now))) /*/按limit切割成多个skb*/\r\n            break;\r\n \r\n        TCP_SKB_CB(skb)-&gt;when = tcp_time_stamp;\r\n        /*发送，如果包被qdisc丢了，则退出循环，不继续发送了*/\r\n        if (unlikely(tcp_transmit_skb(sk, skb, 1, gfp)))\r\n            break;\r\n \r\n        /* Advance the send_head. This one is sent out.\r\n         * This call will increment packets_out.\r\n         */\r\n        /*更新sk_send_head和packets_out*/\r\n        tcp_event_new_data_sent(sk, skb);\r\n        tcp_minshall_update(tp, mss_now, skb);\r\n        sent_pkts++;\r\n \r\n        if (push_one)\r\n            break;\r\n    }\r\n \r\n    if (likely(sent_pkts)) {\r\n        tcp_cwnd_validate(sk);\r\n        return 0;\r\n    }\r\n    return !tp-&gt;packets_out &amp;&amp; tcp_send_head(sk);\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9728592230895-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9728592230895-77\">77</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_write_xmit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nonagle</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-2\"><span class=\"crayon-h\">                                             </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">push_one</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">gfp_t </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">tcp_sock *</span><span class=\"crayon-v\">tp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-9\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-11\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">push_one</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/* Do MTU probing. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_mtu_probe</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-18\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/*遍历发送队列*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">limit</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-24\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_init_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*skb-&gt;len/mss，重新设置tcp_gso_segs，因为在tcp_sendmsg中被清零了*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">BUG_ON</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-27\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_cwnd_test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-30\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-31\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">tcp_snd_wnd_test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-33\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-34\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*tso_segs=1表示无需tso分段*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-36\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/* 根据nagle算法，计算是否需要推迟发送数据 */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-37\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">tcp_nagle_test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tcp_skb_is_last</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*last skb就直接发送*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-38\"><span class=\"crayon-h\">                           </span><span class=\"crayon-v\">nonagle</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCP_NAGLE_PUSH</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-39\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-40\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">/*有多个tso分段*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-41\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">push_one</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*push所有skb*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-42\"><span class=\"crayon-h\">                 </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_tso_should_defer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">/*/如果发送窗口剩余不多，并且预计下一个ack将很快到来(意味着可用窗口会增加)，则推迟发送*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-43\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-45\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*下面的逻辑是：不用推迟发送，马上发送的情况*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-46\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">limit</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-47\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*由于tso_segs被设置为skb-&gt;len/mss_now，所以开启gso时一定大于1*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-48\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">tcp_urg_mode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*tso分段大于1且非urg模式*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-49\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">limit</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_mss_split_point</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*返回当前skb中可以发送的数据大小，通过mss和cwnd*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/* 当skb的长度大于限制时，需要调用tso_fragment分片,如果分段失败则暂不发送 */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-51\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">limit</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-52\"><span class=\"crayon-h\">             </span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tso_fragment</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">limit</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*/按limit切割成多个skb*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-54\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-55\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">TCP_SKB_CB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">when</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tcp_time_stamp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-56\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*发送，如果包被qdisc丢了，则退出循环，不继续发送了*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tcp_transmit_skb</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-58\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-59\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-60\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/* Advance the send_head. This one is sent out.</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-61\"><span class=\"crayon-c\">         * This call will increment packets_out.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-62\"><span class=\"crayon-c\">         */</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-63\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*更新sk_send_head和packets_out*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-64\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_event_new_data_sent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-65\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_minshall_update</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-66\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-67\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-68\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">push_one</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-69\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-70\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-71\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-72\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">likely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-73\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_cwnd_validate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-74\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-75\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9728592230895-76\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">packets_out</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9728592230895-77\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0109 seconds] -->\r\n<p>其中tcp_init_tso_segs会设置skb的gso信息后文分析。我们看到tcp_write_xmit 会调用tso_fragment进行“tcp分段”。而分段的条件是skb-&gt;len &gt; limit。这里的关键就是limit的值，我们看到在tso_segs &gt; 1时，也就是开启gso的时候，limit的值是由tcp_mss_split_point得到的，也就是min(skb-&gt;len, window)，即发送窗口允许的最大值。在没有开启gso时limit就是当前的mss。</p>\n<p>l  <b>tcp_init_tso_segs</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d972e356648663\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic int tcp_init_tso_segs(struct sock *sk, struct sk_buff *skb, unsigned int mss_now)\r\n{\r\n    int tso_segs = tcp_skb_pcount(skb); /*skb_shinfo(skb)-&gt;gso_seg之前被初始化为0*/\r\n \r\n    if (!tso_segs || (tso_segs &gt; 1 &amp;&amp; tcp_skb_mss(skb) != mss_now)) {\r\n        tcp_set_skb_tso_segs(sk, skb, mss_now);\r\n        tso_segs = tcp_skb_pcount(skb);\r\n    }\r\n    return tso_segs;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d972e356648663-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d972e356648663-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d972e356648663-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d972e356648663-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d972e356648663-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d972e356648663-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d972e356648663-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d972e356648663-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d972e356648663-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d972e356648663-10\">10</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d972e356648663-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_init_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d972e356648663-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d972e356648663-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_skb_pcount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*skb_shinfo(skb)-&gt;gso_seg之前被初始化为0*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d972e356648663-4\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d972e356648663-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_skb_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d972e356648663-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_set_skb_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d972e356648663-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_skb_pcount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d972e356648663-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d972e356648663-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d972e356648663-10\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0022 seconds] -->\r\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d9732861506398\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic void tcp_set_skb_tso_segs(struct sock *sk, struct sk_buff *skb, unsigned int mss_now)\r\n{\r\n    /* Make sure we own this skb before messing gso_size/gso_segs */\r\n    WARN_ON_ONCE(skb_cloned(skb));\r\n    if (skb-&gt;len &lt;= mss_now || !sk_can_gso(sk) ||\r\n        skb-&gt;ip_summed == CHECKSUM_NONE) {/*不支持gso的情况*/\r\n       /* Avoid the costly divide in the normal\r\n        * non-TSO case.\r\n        */\r\n       skb_shinfo(skb)-&gt;gso_segs = 1;\r\n       skb_shinfo(skb)-&gt;gso_size = 0;\r\n       skb_shinfo(skb)-&gt;gso_type = 0;\r\n    } else {\r\n        skb_shinfo(skb)-&gt;gso_segs = DIV_ROUND_UP(skb-&gt;len, mss_now); /*被设置为skb-&gt;len/mss_now*/\r\n        skb_shinfo(skb)-&gt;gso_size = mss_now; /*注意mss_now为真实的mss，这里保存以供gso分段使用*/\r\n        skb_shinfo(skb)-&gt;gso_type = sk-&gt;sk_gso_type;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9732861506398-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9732861506398-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9732861506398-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9732861506398-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9732861506398-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9732861506398-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9732861506398-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9732861506398-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9732861506398-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9732861506398-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9732861506398-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9732861506398-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9732861506398-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9732861506398-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9732861506398-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9732861506398-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9732861506398-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9732861506398-18\">18</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d9732861506398-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_set_skb_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9732861506398-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9732861506398-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* Make sure we own this skb before messing gso_size/gso_segs */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9732861506398-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">WARN_ON_ONCE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">skb_cloned</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9732861506398-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9732861506398-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ip_summed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CHECKSUM_NONE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">/*不支持gso的情况*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9732861506398-7\"><span class=\"crayon-h\">       </span><span class=\"crayon-c\">/* Avoid the costly divide in the normal</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9732861506398-8\"><span class=\"crayon-c\">        * non-TSO case.</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9732861506398-9\"><span class=\"crayon-c\">        */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9732861506398-10\"><span class=\"crayon-h\">       </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9732861506398-11\"><span class=\"crayon-h\">       </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9732861506398-12\"><span class=\"crayon-h\">       </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9732861506398-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9732861506398-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DIV_ROUND_UP</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*被设置为skb-&gt;len/mss_now*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9732861506398-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*注意mss_now为真实的mss，这里保存以供gso分段使用*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9732861506398-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_type</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9732861506398-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9732861506398-18\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0034 seconds] -->\r\n<p>tcp_write_xmit最后会调用ip_queue_xmit发送skb，进入ip层。</p>\n<h2>ip分片，tcp分段，GSO，TSO</h2>\n<p>之后的逻辑就是之前另一篇文章中分析的GSO逻辑了。下面我们看下整个协议栈中ip分片，tcp分段，GSO，TSO的关系。我将这个流程由下图表示。</p>\n<p><img class=\"aligncenter\" src=\"http://blog.chinaunix.net/attachment/201705/6/28541347_1494074632KCCh.png\" alt=\"\" width=\"598\" height=\"856\"></p>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111668\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111668votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111668\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "能当主力，能入虚拟机，还能随时打包带走，Linux 就是这么强大", "url": "http://blog.jobbole.com/111672/", "url_object_id": "851c8144fffb89af1d9613091b149fa9", "create_date": "2017/07/03 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2014/04/e260ae4f5d153b25be87819b25ff0577.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 3, "tags": "IT技术,Linux", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/\">zasdfgbnm</a>   </div><p>这里介绍一下自己管理自己的Linux桌面的一点经验吧，我觉得还是有不少可取之处的。先来说一下大多数人管理Linux桌面的方法有哪些不方便的地方吧：</p>\n<ul>\n<li>买新电脑了，又得在新电脑上安装Linux，安装各种软件，各种库，各种开发环境，配置各种服务，真麻烦。</li>\n<li>最近一直在用电脑A，干了好多事情安装了好多软件，也配置了不少开发环境跟各种服务，然而处于某种原因，我又要开始使用好久没用过的电脑B了，难道我要把在A上的做的各种配置在B上再重新做一遍？</li>\n<li>在Windows下做着PPT呢，发现需要调出自己之前的程序，然后根据若干组输入跑几个结果画张图好插到PPT里，然而这个程序是在Linux下写的，编译等的过程也严重依赖自己用的Linux环境，重启进Linux拿到结果再回Windows太不方便，想在Windows下配置好环境把自己的程序跑通更不容易。</li>\n<li>要对系统安装某个软件，或者进行一些比较危险的更新操作（要知道Archlinux滚动更新滚挂了太正常了），担心把系统搞挂了，系统备份又实在太麻烦，要真挂了，系统恢复起来更麻烦。</li>\n<li>我一直用Archlinux做主力，然而最近做的某件事情要用某个软件，这个软件官方只给了Ubuntu上的安装方式，Archlinux里面没有相应的包，在Archlinux上手动安装也太不方便。装个Ubuntu，然后暂时用几天Ubuntu吧，也是够折腾的。更何况有时候只是想用一小下而已，怎样才能最小化自己在折腾上浪费的时间呢？</li>\n<li>有的软件官方软件仓库里面没有，而<code>make install</code>的话则会在系统中安装上不被包管理器所管理的文件，将来卸载也不方便，我还是更希望所有的文件都在一个包管理器中管理的。</li>\n<li>听说新版本内核引入了某个牛逼的东西？我就想快速测试一下玩玩，我电脑还有计算在跑着呢，我可不想重启，那就只能用虚拟机尝试了。而且，一定要快速，我可不想为此特地装一个虚拟机。</li>\n</ul>\n<p>上述的这些不方便之处是可以通过自己管理系统时的一些技巧来克服的，本文目的就是来介绍一下这些技巧。通过这些技巧，我们实现的功能是：一台机器上，可以同时安装Windows跟若干Linux系统，Windows下可以通过虚拟机来运行位于本地磁盘的这些Linux系统，而这些Linux系统下也可以通过容器或者虚拟机的方式互相运行。并且这些系统可以非常方便地备份跟删除，也可以随时创建以及运行快照。并且这些Linux系统可以随时打包带走，只需要经过很少的修改，就能直接在U盘或者其他机器上运行。如果要换电脑，或者新装一台电脑，也不需要重新安装系统，只需要把已有的系统同步到新电脑就行。这也正是这篇文章标题的意思。</p>\n<p>为了行文的方便，我们假定读者有一台全新的机器，硬盘还没分区，也还没装任何系统。如果已经什么都装好了，而只是想迁移到我这种管理方式的话，我相信读者能够判断这个安装教程中哪些步骤是需要做的哪些步骤是不需要做的。 另外需要注意的是这不是一个手把手的一步一步的教程，中间有一些显然的步骤我就略去不写了，所以希望读者不要照着文章里的的命令不加思考地一条一条粘贴运行，而是要搞明白这些命令的目的是什么，然后根据你自己的情况来做相应的修改。</p>\n<h3 id=\"分区与子卷\">分区与子卷</h3>\n<p>具体怎么分区我就不说了，随便找个livecd启动进去，然后找到你自己最喜欢的分区程序，按照你的喜好把区分了就好。注意别忘了EFI分区。我这里需要说的是，分区的时候，不论有多少个发行版要安装，总共只给Linux划分两个分区：一个是swap，另一个则是一个大的btrfs分区。那个btrfs分区里面装着所有的文件，包括用户的个人数据，以及所有发行版的rootfs。这两个分区在格式化的时候，一定要给他们取Label，这么做的好处接下来我们很快就会看到。我的习惯是，swap分区的Label我就叫他“swap”，而那个btrfs分区我则叫他“linux”。创建好分区以后，如果格式化工作是在图形的分区管理程序下完成的，那么指定Label是个非常简单的工作，右键属性里面就有。如果是使用命令行工具格式化分区的，则可以使用<code>-L label</code>选项来指定label，比如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da4cc002560907\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmkswap -L swap /dev/sdb4\r\nmkfs.btrfs -L linux /dev/nvme0n1p4</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4cc002560907-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da4cc002560907-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da4cc002560907-1\"><span class=\"crayon-v\">mkswap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">L</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">swap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">sdb4</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da4cc002560907-2\"><span class=\"crayon-v\">mkfs</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">btrfs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">L</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">nvme0n1p4</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>那个大的btrfs分区上的不同内容是通过btrfs的子卷来管理的，具体来讲就是为自己想安装的每个不同的Linux系统来创建一个单独的子卷。 比如说我电脑上同时安装了Archlinux、Ubuntu、Kali、Debian四个系统，那么的btrfs分区里面就有四个子卷：archlinux、ubuntu、kali、debian。 子卷的创建可以通过<code>btrfs subvolume create &lt;name&gt;</code>命令完成，比如说要创建我这五个子卷，需要做的事情就是：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da4d7585188903\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmount /dev/disk/by-label/linux /mnt\r\ncd /mnt\r\nbtrfs subvolume create archlinux\r\nbtrfs subvolume create ubuntu\r\nbtrfs subvolume create kali\r\nbtrfs subvolume create debian</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4d7585188903-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da4d7585188903-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4d7585188903-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da4d7585188903-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4d7585188903-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da4d7585188903-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da4d7585188903-1\"><span class=\"crayon-v\">mount</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da4d7585188903-2\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da4d7585188903-3\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-e\">archlinux</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da4d7585188903-4\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-e\">ubuntu</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da4d7585188903-5\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-e\">kali</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da4d7585188903-6\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-v\">debian</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>如果你只想装一个发行版，比如archlinux，那么只需要archlinux子卷就够了。另外，如果你想把用户数据单独放在一个子卷里，也是完全可以的，不过这里不推荐多个Linux系统共享同一个家目录，因为不同系统上安装的软件不同，同样的软件版本也不相同，即使版本相同，不同发行版也可能应用了不同的patch，这就导致在一个系统上用户家目录里面产生的配置文件，在另一个系统里无法兼容，产生奇怪的行为。</p>\n<h3 id=\"系统安装\">系统安装</h3>\n<p>创建好分区与子卷，下一步就是安装操作系统了。这里分两种情况来讲：第一种情况是你想要全新安装一个Linux操作系统；第二种情况则是你已经有了某个可用的操作系统了，而只是想把这个操作系统迁移到文章所说的管理方式上。</p>\n<h4 id=\"全新安装\">全新安装</h4>\n<p>如果想要全新安装一个操作系统，安装方式上，作者只推荐纯手工安装，而不是用官方给的安装光盘不断点着“下一步”来进行安装。这么做是为了防止官方安装程序做一些我们不想让他做的事情，比如说自动安装grub。对于Archlinux跟Gentoo来讲，唯一的安装方法就是纯手工安装，所以只要按照官方的教程来就好了。对于deb系的系统，可以使用debootstrap程序。对于其他的发行版，可能会找不到手工安装的教程，这时候可以新建一个虚拟机，在虚拟机中使用官方的安装程序不断点击“下一步”来完成安装，然后按照下一节即将介绍的现有系统迁移教程把系统从虚拟机中迁移到现实机器上；除此之外，读者还可以找到发行版官方提供的安装程序的源代码阅读一下，看明白这些安装程序都在干啥，就知道怎么手工安装了，安装程序的代码还是相对简单的，有时间的读者不妨尝试一下。下面来具体说一下安装过程，这里只介绍Archlinux跟deb系。如果有多个Linux系统需要安装，建议先安装并完全配置好其中一个，让这个系统处于可用并且方便使用的状态，然后再在这个可用的系统中安装其他系统。这里我们假设读者已经完成了分区，创建了对应的子卷，并且把那个btrfs分区挂载在了<code>/mnt</code>上。</p>\n<h5 id=\"Archlinux的手动安装\">Archlinux的手动安装</h5>\n<p>Archlinux的手动安装主要还是看<a href=\"https://wiki.archlinux.org/index.php/Installation_guide\" target=\"_blank\" rel=\"external\">官方教程</a>。分区的时候注意按照上文介绍的方法。非常关键的<code>pacstrap</code>那一步注意使用如下命令安装到子卷里，而不是整个btrfs分区中:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da4dd572157837\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npacstrap -d /mnt/archlinux base</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4dd572157837-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da4dd572157837-1\"><span class=\"crayon-v\">pacstrap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">d</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">archlinux </span><span class=\"crayon-v\">base</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>至于fstab，就不要使用教程中的方法来生成了，我们的管理方式比较非常规，还是自己写fstab比较好。bootloader也要按照本文下文说的方式来安装跟配置。至于其他的设置键盘、设置网络、设置时区等操作，照着教程来就行。</p>\n<h5 id=\"deb系的手动安装\">deb系的手动安装</h5>\n<p>deb系的系统网上找到的教程都是使用发行版自带的安装程序的教程，并没有像Archlinux那么详细的手动安装教程。因为我们想要手动安装，所以我们就不参照网上的deb系的安装教程了。但是我们还是有教程可以参照的，那就是Archlinux的wiki里面<a href=\"https://wiki.archlinux.org/index.php/Systemd-nspawn#Create_a_Debian_or_Ubuntu_environment\" target=\"_blank\" rel=\"external\">关于systemd-nspawn的教程</a>，这个教程里面有一节介绍如何使用debootstrap安装Debian或者Ubuntu。具体安装过程请参照上述教程，其中关键命令如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da4e1937597243\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndebootstrap --arch amd64 zesty /mnt/ubuntu http://archive.ubuntu.com/ubuntu/</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4e1937597243-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da4e1937597243-1\"><span class=\"crayon-v\">debootstrap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">arch </span><span class=\"crayon-e\">amd64 </span><span class=\"crayon-v\">zesty</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ubuntu </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//archive.ubuntu.com/ubuntu/</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>值得一提的是，我们安装deb系的发行版并不一定要使用deb系的livecd，任何能够安装debootstrap程序的livecd都是可以的。比如说我们完全可以使用Archlinux的livecd来启动，然后安装debootstrap并通过debootstrap来安装Ubuntu。</p>\n<p>注意的是，debootstrap并不会像官方安装程序那样安装一个完整齐全开袋即食的操作系统，而只是安装最基本的软件包，读者需要根据自己的情况单独安装桌面环境等的软件包。同时fstab跟bootloader也要根据本文的方法自己配置。</p>\n<h4 id=\"现有系统迁移\">现有系统迁移</h4>\n<p>Linux系统的迁移其实非常简单，无非就是把rootfs的文件全都拷贝到目的地即可。不过这个过程虽然看似简单，但是还是有一些需要注意的东西的。比如说对于符号链接，如果处理不当，则会不小心把符号链接搞成实体文件，这就不好了。再比如说，文件的权限等元数据的问题，如果处理不当，可能会导致拷贝过程中元数据的丢失。这两种问题，都有可能会导致系统不能正常运行。还有一个需要注意的地方就是，正常运行的操作系统里，会有/proc、/dev等目录，这些目录都是单独的虚拟文件系统，是不需要拷贝的，也是无法拷贝的。</p>\n<p>我们现在假设用户想要把位于A的Ubuntu系统迁移到目标子卷<code>/mnt/ubuntu</code>去。其中，A可能位于虚拟机中，可能位于另一台电脑上，也可能位于本地磁盘。对系统进行迁移，大方向上来讲，需要做的有两步：</p>\n<ol>\n<li>挂载相应分区，设置ssh，保证我们能够访问到A。</li>\n<li>使用<code>rsync</code>或者<code>btrfs send</code>命令来把数据从A发送到目标子卷中去。</li>\n</ol>\n<p>第一步具体怎么做就不说了，分三种情况简单几句话概括一下怎么做：</p>\n<ul>\n<li>如果只是一个分区的话，mount就可以了</li>\n<li>如果是另一台机器，把那台机器配置好ssh，保证root用户可以用ssh访问</li>\n<li>如果是虚拟机，有两种选择，一种是想办法挂载虚拟机的磁盘镜像，然后像情况1那样处理；另一种则是配置好网络跟ssh，像情况2那样处理。具体采取哪种措施请读者根据自己的情况来自行决定。</li>\n</ul>\n<p>第二步我们来分别介绍<code>rsync</code>跟<code>btrfs send</code>两种方法。</p>\n<p><code>rsync</code>的方法<a href=\"https://wiki.archlinux.org/index.php/full_system_backup_with_rsync\" target=\"_blank\" rel=\"external\">这里有教程</a>可以参照。我们现在假设A的ip地址为<code>192.168.88.3</code>。则只需执行如下命令即可：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da4e6151494391\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nrsync -aAXv --exclude={\"/dev/*\",\"/proc/*\",\"/sys/*\",\"/tmp/*\",\"/run/*\",\"/mnt/*\",\"/media/*\",\"/lost+found\"} root@192.168.88.3:/ /mnt/ubuntu</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4e6151494391-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da4e6151494391-1\"><span class=\"crayon-v\">rsync</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">aAXv</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">exclude</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">{</span><span class=\"crayon-s\">\"/dev/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/proc/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/sys/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/tmp/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/run/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/mnt/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/media/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/lost+found\"</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-cn\">192.168.88.3</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>这里提醒读者注意自己系统上是否还有其他不想要同步的文件，记得一并排除掉。</p>\n<p><code>btrfs send</code>只在A的rootfs也是btrfs的情况下才能使用。<a href=\"https://btrfs.wiki.kernel.org/index.php/Incremental_Backup\" target=\"_blank\" rel=\"external\">这个方法的教程参见这里</a>。首先需要做的是在A机器上给rootfs创建一个只读快照（注意下面命令是在A机器上执行的）：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da4ea969171826\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbtrfs subvolume snapshot -r / /ubuntu</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4ea969171826-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da4ea969171826-1\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-v\">snapshot</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">r</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>注意上面命令中快照的名字要和目标子卷的名字相同，这样可以省去将来改名的麻烦。然后就可以使用<code>btrfs send</code>命令来把快照/ubuntu中的内容发送到目的地了，在这之前我们需要暂时删除我们分区的时候创建的ubuntu子卷，这个子卷会在接收过程中自动重新创建：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da4ed419946672\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbtrfs subvolume delete /mnt/ubuntu\r\nssh root@192.168.88.3 btrfs send /ubuntu | btrfs receive /mnt</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4ed419946672-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da4ed419946672-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da4ed419946672-1\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-v\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ubuntu</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da4ed419946672-2\"><span class=\"crayon-e\">ssh </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-cn\">192.168.88.3</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">btrfs </span><span class=\"crayon-v\">send</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">btrfs </span><span class=\"crayon-v\">receive</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>最后在A机器上把刚刚创建的快照删除就可以了</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da4f0192960817\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbtrfs subvolume delete /ubuntu</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4f0192960817-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da4f0192960817-1\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-v\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p>\n<h3 id=\"bootloader与fstab\">bootloader与fstab</h3>\n<p>系统装好了，我们的fstab还没设置，启动管理器也还没安装配置。下面来讲讲怎么配置这两样东西。我们之前说过一定要给分区取一个Label，玄机在这里。如何在虚拟机中直接运行本地磁盘上安装的Linux，以及如何能把一个系统直接进行打包带走而不需要更改太多配置，关键也在这里。</p>\n<h4 id=\"fstab\">fstab</h4>\n<p>先来说说fstab，fstab总共有五列，分别为fs、mountpoint、type、opts跟dump/pass。这五列分别为什么意思、以及fstab该怎么填，网上一查便知，在此不再赘述。这里只说我们需要做的跟常规不一样的地方。</p>\n<p>第一个要注意的事情是，大家在填写fstab的时候，通常喜欢在fs那一列填写类似<code>/dev/sda4</code>或者<code>UUID=d5acc217-d524-4a2d-a937-bad945a047b2</code>，而在这里这样是不行的，这里我们填写的是形如<code>/dev/disk/by-label/linux</code>这样的东西。也就是说，我们的fstab里面是通过分区的Label来找分区的。这么做的原因是，我们希望我们的rootfs不光能在这台机器上启动，还希望它能在虚拟机的环境中，或者当我们把rootfs打包带走同步到别的机器上的时候，也能正常启动。在这台机器上rootfs所在的分区叫做<code>/dev/sda4</code>，在别的机器上或者虚拟机里就不一定还叫<code>/dev/sda4</code>了。但是我们只要遵守自己的命名规则，所有机器上的这些分区我们都取相同的Label，那么我们的fstab就是放之四海而皆准的，不需要为不同的环境而更改。</p>\n<p>第二个需要注意的问题是，不要填写rootfs的条目。这种做法跟通常发行版或者其他用户的默认做法是非常不相同的。为了理解这一点，先来说说Linux系统的启动过程。通常情况下，Linux启动的时候，首先由bootloader把内核装载到内存，并向内核传递参数告诉内核rootfs的位置。接下来内核就会根据传递的参数，以只读方式挂载rootfs，并执行rootfs中的init程序。init程序会调用相应的初始化程序执行各种初始化操作。其中一项初始化操作就是根据fstab的配置，来重新以读写方式挂载rootfs，并且挂载fstab里面配置的其他各个分区到指定位置。明白了Linux启动的过程，我们就知道，fstab里面的rootfs那一行其实不是必须的。删掉了rootfs那一行，我们只需要通过修改bootloader传递给内核的参数，就可以告诉内核直接以读写而不是只读的方式挂载rootfs。</p>\n<p>那么，我们在写fstab的时候不写rootfs那一项有啥好处呢？好处就是，我们不仅希望我们的系统能在裸机上用，还希望我们的系统能在虚拟机上用。在下文设置qemu虚拟机的时候，我们会以virtfs的方式把我们的子卷传递给虚拟机，这个时候rootfs就已经不再是<code>/dev/disk/by-label/linux</code>了，如果我们把rootfs的挂载方式硬编码到fstab里面，那么会导致init程序的失败，进而无法启动。</p>\n<p>另外有一点值得一提的小技巧是，很多时候我们还有别的一些个分区想要自动挂载。问题在于，这些分区在虚拟机环境中，并不一定是存在的，这就会导致启动的时候由于无法挂载而启动失败。其实系统的设计者早就考虑到这个问题了。如果你不希望fstab中的某些条目自动挂载，在选项里面增加<code>noauto</code>即可。如果你希望一些条目自动挂载，但是这些条目不是那么重要，即使挂载失败也不希望这些条目导致启动失败，可以在选项中增加<code>nofail</code>。这两个选项真的是给我们的系统管理工作提供了非常大的方便。比如说我们可能会在fstab中增加<code>/dev/disk/by-label/swap</code>的条目，以便开机自动将这个分区设置为交换分区供系统使用。然而后面我们会看到，我们设置虚拟机的时候，这个分区在虚拟机环境下，并不一定是可用的。这种情况下，我们希望系统在找不到这个分区的时候直接忽略错误不用swap便是，而不是报错拒绝启动。</p>\n<p>说了这么多，直接贴一个fstab的例子好了：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da4f6701421128\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntmpfs                  \t\t/tmp\ttmpfs\tdefaults\t\t0 0\r\n/dev/disk/by-label/swap\t\tnone\tswap\tdefaults,nofail\t\t0 0</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4f6701421128-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da4f6701421128-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da4f6701421128-1\"><span class=\"crayon-v\">tmpfs</span><span class=\"crayon-h\">                  \t\t</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">tmp\t</span><span class=\"crayon-e\">tmpfs\t</span><span class=\"crayon-i\">defaults</span><span class=\"crayon-h\">\t\t</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da4f6701421128-2\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">swap\t\t</span><span class=\"crayon-e\">none\t</span><span class=\"crayon-e\">swap\t</span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">nofail</span><span class=\"crayon-h\">\t\t</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p></p>\n<h4 id=\"bootloader\">bootloader</h4>\n<p>再来说说启动管理器，这里作者推荐的启动管理器是refind，<a href=\"http://www.rodsbooks.com/refind/installing.html\" target=\"_blank\" rel=\"external\">安装教程官网有</a>，在此不赘述。这里只讲一下启动项怎么写。先贴示例代码：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da4f9672429432\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmenuentry archlinux {\r\n\ticon EFI/refind/icons/os_arch.png\r\n\tvolume linux\r\n\tloader archlinux/boot/vmlinuz-linux\r\n\toptions \"root=/dev/disk/by-label/linux rootflags=subvol=archlinux rw\"\r\n\tinitrd archlinux/boot/initramfs-linux.img\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4f9672429432-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da4f9672429432-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4f9672429432-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da4f9672429432-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4f9672429432-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da4f9672429432-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4f9672429432-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da4f9672429432-1\"><span class=\"crayon-e\">menuentry</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">archlinux</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da4f9672429432-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">icon </span><span class=\"crayon-v\">EFI</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">refind</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">icons</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">os_arch</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">png</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da4f9672429432-3\"><span class=\"crayon-e\">\t</span><span class=\"crayon-e\">volume </span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da4f9672429432-4\"><span class=\"crayon-e\">\t</span><span class=\"crayon-e\">loader </span><span class=\"crayon-v\">archlinux</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">vmlinuz</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da4f9672429432-5\"><span class=\"crayon-e\">\t</span><span class=\"crayon-i\">options</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"root=/dev/disk/by-label/linux rootflags=subvol=archlinux rw\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da4f9672429432-6\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">initrd </span><span class=\"crayon-v\">archlinux</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initramfs</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">linux</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">img</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da4f9672429432-7\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>其中第三行的volume用来指定内核存放的分区，此分区可以通过多种方式来指定，比如通过分区的GUID，但是对我们来说最重要的是可以通过文件系统的Label来指定。我们的rootfs分区Label是”linux”，所以这一行写作<code>volume linux</code>。</p>\n<p>接下来就是指定内核位置、内核参数跟initramfs的位置了。其中loader用来指定内核位置，options用来指定内核参数，initrd则用来指定initramfs的位置。示例中的是Archlinux系统，内核是archlinux子卷中的<code>boot/vmlinuz-linux</code>文件，所以写作<code>loader archlinux/boot/vmlinuz-linux</code>。类似，initrd那一行则写作<code>initrd archlinux/boot/initramfs-linux.img</code>。至于内核参数，<code>root=/dev/disk/by-label/linux</code>告诉内核我们的rootfs所在的分区，<code>rootflags=subvol=archlinux</code>告诉内核挂载名为archlinux的子卷，<code>rw</code>则告诉内核以读写方式挂载。对于Ubuntu系统，这三行应该写作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da4fd037873340\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nloader ubuntu/vmlinuz\r\noptions \"root=/dev/disk/by-label/linux rootflags=subvol=ubuntu rw\"\r\ninitrd ubuntu/initrd.img</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4fd037873340-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da4fd037873340-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da4fd037873340-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da4fd037873340-1\"><span class=\"crayon-e\">loader </span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">vmlinuz</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da4fd037873340-2\"><span class=\"crayon-i\">options</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"root=/dev/disk/by-label/linux rootflags=subvol=ubuntu rw\"</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da4fd037873340-3\"><span class=\"crayon-e\">initrd </span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initrd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">img</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>细心的读者可能已经发现，我们的refind的配置文件中在指定分区的时候用的全是他们的Label，这就保证了这个配置文件的普适性，换台电脑，只要你用同样的管理方式，同样的命名习惯，配置文件里面的东西动都不用动，直接拷贝过去就行。</p>\n<h3 id=\"系统的备份与恢复以及快照的应用\">系统的备份与恢复以及快照的应用</h3>\n<p>由于使用了btrfs的动态卷，所以备份恢复工作做起来非常简单。备份系统只需要创建快照即可：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da501693152014\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd /mnt\r\nbtrfs subvolume snapshot archlinux backup</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da501693152014-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da501693152014-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da501693152014-1\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da501693152014-2\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">snapshot </span><span class=\"crayon-e\">archlinux </span><span class=\"crayon-v\">backup</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>至于恢复，其实我们根本不需要恢复，直接把快照作为rootfs用就行。我们只需要去refind的配置文件里面，把相应的启动项改改即可。比如说对于Archlinux而言，只需要改成：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da504962639736\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmenuentry archlinux {\r\n\ticon EFI/refind/icons/os_arch.png\r\n\tvolume linux\r\n\tloader backup/boot/vmlinuz-linux\r\n\toptions \"root=/dev/disk/by-label/linux rootflags=subvol=backup rw\"\r\n\tinitrd backup/boot/initramfs-linux.img\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da504962639736-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da504962639736-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da504962639736-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da504962639736-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da504962639736-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da504962639736-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da504962639736-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da504962639736-1\"><span class=\"crayon-e\">menuentry</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">archlinux</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da504962639736-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">icon </span><span class=\"crayon-v\">EFI</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">refind</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">icons</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">os_arch</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">png</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da504962639736-3\"><span class=\"crayon-e\">\t</span><span class=\"crayon-e\">volume </span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da504962639736-4\"><span class=\"crayon-e\">\t</span><span class=\"crayon-e\">loader </span><span class=\"crayon-v\">backup</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">vmlinuz</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da504962639736-5\"><span class=\"crayon-e\">\t</span><span class=\"crayon-i\">options</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"root=/dev/disk/by-label/linux rootflags=subvol=backup rw\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da504962639736-6\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">initrd </span><span class=\"crayon-v\">backup</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initramfs</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">linux</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">img</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da504962639736-7\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p>如果有强迫症，觉得rootfs名字不叫archlinux很不爽，那其实改名也很简单:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da507408400946\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd /mnt\r\nbtrfs subvolume delete archlinux\r\nbtrfs subvolume snapshot backup archlinux</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da507408400946-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da507408400946-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da507408400946-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da507408400946-1\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da507408400946-2\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">delete </span><span class=\"crayon-e\">archlinux</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da507408400946-3\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">snapshot </span><span class=\"crayon-e\">backup </span><span class=\"crayon-v\">archlinux</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>其实，btrfs的快照功能不仅可以用来备份与恢复系统，还有很多非常灵活的运用的。比如说我想在系统里面安装一个巨大而又混乱的软件，这个软件我只想用几天干一件事情，干完这件事情我就不想用了。问题是，这个软件在官方的软件仓库并没有，要安装，我只能使用软件提供的安装程序来安装，然而软件并没有提供卸载程序，或者卸载程序卸载的很不彻底，会在系统残留垃圾。我想用这软件，然而又不想脏了我的系统，这该怎么办？很简单：创建一个快照，新增加一条以快照为rootfs的启动项，要用软件了就启动到快照中去，用完这个软件以后把快照删除即可。再比如说，我想要搞个虚拟机跟实体机一起来测试某个东西（比如说测试某些网络协议、测试某些集群管理软件等），这个时候我根本没必要重新用安装光盘去装一个虚拟机，只需要创建一个快照，然后把快照作为虚拟机的rootfs启动即可，具体方法下文会介绍，在此不多说。当然，快照的应用还远远不止我说的这些，更多好玩的应用还待读者自己探索。</p>\n<h3 id=\"Windows下访问Linux\">Windows下访问Linux</h3>\n<p>从文章的刚开头我们就说，有时候我们是有在Windows下运行本地安装的Linux的需求的。这个需求可以通过VirtualBox来满足，只需要在VirtualBox中使用本地磁盘来作虚拟磁盘即可。说起来简单，但是实现起来还是需要折腾一下子的。</p>\n<p>首先我们需要新建一个虚拟机，具体过程不多说，一路“下一步”就行了，唯一需要注意的是，在创建虚拟磁盘的那一步，选择“不添加虚拟硬盘”：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/virt_hdd.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/virt_hdd.png\" alt=\"virt_hdd.png\"></a></p>\n<p>这里我的虚拟机取名为“Linux”。创建完虚拟机了以后，就需要把本地磁盘设置为虚拟磁盘了。VirtualBox只能通过命令来做这件事情，<a href=\"http://www.serverwatch.com/server-tutorials/using-a-physical-hard-drive-with-a-virtualbox-vm.html\" target=\"_blank\" rel=\"external\">教程可以在这里找到</a>。首先要做的是寻找我们安装Linux的磁盘的编号，这个可以在系统自带的磁盘管理程序中找到，在我的机器上这个磁盘编号为2：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/dskmgr.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/dskmgr.png\" alt=\"dskmgr.png\"></a><br>\n知道了磁盘的编号，就可以创建虚拟盘了。这里我们使用的命令如下，注意使用管理员身份运行：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da50c209601469\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nVBoxManage internalcommands createrawvmdk -filename \"C:\\Users\\gaoxiang\\VirtualBox VMs\\Linux\\localdisk.vmdk\" -rawdisk \\\\.\\PhysicalDrive2</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da50c209601469-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da50c209601469-1\"><span class=\"crayon-e\">VBoxManage </span><span class=\"crayon-e\">internalcommands </span><span class=\"crayon-v\">createrawvmdk</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">filename</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"C:\\Users\\gaoxiang\\VirtualBox VMs\\Linux\\localdisk.vmdk\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">rawdisk</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">PhysicalDrive2</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>有了虚拟磁盘了，就可以将虚拟磁盘添加到虚拟机中去了：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/newdisk.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/newdisk.png\" alt=\"newdisk.png\"></a></p>\n<p>虚拟磁盘设置好了，最后一步就是设置EFI了。由于我们之前在分区的时候给文件系统都赋予了Label，并且在refind设置的时候也是用的Label来指定分区，所以同一套refind的配置在虚拟机上也能用。因此我们不需要单独给虚拟机安装bootloader，而是直接用我们之前安装在物理磁盘上的EFI分区中的refind就行。VitualBox默认是不开启EFI的，我们需要在虚拟机的系统设置里面手动勾选EFI：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/efi.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/efi.png\" alt=\"efi.png\"></a><br>\n为了要让VirtualBox自动启动refind，还要对EFI的分区做一些简单的设置，<a href=\"https://wiki.archlinux.org/index.php/VirtualBox#Installation_in_EFI_mode\" target=\"_blank\" rel=\"external\">设置的教程参考这里</a>。设置的时候一定要注意，这些设置一定要是通用的，即同一份文件既能在物理机上正常工作也能在虚拟机上正常工作，不要改完了设置以后虚拟机上能跑了物理机却挂了，这就不好玩了。VirtualBox的EFI在启动的时候会优先选择<code>/EFI/BOOT/BOOTX64.EFI</code>，如果找不到的话，才会启动EFI分区根目录下的<code>startup.nsh</code>中指定的bootloader。知道了这一点，为了实现自动启动refind，首先需要检查一下<code>/EFI/BOOT/BOOTX64.EFI</code>这个文件是否存在，若存在，备份并删除之：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da511317916483\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd EFI/BOOT\r\nmv bootx64.efi bootx64-backup.efi</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da511317916483-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da511317916483-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da511317916483-1\"><span class=\"crayon-e\">cd </span><span class=\"crayon-v\">EFI</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">BOOT</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da511317916483-2\"><span class=\"crayon-e\">mv </span><span class=\"crayon-v\">bootx64</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">efi </span><span class=\"crayon-v\">bootx64</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">backup</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">efi</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>然后就是在EFI分区根目录下新建一个<code>startup.nsh</code>了，这个文件只需要一行，内容如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da515709861624\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n\\EFI\\refind\\refind_x64.efi</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da515709861624-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da515709861624-1\"><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">EFI</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">refind</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">refind_x64</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">efi</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>一切设置完毕，运行虚拟机，就能看到我们熟悉的refind界面了：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/refind.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/refind.png\" alt=\"refind.png\"></a><br>\n打开其中的Ubuntu系统，测试一切正常就大功告成了：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/ubuntu.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/ubuntu.png\" alt=\"ubuntu.png\"></a></p>\n<p>当然，要在虚拟机中使用，还有一些细节性的工作要处理，比如安装VirtualBox的guest需要的相应的内核模块等等，这些在此不谈，读者使用过程中如果发现少啥了，自己装上便是。</p>\n<h3 id=\"Linux下不同发行版的互相访问\">Linux下不同发行版的互相访问</h3>\n<p>我们已经成功地在Windows下运行Linux了，下一步就是想办法在一个Linux系统下访问其他Linux了。由于这些系统都是Linux，而且都在同一个文件系统里面，所以如果只是想要访问一下里面的文件的话，挂载了用就行了。但是很多时候我们还是有需要来运行其他系统里面安装的程序，或者对那个系统进行管理的。应对这种需求有两种解决方案：容器跟虚拟机。</p>\n<p>可能很多读者并不了解这两者的区别，这里简单介绍一下。粗略来讲，虚拟机是通过软件的方式虚拟出一套硬件环境来，并在这套硬件环境中启动内核，然后内核会进行一个完整的开机过程，包括进行相应的初始化，加载init程序等。相比之下，容器则要轻量很多。容器并不会虚拟出自己的硬件环境，也不会额外加载一个内核。容器所做的，就是在现有内核上，运用namespace来创建出一套独立的进程PID、挂载点、网络接口、用户ID等等，由于不同namespace中的这些个ID之类的标识符都是独立的，所以不同namespace中的进程是互相之间看不到对方的，虚拟出来的环境乍看上去就跟在单独运行的一个系统一样，同样有PID为1的init进程，有自己一套独立的rootfs，等等。虚拟机的优点是更不容易被突破，安全性更好，可以使用自己的内核，但是效率也更低。容器的优点是轻便效率高，但是安全性就要稍差一些，也没法使用定制内核。</p>\n<h4 id=\"容器\">容器</h4>\n<p>Linux下大家最熟悉的容器就是chroot了，但是作者并不喜欢chroot，主要原因有两点：</p>\n<ul>\n<li>/proc、 /dev等东西不会自动挂载，每次手动挂载挂的心好累</li>\n<li>没有一个相对完整的开机过程，好多我希望自动启动的服务并不会运行起来</li>\n</ul>\n<p>基于上面的原因，作者在这里推荐的容器是systemd-nspawn。关于systemd-nspawn的介绍跟使用教程，<a href=\"https://wiki.archlinux.org/index.php/Systemd-nspawn\" target=\"_blank\" rel=\"external\">推荐看这里</a>。systemd-nspawn的使用非常简单，假设你的linux分区已经mount到了/mnt上去了，那么你只需要下面步骤就能启动一个systemd-nspawn容器（以Debian为例）：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da51a919351832\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd /mnt/debian\r\nsystemd-nspawn -b</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da51a919351832-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da51a919351832-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da51a919351832-1\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">debian</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da51a919351832-2\"><span class=\"crayon-v\">systemd</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">nspawn</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">b</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>然后就能看到刷刷刷的开机界面了，真的是非常的方便快捷。这里还有一点小技巧是，如果嫌每次开容器都要把linux分区挂载到/mnt上太麻烦，可以在<code>/var/lib/machines</code>里面为每个系统新建一个目录，然后在fstab里面设置一下自动把相应的子卷挂载进去：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da51d540277184\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/dev/disk/by-label/linux        /var/lib/machines/kali          btrfs           defaults,nofail,noatime,discard,subvol=kali            0 0\r\n/dev/disk/by-label/linux        /var/lib/machines/debian        btrfs           defaults,nofail,noatime,discard,subvol=debian          0 0\r\n/dev/disk/by-label/linux        /var/lib/machines/ubuntu        btrfs           defaults,nofail,noatime,discard,subvol=ubuntu          0 0</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da51d540277184-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da51d540277184-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da51d540277184-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da51d540277184-1\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">kali          </span><span class=\"crayon-e\">btrfs           </span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">nofail</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">noatime</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">discard</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">subvol</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">kali</span><span class=\"crayon-h\">            </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da51d540277184-2\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">debian        </span><span class=\"crayon-e\">btrfs           </span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">nofail</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">noatime</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">discard</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">subvol</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">debian</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da51d540277184-3\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ubuntu        </span><span class=\"crayon-e\">btrfs           </span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">nofail</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">noatime</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">discard</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">subvol</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">ubuntu</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0025 seconds] -->\r\n<p>这么做的好处是，根目录位于<code>/var/lib/machines</code>的系统，在启动systemd-nspawn的时候可以直接使用<code>-M</code>选项来指定系统，而不需要进入相应目录。比如如果想启动Ubuntu系统：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da521404209011\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsystemd-nspawn -b -M ubuntu</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da521404209011-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da521404209011-1\"><span class=\"crayon-v\">systemd</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">nspawn</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">b</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">M</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p></p>\n<h4 id=\"虚拟机\">虚拟机</h4>\n<p>如果只是想运行一下其他系统里面的程序，那么容器完全就够用了，但是有的时候我们还是需要玩玩不同的内核的，这就必须得用虚拟机了。通常情况下，大家用虚拟机，都是新建一个磁盘镜像，然后插入安装光盘，然后把光盘安装到镜像上。这么做的坏处，一个是访问镜像中的文件不方便，另一个是，我们在本地已经有安装过若干系统了，不去充分利用一下这些而去再重新往镜像里面安装那实在是舍近求远。那我们就来找一个把子卷当成虚拟机rootfs的方法。困难在于，虚拟机是个很独立的东西，是无法直接访问宿主机的文件系统的。然而幸运的是，Linux的内核虚拟化方案KVM提供了一个把本地文件系统传递给虚拟机的解决方案，用到的东西叫做VirtFS，<a href=\"http://wiki.qemu.org/Documentation/9psetup\" target=\"_blank\" rel=\"external\">相关的文档见这里</a>。</p>\n<p>好消息是，VirtFS是可以作为rootfs的。但是要能正常挂载VirtFS，内核必须要有相应的驱动才行。这里有两种方法可以做到这一点。如果你是自己编译内核的话，那么建议直接将相应的驱动编译进内核而不是模块。根据官网的指示，涉及到的内核配置如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da525875721001\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nCONFIG_NET_9P=y\r\nCONFIG_NET_9P_VIRTIO=y\r\nCONFIG_9P_FS=y\r\nCONFIG_9P_FS_POSIX_ACL=y</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da525875721001-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da525875721001-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da525875721001-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da525875721001-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da525875721001-1\"><span class=\"crayon-v\">CONFIG_NET_9P</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">y</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da525875721001-2\"><span class=\"crayon-v\">CONFIG_NET_9P_VIRTIO</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">y</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da525875721001-3\"><span class=\"crayon-v\">CONFIG_9P_FS</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">y</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da525875721001-4\"><span class=\"crayon-v\">CONFIG_9P_FS_POSIX_ACL</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">y</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>如果使用的是发行版提供的内核的话，那么可以修改initramfs的相关设置保证9p、9pnet、9pnet_virtio三个modules能被安装到initramfs里面去。这里以Ubuntu做guest为例，具体做法是修改Ubuntu系统中的<code>/etc/initramfs-tools/modules</code>文件，增加下面三行：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da528777824425\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n9p\r\n9pnet\r\n9pnet_virtio</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da528777824425-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe73da528777824425-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe73da528777824425-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da528777824425-1\"><span class=\"crayon-cn\">9p</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe73da528777824425-2\"><span class=\"crayon-cn\">9pnet</span></div><div class=\"crayon-line\" id=\"crayon-596bfe73da528777824425-3\"><span class=\"crayon-cn\">9pnet_virtio</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>然后重新生成initramfs即可：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da52b121819380\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nupdate-initramfs -u</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da52b121819380-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da52b121819380-1\"><span class=\"crayon-v\">update</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">initramfs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">u</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>内核驱动设置好了，就可以启动qemu虚拟机了，这里假定Ubuntu的rootfs已经被mount到了<code>/var/lib/machines/ubuntu</code>：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe73da52f130011796\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nqemu-system-x86_64 -enable-kvm -m 16G -kernel /var/lib/machines/ubuntu/vmlinuz -initrd /var/lib/machines/ubuntu/initrd.img -virtfs local,id=root9p,path=/var/lib/machines/ubuntu,security_model=passthrough,mount_tag=root9p -nographic -append 'root=root9p rw rootfstype=9p rootflags=trans=virtio console=ttyS0 init=/lib/systemd/systemd'</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe73da52f130011796-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe73da52f130011796-1\"><span class=\"crayon-v\">qemu</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">system</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">x86_64</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">enable</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">kvm</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">m</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">16G</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">kernel</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">vmlinuz</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">initrd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initrd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">img</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">virtfs </span><span class=\"crayon-v\">local</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">id</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">root9p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">path</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">security_model</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">passthrough</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">mount_tag</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">root9p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">nographic</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">append</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'root=root9p rw rootfstype=9p rootflags=trans=virtio console=ttyS0 init=/lib/systemd/systemd'</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0020 seconds] -->\r\n<p>最后放一张成功的截图：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/qemu-ubuntu.png\" rel=\"group\"><img title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/qemu-ubuntu.png\" alt=\"qemu-ubuntu.png\"></a></p>\n<p>全剧终</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111672\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111672votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111672\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "带着问题学习分布式系统之数据分片", "url": "http://blog.jobbole.com/111716/", "url_object_id": "7005be04c2edd13df9a087263d719892", "create_date": "2017/07/03 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/07/9c3ebd88533763a9cc48fc406d741a1a.png"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 3, "tags": "IT技术,分布式系统", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/xybaby/p/7076731.html\">xybaby</a>   </div><p>听过很多道理，却依然过不好这一生。</p>\n<p>看过很多关于学习的技巧、方法，却没应用到自己的学习中。</p>\n<p>随着年纪变大，记忆力越来越差，整块的时间也越来越少，于是，越来越希望能够更高效的学习。学习是一种习惯也是一种能力，这种能力在上学期间养成是最好的，毕竟那个时候绝大部分时间都在学习。但很遗憾，我没有养成适合自己的、好的学习习惯。工作之后，除了在日常工作中用到的知识技术，很难通过自学掌握新的知识（偏向于专业知识，即技术）。而互联网行业的分支、知识点又是如此之多，于是会出现这样的情况，遇到一个新的知识，觉得很厉害很感兴趣，看两天，但很快就忘记了。另外，对于一些比较庞杂的技术，又无从下手，也很难坚持下去。</p>\n<p>根本的问题在于学习不系统，没有把一个个的知识点连接起来，本来这些新的知识就很少在工作中实践，如果又是一个个的信息孤岛，很快就会被遗忘。另一个问题，没有良好的规划，今天看看这里，明天看看哪里，纠结于细枝末节，忘了从整体上把握。</p>\n<p>幸好，差不多半年前开始意识到了这个问题，开始看书，看别人的博客，开始思考如何充分利用好有限的时间。自己也实践了一些想法，比如写博客，坚持写博客。也有很多没做好，比如如何学习掌握一门新技术。关于这一点，其实看了许多文章，也有很多印象深刻，觉得很有道理；也有一些好书，比如《study more，learn less》。纸上得来终觉浅，绝知此事要躬行，别人的办法再好也需要亲身实践才知道是否对自己适用。</p>\n<p>需要学习的技术很多，要自学新知识也不是一件容易的事，选择一个自己比较感兴趣的会是一个比较好的开端，于是，打算学一学分布式系统。</p>\n<p><strong>带着问题，有目的的学习，先了解整体架构，在深入感兴趣的细节</strong>，这是我的计划。</p>\n<div>首先得有问题，如果每日重复相同的工作，也不主动去学习，很难发现新的问题。不怕自己无知，就怕不知道自己无知，只有不断的学习，才会发现更多未知的知识领域！</div>\n<h3>带着问题出发</h3>\n<p>分布式要解决什么问题呢？解决持久化数据太大，单个节点的硬盘无法存储的问题；解决运算量太大，单个节点的内存、CPU无法处理的问题。解决这些问题，有两种思路：scale up，scale out。前者就是提升单个节点的能力，更大的磁盘，更快的CPU，定制的软硬件，然而这意味着更高的价格，而且再怎么scaleup 也是有上限的。后者就是把存储、计算任务分担到普通的机器上，通过动态增加节点来应对数据量的增长，但缺点是多个节点的管理、任务的调度比较麻烦，这也是分布式系统研究和解决的问题。只有当数据量达到单机无法存储、处理的情况下才考虑分布式，不然都是自找麻烦。</p>\n<div>\n<div>状态的维护比计算要难很多，所谓状态就是需要持久化的数据。因此主要考虑分布式存储，况且即使是分布式计算，为了节省带宽需要尽量保证data locality，也是需要分布式存储。</div>\n<div></div>\n<div>现在有一堆数据，可能是结构化或者半结构化，需要将数据分片（segment、fragment、shard），形成一个个的数据子集，存储到一组物理节点上，物理节点之间通过网络通信。那么需要考虑两个问题：</div>\n<div></div>\n<blockquote>\n<div>第一：数据如何划分;</div>\n<div>第二：数据的可靠性、可用性问题</div>\n</blockquote>\n<h3>数据分片</h3>\n<p>数据分片是指将数据子集尽可能均衡的划分到各个物理节点上。那么会有哪些挑战呢？</p>\n<div>\n<p>（1）如果某个物理节点宕机，如何将该物理节点负责的数据尽快的转移到其他物理节点；</p>\n</div>\n<div>\n<p>（2）如果新增了物理节点，怎么从其他节点迁移数据到新节点；</p>\n</div>\n<p>（3）对于可修改的数据（即不是只能追加的数据），比如数据库数据，如果某节点数据量变大，怎么将部分数据迁移到其他负载较小的节点，及达到动态均衡的效果。</p>\n<div>（4）元数据的管理问题：当数据分布在各个节点，那么当用户使用的时候需要知道具体的数据在哪一个节点上。因此，系统需要维护<strong>数据的元数据：即每一个数据所在的位置、状态等信息</strong>。当用户需要具体的数据时，先查询元数据，然后再去具体的节点上查询。当数据在节点之间迁移的时候，也需要更新元数据。元数据的管理节点这里称之为meta server。元数据的管理也带来了新的挑战：</div>\n<div>（4.1）如何抽取数据的特征（特征是分片的依据，也是用户查询数据时的key），或者支持用户自定义数据特征；</div>\n<p>（4.2）如何保证meta server的高性能和高可用，是单点还是复制集</p>\n<div>（5）分片的粒度，即数据子集的大小，也是数据迁移的基本单位。粒度过粗，不利于数据均衡；粒度过细，管理、迁移成本又会比较大。</div>\n<h3>数据冗余</h3>\n<div>\n<p>前面提到，分布式系统中的节点都是普通的节点，因此有一定的概率会出现物理故障，比如断电、网络不可用，这些故障导致数据的暂时不可用；另外一些故障更严重，会导致数据的丢失，比如磁盘损坏。即使单个节点的故障是小概率，当集群中的节点数目很多是，故障就成为了一个大概率事件。因此，保证数据的高可用和可靠性是分布式系统必须解决的问题。</p>\n<p>为了避免单点故障，可行的办法就是数据冗余（复制集），即将同一份数据放在不同的物理节点，甚至是不同的数据中心。如果数据是一次写，多次读那很好办，随便从哪个副本读取都行。但对于很多分布式存储系统，比如数据库，数据是持续变化的，有读有写。那么复制集会带来什么样的挑战呢，需要如何权衡呢，假设有三个副本：</p>\n<p>（1）三个副本的地位，大家都是平等的还是有主（primary、master）有次（secondary、slave），如果是平等的，那么每个节点都可以接收写操作；如果不平等，可以一个节点负责所有的写操作，所有节点都提供读操作，</p>\n<p>（2）在平等的情况下，怎么保证写入操作不冲突，保证各个节点的数据是一致的，怎么保证能读取到最新的数据</p>\n<div>　　（3）不平等的情况下</div>\n<div>　　　　（3.1）写节点怎么将变更的数据同步到其他节点，同步还是异步；</div>\n<div>　　　　（3.2）非写节点能否提供读数据，如果能够允许，会不会读取到过时的数据。</div>\n<div>　　　　（3.3）主节点是怎么产生的，当主节点宕机的时候，怎么选择出新的主节点。是有统一的复制集管理中心（记录谁主谁次，各自的状态），还是复制集自己选举出一个主节点？</div>\n<p>（4）不管复制集内部的节点是平等的，还是有集中式节点的，只要有多个数据副本，就需要考虑数据的一致性可用性问题。按照CAP理论，只能同时满足一致性 可用性 分区容错性之间的二者，不同的分布式系统需要权衡。</p>\n</div>\n</div>\n<hr>\n<p>在前文中，提出了分布式系统（尤其是分布式存储系统）需要解决的两个最主要的问题，即数据分片和数据冗余，下面这个图片（<a href=\"http://book.mixu.net/distsys/intro.html\" target=\"_blank\">来源</a>）形象生动的解释了其概念和区别：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9c3ebd88533763a9cc48fc406d741a1a.png\" alt=\"\"></p>\n<p>其中数据即A、B属于数据分片，原始数据被拆分成两个正交子集分布在两个节点上。而数据集C属于数据冗余，同一份完整的数据在两个节点都有存储。当然，在实际的分布式系统中，数据分片和数据冗余一般都是共存的。</p>\n<p>本文主要讨论数据分片的三个问题：</p>\n<p>（1）如何做数据分片，即如何将数据映射到节点</p>\n<p>（2）数据分片的特征值，即按照数据中的哪一个属性（字段）来分片</p>\n<p>（3）数据分片的元数据的管理，如何保证元数据服务器的高性能、高可用，如果是一组服务器，如何保证强一致性</p>\n<p>所谓分布式系统，就是利用多个独立的计算机来解决单个节点（计算机）无法处理的存储、计算问题，这是非常典型的分而治之的思想。每个节点只负责原问题（即整个系统需要完成的任务）的一个子集，那么原问题如何拆分到多个节点？在分布式存储系统中，任务的拆分即数据分片。</p>\n<p>何为数据分片（segment，fragment， shard， partition），就是按照一定的规则，将数据集划分成相互独立、正交的数据子集，然后将数据子集分布到不同的节点上。注意，这里提到，数据分片需要按照一定的规则，不同的分布式应用有不同的规则，但都遵循同样的原则：按照最主要、最频繁使用的访问方式来分片。</p>\n<h1>三种数据分片方式</h1>\n<div>　　首先介绍三种分片方式：hash方式，一致性hash（consistent hash），按照数据范围（range based）。对于任何方式，都需要思考以下几个问题：</div>\n<div>\n<ol>\n<li>具体如何划分原始数据集？</li>\n<li>当原问题的规模变大的时候，能否通过增加节点来动态适应？</li>\n<li>当某个节点故障的时候，能否将该节点上的任务均衡的分摊到其他节点？</li>\n<li>对于可修改的数据（比如数据库数据），如果某节点数据量变大，能否以及如何将部分数据迁移到其他负载较小的节点，及达到动态均衡的效果？</li>\n<li>元数据的管理（即数据与物理节点的对应关系）规模？元数据更新的频率以及复杂度？</li>\n</ol>\n<p>为了后面分析不同的数据分片方式，假设有三个物理节点，编号为N0， N1， N2；有以下几条记录：</p>\n<p>R0: {id: 95, name: ‘aa’, tag:’older’}<br>\nR1: {id: 302, name: ‘bb’,}<br>\nR2: {id: 759, name: ‘aa’,}<br>\nR3: {id: 607, name: ‘dd’, age: 18}<br>\nR4: {id: 904, name: ‘ff’,}<br>\nR5: {id: 246, name: ‘gg’,}<br>\nR6: {id: 148, name: ‘ff’,}<br>\nR7: {id: 533, name: ‘kk’,}</p>\n</div>\n<h2>hash方式：</h2>\n<p>哈希表（散列表）是最为常见的数据结构，根据记录（或者对象）的关键值将记录映射到表中的一个槽（slot），便于快速访问。绝大多数编程语言都有对hash表的支持，如python中的dict， C++中的map，Java中的Hashtable， Lua中的table等等。在哈希表中，最为简单的散列函数是 mod N（N为表的大小）。即首先将关键值计算出hash值（这里是一个整型），通过对N取余，余数即在表中的位置。</p>\n<p>数据分片的hash方式也是这个思想，即按照数据的某一特征（key）来计算哈希值，并将哈希值与系统中的节点建立映射关系,从而将哈希值不同的数据分布到不同的节点上。</p>\n<p>我们选择id作为数据分片的key，那么各个节点负责的数据如下：</p>\n<div>　　<img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/60b1cd0b902642fcd732d92d826bf1d7.png\" alt=\"\" width=\"735\" height=\"173\"></div>\n<p>由此可以看到，按照hash方式做数据分片，映射关系非常简单；需要管理的元数据也非常之少，只需要记录节点的数目以及hash方式就行了。</p>\n<div>　　但hash方式的缺点也非常明显：当加入或者删除一个节点的时候，大量的数据需要移动。比如在这里增加一个节点N3，因此hash方式变为了mod 4，数据的迁移如下：</div>\n<div>　　<img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a070c20a578c8728f269a7c5f88a9bc1.png\" alt=\"\"></div>\n<p>在这种方式下，是不满足单调性（Monotonicity）的：如果已经有一些内容通过哈希分派到了相应的缓冲中，又有新的缓冲加入到系统中。哈希的结果应能够保证原有已分配的内容可以被映射到原有的或者新的缓冲中去，而不会被映射到旧的缓冲集合中的其他缓冲区。</p>\n<p>在工程中，为了减少迁移的数据量，节点的数目可以成倍增长，这样概率上来讲至多有50%的数据迁移。</p>\n<div>hash方式还有一个缺点，即很难解决数据不均衡的问题。有两种情况：原始数据的特征值分布不均匀，导致大量的数据集中到一个物理节点上；第二，对于可修改的记录数据，单条记录的数据变大。在这两种情况下，都会导致节点之间的负载不均衡，而且在hash方式下很难解决。</div>\n<h2>一致性hash</h2>\n<div><a href=\"https://en.wikipedia.org/wiki/Consistent_hashing\" target=\"_blank\">一致性hash</a>是将数据按照特征值映射到一个首尾相接的hash环上，同时也将节点（按照IP地址或者机器名hash）映射到这个环上。对于数据，从数据在环上的位置开始，顺时针找到的第一个节点即为数据的存储节点。这里仍然以上述的数据为例，假设id的范围为［0， 1000］，N0， N1， N2在环上的位置分别是100， 400， 800，那么hash环示意图与数据的分布如下：</div>\n<div style=\"text-align: center;\"> 　　<img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/265e3dc723d195313a689e01bc6c542e.png\" alt=\"\">　　<img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bba07578f38434571328a37d984025c0.png\" alt=\"\"></div>\n<p>可以看到相比于上述的hash方式，一致性hash方式需要维护的元数据额外包含了节点在环上的位置，但这个数据量也是非常小的。</p>\n<p>一致性hash在增加或者删除节点的时候，受到影响的数据是比较有限的，比如这里增加一个节点N3，其在环上的位置为600，因此，原来N2负责的范围段（400， 800］现在由N2（400， 600] N3(600, 800]负责，因此只需要将记录R2(id:759), R3(id: 607) 从N2,迁移到N3:</p>\n<div>　　不难发现一致性hash方式在增删的时候只会影响到hash环上响应的节点，不会发生大规模的数据迁移。</div>\n<p>但是，一致性hash方式在增加节点的时候，只能分摊一个已存在节点的压力；同样，在其中一个节点挂掉的时候，该节点的压力也会被全部转移到下一个节点。我们希望的是“一方有难，八方支援”，因此需要在增删节点的时候，已存在的所有节点都能参与响应，达到新的均衡状态。</p>\n<p>因此，在实际工程中，一般会引入虚拟节点（virtual node）的概念。即不是将物理节点映射在hash换上，而是将虚拟节点映射到hash环上。虚拟节点的数目远大于物理节点，因此一个物理节点需要负责多个虚拟节点的真实存储。操作数据的时候，先通过hash环找到对应的虚拟节点，再通过虚拟节点与物理节点的映射关系找到对应的物理节点。</p>\n<p>引入虚拟节点后的一致性hash需要维护的元数据也会增加：第一，虚拟节点在hash环上的问题，且虚拟节点的数目又比较多；第二，虚拟节点与物理节点的映射关系。但带来的好处是明显的，当一个物理节点失效是，hash环上多个虚拟节点失效，对应的压力也就会发散到多个其余的虚拟节点，事实上也就是多个其余的物理节点。在增加物理节点的时候同样如此。</p>\n<p>工程中，<a href=\"http://cloudgroup.neu.edu.cn/papers/cloud%20data%20storage/dynamo-sosp-2007.pdf\" target=\"_blank\">Dynamo</a>、<a href=\"https://cassandra.apache.org/%20%20%20%20\" target=\"_blank\">Cassandra</a>都使用了一致性hash算法，且在比较高的版本中都使用了虚拟节点的概念。在这些系统中，需要考虑综合考虑数据分布方式和数据副本，当引入数据副本之后，一致性hash方式也需要做相应的调整， 可以参加cassandra的相关文档。</p>\n<h2>range based</h2>\n<p>简单来说，就是按照关键值划分成不同的区间，每个物理节点负责一个或者多个区间。其实这种方式跟一致性hash有点像，可以理解为物理节点在hash环上的位置是动态变化的。</p>\n<p>还是以上面的数据举例，三个节点的数据区间分别是N0(0, 200]， N1(200, 500]， N2(500, 1000]。那么数据分布如下：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/97744e5665ed8d8444a5642e0e887714.png\" alt=\"\"></p>\n<p>注意，区间的大小不是固定的，每个数据区间的数据量与区间的大小也是没有关系的。比如说，一部分数据非常集中，那么区间大小应该是比较小的，即以数据量的大小为片段标准。在实际工程中，一个节点往往负责多个区间，每个区间成为一个块（chunk、block），每个块有一个阈值，当达到这个阈值之后就会分裂成两个块。这样做的目的在于当有节点加入的时候，可以快速达到均衡的目的。</p>\n<p>不知道读者有没有发现，如果一个节点负责的数据只有一个区间，range based与没有虚拟节点概念的一致性hash很类似；如果一个节点负责多个区间，range based与有虚拟节点概念的一致性hash很类似。</p>\n<p>range based的元数据管理相对复杂一些，需要记录每个节点的数据区间范围，特别单个节点对于多个区间的情况。而且，在数据可修改的情况下，如果块进行分裂，那么元数据中的区间信息也需要同步修改。</p>\n<p>range based这种数据分片方式应用非常广泛，比如MongoDB, PostgreSQL， HDFS</p>\n<h2>小结：</h2>\n<p>在这里对三种分片方式（应该是四种，有没有virtual node的一致性hash算两种）进行简单总结，主要是针对提出的几个问题：</p>\n<table cellspacing=\"0\" cellpadding=\"2\">\n<colgroup></colgroup>\n<tbody>\n<tr>\n<td></td>\n<td>映射难度</td>\n<td>元数据</td>\n<td>节点增删</td>\n<td>数据动态均衡</td>\n</tr>\n<tr>\n<td>hash方式</td>\n<td>简单</td>\n<td>非常简单，几乎不用修改</td>\n<td>需要迁移的数据比较多</td>\n<td>不支持</td>\n</tr>\n<tr>\n<td>consistent hash<br>\nwithout virtual node</td>\n<td>简单</td>\n<td>比较简单，取决于节点规模，几乎不用修改</td>\n<td>增删节点的时候只影响hash环上相邻节点，但不能使所有节点都参与数据迁移过程</td>\n<td>不支持</td>\n</tr>\n<tr>\n<td>consistent hash<br>\nwith virtual node</td>\n<td>中等</td>\n<td>稍微复杂一些，主要取决于虚拟节点规模，很少修改</td>\n<td>需要迁移的数据比较少，且所有节点都能贡献部分数据</td>\n<td>若支持（修改虚拟节点与物理节点映射关系）</td>\n</tr>\n<tr>\n<td>range based</td>\n<td>较为复杂</td>\n<td>取决于每个块的大小，一般来说规模较大；且修改频率较高</td>\n<td>需要迁移的数据比较少，且所有节点都能贡献部分数据</td>\n<td>支持，且比较容易</td>\n</tr>\n</tbody>\n</table>\n<p>上面的数据动态均衡，值得是上述问题的第4点，即如果某节点数据量变大，能否以及如何将部分数据迁移到其他负载较小的节点</p>\n<h1>分片特征值的选择</h1>\n<p>上面的三种方式都提到了对数据的分片是基于关键值、特征值的。这个特征值在不同的系统中有不同的叫法，比如MongoDB中的<a href=\"https://docs.mongodb.com/manual/core/sharding-shard-key/\" target=\"_blank\">sharding key</a>， Oracle中的<a href=\"https://docs.oracle.com/cd/B28359_01/server.111/b32024/partition.htm\" target=\"_blank\">Partition Key</a>，不管怎么样，这个特征值的选择都是非常非常重要的。</p>\n<p>那么。怎么选择这个特征值呢？《<a href=\"http://book.mixu.net/distsys/intro.html\" target=\"_blank\">Distributed systems for fun and profi</a>t》给出了言简意赅的标准：</p>\n<blockquote><p>　　 based on what you think the primary access pattern will be</p></blockquote>\n<p>大概翻译为：基于最常用的访问模式。访问时包括对数据的增删改查的。比如上面的列子，我们选择“id”作为分片的依据，那么就是默认对的数据增删改查都是通过“id”字段来进行的。</p>\n<p>如果在应用中，大量的数据操作都是通过这个特征值进行，那么数据分片就能提供两个额外的好处：</p>\n<p>（1）提升性能和并发，操作被分发到不同的分片，相互独立</p>\n<p>（2）提升系统的可用性，即使部分分片不能用，其他分片不会受到影响</p>\n<p>如果大量操作并没有使用到特征值，那么就很麻烦了。比如在本文的例子中，如果用name去查询，而元数据记录的是如何根据按照id映射数据位置，那就尴尬了，需要到多有分片都去查一下，然后再做一个聚合！</p>\n<p>另外一个问题，如果以单个字段为特征值（如id），那么不管按照什么分布方式，在多条数据拥有相同的特征值（如id）的情况下，这些数据一定都会分布到同一个节点上。在这种情况下有两个问题，一是不能达到节点间数据的均衡，二是如果数据超过了单个节点的存储能力怎么办？关键在于，即使按照分布式系统解决问题的常规办法 — 增加节点 –也是于事无补的。</p>\n<p>在这个时候，单个字段做特征值就不行了，可能得再增加一个字段作为“联合特征值”，类似数据库中的联合索引。比如，数据是用户的操作日志，可以使用id和时间戳一起作为hash函数的输入，然后算出特征值；但在这种情况下，如果还想以id为查询关键字来查询，那就得遍历所有节点了。</p>\n<p>所以说没有最优的设计，只有最符合应用需求的设计。</p>\n<p>下面以MongoDB中的sharding key为例，解释特征值选择的重要性以及对数据操作的影响。如果有数据库操作基础，即使没有使用过MongoDB，阅读下面的内容应该也没有问题。</p>\n<h2>以MongoDB sharding key为例</h2>\n<p>关于MongoDB Sharded cluster，之前也写过一篇文章《<a href=\"http://www.cnblogs.com/xybaby/p/6832296.html\" target=\"_blank\">通过一步步创建sharded cluster来认识mongodb</a>》，做了简单介绍。在我的工作场景中，除了联合查询（join）和事务，MongoDB的使用和Mysql还是比较相似的，特别是基本的CRUD操作、数据库索引。MongoDb中，每一个分片成为一个shard，分片的特征值成为sharding key，每个数据称之为一个document。选择适合的字段作为shardingkey非常重要，why？</p>\n<p>前面也提到，如果使用非sharding key去访问数据，那么元数据服务器（或者元数据缓存服务器，后面会讲解这一部分）是没法知道对应的数据在哪一个shard上，那么该访问就得发送到所有的shard，得到所有shard的结果之后再做聚合，在mongoDB中，由mongos（缓存有元数据信息）做数据聚合。对于数据读取（R： read or retrieve），通过同一个字段获取到多个数据，是没有问题的，只是效率比较低而已。对于数据更新，如果只能更新一个数据，那么在哪一个shard上更新呢，似乎都不对，这个时候，MongoDB是拒绝的。对应到MongoDB（MongoDD3.0）的命令包括但不限于：</p>\n<ul>\n<li>　　findandmodify：这个命令只能更新一个document，因此查询部分必须包含sharding key</li>\n</ul>\n<blockquote><p>　　When using <code>findAndModify</code> in a sharded environment, the <code>query</code> must contain the shard key for all operations against the shard cluster for the <em>sharded</em> collections.</p></blockquote>\n<ul>\n<li>　　update：这个命令有一个参数multi，默认是false，即只能更新一个document，此时查询部分必须包含sharding key</li>\n</ul>\n<blockquote>\n<div>All <code>update()</code> operations for a sharded collection that specify the <code>multi: false</code> option must include theshard key <em>or</em> the <code>_id</code> field in the query specification.</div>\n</blockquote>\n<ul>\n<li> 　  remove：有一个参数JustOne，如果为True，只能删除一个document，也必须使用sharidng key</li>\n</ul>\n<p>另外，熟悉sql的同学都知道，在数据中索引中有unique index（唯一索引），即保证这个字段的值在table中是唯一的。mongoDB中，也可以建立unique index，但是在sharded cluster环境下，只能对sharding key创建unique index，道理也很简单，如果unique index不是sharidng key，那么插入的时候就得去所有shard上查看，而且还得加锁。</p>\n<p>接下来，讨论分片到shard上的数据不均的问题，如果一段时间内shardkey过于集中（比如按时间增长），那么数据只往一个shard写入，导致无法平衡集群压力。</p>\n<div>　　MongoDB中提供了”<a href=\"https://docs.mongodb.com/manual/core/ranged-sharding/\" target=\"_blank\">range partition</a>“和”<a href=\"https://docs.mongodb.com/manual/core/hashed-sharding/\" target=\"_blank\">hash partition</a>“，<strong>这个跟上面提到的分片方式 hash方式， ranged based不是一回事儿</strong>，而是指对sharding key处理。MongoDB一定是ranged base分片方式,<a href=\"https://docs.mongodb.com/manual/core/sharding-shard-key/\" target=\"_blank\">docuemnt</a>中如是说：</div>\n<blockquote>\n<div>MongoDB <a href=\"https://docs.mongodb.com/manual/reference/glossary/#term-data-partition\">partitions</a> data in the collection using ranges of shard key values. Each range defines a non-overlapping range of shard key values and is associated with a <a href=\"https://docs.mongodb.com/manual/reference/glossary/#term-chunk\">chunk</a>.</div>\n</blockquote>\n<p>那么什么是”range partition”和”hash partition”，官网的一张图很好说明了二者的区别：</p>\n<p style=\"text-align: center;\">　　<img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4f75dba562d78dd3cf88e6a0420a83b6.png\" alt=\"\" width=\"496\" height=\"248\">            <img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/13aa93953848ef771a508070a6e68ee7.png\" alt=\"\" width=\"504\" height=\"252\"></p>\n<p>　　上图左是range partition，右是hash partition。range partition就是使用字段本身作为分片的边界，比如上图的x；而hash partition会将字段重新hash到一个更大、更离散的值域区间。</p>\n<p>hash partition的最大好处在于保证数据在各个节点上均匀分布（这里的均匀指的是在写入的时候就均匀，而不是通过MongoDB的balancing功能）。比如MongoDB中默认的_id是objectid，objectid是一个12个字节的BSON类型，前4个字节是机器的时间戳，那么如果在同一时间大量创建以ObjectId为_id的数据 会分配到同一个shard上，此时若将_id设置为hash index 和 hash sharding key，就不会有这个问题。</p>\n<p>当然，hash  partition相比range partition也有一个很大的缺点，就是范围查询的时候效率低！因此到底选用hash  partition还是range partition还得根据应用场景来具体讨论。</p>\n<p>最后得知道，sharding key一但选定，就无法修改（Immutable）。如果应用必须要修改sharidng key，那么只能将数据导出，新建数据库并创建新的sharding key，最后导入数据。</p>\n<h1>元数据服务器</h1>\n<p>在上面讨论的三种数据分片分式中，或多或少都会记录一些元数据：数据与节点的映射关系、节点状态等等。我们称记录元数据的服务器为元数据服务器（metaserver），不同的系统叫法不一样，比如master、configserver、namenode等。</p>\n<p>元数据服务器就像人类的大脑，一只手不能用了还没忍受，大脑不工作整个人就瘫痪了。因此，元数据服务器的<strong>高性能、高可用</strong>，要达到这两个目标，元数据服务器就得高<strong>可扩展</strong> — 以此应对元数据的增长。</p>\n<p>元数据的高可用要求元数据服务器不能成为故障单点（single point of failure），因此需要元数据服务器有多个备份，并且能够在故障的时候迅速切换。</p>\n<p>有多个备份，那么问题就来了，怎么保证多个备份的数据一致性？</p>\n<p>多个副本的一致性、可用性是CAP理论讨论的范畴，这里简单介绍两种方案。第一种是主从同步，首先选出主服务器，只有主服务器提供对外服务，主服务器将元数据的变革信息以日志的方式持久化到共享存储（例如nfs），然后从服务器从共享存储读取日志并应用，达到与主服务器一致的状态，如果主服务器被检测到故障（比如通过心跳），那么会重新选出新的主服务器。第二种方式，通过分布式一致性协议来达到多个副本件的一致，比如大名鼎鼎的Paxos协议，以及工程中使用较多的Paxos的特化版本 — Raft协议，协议可以实现所有备份均可以提供对外服务，并且保证强一致性。</p>\n<h2>HDFS元数据</h2>\n<p>HDFS中，元数据服务器被称之为namenode，在hdfs1.0之前，namenode还是单点，一旦namenode挂掉，整个系统就无法工作。在hdfs2.0，解决了namenode的单点问题。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/8221eac439b32bd000638097d281c3bb.png\" alt=\"\"></p>\n<p>上图中NN即NameNode， DN即DataNode（即实际存储数据的节点）。从图中可以看到， 两台 NameNode 形成互备，一台处于 Active 状态，为主 NameNode，另外一台处于 Standby 状态，为备 NameNode，<strong>只有主 NameNode 才能对外提供读写服务</strong>。</p>\n<p>Active NN与standby NN之间的数据同步通过共享存储实现，共享存储系统保证了Namenode的高可用。为了保证元数据的强一致性，在进行准备切换的时候，新的Active NN必须要在确认元数据完全同步之后才能继续对外提供服务。</p>\n<p>另外，Namenode的状态监控以及准备切换都是Zookeeper集群负责，在网络分割（network partition）的情况下，有可能zookeeper认为原来的Active NN挂掉了，选举出新的ActiveNN，但实际上原来的Active NN还在继续提供服务。这就导致了“双主“或者脑裂（brain-split）现象。为了解决这个问题，提出了fencing机制，也就是想办法把旧的 Active NameNode 隔离起来，使它不能正常对外提供服务。具体参见<a href=\"https://www.ibm.com/developerworks/cn/opensource/os-cn-hadoop-name-node/\" target=\"_blank\">这篇文章</a>。</p>\n<h2>MongoDB元数据</h2>\n<p>MongoDB中，元数据服务器被称为config server。在MongoDB3.2中，已经不再建议使用三个镜像(Mirrored)MongoDB实例作为config server，而是推荐使用复制集（replica set）作为config server，此举的目的是增强config server的一致性，而且config sever中mongod的数目也能从3个达到replica set的上线（50个节点），从而提高了可靠性。</p>\n<p>在MongoDB3.0及之前的版本中，元数据的读写按照下面的方式进行：</p>\n<blockquote><p>　　When writing to the three config servers, a <strong>coordinator</strong> dispatches the same write commands to the three config servers and collects the results. Differing results indicate an inconsistent writes to the config servers and may require manual intervention.</p></blockquote>\n<p>MongoDB的官方文档并没有详细解释这一过程，不过在<a href=\"https://dba.stackexchange.com/questions/91194/why-does-mongodb-require-three-config-servers\" target=\"_blank\">stackexchange</a>上，有人指出这个过程是两阶段提交。</p>\n<p>MongoDB3.2及之后的版本，使用了replica set config server，在《<a href=\"http://www.cnblogs.com/xybaby/p/6871764.html\" target=\"_blank\">CAP理论与MongoDB一致性、可用性的一些思考</a>》文章中，详细介绍了replica set的write concern、read concern和read references，这三个选项会影响到复制集的一致性、可靠性与读取性能。在config server中，使用了WriteConcern：Majority；ReadConcern：Majority；ReadReferences：nearest。</p>\n<h2>元数据的缓存：</h2>\n<p>即使元数据服务器可以由一组物理机器组成，也保证了副本集之间的一致性问题。但是如果每次对数据的请求都经过元数据服务器的话，元数据服务器的压力也是非常大的。很多应用场景，元数据的变化并不是很频繁，因此可以在访问节点上做缓存，这样应用可以直接利用缓存数据进行数据读写，减轻元数据服务器压力。</p>\n<p>在这个环境下，缓存的元数据必须与元数据服务器上的元数据一致，缓存的元数据必须是准确的，未过时的。相反的例子是DNS之类的缓存，即使使用了过期的DNS缓存也不会有太大的问题。</p>\n<p>怎么达到缓存的强一致性呢？比较容易想到的办法是当metadata变化的时候立即通知所有的缓存服务器（mongos），但问题是通信有延时，不可靠。</p>\n<p>解决不一致的问题，一个比较常见的思路是版本号，比如网络通信，通信协议可能会发生变化，通信双方为了达成一致，那么可以使用版本号。在缓存一致性的问题上，也可以使用版本号，基本思路是请求的时候带上缓存的版本号，路由到具体节点之后比较实际数据的版本号，如果版本号不一致，那么表示缓存信息过旧，此时需要从元数据服务器重新拉取元数据并缓存。在MongoDB中，mongos缓存上就是使用的这种办法。</p>\n<p>另外一种解决办法，就是大名鼎鼎的lease机制 — “An Efficient Fault-Tolerant Mechanism for Distributed File Cache Consistency”，lease机制在分布式系统中使用非常广泛，不仅仅用于分布式缓存，在很多需要达成某种约定的地方都大显身手，在《分布式系统原理介绍》中，对lease机制有较为详细的描述，下面对lease机制进行简单介绍。</p>\n<h2>Lease机制：</h2>\n<p>既然，Lease机制提出的时候是为了解决分布式存储系统中缓存一致性的问题，那么首先来看看Lease机制是怎么保证缓存的强一致性的。<strong>注意</strong>，为了方便后文描述，在本小节中，我们称元数据服务器为服务器，缓存服务器为客户端。</p>\n<p><strong>要点</strong>：</p>\n<ul>\n<li>　　服务器向所有客户端发送缓存数据的同时，颁发一个lease，lease包含一个有限期（即过期时间）</li>\n<li>　　lease的含义是：在这个有效期内，服务器保证元数据不会发生变化</li>\n<li>　　因此客户端在这个有效期内可以放心大胆的使用缓存的元数据，如果超过了有效期，就不能使用数据了，就得去服务器请求。</li>\n<li>　　如果外部请求修改服务器上的元数据（元数据的修改一定在服务器上进行），那么服务器会阻塞修改请求，直到所有已颁发的lease过期，然后修改元数据，并将新的元数据和新的lease发送到客户端</li>\n<li>　　如果元数据没有发生变化，那么服务器也需要在之前已颁发的lease到期之间，重新给客户端颁发新的lease（只有lease，没有数据）</li>\n</ul>\n<p>在Lease论文的标题中，提到了“Fault-Tolerant”，那么lease是怎么做到容错的呢。关键在于，只要服务器一旦发出数据和lease，不关心客户端是否收到数据，只要等待lease过期，就可以修改元数据；另外，lease的有效期通过过期时间（一个时间戳）来标识，因此即使从服务器到客户端的消息延时到达、或者重复发送都是没有关系的。</p>\n<p>不难发现，容错的前提是服务器与客户端的时间要一致。如果服务器的时间比客户端的时间慢，那么客户端收到lease之后很快就过期了，lease机制就发挥不了作用；如果服务器的时间比客户端的时间快，那么就比较危险，因为客户端会在服务器已经开始更新元数据的时候继续使用缓存，工程中，通常将服务器的过期时间设置得比客户端的略大，来解决这个问题。为了保持时间的一致，最好的办法是使用NTP（Network Time Protocol）来保证时钟同步。</p>\n<p>Lease机制的本质是颁发者授予的在某一有效期内的承诺，承诺的范围是非常广泛的：比如上面提到的cache；比如做权限控制，例如当需要做并发控制时，同一时刻只给某一个节点颁发lease，只有持有lease的节点才可以修改数据；比如身份验证，例如在primary-secondary架构中，给节点颁发lease，只有持有lease的节点才具有primary身份；比如节点的状态监测，例如在primary-secondary架构中监测primary是否正常，这个后文再详细介绍。</p>\n<p>工程中，lease机制也有大量的应用：GFS中使用Lease确定Chuck的Primary副本, Lease由Master节点颁发给primary副本，持有Lease的副本成为primary副本。chubby通过paxos协议实现去中心化的选择primary节点，然后Secondary节点向primary节点发送lease，该lease的含义是：“承诺在lease时间内，不选举其他节点成为primary节点”。chubby中，primary节点也会向每个client节点颁发lease。该lease的含义是用来判断client的死活状态，一个client节点只有只有合法的lease，才能与chubby中的primary进行读写操作。</p>\n<h1>总结</h1>\n<p>本文主要介绍分布式系统中的分片相关问题，包括三种分布方式：hash、一致性hash、range based，以及各自的优缺点。分片都是按照一定的特征值来进行，特征值应该从应用的使用场景来选取，并结合MongoDB展示了特征值（mongodb中的sharding key）对数据操作的影响。分片信息（即元数据）需要专门的服务器存储，元数据服务器是分布式存储系统的核心，因此需要提到其可用性和可靠性，为了减轻元数据服务器的压力，分布式系统中，会在其他节点缓存元数据，缓存的元数据由带来了一致性的挑战，由此引入了Lease机制。</p>\n<h1>references</h1>\n<ul>\n<li>刘杰的《分布式系统原理介绍》</li>\n<li><a href=\"http://book.mixu.net/distsys/\" target=\"_blank\">Distributed systems for fun and profit  </a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/Consistent_hashing\" target=\"_blank\">Wiki：Consistent_hashing</a></li>\n<li><a href=\"https://www.ibm.com/developerworks/cn/opensource/os-cn-hadoop-name-node/\" target=\"_blank\">Hadoop NameNode 高可用 (High Availability) 实现解析</a></li>\n<li><a href=\"http://www.cnblogs.com/xybaby/p/6871764.html\" target=\"_blank\">CAP理论与MongoDB一致性、可用性的一些思考</a></li>\n<li><a href=\"http://web.eecs.umich.edu/~mosharaf/Readings/Leases.pdf\" target=\"_blank\">Leases: An Efficient Fault-Tolerant Mechanism for Distributed File Cache Consistency</a></li>\n</ul>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111716\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111716votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111716\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "ASP.NET Core 2.0 新功能汇总", "url": "http://blog.jobbole.com/111534/", "url_object_id": "f7fa476bb742d228be961501bbcc2938", "create_date": "2017/06/30 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/06/a691babb749ea56405877127a4d45736.png"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 0, "tags": "开发,.NET Core", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/savorboard/p/aspnetcore2-feature.html\">Savorboard</a>   </div><div>\n<h3 id=\"前言\">前言</h3>\n<p>ASP.NET Core 的变化和发展速度是飞快的，当你发现你还没有掌握 ASP.NET Core 1.0 的时候， 2.0 已经快要发布了，目前 2.0 处于 Preview 1 版本，意味着功能已经基本确定，还没有学习过 ASP.NET Core 的同学可以直接从 2.0 开始学起，但是如果你已经掌握了 1.0 的话，那么你只需要了解在 2.0 中增加和修改的一些功能即可。</p>\n<p>每一次大版本的发布和升级，总会带给开发人员一些惊喜和令人兴奋的特性，有关 ASP.NET Core 本次的 2.0 版本的新特性，主要集中在几个部分上。</p>\n<h3 id=\"sdk-的变化\">SDK 的变化</h3>\n<p>PS: 目前如果你想在VS中体验 ASP.NET Core 2.0 全部特性的话，你需要 VS 2017.3 预览版本。当然你可以使用 VS Core 来快速了解。</p>\n<p>.NET Core 2.0 Priview 的下载地址：<br>\n<a href=\"https://www.microsoft.com/net/core/preview#windowscmd\">https://www.microsoft.com/net/core/preview#windowscmd</a></p>\n<p>完成之后可以在 cmd 中使用以下命令查看版本。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/ab55900c39118415725f32ac7906f437.png\"></p>\n<p><strong>变化1</strong>：添加了如下图箭头所指新命令。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/c1586e500a04c565a23bbe72f2cf2f0d.png\"></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d9720548715984\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndotnet new razor\r\ndotnet new nugetconfig\r\ndotnet new page\r\ndotnet new viewimports\r\ndotnet new viewstart</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9720548715984-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9720548715984-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9720548715984-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9720548715984-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9720548715984-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d9720548715984-1\"><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">razor</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9720548715984-2\"><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">nugetconfig</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9720548715984-3\"><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">page</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9720548715984-4\"><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">viewimports</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9720548715984-5\"><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">viewstart</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>添加了这些新的cli命令。 其中 <code>viewimports</code>,<code>viewstart</code> 即为Razor视图中的_xxx.cshtml那两个文件.</p>\n<p><strong>变化2</strong>： <code>dotnet new xxx</code> 将会自动还原 NuGet 包，不需要你再次进行 <code>dotnet restore</code> 命令了。</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d972a228961393\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nG:SampleASPNETCore2 &gt; dotnet new mvc\r\n\r\nThe template \"ASP.NET Core Web App (Model-View-Controller)\" was created successfully.\r\nThis template contains technologies from parties other than Microsoft, see https://aka.ms/template-3pn for details.\r\n\r\nProcessing post-creation actions...\r\nRunning 'dotnet restore' on G:SampleASPNETCore2ASPNETCore2.csproj...\r\nRestore succeeded.</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d972a228961393-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d972a228961393-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d972a228961393-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d972a228961393-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d972a228961393-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d972a228961393-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d972a228961393-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d972a228961393-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d972a228961393-1\"><span class=\"crayon-v\">G</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">SampleASPNETCore2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">mvc</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d972a228961393-2\"> </div><div class=\"crayon-line\" id=\"crayon-596bfce4d972a228961393-3\"><span class=\"crayon-e\">The </span><span class=\"crayon-i\">template</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"ASP.NET Core Web App (Model-View-Controller)\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">was </span><span class=\"crayon-e\">created </span><span class=\"crayon-v\">successfully</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d972a228961393-4\"><span class=\"crayon-r\">This</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">template </span><span class=\"crayon-e\">contains </span><span class=\"crayon-e\">technologies </span><span class=\"crayon-e\">from </span><span class=\"crayon-e\">parties </span><span class=\"crayon-e\">other </span><span class=\"crayon-e\">than </span><span class=\"crayon-v\">Microsoft</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">see </span><span class=\"crayon-v\">https</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//aka.ms/template-3pn for details.</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d972a228961393-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d972a228961393-6\"><span class=\"crayon-e\">Processing </span><span class=\"crayon-v\">post</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">creation </span><span class=\"crayon-v\">actions</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d972a228961393-7\"><span class=\"crayon-i\">Running</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'dotnet restore'</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">on</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">G</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">SampleASPNETCore2ASPNETCore2</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">csproj</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d972a228961393-8\"><span class=\"crayon-e\">Restore </span><span class=\"crayon-v\">succeeded</span><span class=\"crayon-sy\">.</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0015 seconds] -->\r\n\n</div>\n<h3 id=\"csproj-项目文件\">*.csproj 项目文件</h3>\n<p>在 2.0 中，当创建一个 MVC 项目的时候，生成的 csporj 项目文件如下：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/97fdfcb1ba546862f303e979c9e1abf6.png\"></p>\n<p>其中，红色箭头部分为新增内容，我们依次来看一下：</p>\n<p><strong>MvcRazorCompileOnPublish</strong>：</p>\n<p>在 1.0 版本中，如果我们需要在发布的时候编译 MVC 中的 Views 文件夹为DLL的话，需要引用<br>\n<code>Microsoft.AspNetCore.Mvc.Razor.ViewCompilation</code> 这个 NuGet 包，而现在已经不需要了，这个功能已经默认的集成在了SDK中，只需要在csporj添加配置即可，在发布的时候将会自动打包 Views 文件夹中的 *.cshtml 文件为 DLL 程序集。</p>\n<p><strong>PackageTargetFallback</strong></p>\n<p>这个配置项是用来配置当前程序集支持的目标框架。</p>\n<p><strong>UserSecretsId</strong></p>\n<p>这个是用来存储程序中使用的机密，以前是存储在 <code>project.json</code> 文件中，现在你可以在这里进行配置了。</p>\n<p>有关 UserSecrets 的更多信息，可以查看我的<a href=\"http://www.cnblogs.com/savorboard/p/dotnetcore-user-secrets.html\">这篇博客文章</a>。</p>\n<p><strong>MVC 相关包</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d972f869766093\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n&lt;packagereference include=\"Microsoft.AspNetCore.All\" version=\"2.0.0-preview1-final\"/&gt;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d972f869766093-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d972f869766093-1\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">packagereference </span><span class=\"crayon-v\">include</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"Microsoft.AspNetCore.All\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">version</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"2.0.0-preview1-final\"</span><span class=\"crayon-o\">/</span><span class=\"crayon-o\">&gt;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>在 Core MVC 2.0 中，所有MVC相关的NuGet 包都被集成到了这个<code>Microsoft.AspNetCore.All</code>包中，它是一个元数据包，包含了大量的东西，其中包括：Authorization, Authentication, Identity, CORS, Localization, Logging, Razor, Kestrel 等，除了这些它还附加了 EntityFramework, SqlServer, Sqlite 等包。</p>\n<p>有些同学可能会觉得这样会引用了很多项目中使用不到的程序集，导致发布后的程序变得很庞大，不过我要告诉你不必担心，发布后的程序集不但不会变得很大，反而会小很多，因为 Microsoft 把所有的这些依赖全部都集成到了sdk中，也就是说当你安装sdk的之后，MVC相关的包就已经安装到了你的系统上。</p>\n<p>这样的好处是你不用担心更新Nuget包或者删除的时候，因为大量的版本不一致问题导致隐藏的冲突问题，另外一个好处就是，这样对于很多新手的话就很友好 2333，他们不需要知道他们什么情况下会从那个NuGet 包中获取自己需要的信息。</p>\n<p><strong>现在</strong>，发布后的文件夹是如此简洁： 大小 4.3M</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/45fbe5a1339d55457e306c99537e2275.png\"></p>\n<p>再贴个<strong>以前的</strong> 发布后的文件夹你们感受一下: 大小 16.5M</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/4ed198a340b62b14d8b07293a2729a09.png\"></p>\n<p>有些同学可能好奇他们把那些引用的 MVC 包放到哪里了，默认情况下他们位于这个目录：</p>\n<p><code>C:Program Filesdotnetstorex64netcoreapp2.0</code></p>\n<h3 id=\"新的-program.cs-和-startup.cs\">新的 Program.cs 和 Startup.cs</h3>\n<p>现在，当创建一个 ASP.NET Core 2.0 MVC 程序的时候，Program 和 Startup 已经发生了变化，他们已经变成了这样：</p>\n<p><em>Program.cs</em></p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d9735910732401\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npublic class Program\r\n{\r\n    public static void Main(string[] args)\r\n    {\r\n        BuildWebHost(args).Run();\r\n    }\r\n\r\n    public static IWebHost BuildWebHost(string[] args) =&gt;\r\n        WebHost.CreateDefaultBuilder(args)\r\n            .UseStartup&lt;Startup&gt;()\r\n            .Build();\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9735910732401-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9735910732401-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9735910732401-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9735910732401-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9735910732401-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9735910732401-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9735910732401-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9735910732401-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9735910732401-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9735910732401-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9735910732401-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9735910732401-12\">12</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d9735910732401-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Program</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9735910732401-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9735910732401-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9735910732401-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9735910732401-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">BuildWebHost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Run</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9735910732401-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9735910732401-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9735910732401-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IWebHost </span><span class=\"crayon-e\">BuildWebHost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9735910732401-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">WebHost</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">CreateDefaultBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9735910732401-10\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">UseStartup</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">Startup</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9735910732401-11\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Build</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9735910732401-12\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0018 seconds] -->\r\n\n</div>\n<p><em>Startup.cs</em></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d9739973856117\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npublic class Startup\r\n{\r\n    public Startup(IConfiguration configuration)\r\n    {\r\n        Configuration = configuration;\r\n    }\r\n    \r\n    public IConfiguration Configuration { get; }\r\n    \r\n    public void ConfigureServices(IServiceCollection services)\r\n    {\r\n        services.AddMvc();\r\n    }\r\n\r\n    public void Configure(IApplicationBuilder app, IHostingEnvironment env)\r\n    {\r\n        if (env.IsDevelopment())\r\n        {\r\n            app.UseDeveloperExceptionPage();\r\n        }\r\n        else\r\n        {\r\n            app.UseExceptionHandler(\"/Home/Error\");\r\n        }\r\n\r\n        app.UseStaticFiles();\r\n\r\n        app.UseMvc(routes =&gt;\r\n        {\r\n            routes.MapRoute(\r\n                name: \"default\",\r\n                template: \"{controller=Home}/{action=Index}/{id?}\");\r\n        });\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9739973856117-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9739973856117-35\">35</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Startup</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Startup</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">configuration</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">configuration</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-7\"><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IConfiguration</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-9\"><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ConfigureServices</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IServiceCollection </span><span class=\"crayon-v\">services</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">services</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddMvc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-14\"> </div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Configure</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IApplicationBuilder </span><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IHostingEnvironment </span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">IsDevelopment</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-19\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseDeveloperExceptionPage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-23\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseExceptionHandler</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/Home/Error\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-25\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseStaticFiles</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-27\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseMvc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">routes</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-30\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">routes</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">MapRoute</span><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-31\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"default\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-32\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">template</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"{controller=Home}/{action=Index}/{id?}\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9739973856117-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9739973856117-35\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0034 seconds] -->\r\n<p>可以发现，新的 Program.cs 中和 Startup.cs 中的内容已经变得很简单了，少了很多比如 appsetting.json 文件的添加，日志中间件， Kertrel ， HostingEnvironment 等，那么是怎么回事呢？ 其他他们已经被集成到了 <code>WebHost.CreateDefaultBuilder</code> 这个函数中，那么我们跟进源码来看一下内部是怎么做的。</p>\n<h4 id=\"webhost.createdefaultbuilder\">WebHost.CreateDefaultBuilder</h4>\n<p>下面是 <code>WebHost.CreateDefaultBuilder</code> 这个函数的源码：</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d973d439019129\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npublic static IWebHostBuilder CreateDefaultBuilder(string[] args)\r\n{\r\n    var builder = new WebHostBuilder()\r\n        .UseKestrel()\r\n        .UseContentRoot(Directory.GetCurrentDirectory())\r\n        .ConfigureAppConfiguration((hostingContext, config) =&gt;\r\n        {\r\n            var env = hostingContext.HostingEnvironment;\r\n\r\n            config.AddJsonFile(\"appsettings.json\", optional: true, reloadOnChange: true)\r\n                  .AddJsonFile($\"appsettings.{env.EnvironmentName}.json\", optional: true, reloadOnChange: true);\r\n\r\n            if (env.IsDevelopment())\r\n            {\r\n                var appAssembly = Assembly.Load(new AssemblyName(env.ApplicationName));\r\n                if (appAssembly != null)\r\n                {\r\n                    config.AddUserSecrets(appAssembly, optional: true);\r\n                }\r\n            }\r\n\r\n            config.AddEnvironmentVariables();\r\n\r\n            if (args != null)\r\n            {\r\n                config.AddCommandLine(args);\r\n            }\r\n        })\r\n        .ConfigureLogging((hostingContext, logging) =&gt;\r\n        {\r\n            logging.UseConfiguration(hostingContext.Configuration.GetSection(\"Logging\"));\r\n            logging.AddConsole();\r\n            logging.AddDebug();\r\n        })\r\n        .UseIISIntegration()\r\n        .UseDefaultServiceProvider((context, options) =&gt;\r\n        {\r\n            options.ValidateScopes = context.HostingEnvironment.IsDevelopment();\r\n        })\r\n        .ConfigureServices(services =&gt;\r\n        {\r\n            services.AddTransient&lt;IConfigureOptions&lt;KestrelServerOptions&gt;, KestrelServerOptionsSetup&gt;();\r\n        });\r\n\r\n    return builder;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d973d439019129-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d973d439019129-46\">46</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IWebHostBuilder </span><span class=\"crayon-e\">CreateDefaultBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">builder</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebHostBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-4\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseKestrel</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseContentRoot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Directory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetCurrentDirectory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ConfigureAppConfiguration</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hostingContext</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-8\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">env</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hostingContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">HostingEnvironment</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-10\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddJsonFile</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"appsettings.json\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">optional</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">reloadOnChange</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-11\"><span class=\"crayon-h\">                  </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddJsonFile</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"appsettings.{env.EnvironmentName}.json\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">optional</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">reloadOnChange</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-12\"> </div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-13\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">IsDevelopment</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-14\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-15\"><span class=\"crayon-h\">                </span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">appAssembly</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Assembly</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Load</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AssemblyName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ApplicationName</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-16\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">appAssembly</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-17\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-18\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddUserSecrets</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">appAssembly</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">optional</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-19\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-20\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-22\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddEnvironmentVariables</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-23\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-24\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">args</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-25\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-26\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddCommandLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-27\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ConfigureLogging</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hostingContext</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">logging</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-31\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">logging</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseConfiguration</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hostingContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetSection</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"Logging\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-32\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">logging</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddConsole</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-33\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">logging</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddDebug</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-34\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseIISIntegration</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseDefaultServiceProvider</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-37\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-38\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ValidateScopes</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">HostingEnvironment</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">IsDevelopment</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-39\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-40\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ConfigureServices</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">services</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-41\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-42\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">services</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">AddTransient</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">IConfigureOptions</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">KestrelServerOptions</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">KestrelServerOptionsSetup</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-44\"> </div><div class=\"crayon-line\" id=\"crayon-596bfce4d973d439019129-45\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">builder</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d973d439019129-46\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0067 seconds] -->\r\n\n</div>\n<p>可看到，新的方式已经隐藏了很多细节，帮助我们完成了大部分的配置工作。但是你知道怎么样来自定义这些中间件或者配置也是必要的技能之一。</p>\n<h3 id=\"appsettings.json-的变化\">appsettings.json 的变化</h3>\n<p>在 appsettings.json 中，我们可以定义 Kestrel 相关的配置，应用程序会在启动的时候使用该配置进行Kerstrel的启动。</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d9742526031982\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n{\r\n    \"Kestrel\": {\r\n        \"Endpoints\": {\r\n            \"Localhost\": {\r\n                \"Address\": \"127.0.0.1\",\r\n                \"Port\": \"9000\"\r\n            },\r\n            \"LocalhostHttps\": {\r\n                \"Address\": \"127.0.0.1\",\r\n                \"Port\": \"9001\",\r\n                \"Certificate\": \"Https\"\r\n            }\r\n        }\r\n    },\r\n    \"Certificate\": {\r\n        \"HTTPS\": {\r\n            \"Source\": \"Store\",\r\n            \"StoreLocation\": \"LocalMachine\",\r\n            \"StoreName\": \"MyName\",\r\n            \"Subject\": \"CN=localhost\",\r\n            \"AllowInvalid\": true\r\n        }\r\n    },\r\n    \"Logging\": {\r\n        \"IncludeScopes\": false,\r\n        \"LogLevel\": {\r\n            \"Default\": \"Warning\"\r\n        }\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9742526031982-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9742526031982-30\">30</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-1\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-s\">\"Kestrel\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Endpoints\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-4\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"Localhost\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-5\"><span class=\"crayon-h\">                </span><span class=\"crayon-s\">\"Address\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"127.0.0.1\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-6\"><span class=\"crayon-h\">                </span><span class=\"crayon-s\">\"Port\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"9000\"</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-7\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-8\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"LocalhostHttps\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-9\"><span class=\"crayon-h\">                </span><span class=\"crayon-s\">\"Address\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"127.0.0.1\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-10\"><span class=\"crayon-h\">                </span><span class=\"crayon-s\">\"Port\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"9001\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-11\"><span class=\"crayon-h\">                </span><span class=\"crayon-s\">\"Certificate\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Https\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-12\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-s\">\"Certificate\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"HTTPS\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-17\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"Source\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Store\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-18\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"StoreLocation\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"LocalMachine\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-19\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"StoreName\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"MyName\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-20\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"Subject\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"CN=localhost\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-21\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"AllowInvalid\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-s\">\"Logging\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"IncludeScopes\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"LogLevel\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-27\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"Default\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Warning\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9742526031982-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9742526031982-30\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0028 seconds] -->\r\n\n</div>\n<p>以上配置内容配置了 Kertrel 启动的时候使用的本地地址和端口，以及在生产环境需要使用的 HTTPS 的配置项，通常情况下关于 HTTPS 的节点配置部分应该位于 appsettings.Production.json 文件中。</p>\n<p>现在，<code>dotnet run</code>在启动的时候将同时监听 9000, 和 9001 端口。</p>\n<h3 id=\"日志的变化\">日志的变化</h3>\n<p>在 ASP.NET Core 2.0 中关于日志的变化是非常令人欣慰的，因为它现在不是作为MVC中间件配置的一部分了，而是 Host 的一部分，这句话好像有点别扭，囧~。 这意味着你可以记录到更加底层产生的一些错误信息了。</p>\n<p>现在你可以这样来扩展日志配置。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d9747734897304\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n  public static IWebHost BuildWebHost(string[] args) =&gt;\r\n        WebHost.CreateDefaultBuilder(args)\r\n        .UseStartup&lt;Startup&gt;()\r\n        .ConfigureLogging(factory=&gt;{你的配置})\r\n        .Build();</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9747734897304-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9747734897304-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9747734897304-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d9747734897304-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d9747734897304-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d9747734897304-1\"><span class=\"crayon-h\">  </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IWebHost </span><span class=\"crayon-e\">BuildWebHost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9747734897304-2\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">WebHost</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">CreateDefaultBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9747734897304-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">UseStartup</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">Startup</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d9747734897304-4\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ConfigureLogging</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">factory</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">{</span>你的配置<span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d9747734897304-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Build</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p></p>\n<h3 id=\"全新的-razor-pages\">全新的 Razor Pages</h3>\n<p>ASP.NET Core 2.0 引入的另外一个令人兴奋的特性就是 Razor Pages。提供了另外一种方式可以让你在做Web 页面开发的时候更加的沉浸式编程，或者叫 page-focused 。额…它有点像以前 Web Form Page，它隶属于 MVC 框架的一部分，但是他们没有 Controller。</p>\n<p>你可以通过 <code>dotnet new razor</code> 命令来新建一个 Razor Pages 类型的<strong>应用程序</strong>。</p>\n<p>Razor Pages 的 cshtml 页面代码可能看起来是这样的：</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce4d974b476849636\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n@ page\r\n\r\n@{\r\n    var message = \"Hello, World!\";\r\n}\r\n\r\n&lt;html&gt;\r\n&lt;body&gt;\r\n    &lt;p&gt;@ message&lt;/p&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce4d974b476849636-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d974b476849636-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d974b476849636-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d974b476849636-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d974b476849636-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d974b476849636-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d974b476849636-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d974b476849636-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d974b476849636-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce4d974b476849636-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce4d974b476849636-11\">11</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce4d974b476849636-1\"><span class=\"crayon-sy\">@</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">page</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d974b476849636-2\"> </div><div class=\"crayon-line\" id=\"crayon-596bfce4d974b476849636-3\"><span class=\"crayon-sy\">@</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d974b476849636-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Hello, World!\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d974b476849636-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d974b476849636-6\"> </div><div class=\"crayon-line\" id=\"crayon-596bfce4d974b476849636-7\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">html</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d974b476849636-8\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">body</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d974b476849636-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">@</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce4d974b476849636-10\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">body</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce4d974b476849636-11\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">html</span><span class=\"crayon-o\">&gt;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n\n</div>\n<p>Razor Pages 的页面必须具有 <code>@page</code> 标记。他们可能还会有一个 <code>*.cshtml.cs</code> 的 class 文件，对应的页面相关的一些代码，是不是很像 Web Form 呢？</p>\n<p>有同学可能会问了，没有 Controller 是怎么路由的呢？ 实际上，他们是通过文件夹物理路径的方式进行导航，比如：</p>\n<table>\n<thead>\n<tr>\n<th>文件名和路径</th>\n<th>匹配的URL</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>/Pages/Index.cshtml</td>\n<td><code>/</code> or <code>/Index</code></td>\n</tr>\n<tr>\n<td>/Pages/Contact.cshtml</td>\n<td><code>/Contact</code></td>\n</tr>\n<tr>\n<td>/Pages/Store/Contact.cshtml</td>\n<td><code>/Store/Contact</code></td>\n</tr>\n</tbody>\n</table>\n<p>有关 Razor Pages的更多信息可以看这里：<br>\n<a href=\"https://docs.microsoft.com/en-us/aspnet/core/razor-pages/\">https://docs.microsoft.com/en-us/aspnet/core/razor-pages</a></p>\n<h3 id=\"总结\">总结</h3>\n<p>可以看到，在 ASP.NET Core 2.0 中，给我们的开发过程带来了很多便利和帮助，他们包括 Program 等的改进，包括 MVC 相关 NuGet 包的集成，包括appsetting.json的服务器配置，以及令人惊讶的Razor Page，是不是已经迫不及待的期待正式版的发布呢？</p>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111534\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111534votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111534\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "迪斯尼的华丽海洋动效算法，是如何实现的？", "url": "http://blog.jobbole.com/111596/", "url_object_id": "3986d7468c90d34fb100d57e8460b2ac", "create_date": "2017/06/30 ·", "front_image_url": ["http://wx3.sinaimg.cn/large/7cc829d3gy1fh2ctg0y8vj21hc0u017k.jpg"], "praise_nums": "2", "comment_nums": 0, "fav_nums": 1, "tags": "IT技术,算法", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/upanblack\">Panblack</a> 翻译。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://www.theatlantic.com/technology/archive/2017/05/the-algorithms-behind-moanas-gorgeously-animated-pacific-ocean/528645/?single_page=true\">Adrienne LaFrance</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>【伯乐在线导读】：《海洋奇缘》讲述了作为航海世家后代的波里尼西亚公主莫阿娜，为了找寻传说中的神秘之岛，独自踏上了航海之旅的故事。本文并没有详细介绍具体的动画技术，而是迪斯尼如何用心拍摄了一部感人至深的作品。</p>\n<p><img id=\"pic\" class=\"M_cur_zoom_in aligncenter\" src=\"http://wx3.sinaimg.cn/large/7cc829d3gy1fh2ctg0y8vj21hc0u017k.jpg\" width=\"621\" height=\"349\"></p>\n<hr>\n<p>早期，当电影还是个新鲜事物的时候，拍摄海洋是个疯狂的想法。</p>\n<p>海面的波浪当然没问题，但是，捕捉摇曳多姿的海底物种群、游泳的鱼和海底大理石般烁烁生辉的阳光？人们的普遍观点是：做不到。</p>\n<p>事实上，这可以做到。一个世纪前，船长 Williamson 的两个儿子 John Ernest 和 George 愿意证明这一点。Williamson 兄弟俩求助于他们的父亲给潜水员设计的一项用于水下维修和救援用的技术。这个装置是一串柔韧的同心管（美国国会图书馆是<a href=\"http://www.loc.gov/loc/lcib/9615/sea.html\">这么描述</a>的：“….联锁在一起的一串铁环，伸展开了就像一个手风琴” ），悬垂在一艘特制的船上，潜水员可以通过它下到一个密封舱内。管道的一头是水面上的船，另一头是潜水屋。</p>\n<p>John Ernest 和 George 被父亲的这个机器迷住了。透过管道上的大玻璃窗，他们可以观察到红鲷鱼、鰤鱼、胖胖的鲶鱼，还有其他亮晶晶的海底生物在巴哈马群岛珊瑚礁中穿行。他们决定下次来要带上相机。之后，他们发表的报纸上的照片——包括一条模糊的鲨鱼和朦胧的海草——产生了轰动。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/32c4f4684e33f3227627440eef7a0799.png\"><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/32c4f4684e33f3227627440eef7a0799.png\" alt=\"b215ee4e7\" width=\"622\" height=\"483\"></a></p>\n<blockquote><p>顺时针方向左起：Williamson 兄弟海底拍摄的鲨鱼、潜水挖金币的男孩、巴哈马群岛“海洋伊甸园”、兄弟俩中的一个坐在装置的球层内。这些照片1914年7月发表在《巴尔的摩太阳报》（Baltimore Sun）上。</p></blockquote>\n<p>最终，Williamson 兄弟的管状装置——配备了新的特制球形观察舱，还有一个巨大的漏斗形的窗——1916年被用来拍摄电影《海底两万里》的水下场景。“我管它叫魔法窗，” 电影在展现一片灰暗如乌云的海底画面前，幕间旁白这样写道：“我们注视到的场面，你也许会觉得上帝从未打算让我们看到。”</p>\n<p>在那时，这些镜头是非同寻常的，电影空前成功。</p>\n<p><img class=\"alignnone aligncenter\" src=\"https://cdn.theatlantic.com/assets/media/img/posts/2017/05/gif_20000leages/37dadcf8c.gif\" width=\"450\" height=\"338\"></p>\n<blockquote>\n<p style=\"text-align: center\">《海底两万里》（1916）中的海洋镜头</p>\n</blockquote>\n<p>从那以后，电影制作者们使用科技手段不断推近描绘海洋的极限，不仅仅限于真人电影。最近，迪斯尼卡通片《海洋奇缘》（Moana）让观众为之倾倒。这部片子讲述了太平洋岛屿上的一个少女沿着祖先的足迹踏上探险之旅的故事。</p>\n<p>《海洋奇缘》的导演，Ron Clements 和 John Musker，几十年来一直迷恋与海洋有关的故事。他们在1989年拍摄了《小美人鱼》（The Little Mermaid）。Clements 是受 1940 年的电影《木偶奇遇记》（Pinocchio）——其中有著名的巨鲸扑浪镜头 —— 的激励，开始追求在动画事业上有所作为。不过，那些电影中的海洋画面与观众在《海洋奇缘》中看到的无法同日而语，《海洋奇缘》就像是 1916年的《海底两万里》一样具有开创性。</p>\n<p>“制作水的特效总是很难。” 《海洋奇缘》的联合动效主管 Marlon West 说，“通常一部动画片会有十几个水的镜头，非常难做。” 但《海洋奇缘》的大部分情节与水有关，而且海洋并不仅仅是个场景，所有情节就发生在水上，这增加了另一层复杂度。除此之外，《海洋奇缘》的太平洋有时候是拟人化的，就像是詹姆斯卡梅隆的《深渊》里那个海水的远房表亲。</p>\n<p>迪斯尼的软件团队搞出了一个工具软件，叫 Splash（类似制作《冰雪奇缘》的软件 Matterhorn），来自动化处理水在不同镜头下的行为。Splash 是第三方 3D 动画软件 Houdini 的“流体解算器”插件。用这款解算器，视效专业人员可以定义需要模拟的区域，比如动画小船周围的水域。然后用一个设定值来决定从什么样的海水条件开始。在这个基础上，他们在预定义的海面运行模拟器，来确定那片水面如何跟小船互动。模拟的输出，即“几百万的粒子”，实际上就是几百万的新动画数据点，被平滑处理到影片最后的渲染中。</p>\n<p><img class=\"alignnone aligncenter\" src=\"https://cdn.theatlantic.com/assets/media/img/posts/2017/06/041817_Bforever/a2379f3f8.gif\" width=\"629\" height=\"354\"></p>\n<blockquote>\n<p style=\"text-align: center\">《海洋奇缘》的技术团队花了差不多一年来给片中的船开发自动航迹系统</p>\n</blockquote>\n<p>Splash 还引进了一系列模拟水花、漩涡和航迹的算法。软件的浮力算法让片中巨大的领航帆船在波浪中上下拍打的动作非常逼真。（好多镜头中，许多帆船一齐出现在水中，互相挨得很近，带来了更多动画制作的挑战。）</p>\n<p>“作为特效艺术家，在制作流体时，你不会总能预料到你的模拟会出来什么效果。” 本片的视效主管 Erin Ramos 说，“对水来说最难的是，如果不对劲，你一眼就能看出来，哪怕是作为背景。”</p>\n<p style=\"text-align: center\"><img class=\"alignnone aligncenter\" src=\"https://cdn.theatlantic.com/assets/media/img/posts/2017/06/052517forever/d84211b74.gif\" width=\"630\" height=\"264\"></p>\n<blockquote>\n<p style=\"text-align: center\">“莫阿娜与海洋的亲密接触” Eric Goldberg 的铅笔动画稿</p>\n</blockquote>\n<p>迪斯尼的特效专业人员告诉我，他们可以在约80%的时间成功地自动化处理关键的海洋活动细节——就是说，可以找一个助理简单地运行一个脚本就生成了船只的航迹。“运行脚本来生成动画，艺术家们可以有更多精力去专注镜头的艺术性，” Ramos对我说，“所以他们才有时间创造这些叹为观止的镜头，而且得以让海洋表现得像一个角色。”</p>\n<p>《海洋奇缘》里的大海是个拟人化的力量，在莫阿娜的旅途中经常起到推动作用，只不过这个角色既没有脸，也不会说话。（“在这个意义上说，它有些像迪斯尼《阿拉丁》里那个动画魔毯。”《海洋奇缘》制作人 Osnat Shurer 对我说。）因此，迪斯尼的视效专业人员和动画师们始终在矛盾中权衡：一方面让水看起来、动起来像真正的水，同时又要展现出魔力。</p>\n<p>“这是个很大的挑战。” West 说，“他们要把海洋做得像一个袜子玩偶，我们要把它举起来，往里面灌满了泡泡和液体，或者做一个模拟计算给它充满了水，好让它看上去更加水汪汪的。”</p>\n<p>对于如何把海洋从平常状态转换为角色，动画师和视效专业人员同制片方之间照旧有很多争论。“是什么让海洋角色在一个人看来像普通的水，在另一个人看来却过于躁动和咄咄逼人？” West 说，“我们的海洋角色突现在蹒跚学步的莫阿娜或莫阿娜的奶奶面前时，你绝不能让人担忧她们的安危，你要让人感到不可思议。”</p>\n<p><img class=\"aligncenter\" src=\"https://cdn.theatlantic.com/assets/media/img/posts/2017/06/040417forever/4695c56ff.gif\" width=\"629\" height=\"354\"></p>\n<blockquote><p>为了达到这样的感觉，动画师们先是创建了海洋的动作，视效专业人员运行模拟器，添加上水的真实特性，然后照明专业人员补上附加的细节。（沃特迪斯尼动画工作室）</p></blockquote>\n<p>最后，平衡这两种预期——真实的海洋，同时像个角色一样传达暖意和鼓舞——意味着当水作为一个角色时，让它表现出部分超自然的光滑和圆润。还有些时候忽略物理定律，以便于观众更加关注角色。“因为我们要讲故事，” West 对我说，“这是个非写实的世界。我们力求创造出存在于你的心中和脑海中的水的形象。”</p>\n<p>接着面临的问题时如何展现可信的海洋——不是物理上写实，而是文化上真实。迪斯尼为此成立了“大洋洲故事基金会”，由来自太平洋岛屿上的一群文化业者组成，作为影片的顾问。基金会成员参与到影片的方方面面，从哈卡战舞到纹身的设计到半神毛依的头发。（毛依的初稿是光头，基金会成员说不应该，于是迪斯尼给了他华丽的头发。）</p>\n<p>影片制作者第一次考察之旅去了斐济，见到了“天使”Jiujiua Bera，一个熟练的探路人。“他带着强烈的个人感情谈论大海，” 《海洋奇缘》制片人Osnat Shurer 对我说。“他真的会非常轻柔地拍打海水，还告诉我们对海洋讲话也要轻柔。他说：‘海洋什么都知道。’ 清晨他会问候海洋，就像问候自己的家人。这让我们印象深刻。”</p>\n<p>让 Shurer 和同事大为触动的是，他们见到的太平洋岛民之间更加广泛的纽带联系，而且很多海岛文化认为海洋和陆地是浑然一体的。（比如在古代夏威夷，这个理念形成了 <a href=\"http://baike.sogou.com/v192899.htm\">ahupuaʻa</a>  的概念，即从山顶连绵到海里的陆地区块单位。）还有一些文化认为海洋本身就是一个纽带。“在太平洋上，我们不认为水是一种阻隔。”人类学家、大洋洲故事基金会成员 Dionne Fonoti 在《海洋奇缘》特别收录版中接受迪斯尼采访时说道。“把我们连接在一起的并不仅仅是海岛文化和居民，还有海洋。”</p>\n<p>然而，当制片项目开始的时候，迪斯尼团队还不知道该如何描绘这么复杂事物——即使是从技术角度。更不用说另一个相关的挑战：制作人性化的火山岛。</p>\n<p style=\"text-align: center\"><img class=\"alignnone aligncenter\" src=\"https://cdn.theatlantic.com/assets/media/img/posts/2017/06/050217forever/e172aa646.gif\" width=\"630\" height=\"264\"></p>\n<blockquote>\n<p style=\"text-align: center\">制作《海洋奇缘》的 Te Kā 所需的多个动效层：烟、或、岩浆、闪电和水</p>\n</blockquote>\n<p>“我对我们的工作成果充满期待，” West 对我说。“当我看到最终的电影，我觉得没有什么能让我畏缩不前，从来没有。”</p>\n<p>这个项目也改变了动画师和视效专业人员们看待真实海洋的角度。视效主管 Ramos 说她用了一年半以上的时间制作逼真的海岸线动画。即使现在，她只要去了海滩就会留意那些参与《海洋奇缘》之前从未考虑过的细节。</p>\n<p>“要知道，去海滩对我来说是件艰难的事情，” 她说。“只要去了那儿，我就会观察泡沫是如何消散的，海水如何渐渐退回大海，海浪短暂停顿的韵律和节奏。我会观察沙滩如何成型为礁岩浪型，光线如何影响水的外观、清澈度、颜色。脑子里要过的东西太多了。”</p>\n<p>“我不觉得这是坏事，” 她补充道。“我觉得这美妙无比。”</p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>任选一种支付方式</p>\n                <p>\n                        <img src=\"http://www.jobbole.com/wp-content/uploads/2016/03/bb6b0431912b5b441aac6477e67bd0d22.png\">\n            \n                            <img src=\"http://www.jobbole.com/wp-content/uploads/2016/03/381b4bd995d3cff3c32be73b9d0571b82.jpg\">\n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111596\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111596votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111596\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/upanblack\">Panblack</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/upanblack\">\r\n\t\t\t<img src=\"http://tp4.sinaimg.cn/1611865122/180/0/1\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            挺老的Linux新手        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/upanblack\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/upanblack/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/upanblack/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 37</a> · <a title=\"我的网站\" target=\"_blank\" href=\"http://www.cnblogs.com/panblack\"><i class=\"fa fa-link\"></i></a> <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/panblack\"><i class=\"fa fa-weibo\"></i></a> <a title=\"GitHub主页\" target=\"_blank\" href=\"http://github.com/panblack\"><i class=\"fa fa-github\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "每个程序员都需要知道一些游戏网络知识", "url": "http://blog.jobbole.com/111711/", "url_object_id": "fac35b12c02fb27f44780851ac24f152", "create_date": "2017/07/03 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/07/c39de1bb884eaa81287bd08dab06403d.jpg"], "praise_nums": "2", "comment_nums": 0, "fav_nums": 3, "tags": "IT技术,游戏开发", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"http://gafferongames.com/networking-for-game-programmers/what-every-programmer-needs-to-know-about-game-networking/\">GLENN FIEDLER</a>   译文出处：<a target=\"_blank\" href=\"https://my.oschina.net/u/1859679/blog/911474\">wier</a>   </div><p>这是一篇翻译文章，主要针对游戏的网络设计，目前主流的网络游戏实现方案都有讲解，如果对英文更感兴趣，请查看原文地址，你若是觉得有翻译不妥的地方，欢迎留言指正。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/c39de1bb884eaa81287bd08dab06403d.jpg\"><img class=\"aligncenter wp-image-111712 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c39de1bb884eaa81287bd08dab06403d.jpg\" alt=\"084635_zdwT_1859679\" width=\"900\" height=\"500\"></a></p>\n<p>作为一个程序员，你有没有想象过多人游戏是如何实现的？</p>\n<p>在外行人看来游戏很神奇：两个或者更多的玩家在网络上分享共同的经历，就像他们真实的存在于相同的虚拟的世界一样。游戏看起来犹如一个巨大的魔术，奇妙而又刺激，但作为一个开发人员我们知道，真实的情况和我们所看到的并不一样，那只是一种错觉。你感受到的共享现实，实际上是在那个时刻内，由你自己的独特视角和位置所感知的近似情况。</p>\n<h1 id=\"h1_0\"><strong>Peer-to-Peer 帧同步</strong></h1>\n<p>最初的游戏是通过peer-to-peer来联网的，每个计算机通过网状拓扑的结构的彼此连接并交换信息。你仍然可以看到这种模型存在于RTS游戏中，而且基于某些原因它还很有趣，也许是因为它是大多数人认为游戏网络工作方式的第一种方式。</p>\n<p>处理游戏信息的基本思想就是把游戏的数据抽象并转换成一系列命令消息，当处理每个转换的时候就直接演变为游戏的状态。比如:移动单位、攻击物体、建造建筑。这一切都需要在线的每个玩家机器，从一个初始化命令开始之后，都运行完全相同的命令和转换数据。</p>\n<p>当然了，这只是一个过于简单的解释，同时也隐去了很多细节，不过我们通过这个基本的思路可以知道RTS游戏的网络是如何工作的。如果你想知道更多网络模型，请点击:<a href=\"http://www.gamasutra.com/view/feature/3094/1500_archers_on_a_288_network_.php\" target=\"_blank\" rel=\"nofollow\">1500 Archers on a 28.8: Network Programming in Age of Empires and Beyond</a>.</p>\n<p>这些看起来是如此简单和优雅，但不幸的它们有几个因素限制者我们。</p>\n<p>第一个限制，要保证游戏状态完全确定一致的是异常困难，特别是保持每台机器上每个转换输出都保持相同。比如，一个单位在两台机器上有略微不同的路径，在一台机器上早一些到达并开始了战斗，结果反败为胜，而在另一台机器上，由于稍微晚一些到达而失败。就像一只蝴蝶扇动了翅膀，然后在世界的另一边导致了飓风的出现，随着时间的推移，一个微小的区别就会导致两边完全的不同步。</p>\n<p>第二个限制，为了保证游戏的所有玩家输出一致，这就需要等到所有玩家的当前回合数据都到达之后才可以模拟播放这一回合动作。这就意味着游戏中的每一个玩家都需要等待网络延迟最高的那个玩家。RTS游戏通常代表性地通过立即提供音频反馈与（或是）播放吟唱（过渡）动画来掩盖这段延迟，但是最终真正影响游戏的动作要在这段延迟过去之后才能进行。</p>\n<p>第三个限制，因为游戏中状态改变的同步是通过发送命令信息来同步的。所以为了游戏中玩家状态都一致，需要所有的玩家都要从相同的初始状态来开始游戏。这意味着每个玩家必须在开始游戏之前先加入房间然后一起开始游戏，尽管理论上也可以支持让某些玩家晚些加入游戏，但是在一场进行中的游戏中获得一个完全确定的起始点的难度相当大，所以这种情况并不常见。</p>\n<p>尽管有这些因素限制困扰者我们，不过这个模型还是很适合RTS游戏的，并且它仍然存在于今天的游戏当中，例如“<strong>Command and Conquer</strong>”、“<strong>Age of Empires</strong>”与“<strong>Starcraft</strong>”等。原因就是在RTS游戏中，里面包含了上千多的单位，这些单位都有自己的状态需要同步，而且他们数据量都太大了，很难用来在玩家之间交换。别无选择，我们只能通过这些游戏状态改变的命令来同步。</p>\n<p>所以以上这些就是 peer-to-peer 帧同步的网路游戏模型的介绍了，对于其他类型的游戏，最先进的技术已经开始出现了。让我们现在从<strong>Doom</strong>, <strong>Quake </strong>以及 <strong>Unreal</strong>经典游戏中开始一起观察动作游戏的技术演化。</p>\n<h1 id=\"h1_1\"><strong>客户端/服务器（c/s架构）</strong></h1>\n<p>在动作游戏的时代，以上帧同步的限制在<strong>Doom </strong>游戏中变得更加明显，尽管在局域网中体验还不错，但在对于互联网的用户来说它体验太糟糕了：</p>\n<p>尽管可以使用一个猫（调制解调器）把两个<strong>Doom </strong>机器通过互联网连接在一起，但他们一起游戏会异常缓慢。范围从无法游戏（例如:14.4Kbps PPP 连接)到稍微可以玩(例如 ：28.8Kbps 猫运行一个被SLIP驱动压缩的数据)之间游戏联机都异常缓慢。由于这些连接方式只是边际效用，本文将仅关注直接的网络连接。</p>\n<p>这个问题是因为Doom网络部分本来就是只为局域网而设计的，并且使用了前面介绍的peer-to-peer 帧同步模型。每一回合每个玩家的输入的信息（比如关键按键等）都与其他人进行同步通知，并且任何玩家在播放这一帧动画之前，必须得等到所有其他玩家的关键按键信息都被接收到，才可以去模拟播放。</p>\n<p>也就是说，在你可以转身（转换），移动或者射击之前，你必须等待延迟最大的猫（调制调解器）玩家的输入。只是想想上述那个人所写的“这些连接方式只是边际效用”就会让人咬牙切齿和沮丧了。</p>\n<p>为了改变这种现状，只能在局域网以及大学网络和大型企业才能获得良好连接而进行游戏，是需要改变这种网络模型了。在1996年，这变成了现实并被实现了，John Carmack当时 发布雷神之锤，他采用客户端/服务器（C/S）架构代替了P2P模型。</p>\n<p>如今游戏中的玩家可以不必再运行相同的代码以及直接相互通信，每个玩家的机器是都是一个“客户端”，他们都通过一台叫做“服务器”的机器进行通信交互。游戏的最终状态确定不再依赖于每台客户端机器来共同确认，而是由服务器来确定最终结果。每个客户端如同一个哑终端，用来展示一个近似值的表演，真是的游戏状态是运行于服务器之上。</p>\n<p>在一个纯粹的c/s架构中，你不必在本地运行游戏代码，而是把一些例如按键、鼠标移动，点击等输入信息发送到服务器。服务器会在游戏世界中更新你的玩家状态，然后再封包一个包含你角色信息以及临近玩家数据的包回复给你的客户端。所有的客户端在每个消息更新的间隙做一个插值预测，以改善在每个状态更新期间，物体可以平滑的移动，如此，你就有一个可以联网的客户端/服务器架构的游戏了。</p>\n<p>这已经是向前迈出了极大的一步。游戏的体验依赖于客户端和服务器的连接，而不是游戏中延迟最大的那个玩家。如此可以支持玩家在游戏中自由的进入和退出，同时由于客户端/服务器降低了平均每位玩家的带宽，从而可以增加更多的在线玩家。</p>\n<p>但是这里仍然有一些问题存在于 c/s 架构中:</p>\n<p>我记得我交代了所有从DOO到Quake中关于网络的决策，但是重要的是我正在使用错误的假设来做一个好的网络游戏。我原先设计的目标是网络延迟&lt;200ｍs。人们通过一个好的网络供应商连接互联网，从而可以获得一个好的游戏体验。但事与愿违，世界上99%的用户使用猫(调制调解器)通过 slip或者ppp 进行连接，而他们常常都会通过槽糕而又拥挤的ISP。这会带来最低300+ms 的 网络延迟。一个消息要经过，客户端&gt;用户猫&gt;ISP猫&gt;服务器&gt;ISP猫&gt;用户猫&gt;客户端。上帝，这太逊了。</p>\n<p>OK,我做了一个错误的设定。我在家里使用T1 宽带，所以我只是不了解在PPP网络下的生活。我现在就解决它。</p>\n<p>这个问题当然是延迟。</p>\n<p>接下来John在他发布QuakeWorld的时候将改变这个行业。</p>\n<h1 id=\"h1_2\"><strong>客户端预测（<strong>Client-Side Prediction</strong>）</strong></h1>\n<p>在原来的Quake游戏中，你会感觉到电脑与服务器之间的延迟。比如，你按键向前移动，在你真正移动之前，你需要等到数据包发送服务器然后再回复到你的客户端，你才可以真正的移动。按键开火，在你的射击之前同样需要相同的等待。</p>\n<p>如果你玩过任何FPS游戏，比如:Modern Warfar,你会发现并没有延迟发生。那么fps游戏是如何做到在多人情况下，你的动作看起来并没有延迟？</p>\n<p>这个问题被分为两个部分来解决。第一个部分是客户端移动预测，这事John Carmack 为 QuakeWorld游戏多开发的，后来被合并到了Tim Sweeney的虚幻网络模块。第二个部分就是延迟补偿，它是有Valve公司的Yahn Bernier在Counterstrike所开发。那么在这个章节，我们把焦点放在第一部分——隐藏用户移动的延迟。</p>\n<p>当写到关于他即将发布的QuakeWorld计划的时候，John Carmack 讲到:</p>\n<p>我现在允许客户端可以预测用户的移动，直到服务器的权威信息回复之前。这是一个重大的结构变更。客户端需要知道关于对象的硬度、摩擦力、重力等一系列基础属性。我很伤心的看到，客户端仅作为一个终端存在将会离开，但作为一个实用主义者，我必须超越这种理想情怀。</p>\n<p>那么现在我们为了消除延迟，客户端需要运行更多的代码。它现在不再是一个只把输入发送给服务器然后再把返回信息进行插入的哑终端。现在客户端的机器可以运行一部分游戏代码，它可以在本地预测你的角色移动并且可以即时响应你的输入。</p>\n<p>现在当你即刻按键向前，你的游戏会立刻向前移动，不会再去等待数据往返一次客户端和服务器之间才来回应你的操作。</p>\n<p>这种方式的难点不在于预测，这种预测工作，就像正常的游戏代码一样 —— 根据玩家的输入，及时地更新游戏角色的状态。而难点在于，当客户端和服务器对于玩家角色所做的事情（动作）核检不一致的时候，客户端如何基于服务器信息进行更正。</p>\n<p>现在你会想，hey，如果代码运行在客户端——为何不以客户端的信息为准？客户端可以自己的为角色模拟运行代码，并且只需要在每次发送数据包时告知服务器这些信息。如果每个客户端都对服务器发送相同的信息，告诉服务器“这是我现在的位置信息”，那么将会带来这样的问题。客户端会很容易被黑客攻击并控制，这样在RPG游戏中，一个作弊便可以立即躲避对方技能击中，或者当你射击的时候瞬间移动到你的身后。</p>\n<p>所以在FPS游戏中，尽快每个玩家的客户端可以预测他们自己的角色进行操作移动，但最终每个玩家的角色状态绝对以服务器为准。就像Tim Sweeney 在所写的文章<a href=\"http://unreal.epicgames.com/Network.htm\" target=\"_blank\" rel=\"nofollow\">The Unreal Networking Architecture</a>中描述的一样：“服务器才是主人”。</p>\n<p>这就是有趣的地方。如果客户端和服务器产生了不一致，客户端必须基于服务器的信息为准并更新，但是由于客户端和服务器之前有延迟，服务器的修正必然是过去的动作。比如，如果信息从客户端到服务器耗时100ms，然后返回又耗时100ms，那么任何服务器的的修正都是客户端200ms之前的行为动作，这个时间正好是客户端预测角色移动的时间。</p>\n<p>如果客户端每个动作都会被服务器修正，那么你将会看客户端被拉回了原先的位置，如此客户端将做不了任何预先预测的运算。那么我们如何解决这个问题，依然可以保持客户端提前预测？</p>\n<p>解决方案就是在客户端创建一个buffer，然后用来循环保持角色的状态以及本来玩家的输入。当客户端收到了服务器的更正信息时候，它首先丢弃掉buffer里面比（服务器回复的）更正状态要老的状态信息，然后基于（更正的）正确的状态重放存储在buffer里面的输入信息，重发的这些输入信息的范围是从正确状态到当前预测时间之间。如此实际上，客户端只是看似无形中“倒带和重放”当地玩家角色运动的最后n帧，同时保持世界其他地方没有变化。</p>\n<p>这种方法可以让玩家感觉在控制游戏的时候没有延迟，同时也改善了客户端和服务器之间代码运行的一致性——在同等输入的情况下保持一致的结果。当然了，修正的情况很少发生，Tim Sweeney 如此描述:</p>\n<p>…对于客户端和服务器最好的是：所有情况下，服务器都是权威的。几乎所有的时间，客户端模拟的和服务器的数据都是一致，所以客户端的位置很少被修正。只有的少数罕见的情况下，例如一个玩家被火箭击中，或者和一个敌人（怪物）碰撞上，那么客户端本地的情况有可能需要被修正。</p>\n<p>也就是说，只有当玩家的角色被一些外部事件影响玩家的输入，并且这些不能被客户端预测时，玩家的位置（行为）需要被服务器修正。当然，如果玩家试图作弊，必然会被服务器修正。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111711\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111711votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111711\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "七大查找算法", "url": "http://blog.jobbole.com/111629/", "url_object_id": "cc019be26c351dec19513c88ffcb4c59", "create_date": "2017/07/03 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/07/2d0c7fc61e19c487cc2aa6c2b3193ae9.jpg"], "praise_nums": "2", "comment_nums": 0, "fav_nums": 5, "tags": "IT技术,算法", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/maybe2030/p/4715035.html\">Poll的笔记</a>   </div><p>查找是在大量的信息中寻找一个特定的信息元素，在计算机应用中，查找是常用的基本运算，例如编译程序中符号表的查找。本文简单概括性的介绍了常见的七种查找算法，说是七种，其实二分查找、插值查找以及斐波那契查找都可以归为一类——插值查找。插值查找和斐波那契查找是在二分查找的基础上的优化查找算法。树表查找和哈希查找会在后续的博文中进行详细介绍。</p>\n<p>查找定义：根据给定的某个值，在查找表中确定一个其关键字等于给定值的数据元素（或记录）。</p>\n<p>查找算法分类：<br>\n1）静态查找和动态查找；<br>\n注：静态或者动态都是针对查找表而言的。动态表指查找表中有删除和插入操作的表。<br>\n2）无序查找和有序查找。<br>\n无序查找：被查找数列有序无序均可；<br>\n有序查找：被查找数列必须为有序数列。</p>\n<p><strong>平均查找长度（Average Search Length，ASL）：</strong>需和指定key进行比较的关键字的个数的期望值，称为查找算法在查找成功时的平均查找长度。<br>\n对于含有n个数据元素的查找表，查找成功的平均查找长度为：ASL = P<sub>i</sub>*C<sub>i</sub>的和。<br>\nP<sub>i</sub>：查找表中第i个数据元素的概率。<br>\nC<sub>i</sub>：找到第i个数据元素时已经比较过的次数。</p>\n<h3 class=\"First\">1. 顺序查找</h3>\n<p><span style=\"text-decoration: underline;\"><strong>说明：顺序查找适合于存储结构为顺序存储或链接存储的线性表。</strong></span></p>\n<p>查找成功时的平均查找长度为：（假设每个数据元素的概率相等） ASL = 1/n(1+2+3+…+n) = (n+1)/2 ;</p>\n<p>当查找不成功时，需要n+1次比较，时间复杂度为O(n);</p>\n<p>所以，<span style=\"text-decoration: underline;\"><strong>顺序查找的时间复杂度为O(n</strong><strong>)</strong><strong>。</strong></span></p>\n<p><strong>C++实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bdffd74224907858486\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//顺序查找\r\nint SequenceSearch(int a[], int value, int n)\r\n{\r\n   int i;\r\n   for(i=0; i&lt;n; i++)\r\n   if(a[i]==value)\r\n   return i;\r\n   return -1;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bdffd74224907858486-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74224907858486-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74224907858486-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74224907858486-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74224907858486-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74224907858486-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74224907858486-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74224907858486-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74224907858486-9\">9</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bdffd74224907858486-1\"><span class=\"crayon-c\">//顺序查找</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74224907858486-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SequenceSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74224907858486-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74224907858486-4\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74224907858486-5\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">for</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74224907858486-6\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">==</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74224907858486-7\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74224907858486-8\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74224907858486-9\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p></p>\n<h3>2. 二分查找</h3>\n<p><strong>说明：元素必须是有序的，如果是无序的则要先进行排序操作。</strong></p>\n<p><strong>基本思想：</strong>也称为是折半查找，属于有序查找算法。用给定值k先与中间结点的关键字比较，中间结点把线形表分成两个子表，若相等则查找成功；若不相等，再根据k与该中间结点关键字的比较结果确定下一步查找哪个子表，这样递归进行，直到查找到或查找结束发现表中没有这样的结点。</p>\n<p><strong>复杂度分析：</strong>最坏情况下，关键词比较次数为log<sub>2</sub>(n+1)，且<strong>期望时间复杂度为O(log<sub>2</sub>n)</strong>；</p>\n<p>注：<strong>折半查找的前提条件是需要有序表顺序存储，对于静态查找表，一次排序后不再变化，折半查找能得到不错的效率。但对于需要</strong><strong>频繁执行插入或删除操作的数据集来说，维护有序的排序会带来不小的工作量，那就不建议使用。——《大话数据结构》</strong></p>\n<p><strong>C++实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bdffd74235581249122\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//二分查找（折半查找），版本1\r\nint BinarySearch1(int a[], int value, int n)\r\n{\r\n int low, high, mid;\r\n low = 0;\r\n high = n-1;\r\n while(low&lt;=high)\r\n {\r\n     mid = (low+high)/2;\r\n     if(a[mid]==value)\r\n     return mid;\r\n     if(a[mid]&gt;value)\r\n     high = mid-1;\r\n     if(a[mid]&lt;value)\r\n     low = mid+1;\r\n }\r\n     return -1;\r\n}\r\n\r\n//二分查找，递归版本\r\nint BinarySearch2(int a[], int value, int low, int high)\r\n{\r\n   int mid = low+(high-low)/2;\r\n   if(a[mid]==value)\r\n   return mid;\r\n   if(a[mid]&gt;value)\r\n   return BinarySearch2(a, value, low, mid-1);\r\n   if(a[mid]&lt;value)\r\n   return BinarySearch2(a, value, mid+1, high);\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74235581249122-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74235581249122-30\">30</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-1\"><span class=\"crayon-c\">//二分查找（折半查找），版本1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BinarySearch1</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-4\"><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-5\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-6\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-7\"><span class=\"crayon-h\"> </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-8\"><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-9\"><span class=\"crayon-h\">     </span><span class=\"crayon-v\">mid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">+</span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-10\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">==</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-11\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-12\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-13\"><span class=\"crayon-h\">     </span><span class=\"crayon-v\">high</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-14\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-15\"><span class=\"crayon-h\">     </span><span class=\"crayon-v\">low</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-16\"><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-17\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-18\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-19\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-20\"><span class=\"crayon-c\">//二分查找，递归版本</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-21\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BinarySearch2</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-22\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-23\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">+</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">high</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-24\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">==</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-25\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-26\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-27\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BinarySearch2</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-28\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74235581249122-29\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BinarySearch2</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74235581249122-30\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0048 seconds] -->\r\n<p></p>\n<h3>3. 插值查找</h3>\n<p>在介绍插值查找之前，首先考虑一个新问题，为什么上述算法一定要是折半，而不是折四分之一或者折更多呢？</p>\n<p>打个比方，在英文字典里面查“apple”，你下意识翻开字典是翻前面的书页还是后面的书页呢？如果再让你查“zoo”，你又怎么查？很显然，这里你绝对不会是从中间开始查起，而是有一定目的的往前或往后翻。&lt;</p>\n<p>同样的，比如要在取值范围1 ~ 10000 之间 100 个元素从小到大均匀分布的数组中查找5， 我们自然会考虑从数组下标较小的开始查找。</p>\n<p>经过以上分析，折半查找这种查找方式，不是自适应的（也就是说是傻瓜式的）。二分查找中查找点计算如下：</p>\n<p>mid=(low+high)/2, 即mid=low+1/2*(high-low);</p>\n<p>通过类比，我们可以将查找的点改进为如下：</p>\n<p>mid=low+<span style=\"text-decoration: underline; color: #993300;\">(key-a[low])/(a[high]-a[low])</span>*(high-low)，</p>\n<p>也就是将上述的比例参数1/2改进为自适应的，根据关键字在整个有序表中所处的位置，让mid值的变化更靠近关键字key，这样也就间接地减少了比较次数。</p>\n<p><strong>基本思想：</strong>基于二分查找算法，将查找点的选择改进为自适应选择，可以提高查找效率。当然，差值查找也属于有序查找。</p>\n<p>注：<strong>对于表长较大，而关键字分布又比较均匀的查找表来说，插值查找算法的平均性能比折半查找要好的多。反之，数组中如果分布非常不均匀，那么插值查找未必是很合适的选择。</strong></p>\n<p><strong>复杂度分析：查找成功或者失败的时间复杂度均为O(log<sub>2</sub>(log<sub>2</sub>n))。</strong></p>\n<p><strong>C++实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bdffd7423f396029769\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//插值查找\r\nint InsertionSearch(int a[], int value, int low, int high)\r\n{\r\n     int mid = low+(value-a[low])/(a[high]-a[low])*(high-low);\r\n     if(a[mid]==value)\r\n        return mid;\r\n     if(a[mid]&gt;value)\r\n        return InsertionSearch(a, value, low, mid-1);\r\n     if(a[mid]&lt;value)\r\n        return InsertionSearch(a, value, mid+1, high);\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bdffd7423f396029769-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd7423f396029769-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd7423f396029769-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd7423f396029769-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd7423f396029769-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd7423f396029769-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd7423f396029769-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd7423f396029769-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd7423f396029769-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd7423f396029769-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd7423f396029769-11\">11</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bdffd7423f396029769-1\"><span class=\"crayon-c\">//插值查找</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd7423f396029769-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">InsertionSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd7423f396029769-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd7423f396029769-4\"><span class=\"crayon-h\">     </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">+</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">value</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">high</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd7423f396029769-5\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">==</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd7423f396029769-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd7423f396029769-7\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd7423f396029769-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">InsertionSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd7423f396029769-9\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd7423f396029769-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">InsertionSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd7423f396029769-11\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0027 seconds] -->\r\n<p></p>\n<h3>4. 斐波那契查找</h3>\n<p>在介绍斐波那契查找算法之前，我们先介绍一下很它紧密相连并且大家都熟知的一个概念——黄金分割。</p>\n<p>黄金比例又称黄金分割，是指事物各部分间一定的数学比例关系，即将整体一分为二，较大部分与较小部分之比等于整体与较大部分之比，其比值约为1:0.618或1.618:1。</p>\n<p>0.618被公认为最具有审美意义的比例数字，这个数值的作用不仅仅体现在诸如绘画、雕塑、音乐、建筑等艺术领域，而且在管理、工程设计等方面也有着不可忽视的作用。因此被称为黄金分割。</p>\n<p>大家记不记得斐波那契数列：1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89…….（从第三个数开始，后边每一个数都是前两个数的和）。然后我们会发现，随着斐波那契数列的递增，前后两个数的比值会越来越接近0.618，利用这个特性，我们就可以将黄金比例运用到查找技术中。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/2d0c7fc61e19c487cc2aa6c2b3193ae9.jpg\"><img class=\"aligncenter wp-image-111632 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2d0c7fc61e19c487cc2aa6c2b3193ae9.jpg\" alt=\"20150323100632467\" width=\"570\" height=\"197\"></a><br>\n<strong>基本思想：</strong>也是二分查找的一种提升算法，通过运用黄金比例的概念在数列中选择查找点进行查找，提高查找效率。同样地，斐波那契查找也属于一种有序查找算法。</p>\n<p>相对于折半查找，一般将待比较的key值与第mid=（low+high）/2位置的元素比较，比较结果分三种情况：</p>\n<p>1）相等，mid位置的元素即为所求</p>\n<p>2）&gt;，low=mid+1;</p>\n<p>3）&lt;，high=mid-1。</p>\n<p>斐波那契查找与折半查找很相似，他是根据斐波那契序列的特点对有序表进行分割的。他要求开始表中记录的个数为某个斐波那契数小1，及n=F(k)-1;</p>\n<p>开始将k值与第F(k-1)位置的记录进行比较(及mid=low+F(k-1)-1),比较结果也分为三种</p>\n<p>1）相等，mid位置的元素即为所求</p>\n<p>2）&gt;，low=mid+1,k-=2;</p>\n<p>说明：low=mid+1说明待查找的元素在[mid+1,high]范围内，k-=2 说明范围[mid+1,high]内的元素个数为n-(F(k-1))= Fk-1-F(k-1)=Fk-F(k-1)-1=F(k-2)-1个，所以可以递归的应用斐波那契查找。</p>\n<p>3）&lt;，high=mid-1,k-=1。</p>\n<p>说明：low=mid+1说明待查找的元素在[low,mid-1]范围内，k-=1 说明范围[low,mid-1]内的元素个数为F(k-1)-1个，所以可以递归 的应用斐波那契查找。</p>\n<p><strong>复杂度分析：<span style=\"text-decoration: underline;\">最坏情况下，时间复杂度为O(log<sub>2</sub>n)，且其期望复杂度也为O(log<sub>2</sub>n)。</span></strong></p>\n<p><strong>C++实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bdffd74249995464947\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n// 斐波那契查找.cpp#include \"stdafx.h\"\r\n#include &lt;memory&gt;\r\n#include &lt;iostream&gt;\r\nusing namespace std;\r\nconst int max_size=20;//斐波那契数组的长度\r\n\r\n/*构造一个斐波那契数组*/\r\nvoid Fibonacci(int * F)\r\n{\r\n   F[0]=0;\r\n   F[1]=1;\r\n   for(int i=2;i&lt;max_size;++i)\r\n   F[i]=F[i-1]+F[i-2];\r\n}\r\n\r\n/*定义斐波那契查找法*/\r\nint FibonacciSearch(int *a, int n, int key) //a为要查找的数组,n为要查找的数组长度,key为要查找的关键字\r\n{\r\n   int low=0;\r\n   int high=n-1;\r\n\r\n   int F[max_size];\r\n   Fibonacci(F);//构造一个斐波那契数组F\r\n\r\n   int k=0;\r\n   while(n&gt;F[k]-1)//计算n位于斐波那契数列的位置\r\n   ++k;\r\n\r\n   int * temp;//将数组a扩展到F[k]-1的长度\r\n   temp=new int [F[k]-1];\r\n   memcpy(temp,a,n*sizeof(int));\r\n\r\n   for(int i=n;i&lt;F[k]-1;++i)\r\n   temp[i]=a[n-1];\r\n\r\n   while(low&lt;=high)\r\n{\r\n   int mid=low+F[k-1]-1;\r\n   if(key&lt;temp[mid])\r\n{\r\n   high=mid-1;\r\n   k-=1;\r\n}\r\n   else if(key&gt;temp[mid])\r\n{\r\n   low=mid+1;\r\n   k-=2;\r\n}\r\n   else\r\n{\r\n   if(mid&lt;n)\r\n   return mid; //若相等则说明mid即为查找到的位置\r\n   else\r\n   return n-1; //若mid&gt;=n则说明是扩展的数值,返回n-1\r\n}\r\n}\r\n   delete [] temp;\r\n   return -1;\r\n}\r\n\r\n   int main()\r\n{\r\n   int a[] = {0,16,24,35,47,59,62,73,88,99};\r\n   int key=100;\r\n   int index=FibonacciSearch(a,sizeof(a)/sizeof(int),key);\r\n   cout&lt;&lt;key&lt;&lt;\" is located at:\"&lt;&lt;index;\r\n   return 0;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596bdffd74249995464947-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bdffd74249995464947-68\">68</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-1\"><span class=\"crayon-c\">// 斐波那契查找.cpp#include \"stdafx.h\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-2\"><span class=\"crayon-p\">#include &lt;memory&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-3\"><span class=\"crayon-p\">#include &lt;iostream&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-4\"><span class=\"crayon-e\">using </span><span class=\"crayon-t\">namespace</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">std</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-5\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max_size</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">20</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//斐波那契数组的长度</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-6\"> </div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-7\"><span class=\"crayon-c\">/*构造一个斐波那契数组*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-8\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Fibonacci</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-9\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-10\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-11\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-12\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">for</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">max_size</span><span class=\"crayon-sy\">;</span><span class=\"crayon-o\">++</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-13\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">+</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-14\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-16\"><span class=\"crayon-c\">/*定义斐波那契查找法*/</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-17\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FibonacciSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//a为要查找的数组,n为要查找的数组长度,key为要查找的关键字</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-18\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-19\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-20\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">n</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-22\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">max_size</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-23\"><span class=\"crayon-h\">   </span><span class=\"crayon-e\">Fibonacci</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//构造一个斐波那契数组F</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-24\"> </div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-25\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-26\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">n</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//计算n位于斐波那契数列的位置</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-27\"><span class=\"crayon-h\">   </span><span class=\"crayon-o\">++</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-28\"> </div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-29\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//将数组a扩展到F[k]-1的长度</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-30\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-31\"><span class=\"crayon-h\">   </span><span class=\"crayon-e\">memcpy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e \">n*</span><span class=\"crayon-e\">sizeof</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-32\"> </div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-33\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">for</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">;</span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-o\">++</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-34\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">n</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-35\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-36\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-37\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-38\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">+</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">k</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-39\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">key</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-40\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-41\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">high</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-42\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">k</span><span class=\"crayon-o\">-=</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-43\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-44\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">key</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-45\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-46\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-47\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">k</span><span class=\"crayon-o\">-=</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-48\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-49\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-50\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-51\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-52\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//若相等则说明mid即为查找到的位置</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-53\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-54\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//若mid&gt;=n则说明是扩展的数值,返回n-1</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-55\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-56\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-57\"><span class=\"crayon-h\">   </span><span class=\"crayon-i\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-58\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-59\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-60\"> </div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-61\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-62\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-63\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">16</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">24</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">35</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">47</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">59</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">62</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">73</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">88</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">99</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-64\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">key</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">100</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-65\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">index</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">FibonacciSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">sizeof</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">sizeof</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-66\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">cout</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-v\">key</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-s\">\" is located at:\"</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bdffd74249995464947-67\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bdffd74249995464947-68\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0084 seconds] -->\r\n<p></p>\n<h3>5. 树表查找</h3>\n<p><strong>5.1 最简单的树表查找算法——二叉树查找算法。</strong></p>\n<p><strong>基本思想：</strong>二叉查找树是先对待查找的数据进行生成树，确保树的左分支的值小于右分支的值，然后在就行和每个节点的父节点比较大小，查找最适合的范围。 这个算法的查找效率很高，但是如果使用这种查找方法要首先创建树。</p>\n<p><strong>二叉查找树</strong>（BinarySearch Tree，也叫二叉搜索树，或称二叉排序树Binary Sort Tree）或者是一棵空树，或者是具有下列性质的二叉树：</p>\n<p>1）若任意节点的左子树不空，则左子树上所有结点的值均小于它的根结点的值；</p>\n<p>2）若任意节点的右子树不空，则右子树上所有结点的值均大于它的根结点的值；</p>\n<p>3）任意节点的左、右子树也分别为二叉查找树。</p>\n<p><strong>二叉查找树性质</strong>：<span style=\"text-decoration: underline;\"><strong>对二叉查找树进行中序遍历，即可得到有序的数列。</strong></span></p>\n<p>不同形态的二叉查找树如下图所示：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/c2a4470f8d2ac2d7739856f175f0a2a6.jpg\"><img class=\"wp-image-111633 size-full aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c2a4470f8d2ac2d7739856f175f0a2a6.jpg\" alt=\"1333691114_6839\" width=\"575\" height=\"431\"></a></p>\n<p>有关二叉查找树的查找、插入、删除等操作的详细讲解，请移步<a id=\"cb_post_title_url\" href=\"http://blog.jobbole.com/79305/\" target=\"_blank\">浅谈算法和数据结构: 七 二叉查找树</a>。</p>\n<p><strong>复杂度分析：<span style=\"text-decoration: underline;\">它和二分查找一样，插入和查找的时间复杂度均为O(logn)，但是在最坏的情况下仍然会有O(n)的时间复杂度。</span>原因在于插入和删除元素的时候，树没有保持平衡（比如，我们查找上图（b）中的“93”，我们需要进行n次查找操作）。我们追求的是在最坏的情况下仍然有较好的时间复杂度，这就是平衡查找树设计的初衷。</strong></p>\n<p>下图为二叉树查找和顺序查找以及二分查找性能的对比图：</p>\n<p><strong><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/0bab1b7848505a289a147555e768c011.png\"><img class=\"aligncenter wp-image-111634 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0bab1b7848505a289a147555e768c011.png\" alt=\"242110240767812\" width=\"640\" height=\"297\"></a></strong></p>\n<p>基于二叉查找树进行优化，进而可以得到其他的树表查找算法，如平衡树、红黑树等高效算法。</p>\n<p><strong>5.2 平衡查找树之2-3查找树（2-3 Tree）</strong></p>\n<p><strong>2-3查找树定义</strong>：和二叉树不一样，2-3树运行每个节点保存1个或者两个的值。对于普通的2节点(2-node)，他保存1个key和左右两个自己点。对应3节点(3-node)，保存两个Key，2-3查找树的定义如下：</p>\n<p>1）要么为空，要么：</p>\n<p>2）对于2节点，该节点保存一个key及对应value，以及两个指向左右节点的节点，左节点也是一个2-3节点，所有的值都比key要小，右节点也是一个2-3节点，所有的值比key要大。</p>\n<p>3）对于3节点，该节点保存两个key及对应value，以及三个指向左中右的节点。左节点也是一个2-3节点，所有的值均比两个key中的最小的key还要小；中间节点也是一个2-3节点，中间节点的key值在两个跟节点key值之间；右节点也是一个2-3节点，节点的所有key值比两个key中的最大的key还要大。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/820c68356662f10a63a017836542f86e.png\"><img class=\"aligncenter wp-image-111635 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/820c68356662f10a63a017836542f86e.png\" alt=\"252248450292152\" width=\"577\" height=\"347\"></a></p>\n<p><strong>2-3查找树的性质：</strong></p>\n<p><span style=\"text-decoration: underline;\"><strong>1）如果中序遍历2-3查找树，就可以得到排好序的序列；</strong></span></p>\n<p><span style=\"text-decoration: underline;\"><strong>2）在一个完全平衡的2-3查找树中，根节点到每一个为空节点的距离都相同。（这也是平衡树中“平衡”一词的概念，根节点到叶节点的最长距离对应于查找算法的最坏情况，而平衡树中根节点到叶节点的距离都一样，最坏情况也具有对数复杂度。）</strong></span></p>\n<p>性质2）如下图所示：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/5520f67674c24d9ec25056ec9659db69.png\"><img class=\"aligncenter wp-image-111636 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/5520f67674c24d9ec25056ec9659db69.png\" alt=\"252249082017906\" width=\"640\" height=\"137\"></a></p>\n<p><strong>复杂度分析：</strong></p>\n<p>2-3树的查找效率与树的高度是息息相关的。</p>\n<ul>\n<li>在最坏的情况下，也就是所有的节点都是2-node节点，查找效率为lgN</li>\n<li>在最好的情况下，所有的节点都是3-node节点，查找效率为log<sub>3</sub>N约等于0.631lgN</li>\n</ul>\n<p>距离来说，对于1百万个节点的2-3树，树的高度为12-20之间，对于10亿个节点的2-3树，树的高度为18-30之间。</p>\n<p>对于插入来说，只需要常数次操作即可完成，因为他只需要修改与该节点关联的节点即可，不需要检查其他节点，所以效率和查找类似。下面是2-3查找树的效率：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/e67bb0d46b9098cf63784b9fb3a44762.png\"><img class=\"aligncenter wp-image-111637 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e67bb0d46b9098cf63784b9fb3a44762.png\" alt=\"252249104513019\" width=\"997\" height=\"443\"></a></p>\n<p><strong>5.3 平衡查找树之红黑树（Red-Black Tree）</strong></p>\n<p>2-3查找树能保证在插入元素之后能保持树的平衡状态，最坏情况下即所有的子节点都是2-node，树的高度为lgn，从而保证了最坏情况下的时间复杂度。但是2-3树实现起来比较复杂，于是就有了一种简单实现2-3树的数据结构，即红黑树（Red-Black Tree）。</p>\n<p><strong>基本思想：</strong>红黑树的思想就是对2-3查找树进行编码，尤其是对2-3查找树中的3-nodes节点添加额外的信息。红黑树中将节点之间的链接分为两种不同类型，红色链接，他用来链接两个2-nodes节点来表示一个3-nodes节点。黑色链接用来链接普通的2-3节点。特别的，使用红色链接的两个2-nodes来表示一个3-nodes节点，并且向左倾斜，即一个2-node是另一个2-node的左子节点。这种做法的好处是查找的时候不用做任何修改，和普通的二叉查找树相同。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/87bf495966cd746d1c85c18f2bfdd19e.png\"><img class=\"aligncenter wp-image-111638 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/87bf495966cd746d1c85c18f2bfdd19e.png\" alt=\"270024368439888\" width=\"595\" height=\"249\"></a></p>\n<p><strong>红黑树的定义：</strong></p>\n<p>红黑树是一种具有红色和黑色链接的平衡查找树，同时满足：</p>\n<ul>\n<li>红色节点向左倾斜</li>\n<li>一个节点不可能有两个红色链接</li>\n<li>整个树完全黑色平衡，即从根节点到所以叶子结点的路径上，黑色链接的个数都相同。</li>\n</ul>\n<p>下图可以看到红黑树其实是2-3树的另外一种表现形式：如果我们将红色的连线水平绘制，那么他链接的两个2-node节点就是2-3树中的一个3-node节点了。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/b9da2c6adee6a2cf1bfecab40e784c8a.png\"><img class=\"aligncenter wp-image-111639 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/b9da2c6adee6a2cf1bfecab40e784c8a.png\" alt=\"270024403113529\" width=\"594\" height=\"607\"></a></p>\n<p><span style=\"text-decoration: underline;\"><strong>红黑树的性质：整个树完全黑色平衡，即从根节点到所以叶子结点的路径上，黑色链接的个数都相同（2-3树的第2）性质，从根节点到叶子节点的距离都相等）。</strong></span></p>\n<p><span style=\"text-decoration: underline;\"><strong>复杂度分析：最坏的情况就是，红黑树中除了最左侧路径全部是由3-node节点组成，即红黑相间的路径长度是全黑路径长度的2倍。</strong></span></p>\n<p>下图是一个典型的红黑树，从中可以看到最长的路径(红黑相间的路径)是最短路径的2倍：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/888d499f58cf6554a323d253c8a45d5b.png\"><img class=\"aligncenter wp-image-111640 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/888d499f58cf6554a323d253c8a45d5b.png\" alt=\"270027368747653\" width=\"586\" height=\"230\"></a></p>\n<p><span style=\"text-decoration: underline;\"><strong>红黑树的平均高度大约为logn。</strong></span></p>\n<p>下图是红黑树在各种情况下的时间复杂度，可以看出红黑树是2-3查找树的一种实现，它能保证最坏情况下仍然具有对数的时间复杂度。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/acc945f4b6a4767a1ff9c29188fb3190.png\"><img class=\"aligncenter wp-image-111641 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/acc945f4b6a4767a1ff9c29188fb3190.png\" alt=\"270027378905711\" width=\"640\" height=\"330\"></a></p>\n<p>红黑树这种数据结构应用十分广泛，在多种编程语言中被用作符号表的实现，如：</p>\n<ul>\n<li>Java中的java.util.TreeMap,java.util.TreeSet；</li>\n<li>C++ STL中的：map,multimap,multiset；</li>\n<li>.NET中的：SortedDictionary,SortedSet 等。</li>\n</ul>\n<p><strong>5.4 B树和B+树（B Tree/B+ Tree）</strong></p>\n<p>平衡查找树中的2-3树以及其实现红黑树。2-3树种，一个节点最多有2个key，而红黑树则使用染色的方式来标识这两个key。</p>\n<p>维基百科对B树的定义为“在计算机科学中，B树（B-tree）是一种树状数据结构，它能够存储数据、对其进行排序并允许以O(log n)的时间复杂度运行进行查找、顺序读取、插入和删除的数据结构。B树，概括来说是一个节点可以拥有多于2个子节点的二叉查找树。与自平衡二叉查找树不同，B树为系统最优化<span style=\"text-decoration: underline;\"><strong>大块数据的读和写操作</strong></span>。B-tree算法减少定位记录时所经历的中间过程，从而加快存取速度。普遍运用在<span style=\"text-decoration: underline;\"><strong>数据库</strong></span>和<span style=\"text-decoration: underline;\"><strong>文件系统</strong></span>。</p>\n<p><strong>B树定义：</strong></p>\n<p><strong>B树</strong>可以看作是对2-3查找树的一种扩展，即他允许每个节点有M-1个子节点。</p>\n<ul>\n<li>根节点至少有两个子节点</li>\n<li>每个节点有M-1个key，并且以升序排列</li>\n<li>位于M-1和M key的子节点的值位于M-1 和M key对应的Value之间</li>\n<li>其它节点至少有M/2个子节点</li>\n<li>下图是一个M=4 阶的B树:</li>\n</ul>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/c9c21772ceb0abbee6d86aefb194ae7c.png\"><img class=\"aligncenter wp-image-111642 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c9c21772ceb0abbee6d86aefb194ae7c.png\" alt=\"290047034539184\" width=\"640\" height=\"137\"></a></p>\n<p>可以看到B树是2-3树的一种扩展，他允许一个节点有多于2个的元素。B树的插入及平衡化操作和2-3树很相似，这里就不介绍了。下面是往B树中依次插入</p>\n<p><strong>6 10 4 14 5 11 15 3 2 12 1 7 8 8 6 3 6 21 5 15 15 6 32 23 45 65 7 8 6 5 4</strong></p>\n<p>的演示动画：</p>\n<p><img class=\"aligncenter\" src=\"http://wx3.sinaimg.cn/large/7cc829d3gy1fh5p12mz57g20qm06d4qq.gif\" width=\"958\" height=\"229\"></p>\n<p><strong>B+树定义：</strong></p>\n<p><strong>B+</strong>树是对B树的一种变形树，它与B树的差异在于：</p>\n<ul>\n<li>有k个子结点的结点必然有k个关键码；</li>\n<li>非叶结点仅具有索引作用，跟记录有关的信息均存放在叶结点中。</li>\n<li>树的所有叶结点构成一个有序链表，可以按照关键码排序的次序遍历全部记录。</li>\n</ul>\n<p>如下图，是一个B+树:</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/e100192c3d4fc465ee6a35dc20be441e.png\"><img class=\"aligncenter wp-image-111643 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e100192c3d4fc465ee6a35dc20be441e.png\" alt=\"290050048129679\" width=\"1008\" height=\"208\"></a></p>\n<p>下图是B+树的插入动画：</p>\n<p><img class=\"aligncenter\" src=\"http://wx4.sinaimg.cn/large/7cc829d3gy1fh5p2ef94jg20rz05i7wi.gif\" width=\"1007\" height=\"198\"></p>\n<p><span style=\"text-decoration: underline;\"><strong>B和B+树的区别在于，B+树的非叶子结点只包含导航信息，不包含实际的值，所有的叶子结点和相连的节点使用链表相连，便于区间查找和遍历。</strong></span></p>\n<p>B+ 树的优点在于：</p>\n<ul>\n<li>由于B+树在内部节点上不好含数据信息，因此在内存页中能够存放更多的key。 数据存放的更加紧密，具有更好的空间局部性。因此访问叶子几点上关联的数据也具有更好的缓存命中率。</li>\n<li>B+树的叶子结点都是相链的，因此对整棵树的便利只需要一次线性遍历叶子结点即可。而且由于数据顺序排列并且相连，所以便于区间查找和搜索。而B树则需要进行每一层的递归遍历。相邻的元素可能在内存中不相邻，所以缓存命中性没有B+树好。</li>\n</ul>\n<p><span style=\"text-decoration: underline;\"><strong>但是B树也有优点，其优点在于，由于B树的每一个节点都包含key和value，因此经常访问的元素可能离根节点更近，因此访问也更迅速。</strong></span></p>\n<p>下面是B 树和B+树的区别图：</p>\n<p> </p>\n<p>B/B+树常用于文件系统和数据库系统中，它通过对每个节点存储个数的扩展，使得对连续的数据能够进行较快的定位和访问，能够有效减少查找时间，提高存储的空间局部性从而减少IO操作。它广泛用于文件系统及数据库中，如：</p>\n<ul>\n<li>Windows：HPFS文件系统；</li>\n<li>Mac：HFS，HFS+文件系统；</li>\n<li>Linux：ResiserFS，XFS，Ext3FS，JFS文件系统；</li>\n<li>数据库：ORACLE，MYSQL，SQLSERVER等中。</li>\n</ul>\n<p>有关B/B+树在数据库索引中的应用，请看张洋的《<a href=\"http://blog.jobbole.com/24006/\" target=\"_blank\">MySQL索引背后的数据结构及算法原理</a>》这篇文章，这篇文章对MySQL中的如何使用B+树进行索引有比较详细的介绍，推荐阅读。</p>\n<p><strong>树表查找总结：</strong></p>\n<p>二叉查找树平均查找性能不错，为O(logn)，但是最坏情况会退化为O(n)。在二叉查找树的基础上进行优化，我们可以使用平衡查找树。平衡查找树中的2-3查找树，这种数据结构在插入之后能够进行自平衡操作，从而保证了树的高度在一定的范围内进而能够保证最坏情况下的时间复杂度。但是2-3查找树实现起来比较困难，红黑树是2-3树的一种简单高效的实现，他巧妙地使用颜色标记来替代2-3树中比较难处理的3-node节点问题。红黑树是一种比较高效的平衡查找树，应用非常广泛，很多编程语言的内部实现都或多或少的采用了红黑树。</p>\n<p>除此之外，2-3查找树的另一个扩展——B/B+平衡树，在文件系统和数据库系统中有着广泛的应用。</p>\n<h3><strong>6. 分块查找</strong></h3>\n<p>分块查找又称索引顺序查找，它是顺序查找的一种改进方法。</p>\n<p><strong>算法思想：</strong>将n个数据元素”按块有序”划分为m块（m ≤ n）。每一块中的结点不必有序，但块与块之间必须”按块有序”；即第1块中任一元素的关键字都必须小于第2块中任一元素的关键字；而第2块中任一元素又都必须小于第3块中的任一元素，……</p>\n<p><strong>算法流程：</strong><br>\nstep1 先选取各块中的最大关键字构成一个索引表；<br>\nstep2 查找分两个部分：先对索引表进行二分查找或顺序查找，以确定待查记录在哪一块中；然后，在已确定的块中用顺序法进行查找。</p>\n<h3>7. 哈希查找</h3>\n<p><strong>什么是哈希表（Hash）？</strong></p>\n<div>我们使用一个下标范围比较大的数组来存储元素。可以设计一个函数（哈希函数， 也叫做散列函数），使得每个元素的关键字都与一个函数值（即数组下标）相对应，于是用这个数组单元来存储这个元素；也可以简单的理解为，按照关键字为每一个元素”分类”，然后将这个元素存储在相应”类”所对应的地方。但是，不能够保证每个元素的关键字与函数值是一一对应的，因此极有可能出现对于不同的元素，却计算出了相同的函数值，这样就产生了”冲突”，换句话说，就是把不同的元素分在了相同的”类”之中。后面我们将看到一种解决”冲突”的简便做法。</div>\n<div><span style=\"text-decoration: underline;\"><strong>总的来说，”直接定址”与”解决冲突”是哈希表的两大特点。</strong></span></div>\n<p><strong>什么是哈希函数？</strong></p>\n<p>哈希函数的规则是：通过某种转换关系，使关键字适度的分散到指定大小的的顺序结构中，越分散，则以后查找的时间复杂度越小，空间复杂度越高。</p>\n<p><strong>算法思想：</strong>哈希的思路很简单，如果所有的键都是整数，那么就可以使用一个简单的无序数组来实现：将键作为索引，值即为其对应的值，这样就可以快速访问任意键的值。这是对于简单的键的情况，我们将其扩展到可以处理更加复杂的类型的键。</p>\n<p><strong>算法流程：</strong><br>\n1）用给定的哈希函数构造哈希表；</p>\n<p>2）根据选择的冲突处理方法解决地址冲突；</p>\n<p>（常见的解决冲突的方法：拉链法和线性探测法。详细的介绍可以参见：<a id=\"cb_post_title_url\" href=\"http://blog.jobbole.com/79261/\" target=\"_blank\">浅谈算法和数据结构: 十一 哈希表</a>。）</p>\n<p>3）在哈希表的基础上执行哈希查找。</p>\n<p><span style=\"text-decoration: underline;\"><strong>哈希表是一个在时间和空间上做出权衡的经典例子。如果没有内存限制，那么可以直接将键作为数组的索引。那么所有的查找时间复杂度为O(1)；如果没有时间限制，那么我们可以使用无序数组并进行顺序查找，这样只需要很少的内存。哈希表使用了适度的时间和空间来在这两个极端之间找到了平衡。只需要调整哈希函数算法即可在时间和空间上做出取舍。</strong></span></p>\n<p><strong>复杂度分析</strong>：</p>\n<p>单纯论查找复杂度：对于无冲突的Hash表而言，查找复杂度为O(1)（注意，在查找之前我们需要构建相应的Hash表）。</p>\n<p><strong>使用Hash，我们付出了什么？</strong><br>\n我们在实际编程中存储一个大规模的数据，最先想到的存储结构可能就是map，也就是我们常说的KV pair，经常使用Python的博友可能更有这种体会。使用map的好处就是，我们在后续处理数据处理时，可以根据数据的key快速的查找到对应的value值。map的本质就是Hash表，那我们在获取了超高查找效率的基础上，我们付出了什么？</p>\n<p>Hash是一种典型<strong>以空间换时间</strong>的算法，比如原来一个长度为100的数组，对其查找，只需要遍历且匹配相应记录即可，从空间复杂度上来看，假如数组存储的是byte类型数据，那么该数组占用100byte空间。现在我们采用Hash算法，我们前面说的Hash必须有一个规则，约束键与存储位置的关系，那么就需要一个固定长度的hash表，此时，仍然是100byte的数组，假设我们需要的100byte用来记录键与位置的关系，那么总的空间为200byte,而且用于记录规则的表大小会根据规则，大小可能是不定的。</p>\n<p>Hash算法和其他查找算法的性能对比：<a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/eea75027e83568ebe782611acefbe48d.png\"><img class=\"aligncenter wp-image-111645 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/eea75027e83568ebe782611acefbe48d.png\" alt=\"312301180197071\" width=\"834\" height=\"511\"></a></p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111629\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111629votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111629\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 5 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "浅析 Linux 的共享内存与 tmpfs 文件系统", "url": "http://blog.jobbole.com/111665/", "url_object_id": "e04a2d4d18843ec489eef7404d5f0e1c", "create_date": "2017/07/03 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2016/11/59d49abe8909a122bc2c9aa43b71e3bb.png"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "IT技术,Linux", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.chinaunix.net/uid-28541347-id-5763124.html\">lvyilong316</a>   </div><h2><b>前言</b><b></b></h2>\n<p>共享内存主要用于进程间通信，Linux有两种共享内存(Shared Memory)机制：</p>\n<p>(1) ** System V shared memory(shmget/shmat/shmdt) **</p>\n<p>Original shared memory mechanism, still widely used Sharing between unrelated processes.</p>\n<p>(2) ** POSIX shared memory(shm_open/shm_unlink) **</p>\n<p>Sharing between unrelated processes, without overhead of filesystem I/O Intended to be simpler and better than older APIs.</p>\n<p>另外，在Linux中不得不提一下内存映射（也可用于进程间通信）：</p>\n<p>** Shared mappings – mmap(2) **</p>\n<p>l Shared anonymous mappings：Sharing between related processes only (related via fork())</p>\n<p>l Shared file mappings：Sharing between unrelated processes, backed by file in filesystem</p>\n<p>System V共享内存历史悠久，使用也很广范，很多类Unix系统都支持。一般来说，我们在写程序时也通常使用第一种。这里不再讨论如何使用它们，关于POSIX共享内存的详细介绍可以参考<a href=\"http://man7.org/linux/man-pages/man7/shm_overview.7.html\">这里1</a>,<a href=\"http://man7.org/training/download/posix_shm_slides.pdf\">这里2</a>。</p>\n<p>** 讲到那么多，那么问题来了，共享内存与tmpfs有什么关系？ **</p>\n<p align=\"justify\">The POSIX shared memory object implementation on Linux 2.4 makes use of a dedicated filesystem, which is normally mounted under /dev/shm.</p>\n<p>    从这里可以看到，POSIX共享内存是基于tmpfs来实现的。实际上，更进一步，不仅PSM(POSIX shared memory)，而且SSM(System V shared memory)在内核也是基于tmpfs实现的。</p>\n<h2><b>tmpfs介绍</b><b></b></h2>\n<p>下面是内核文档中关于tmpfs的介绍：</p>\n<p align=\"justify\">tmpfs has the following uses:</p>\n<p align=\"justify\">1) There is always a kernel internal mount which you will not see at all. This is used for shared anonymous mappings and SYSV shared memory.</p>\n<p align=\"justify\">This mount does not depend on CONFIG_TMPFS. If CONFIG_TMPFS is not set, the user visible part of tmpfs is not build. But the internal mechanisms are always present.</p>\n<p align=\"justify\">2) glibc 2.2 and above expects tmpfs to be mounted at /dev/shm for POSIX shared memory (shm_open, shm_unlink). Adding the following line to /etc/fstab should take care of this:</p>\n<p align=\"justify\">tmpfs /dev/shm tmpfs defaults 0 0</p>\n<p align=\"justify\">Remember to create the directory that you intend to mount tmpfs on if necessary.</p>\n<p align=\"justify\">This mount is not needed for SYSV shared memory. The internal mount is used for that. (In the 2.3 kernel versions it was necessary to mount the predecessor of tmpfs (shm fs) to use SYSV shared memory)</p>\n<p>从这里可以看到tmpfs主要有两个作用：</p>\n<p><b>    </b><b>（1）用于SYSV共享内存，还有匿名内存映射；这部分由内核管理，用户不可见；</b><b></b></p>\n<p><b>    </b><b>（2）用于POSIX共享内存，由用户负责mount，而且一般mount到/dev/shm；依赖于CONFIG_TMPFS;</b><b></b></p>\n<p>到这里，我们可以了解，SSM与PSM之间的区别，也明白了/dev/shm的作用。</p>\n<p>下面我们来做一些测试：</p>\n<h2><b>测试</b><b></b></h2>\n<p>我们将/dev/shm的tmpfs设置为64M：</p>\n<p><i># mount -size=64M -o remount /dev/shm# df -lh</i></p>\n<p>Filesystem                  Size  Used Avail Use% Mounted on</p>\n<p>tmpfs                          64M     0   64M   0% /dev/shm</p>\n<p>SYSV共享内存的最大大小为32M：</p>\n<p><i># cat /proc/sys/kernel/shmmax</i></p>\n<p>33554432</p>\n<h3><b>(1)创建65M的system V共享内存失败：</b><b></b></h3>\n<p><i># ipcmk -M 68157440                   </i></p>\n<p>ipcmk: create share memory failed: Invalid argument</p>\n<p>这是正常的。</p>\n<h3><b>(2)将shmmax调整为65M</b><b></b></h3>\n<p><i># echo 68157440 &gt; /proc/sys/kernel/shmmax# cat /proc/sys/kernel/shmmax             </i></p>\n<p>68157440<i># ipcmk -M 68157440                       </i></p>\n<p>Shared memory id: 0<i># ipcs -m</i></p>\n<p>—— Shared Memory Segments ——–</p>\n<p>key        shmid      owner      perms      bytes      nattch     status</p>\n<p>0xef46b249 0          root       644        68157440   0</p>\n<p>可以看到system v共享内存的大小并不受/dev/shm的影响。</p>\n<h3><b>(3)创建POSIX共享内存</b></h3>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe1166795166390261\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/*gcc -o shmopen shmopen.c -lrt*/#include &lt;unistd.h&gt;\r\n#include &lt;fcntl.h&gt;\r\n#include &lt;sys/stat.h&gt;\r\n#include &lt;sys/types.h&gt;\r\n#include &lt;sys/mman.h&gt;\r\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#define MAP_SIZE 68157440\r\nint main(int argc, char *argv[])\r\n{\r\n    int fd;\r\n    void* result;\r\n    fd = shm_open(\"/shm1\", O_RDWR|O_CREAT, 0644);\r\n    if(fd &lt; 0){\r\n        printf(\"shm_open failed\\n\");\r\n        exit(1);\r\n    }\r\n    return 0;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe1166795166390261-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe1166795166390261-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe1166795166390261-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe1166795166390261-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfe1166795166390261-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe1166795166390261-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfe1166795166390261-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe1166795166390261-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfe1166795166390261-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe1166795166390261-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfe1166795166390261-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe1166795166390261-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfe1166795166390261-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe1166795166390261-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfe1166795166390261-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe1166795166390261-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfe1166795166390261-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe1166795166390261-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfe1166795166390261-19\">19</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe1166795166390261-1\"><span class=\"crayon-c\">/*gcc -o shmopen shmopen.c -lrt*/</span><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe1166795166390261-2\"><span class=\"crayon-p\">#include &lt;fcntl.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe1166795166390261-3\"><span class=\"crayon-p\">#include &lt;sys/stat.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe1166795166390261-4\"><span class=\"crayon-p\">#include &lt;sys/types.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe1166795166390261-5\"><span class=\"crayon-p\">#include &lt;sys/mman.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe1166795166390261-6\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe1166795166390261-7\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe1166795166390261-8\"><span class=\"crayon-p\">#define MAP_SIZE 68157440</span></div><div class=\"crayon-line\" id=\"crayon-596bfe1166795166390261-9\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe1166795166390261-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfe1166795166390261-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe1166795166390261-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe1166795166390261-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shm_open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/shm1\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">O_RDWR</span><span class=\"crayon-o\">|</span><span class=\"crayon-v\">O_CREAT</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0644</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe1166795166390261-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfe1166795166390261-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"shm_open failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe1166795166390261-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe1166795166390261-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe1166795166390261-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe1166795166390261-19\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0020 seconds] -->\r\n<p><i># ./shmopen# ls -lh /dev/shm/shm1</i></p>\n<p>-rw-r–r– 1 root root 65M Mar  3 06:19 /dev/shm/shm1</p>\n<p>仅管/dev/shm只有64M,但创建65M的POSIX SM也可以成功。</p>\n<h3><b>(4)向POSIX SM写数据</b></h3>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe11667a2581361614\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/*gcc -o shmwrite shmwrite.c -lrt*/#include &lt;unistd.h&gt;\r\n#include &lt;fcntl.h&gt;\r\n#include &lt;sys/stat.h&gt;\r\n#include &lt;sys/types.h&gt;\r\n#include &lt;sys/mman.h&gt;\r\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#define MAP_SIZE 68157440\r\nint main(int argc, char *argv[])\r\n{\r\n    int fd;\r\n    void* result;\r\n    fd = shm_open(\"/shm1\", O_RDWR|O_CREAT, 0644);\r\n    if(fd &lt; 0){\r\n         printf(\"shm_open failed\\n\");\r\n         exit(1);\r\n    }\r\n    if (ftruncate(fd, MAP_SIZE) &lt; 0){\r\n        printf(\"ftruncate failed\\n\");\r\n        exit(1);\r\n    }\r\n    result = mmap(NULL, MAP_SIZE, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);\r\n    if(result == MAP_FAILED){\r\n        printf(\"mapped failed\\n\");\r\n        exit(1);\r\n    }\r\n    /* ... operate result pointer */\r\n    printf(\"memset\\n\");\r\n    memset(result, 0, MAP_SIZE);\r\n    //shm_unlink(\"/shm1\");\r\n    return 0;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a2581361614-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a2581361614-32\">32</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-1\"><span class=\"crayon-c\">/*gcc -o shmwrite shmwrite.c -lrt*/</span><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-2\"><span class=\"crayon-p\">#include &lt;fcntl.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-3\"><span class=\"crayon-p\">#include &lt;sys/stat.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-4\"><span class=\"crayon-p\">#include &lt;sys/types.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-5\"><span class=\"crayon-p\">#include &lt;sys/mman.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-6\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-7\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-8\"><span class=\"crayon-p\">#define MAP_SIZE 68157440</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-9\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shm_open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/shm1\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">O_RDWR</span><span class=\"crayon-o\">|</span><span class=\"crayon-v\">O_CREAT</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0644</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-15\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"shm_open failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-16\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">ftruncate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"ftruncate failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">mmap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PROT_READ</span><span class=\"crayon-o\">|</span><span class=\"crayon-v\">PROT_WRITE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SHARED</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_FAILED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"mapped failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* ... operate result pointer */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"memset\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">memset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//shm_unlink(\"/shm1\");</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a2581361614-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a2581361614-32\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0038 seconds] -->\r\n<p><i># ./shmwrite</i></p>\n<p>memset</p>\n<p>Bus error</p>\n<p>可以看到，写65M的数据会报Bus error错误。</p>\n<p>但是，却可以在/dev/shm创建新的文件：</p>\n<p><i># ls -lh /dev/shm/ -lh</i></p>\n<p>总用量 64M</p>\n<p>-rw-r–r– 1 root root 65M 3月   3 15:23 shm1</p>\n<p>-rw-r–r– 1 root root 65M 3月   3 15:24 shm2</p>\n<p>这很正常，ls显示的是inode-&gt;size。</p>\n<p><i># stat /dev/shm/shm2</i></p>\n<p>File: “/dev/shm/shm2”</p>\n<p>Size: 68157440        Blocks: 0          IO Block: 4096   普通文件</p>\n<p>Device: 10h/16d Inode: 217177      Links: 1</p>\n<p>Access: (0644/-rw-r–r–)  Uid: (    0/    root)   Gid: (    0/    root)</p>\n<p>Access: 2015-03-03 15:24:28.025985167 +0800</p>\n<p>Modify: 2015-03-03 15:24:28.025985167 +0800</p>\n<p>Change: 2015-03-03 15:24:28.025985167 +0800</p>\n<h3><b>(5)向SYS V共享内存写数据</b><b></b></h3>\n<p>将System V共享内存的最大值调整为65M(/dev/shm仍然为64M)。</p>\n<p><i># cat /proc/sys/kernel/shmmax</i></p>\n<p>68157440</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe11667a7920220156\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/*gcc -o shmv shmv.c*/#include &lt;sys/ipc.h&gt;\r\n#include &lt;sys/shm.h&gt;\r\n#include &lt;sys/types.h&gt;\r\n#include &lt;unistd.h&gt;\r\n#define MAP_SIZE 68157440\r\nint main(int argc, char** argv){\r\n    int shm_id,i;\r\n    key_t key;\r\n    char temp;\r\n    char *p_map;\r\n    char* name = \"/dev/shm/shm3\";\r\n    key = ftok(name,0);\r\n    if(key==-1)\r\n        perror(\"ftok error\");\r\n    shm_id=shmget(key,MAP_SIZE,IPC_CREAT);\r\n    if(shm_id==-1)\r\n    {\r\n        perror(\"shmget error\");\r\n        return;\r\n    }\r\n    p_map=(char*)shmat(shm_id,NULL,0);\r\n    memset(p_map, 0, MAP_SIZE);\r\n    if(shmdt(p_map)==-1)\r\n        perror(\" detach error \");\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667a7920220156-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667a7920220156-25\">25</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-1\"><span class=\"crayon-c\">/*gcc -o shmv shmv.c*/</span><span class=\"crayon-p\">#include &lt;sys/ipc.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-2\"><span class=\"crayon-p\">#include &lt;sys/shm.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-3\"><span class=\"crayon-p\">#include &lt;sys/types.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-4\"><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-5\"><span class=\"crayon-p\">#define MAP_SIZE 68157440</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-6\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">key_t </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">p_map</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">char</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"/dev/shm/shm3\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">key</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ftok</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">key</span><span class=\"crayon-o\">==</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">perror</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"ftok error\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">shmget</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">IPC_CREAT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-o\">==</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">perror</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"shmget error\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p_map</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">char</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">)</span><span class=\"crayon-e\">shmat</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">memset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p_map</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">shmdt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p_map</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">==</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667a7920220156-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">perror</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\" detach error \"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667a7920220156-25\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0032 seconds] -->\r\n<p><i>#./shmv</i></p>\n<p>却可以正常执行。</p>\n<h3><b>(7)结论</b><b></b></h3>\n<p>虽然System V与POSIX共享内存都是通过tmpfs实现，但是受的限制却不相同。也就是说/proc/sys/kernel/shmmax只会影响SYS V共享内存，/dev/shm只会影响Posix共享内存。<b>实际上，System V与Posix共享内存本来就是使用的两个不同的tmpfs实例(instance)</b>。</p>\n<h2><b>内核分析</b><b></b></h2>\n<p>内核在初始化时，会自动mount一个tmpfs文件系统，挂载为shm_mnt：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe11667ab515454698\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//mm/shmem.cstatic struct file_system_type \r\nshmem_fs_type = {\r\n    .owner = THIS_MODULE,\r\n   .name = \"tmpfs\",\r\n    .get_sb = shmem_get_sb,\r\n    .kill_sb = kill_litter_super,\r\n};\r\n\r\nint __init shmem_init(void) {\r\n    ...\r\n    error = register_filesystem(&amp;shmem_fs_type);\r\n    if (error) \r\n    {\r\n        printk(KERN_ERR \"Could not register tmpfs\\n\");\r\n        goto out2;\r\n    }\r\n    ///挂载tmpfs(用于SYS V) \r\n    shm_mnt = vfs_kern_mount(&amp;shmem_fs_type, MS_NOUSER,shmem_fs_type.name, NULL);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe11667ab515454698-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667ab515454698-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667ab515454698-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667ab515454698-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667ab515454698-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667ab515454698-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667ab515454698-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667ab515454698-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667ab515454698-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667ab515454698-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667ab515454698-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667ab515454698-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667ab515454698-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667ab515454698-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667ab515454698-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667ab515454698-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667ab515454698-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667ab515454698-18\">18</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe11667ab515454698-1\"><span class=\"crayon-c\">//mm/shmem.cstatic struct file_system_type </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667ab515454698-2\"><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667ab515454698-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">owner</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">THIS_MODULE</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667ab515454698-4\"><span class=\"crayon-h\">   </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"tmpfs\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667ab515454698-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">get_sb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_get_sb</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667ab515454698-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">kill_sb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">kill_litter_super</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667ab515454698-7\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667ab515454698-8\"> </div><div class=\"crayon-line\" id=\"crayon-596bfe11667ab515454698-9\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__init </span><span class=\"crayon-e\">shmem_init</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">void</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667ab515454698-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667ab515454698-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">register_filesystem</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667ab515454698-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667ab515454698-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667ab515454698-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">KERN</span><span class=\"crayon-sy\">_</span>ERR<span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Could not register tmpfs\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667ab515454698-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667ab515454698-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667ab515454698-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">///挂载tmpfs(用于SYS V) </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667ab515454698-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">shm_mnt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">vfs_kern_mount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MS_NOUSER</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0024 seconds] -->\r\n<p>/dev/shm的mount与普通文件mount的流程类似，不再讨论。但是，<b>值得注意的是，/dev/shm默认的大小为当前物理内存的1/2</b>：</p>\n<p>shmem_get_sb –&gt; shmem_fill_super</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe11667b1845400925\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//mem/shmem.c\r\nint shmem_fill_super(struct super_block *sb, void *data, int silent)\r\n{\r\n    ...\r\n#ifdef CONFIG_TMPFS \r\n/*\r\n* Per default we only allow half of the physical ram per\r\n* tmpfs instance, limiting inodes to one per page of lowmem;\r\n* but the internal instance is left unlimited.\r\n*/\r\n    if (!(sb-&gt;s_flags &amp; MS_NOUSER)) {///内核会设置MS_NOUSER \r\n        sbinfo-&gt;max_blocks = shmem_default_max_blocks();\r\n        sbinfo-&gt;max_inodes = shmem_default_max_inodes();\r\n        if (shmem_parse_options(data, sbinfo, false)) {\r\n            err = -EINVAL;\r\n            goto failed;\r\n        }\r\n    }\r\n    sb-&gt;s_export_op = &amp;shmem_export_ops;\r\n#else\r\n...\r\n\r\n#ifdef CONFIG_TMPFS\r\nstatic unsigned long shmem_default_max_blocks(void) {\r\n    return totalram_pages / 2;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b1845400925-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b1845400925-26\">26</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-1\"><span class=\"crayon-c\">//mem/shmem.c</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_fill_super</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">super_block *</span><span class=\"crayon-v\">sb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">silent</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-5\"><span class=\"crayon-p\">#ifdef CONFIG_TMPFS </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-6\"><span class=\"crayon-c\">/*</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-7\"><span class=\"crayon-c\">* Per default we only allow half of the physical ram per</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-8\"><span class=\"crayon-c\">* tmpfs instance, limiting inodes to one per page of lowmem;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-9\"><span class=\"crayon-c\">* but the internal instance is left unlimited.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-10\"><span class=\"crayon-c\">*/</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">s_flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MS_NOUSER</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">///内核会设置MS_NOUSER </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_blocks</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_default_max_blocks</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_inodes</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_default_max_inodes</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">shmem_parse_options</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">EINVAL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">failed</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">sb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">s_export_op</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">shmem_export_ops</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-20\"><span class=\"crayon-p\">#else</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-21\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-22\"> </div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-23\"><span class=\"crayon-p\">#ifdef CONFIG_TMPFS</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-24\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_default_max_blocks</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">void</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b1845400925-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">totalram_pages</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b1845400925-26\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0029 seconds] -->\r\n<p>可以看到：由于内核在mount tmpfs时，指定了MS_NOUSER，所以该tmpfs没有大小限制，因此，SYS V共享内存能够使用的内存空间只受/proc/sys/kernel/shmmax限制；而用户通过挂载的/dev/shm，默认为物理内存的1/2。</p>\n<p>注意CONFIG_TMPFS.</p>\n<p>另外，在/dev/shm创建文件走VFS接口，而SYS V与匿名映射却是通过shmem_file_setup实现：</p>\n<h2><b>SIGBUS</b><b></b></h2>\n<p>当应用访问共享内存对应的地址空间，如果对应的物理PAGE还没有分配，就会调用fault方法，分配失败，就会返回OOM或者BIGBUS错误：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfe11667b6451341709\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic const struct vm_operations_struct shmem_vm_ops = {\r\n    .fault = shmem_fault,\r\n#ifdef CONFIG_NUMA \r\n    .set_policy = shmem_set_policy,\r\n    .get_policy = shmem_get_policy,\r\n#endif\r\n};\r\n\r\nstatic int shmem_fault(struct vm_area_struct *vma, struct vm_fault *vmf)\r\n{\r\n    struct inode *inode = vma-&gt;vm_file-&gt;f_path.dentry-&gt;d_inode;\r\n    int error;\r\n    int ret = VM_FAULT_LOCKED;\r\n    error = shmem_getpage(inode, vmf-&gt;pgoff, &amp;vmf-&gt;page, SGP_CACHE, &amp;ret);\r\n    if (error)\r\n        return ((error == -ENOMEM) ? VM_FAULT_OOM : VM_FAULT_SIGBUS);\r\n    return ret;\r\n}\r\n\r\nshmem_getpage –&gt; shmem_getpage_gfp：\r\n/*\r\n * shmem_getpage_gfp - find page in cache, or get from swap, or allocate\r\n *\r\n * If we allocate a new one we do not mark it dirty. That's up to the\r\n * vm. If we swap it in we mark it dirty since we also free the swap\r\n * entry since a page cannot live in both the swap and page cache\r\n */\r\nstatic int shmem_getpage_gfp(struct inode *inode, pgoff_t index,\r\nstruct page **pagep, enum sgp_type sgp, gfp_t gfp, int *fault_type) \r\n{\r\n    ...\r\n    if (sbinfo-&gt;max_blocks) { ///dev/shm会有该值 \r\n        if (percpu_counter_compare(&amp;sbinfo-&gt;used_blocks,sbinfo-&gt;max_blocks) &gt;= 0) {\r\n            error = -ENOSPC;\r\n            goto unacct;\r\n        }\r\n    percpu_counter_inc(&amp;sbinfo-&gt;used_blocks);\r\n    }\r\n    //分配一个物理PAGE\r\n    page = shmem_alloc_page(gfp, info, index);\r\n    if (!page) {\r\n        error = -ENOMEM;\r\n        goto decused;\r\n    }\r\n    SetPageSwapBacked(page);\r\n    __set_page_locked(page);\r\n    error = mem_cgroup_cache_charge(page, current-&gt;mm,gfp &amp; GFP_RECLAIM_MASK); ///mem_cgroup检查\r\nif (!error)\r\n    error = shmem_add_to_page_cache(page, mapping, index, gfp, NULL);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfe11667b6451341709-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596bfe11667b6451341709-49\">49</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">vm_operations_struct </span><span class=\"crayon-v\">shmem_vm_ops</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">fault</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_fault</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-3\"><span class=\"crayon-p\">#ifdef CONFIG_NUMA </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">set_policy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_set_policy</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">get_policy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_get_policy</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-6\"><span class=\"crayon-p\">#endif</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-7\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-8\"> </div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-9\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_fault</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">vm_area_struct *</span><span class=\"crayon-v\">vma</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">vm_fault *</span><span class=\"crayon-v\">vmf</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">inode *</span><span class=\"crayon-v\">inode</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vma</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">vm_file</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">f_path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">dentry</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">d_inode</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ret</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">VM_FAULT_LOCKED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_getpage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">inode</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vmf</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">pgoff</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">vmf</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SGP_CACHE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">ret</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ENOMEM</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">VM_FAULT_OOM</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">VM_FAULT_SIGBUS</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ret</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-18\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-19\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-20\"><span class=\"crayon-v\">shmem</span><span class=\"crayon-sy\">_</span>getpage<span class=\"crayon-h\"> </span>–<span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_getpage</span><span class=\"crayon-sy\">_</span>gfp：</div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-21\"><span class=\"crayon-c\">/*</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-22\"><span class=\"crayon-c\"> * shmem_getpage_gfp - find page in cache, or get from swap, or allocate</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-23\"><span class=\"crayon-c\"> *</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-24\"><span class=\"crayon-c\"> * If we allocate a new one we do not mark it dirty. That's up to the</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-25\"><span class=\"crayon-c\"> * vm. If we swap it in we mark it dirty since we also free the swap</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-26\"><span class=\"crayon-c\"> * entry since a page cannot live in both the swap and page cache</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-27\"><span class=\"crayon-c\"> */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-28\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_getpage_gfp</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">inode *</span><span class=\"crayon-v\">inode</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">pgoff_t </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-29\"><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">page *</span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">pagep</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">enum</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sgp_type </span><span class=\"crayon-v\">sgp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">gfp_t </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">fault_type</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-30\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_blocks</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">///dev/shm会有该值 </span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">percpu_counter_compare</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">used_blocks</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_blocks</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-34\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ENOSPC</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-35\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">unacct</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-37\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">percpu_counter_inc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">used_blocks</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-38\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-39\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//分配一个物理PAGE</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-40\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_alloc_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">info</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-42\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ENOMEM</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">decused</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-44\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-45\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SetPageSwapBacked</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-46\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">__set_page_locked</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-47\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">mem_cgroup_cache_charge</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">current</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">mm</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">gfp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">GFP_RECLAIM_MASK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">///mem_cgroup检查</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfe11667b6451341709-48\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bfe11667b6451341709-49\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_add_to_page_cache</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mapping</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0073 seconds] -->\r\n<p></p>\n<h2><b>共享内存与CGROUP</b><b></b></h2>\n<p>目前，共享内存的空间计算在第一个访问共享内存的group，参考：</p>\n<p>l http://lwn.net/Articles/516541/</p>\n<p>l https://www.kernel.org/doc/Documentation/cgroups/memory.txt</p>\n<h2><b>POSIX共享内存与Docker</b><b></b></h2>\n<p>目前Docker将/dev/shm限制为64M，却没有提供参数，这种做法比较糟糕。如果应用使用大内存的POSIX共享内存，必然会导致问题。 参考:</p>\n<p>l https://github.com/docker/docker/issues/2606</p>\n<p>l https://github.com/docker/docker/pull/4981</p>\n<h2><b>总结</b><b></b></h2>\n<p>(1)POSIX共享内存与SYS V共享内存在内核都是通过tmpfs实现，但对应两个不同的tmpfs实例，相互独立。</p>\n<p>(2)通过/proc/sys/kernel/shmmax可以限制SYS V共享内存(单个)的最大值，通过/dev/shm可以限制POSIX共享内存的最大值(所有之和)。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111665\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111665votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111665\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "程序员生涯第一生存法则", "url": "http://blog.jobbole.com/111627/", "url_object_id": "a6d7be3180bc17350825a84d5e402c60", "create_date": "2017/07/04 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2012/08/programmer-developer-at-work.jpg"], "praise_nums": "5", "comment_nums": 3, "fav_nums": 8, "tags": "职场,程序员,职场", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://mp.weixin.qq.com/s/deP25x394QP0lSItHFWs4Q\">世相微语</a>   </div><p><strong>程序员的职业生涯，第一生存法则是什么？</strong></p>\n<p>追求理想、兴趣与爱好？ 不免有点奢侈。坚守道德、信仰与纯粹？ 也许太高尚了。</p>\n<p>平衡生活与工作、兼顾家庭与公司、妥善处理人际关系、熟练掌握沟通能力与谈判能力、扩大社交圈、耐得住寂寞、熬得了夜、活到老充电充到老、懂得取舍与妥协、低调做人高调做事… <strong>本文暂不打算灌输这类心灵鸡汤。</strong></p>\n<p>打开格局、扩大视野、开阔眼界、看准趋势、远见卓识，成为华尔街的宽客、CEO、CTO、首席科学家、首席架构师… 不幸的是，<strong>90%的量产程序员穷极一生，也注定无缘赖此生存，因为这个领域，天赋与机遇缺一不可。</strong></p>\n<p>数据结构、设计模式、算法架构、模型抽象、操作系统原理、编译器原理、概率统计、数论、代数、几何、微分… 相信我，<strong>90%的量产程序员编程10年，赖此生存的时间也不超过10天。</strong></p>\n<hr>\n<p>那程序员生涯的第一生存法则是什么？</p>\n<p><strong>很简单，拥抱开源，拥抱变化。</strong><strong>远离远离开源的公司，远离技术落伍许久的团队。</strong></p>\n<p><strong>职业生涯，无论做什么，第一要务是生存，而且应该是越过越舒适的生存。</strong><strong>譬如律师、医生，程序员亦是如此。</strong></p>\n<p>程序员，到 34 岁了，被公司直接或变相辞退了，是挺悲催的。</p>\n<p>但更悲催的是，离开这里，居然无法找到（至少）和之前同水平待遇的工作…</p>\n<hr>\n<p><strong>原因何在？</strong></p>\n<p>因为不少程序员都固执的认为自己所在的公司、所在的部门、所在的团队会基业长青，自己只需要埋头苦干，耕耘好自己的一亩三分地就能安享太平。</p>\n<p><strong>可现实是，你的工作并不是你想象的那样不可替代，你的业务代码也许一个初出茅庐的毕业生就可以接手，你的团队、部门、甚至公司也可能会在你想象不到的时刻宣布解散。</strong></p>\n<p>如果你的工作只是基于公司内部的闭源框架或陈旧的架构体系，调用一下接口，写写业务代码，修复一下bug，离开这里，还剩多少竞争力呢？</p>\n<p>试想一下，同样是业务系统开发，一个基于Spring（称得上Java第一开源框架）、Spark（大数据开源框架）、Kafka（消息中间件）开发的程序员，和一个基于Spriii、Spaaa、Kafff（泛指公司内部专用的框架）开发的程序员，能力相当，走出这家公司谁更吃香？</p>\n<p>再试想一下，同样是应用开发，一个玩转 Spring、Struts、Hibernate（Java开源老三样）的程序员，和一个玩转 Spring、SpringMVC、Mybatis （Java开源新三样）或 Spring Boot 的程序员，水平相当，出去面试谁更可受欢迎？</p>\n<p><strong>即使只是一颗螺丝钉，也要做一颗技术领先，在外界受欢迎的螺丝钉。去哪都能如鱼得水、畅快优游。</strong></p>\n<p><strong>这也是90%的普通程序员，首要应该思考的问题。</strong></p>\n<p>当然，这不是让你心猿意马，而是要时刻保持危机感，否则一不小心就走入了职场死胡同。</p>\n<hr>\n<p><strong>职场上，最好的生存保障是，走出这家公司，我依然能过得很好，或更好。</strong></p>\n<p>公司实行成本优化，开始清退 34+ 的程序员了？挺好，对面那家公司正想双薪挖人。</p>\n<p>项目市场反馈不行，团队面临解散？没事，另外团队的 Leader 前几日刚找我聊了，正希望我加入。</p>\n<p>Salesforce 来推销他们的 SaaS（企业软件即服务）服务了，IT部门又可以优化几个人员了。正好，那家18薪出国游的公司正在招人，技术要求很匹配…</p>\n<hr>\n<p><strong>在一家远离开源的公司，或技术落伍许久的团队，即使你是首席架构、技术总监，熟练掌握公司或团队内部的各种框架，配置和接口倒背如流，还能一一填埋这些框架的各种坑，那又如何？</strong></p>\n<p><strong>35岁了，换了一家公司，也许你又归零成了小白，因为别人不玩你这一套。</strong></p>\n<p>诺基亚塞班系统的专家，别说去微软了，即使去诺西（诺基亚西门子通信的简称），很多都得从头再来。</p>\n<p>百度 Pyramid（细节自行百度）项目组的大拿，还不如一个精通 Hadoop 配置的工程师更有市场。</p>\n<p>SAP、Oracle EBS 开发的资深工程师，选择公司的余地远比不上一个初级 React 工程师。</p>\n<p>之前参加过一些创业项目的路演，遇到过一个项目，创始人是两位博士，号称研发了最先进的深度学习算法，用于医学扫描成像的癌症诊断。</p>\n<p>但是，TensorFlow（谷歌）、CNTK（微软）等深度学习开源框架的图像识别算法，在癌症检测方面也许可以碾压小创业团队所谓的绝门秘笈。挺替他们的投资人担心的…</p>\n<hr>\n<p><strong>目前为止，只说了 90% 的普通程序员，那还有 10% 精英程序员呢？</strong></p>\n<p><strong>毫无疑问，精英程序员更应该拥抱开源，因为那才是实现个人价值，提升个人影响力的最佳途径。</strong></p>\n<p>如果 Spring 没有开源，就不可能获得如此广泛的应用，Rod Johnson（Spring 之父）的影响力也会大打折扣。</p>\n<p>如果 Lucene、Hadoop 没有开源，很多人可能都不知道 Doug Cutting（Lucene、Hadoop 之父）为何许人也。</p>\n<p>如果 Linux、Git 没有开源，也许就没有 Linus Torvalds（Linux、Git 之父）的享誉世界。更重要的是，这个世界可能会被更多的蝗虫入侵。</p>\n<p><em>注：“突然间，到处都是微软的产品了，被蝗虫入侵了似的。我并不是说蝗虫是坏蛋，我喜欢所有的动物和昆虫。” —— 摘自 Linus Torvalds 语录：</em></p>\n<p><strong>诚然，如上的大神毕竟凤毛麟角。但大牛级别的程序员走向开源，带来的个人影响力、声誉、技术伙伴、收入、成就感等，都是实实在在的。</strong></p>\n<hr>\n<p><strong>说了这么多，也许你也挺无奈的，因为你所在的项目所用的技术体系，刚好是公司专有且闭源的，那怎么办？</strong></p>\n<p>你可以默默的把这篇文章转给你们技术领导看看，看他有没有这个思想觉悟。</p>\n<p>如果领导悟性不够，半晌没有回应，你可以提点他一下：无论实习码农，还是技术大牛，现在优秀的人才都拥抱开源去了，我们再这样下去，会招不到优秀的人才的…</p>\n<hr>\n<p><strong>如果非常不幸，你从事的是银行、基金、保险、电信、电力、石油等领域的业务，而且还是古董级别的项目，领导说稳定才是第一位的。那你也有三条路可以走：</strong></p>\n<p>1、祈祷自己早日实现财务自由（据年初的胡润报告，一线城市财富自由门槛是 2.9亿）</p>\n<p>2、祈祷所在的公司（部门）能够基业长青</p>\n<p>3、更新一下简历，准备跳槽吧~</p>\n<p><strong>那这种古董级别的项目怎么办？总得有人维护吧？</strong></p>\n<p><strong>加薪！加薪！加薪！不能给予锦绣未来，就给予更猛烈的薪水吧！</strong></p>\n<hr>\n<p><strong>最后，即使是第一生存法则，也不是金科玉律。因为世上总存在一些奇葩的人，码农这个群体也不例外。</strong></p>\n<p>譬如我找人，最关注的还是逻辑思考能力。写一个新算法，学一门新语言，用一套新框架，不过几周的事情，何必那么纠结。</p>\n<p>不过，玩过 Tensorflow 图像识别与目标检测，跑过 ResNet、Inception 等网络的优先…</p>\n<hr>\n<p><strong>题外话</strong></p>\n<p>本文通篇都是从务实的角度来谈开源的好处，事物都有两面性，那开源的坏处在哪里？</p>\n<p>其实前面也提到了一点，TensorFlow、CNTK 等开源框架的算法，完全可以碾压大多数人工智能创业团队所研发的所谓独门秘诀，特别是通用算法领域。</p>\n<p><strong>也就是说，不少创业团队、研究院、实验室里，一门心思研究底层算法（包括图像识别、语音识别、翻译、NLP等前沿领域）造轮子的精英程序员、研究员可能会因此荒废多年的心血…</strong></p>\n<p>譬如，两个月前，百度推出阿波罗计划，将自家的自动驾驶平台开放。这同时意味着，国内自动驾驶领域的不少创业团队可能会面临被洗牌、解散。如果今后谷歌也来这么一出，行业震荡可想而知。</p>\n<p>前些日子，还听我一位在某大厂研究院视觉识别组的同学说：谷歌物体检测与图像识别的API一开放，他们视觉组辛苦了3、4年的研发心血又白费了…</p>\n<p><strong>可开源是人类社会进化的最优选择，因为只有开源，才能实现人类顶级智慧的充分共享与协作。</strong>除了谷歌、脸书，连一贯封闭的微软、苹果两大巨头都已走向开放。</p>\n<p><strong>开源大潮，浩浩荡荡，顺之者势如破竹，逆之者举步维艰。</strong></p>\n<p>也许自然规律如此，人类宿命如此吧。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111627\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111627votetotal\">5</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111627\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 8 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 3 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "为何不用担心大公司偷你的绝世创业点子", "url": "http://blog.jobbole.com/111721/", "url_object_id": "38cc12ee297c4f23c14ac3da6f7a65ce", "create_date": "2017/07/04 ·", "front_image_url": ["http://wx1.sinaimg.cn/mw690/63918611gy1fhc6vu9yuej20oq0e4772.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "创业,创业", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/TJQ\">佟大冬</a> 翻译，<a href=\"http://www.jobbole.com/members/young605867996\">Lada</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://timhampson.quora.com/Startups-Why-Google-Facebook-Apple-SalesForce-probably-wont-steal-your-lunch-money\">Tim Hampson</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>【导读】：并非所有人都认为你的创业idea是值得做的。且大公司并非拥有无限人力财力，再加上内部各山头的政治斗争，中层干部只求升职加薪安安稳稳，底层年轻员工空有理想但说话没分量。</p>\n<p style=\"text-align: center\"><strong>为何不用担心 GG/FB/苹果等大公司偷你的绝世创业点子<img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/63918611gy1fhc6vu9yuej20oq0e4772.jpg\" width=\"690\" height=\"394\"></strong></p>\n<p>创业公司经常被问到这样一个问题——为什么大公司不实现你的创业 idea，从而把你踢除这个市场？</p>\n<p>因为相比于典型创业公司的资源，大公司拥有数十亿美元的资金和成千上万个工程师，所以这个问题听起来似乎非常合理。</p>\n<p>其实比起创业公司，大公司的优势实际比你想象的要少。为什么？这个问题的原因值得列出来。</p>\n<h3>1.创新是件全凭运气的事儿</h3>\n<p>只有当你的点子（idea）开始盈利了，别人才会发现你的 idea 到底有多好，在此之前没人真的了解。然而到那个时候，你也将顺利地成为下一代执牛耳者。风投不会投资公司，他们投资市场和人（尤其是 CEO）。因为他们明白，在一个热门市场，他们尝试投资一位出类拔萃的人，他有望成为市场领导者，而且很有可能（50% ~ 80% 的可能性）带来回报，这些回报足以让有限的合伙人安心。如果这个市场足够热门，即使失败了，你也不会失去一切。失败被遗忘，历史被重写，只有其中 1-2 个带来回报的大项目被人们记住，以强调投资人有远见。而 20-30 个失败投资就这样被遗忘了（在大多数人看来，这些失败投资中，有些可能还是很成功的）。</p>\n<p>创业是一项投资组合业务，而且在这项业务中，大部分风投公司的投资规模在 1~5 亿美元之间。你不能在 2004 年左右，只是简单地将 1000 万美元投资给 Facebook，虽然这也不那么容易。你应该采取广泛的组合投资，而这需要大量的资金。因此，即使市场领导人试着实施他们自己的创新项目时也犹豫不决。</p>\n<p>这种投资组合模式也需要优胜劣汰机制，这一点风投们可以轻松做到，因为他们所要做的只是在资金用完时停止续投。对一个大公司而言，要解散一个表现不佳的研发团队无论从心理上还是实际行动上都困难得多。Google 因为终止项目非常果决，所以经常被做为反例。但实际上 Google 在 Google+ 上展示了它比任何风投都多的耐心。大公司对待新项目就像哺乳动物对待自己的孩子，风投则像鱼，虽然冷血（无双关），但它更有效。</p>\n<p>大公司无意和一个 500 万美元的创业公司竞争，他们竞争的是一个数十亿美元的生态系统，这就是为什么创业公司总能克敌制胜。大公司不能像风投那样对项目进行组合投资。</p>\n<h3>2. 每个人都不愿亏损</h3>\n<p>没人想影响正常稳定的收入。创业公司没有什么收入，所以他们不用担心收入受影响。从稳定的、可预测的（即使是下降的）收入形势中走出来不容易。相比之下，一款最新的小工具能不能在市场投放，大公司不关心，他们更倾向于投资升级成熟的主线产品……</p>\n<p> </p>\n<h3>3. 大公司是受过程约束的</h3>\n<p>每个人都可以说不，没有人可以拍板。或者往好了说，整个公司都需要“买进”，“整个”可以是公司遍布全球的各个部门。中层管理者更关注于管理自己的养老金，这是他们固有的惰性。上层管理者往往对现实市场鞭长莫及，不能辨别后起之秀。而对于公司底层人员，别人说什么他们就做什么，要不然就离开公司自己去创业……</p>\n<h3>4. 大公司需要大项目</h3>\n<p>所有的大公司基本都成为了集团。如果你已经是市场的引领者了，那么唯一的发展方向就是进入另一个市场。如果你想每季度收入几十亿美元，那么只有大项目能够做到。当然，创业公司 100 % 的增长看起来很漂亮，而额外的 100 万美元收入，大公司收入四舍五入带来的错误就有这么多。</p>\n<p>大公司注重创新之处都是大量资本密集投注的地方（比如 Google 街景），这是创业公司难以匹敌的事情。</p>\n<p>这还会影响大公司的发展战略。从 90 年代初期开始，Oracle 公司就不再满足于做一家数据库公司，现在已转型为 IT 供应商，为企业提供全套服务，包括硬件、软件和服务。SalesForce 是 CRM 市场的占尽先机者，所以人们经常还会以为 SalesForce 仍然是一家 CRM 公司。事实上，SalesForce 如今已发展为一个 PaaS 公司，希望通过大数据等来扩展其业务。在云服务方面，SalesForce 像 Oracle 看齐。SalesForce 85% 的 IT 支出是用于企业客户的，Marc Benioff （SalesForce 创始人）根本不在乎小客户，更别说想赶上类似 SalesForce 的 CRM 创业公司。这就像 Oracle 根本不在乎 MongoDB 一样。</p>\n<h3>5. 非本公司原创（即不愿意用别人发明的东西）</h3>\n<p>在 1999 年，Google 主动提出仅以 1 百万美元出售给 Excite，但是被 Excite 嗤之以鼻，因为 Excite 仅靠自己可以很容易实现搜索引擎。有趣的是，虽说他们是正确的，但他们从未找到足够的时间去做。正如他们所说，遗留的是历史。</p>\n<p>作为一个手下数百名开发人员的大公司的产品经理，很难接受这个事实：他们可能已经错过了，几个极客在资源紧缺的条件下，成功完成的某个项目。所以他们通常不会（使用创业公司的 idea）。</p>\n<h3>6. 大公司并不大</h3>\n<p>大公司有很多部门，其中有些可能并不大。“<strong>但他们还是有大量资源</strong>”，没错，但是他们都有事情在做。而对于所需的实际技能，他们并没有。</p>\n<p>90 年代，我离开 IBM（当时已有 30 万名员工），加入了 Sybase（当时有 1500 名员工）。令我惊讶的是，后起之秀 Sybase（只做数据库）专注于数据库开发的员工数量是 IBM 的两倍，那时 IBM 还有除数据库之外的各种业务，甚至包括管理军用直升机的交付项目。之后，当我加入创业公司 Illustra（不到 80 名员工）时，我并不惊讶，而至今我们所拥有的 web 数据库专业知识，比 Informix、Oracle 和 Sybase 加起来都多。最后 Informix 付给了 Illustra 4 亿美元。</p>\n<h3>7. 时间就是金钱</h3>\n<p>究竟为什么 Facebook 不简单地复制 Instagram 的 24 人月的工作量，而是支付令人瞠目的 10 亿美元来收购呢？</p>\n<p>这不是对 13 名员工的人才收购。由于 Instragram 的 3000 万用户也都是 Facebook 的用户（那时有 8.45 亿用户），所以和市场份额也没关系。当然这更不是获得多少收入，因为 Instagram 没有钱，完全没有！</p>\n<p>原因是 Facebook 确信这是图片分享的未来，并且会使自家业务面临风险（因为简单来说，Facebook 实际上是和照片相关的应用）。对于以上列出的所有原因，他们明白至少需要 12 个月才能复制出来，到那时，占尽先机的大公司和初创企业之间的财富可能会有很大的逆转。购买而非构造意味着额外的收入，但是相当于并购公司现有的销售和营销渠道的水平，而不是创业公司的。这可以很容易地证明愚蠢的营收倍数，因为重点不是 Instagram 现在在做什么，而是 Facebook 会错过什么，你说是不是？当 Facebook 在 14 年第三季度几乎投了 30 亿美元时，却只为 Instagram 投了一个月的收入。鉴于现在 Instagram 对于 Facebook 价值主张的重要性，这看起来似乎赚到了。</p>\n<h2>专注于客户，而不是竞争</h2>\n<p>你不能指望一颗橡子就能长成一颗橡树。你首先需要准备一盘完整的幼苗，然后筛选剔除一些，最后专心培育其余的幼苗，期待至少有一颗苗子最后能长成橡树。这实际上正是 VC 模式的整个前提，这也是为什么大公司通常不会压制创业公司的原因，因为他们不知道哪个最终会超过他们，并且也不可能把那么多初创公司都扼杀。</p>\n<p>如同商业中所有的普遍规律一样，也有例外存在。总想着成为市场领导者一向不会有什么好结果，但应该明白以上这些规律。虽然总体规则很明确。几乎没有哪家初创公司会因为试图取代占尽先机者而面临风险，更大的风险是：<strong>你的产品在市场上是否有容身之处</strong>。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111721\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111721votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111721\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/TJQ\">佟大冬</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/TJQ\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2017/05/5f8b3a74725397a8f5033c9ac0afeefb.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            live and learn.        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/TJQ\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/tjq/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/TJQ/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 11</a> · <a title=\"QQ：601591123\" target=\"_blank\" href=\"#\"><i class=\"fa fa-qq\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "走近比特币：一个故事看懂“区块链”", "url": "http://blog.jobbole.com/111768/", "url_object_id": "b727b9066b0e290ea3a28731fb346c13", "create_date": "2017/07/10 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/07/9b36ef38a61d648c3160895636320231.png"], "praise_nums": "3", "comment_nums": 0, "fav_nums": 11, "tags": "IT技术,区块链,比特币", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://thenextweb.com/contributors/2017/07/04/ultimate-3500-word-plain-english-guide-blockchain/#.tnw_M8YLXnfv\">Mohit Mamoria</a>   译文出处：<a target=\"_blank\" href=\"http://www.4hou.com/info/news/6152.html\">赛博朔方</a>   </div><p>区块链是比特币的底层技术和基础架构，本质上是一个去中心化的数据库。区块链是一串使用密码学方法相关联产生的数据块，每一个数据块中包含了一次比特币网络交易的信息，用于验证其信息的有效性（防伪）并生成下一个区块。</p>\n<p>狭义来讲，区块链是一种按照时间顺序将数据区块以顺序相连的方式组合成的一 种链式数据结构， 并以密码学方式保证的不可篡改和不可伪造的分布式账本。</p>\n<p>以上定义摘自百度百科。很多菜鸟朋友看完这段解释依然满脸懵逼，到底什么是“区块链”？</p>\n<p><strong>起因</strong></p>\n<p>除非你完全没有接触过信息安全，否则一定听说过比特币和区块链。毕竟这两个名词也是近两年来各大国内外媒体争相报道的热词。尤其是继今年5月爆发的WannaCry病毒爆发以后，很多从未接触过的人都开始加入讨论大军。</p>\n<p>我的很多朋友都不懂技术。最近几周他们一个个都变身好奇宝宝，围着我问比特币和区块链。我想这两个名词的热度一定还会持续攀高，对他们不够了解的人也还有很多很多。何不采用通俗的语言对“区块链”做一个解释，把这个概念传播开来？</p>\n<p>和网上一般的名词解释不同（不管三七二十一，下个定义再说，其实并没有什么卵用），我们以它的作用为切入点来理解区块链的工作机制。</p>\n<p><strong>故事的开端</strong></p>\n<p>Joe是你最好的朋友。他出国旅游后的第五天给你打了个电话：“兄弟，我需要点钱，出国之后把身上的钱都花完了。”</p>\n<p>你回复：“我马上打过来”，然后挂了电话。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/9b36ef38a61d648c3160895636320231.png\"><img class=\"aligncenter wp-image-111770 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9b36ef38a61d648c3160895636320231.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>接着你又打电话给你的银行客户经理：“麻烦你马上从我的账户转1000美元给Joe。”</p>\n<p>客户经理：“好的，明白。”</p>\n<p>客户经理随后确认了你的账户是否有足够的余额。因为你是百万富翁，所以客户经理进行了如下的操作：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/01ba164bb2faac9366790f480929ba0d.png\"><img class=\"aligncenter wp-image-111771 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/01ba164bb2faac9366790f480929ba0d.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>交易账单</p>\n<p>你打电话给Joe说你已经把1000美元转过去了。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/63a42b41972d79baeb70657d8fa43e4d.png\"><img class=\"aligncenter wp-image-111772 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/63a42b41972d79baeb70657d8fa43e4d.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>回头我们再来看看刚刚到底发生了什么。你和Joe都信任那家银行来管理你们各自的财产。整个过程中实际并没有真实货币的物理流动。整个过程只涉及录入系统的两个账户即可。更准确地说，全程只需主动权属于该银行的两个账户就可以完成。</p>\n<p>在这样传统的货币体系中，我的问题就来了。</p>\n<p>交易双方的信任机制建立需要借助第三方。这种“中间人”的方式由来已久。那么你可能又要问了：“这种信任机制有什么问题吗？”问题在于除交易双方以外的“监督者”只是单个个体。这种情况可能存在以下风险：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c15834a9b7578315757\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n如果有人有意或无意地摧毁了某个人或某个第三方组织机构就可能足以引起社会混乱。\r\n如果记录了某个交易的注册表遭遇火灾怎么办？\r\n万一你的客户经理不小心划了1500美元到你朋友的账户怎么办？\r\n如果他是故意这么做的呢？</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c15834a9b7578315757-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c15834a9b7578315757-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c15834a9b7578315757-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c15834a9b7578315757-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c15834a9b7578315757-1\">如果有人有意或无意地摧毁了某个人或某个第三方组织机构就可能足以引起社会混乱。</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c15834a9b7578315757-2\">如果记录了某个交易的注册表遭遇火灾怎么办？</div><div class=\"crayon-line\" id=\"crayon-596c15834a9b7578315757-3\">万一你的客户经理不小心划了<span class=\"crayon-cn\">1500</span>美元到你朋友的账户怎么办？</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c15834a9b7578315757-4\">如果他是故意这么做的呢？</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>世界上有没有无需借助银行就能帮助我们完成安全转账的系统？</p>\n<p>要想解决这个问题，我们首先应该静下心来好好思考，问自己一个更深层次的问题：我们能不能自己掌握账户和历史交易的信息呢？</p>\n<p>这的确是一个值得探讨的问题。答案当然你一定也已经猜到了——那就是“区块链”。现在我们就开始学习这个分布式账本是如何运作的。</p>\n<p><strong>故事的发展</strong></p>\n<p>该方法得以实行的必要条件是必须有足够多的人愿意在交易时不依赖于第三方。只有这样，这一部分的人才能够自己掌控账本资料。</p>\n<p>那么人数要达到多少才足够呢？在下面的例子中，我们假设有10个人愿意放弃银行或其它任何第三方机构。在双方达成协议的前提下，他们互相之间能够在不知道对方身份的情况下时刻掌握对方账户的一切信息和动态。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/9c3b01673d22d6a83ed4ab9a6ec0f20b.png\"><img class=\"aligncenter wp-image-111773 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9c3b01673d22d6a83ed4ab9a6ec0f20b.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>1. 一个空文件夹</p>\n<p>一开始每个人都会获得一个空文件夹。随着时间推进，这十个人都会在他们现在空的文件夹里不断添加记录交易信息的纸张。</p>\n<p>2. 交易发生时</p>\n<p>接下来，这个交易网络中的每个人都带着纸和笔坐下来，准备记录下在这个系统中发生的每一笔交易。</p>\n<p>假设，2号想给9号10美元。</p>\n<p>为了完成这笔交易，2号大声地告诉每个人：“我要转10美元给9号。请大家都在自己的纸上记下来。”</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/81b4ecaa4773d202ad3bfbecd6a37b70.png\"><img class=\"aligncenter wp-image-111774 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/81b4ecaa4773d202ad3bfbecd6a37b70.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>然后每个人都检查确认2号是不是有10美元及以上的余额能够转给9。如2号余额足够，那么大家都在空白纸上记录下这笔交易。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/1183d1ddac95cb55be40dd6f13215cf4.png\"><img class=\"aligncenter wp-image-111775 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/1183d1ddac95cb55be40dd6f13215cf4.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>纸上的第一笔交易</p>\n<p>这笔交易这样就算完成了。</p>\n<p>3. 持续发生的交易</p>\n<p>随着时间的流逝，这个交易网络中出现交易需求的人越来越多。无论何时他们产生交易需求，都会通知网络中的每个人。只要有人听到了这个通知，他/她就会在他们各自的纸上记录下来。</p>\n<p>这个过程会持续进行，直到这张纸上的空间不足。假设每张纸只能记录10次交易，那么只要第10次交易完成，每个人纸上的空间也就随之耗尽。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/5bd3935a377f1251c6165091f6270aa6.png\"><img class=\"aligncenter wp-image-111776 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/5bd3935a377f1251c6165091f6270aa6.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>当白纸被填满</p>\n<p>这时候我们就需要把这张纸放进文件夹并拿出另一张新的白纸，重复上面步骤2的过程。</p>\n<p>4. 把纸张放进文件夹的注意点</p>\n<p>在把纸张放进文件夹之前，我们需要对这张纸用网络中每个人都认可的专有密钥进行密封。但是密封后我们要确保的是，这张纸就只能尘封在文件夹里，无论是谁无论何时都不能对其作任何修改。并且如果每个人都相信这个“封印”，那么也就意味着每个人都绝对信任这张纸上的内容。这种密封方式也是区块链的关键所在。</p>\n<p>以前第三方或中间人都会说服我们相信无论他们在注册表中记录了什么，里面的内容都不会发生改变。但在现在这个分布式的、去中心化的系统中，这个印章（密钥）就为我们建立了这种信任机制。</p>\n<p><strong>故事的高潮 （一）</strong></p>\n<p>新的问题又来了。我们应该如何密封这张纸？</p>\n<p>在学习如何密封之前，我们先来了解印章的工作原理。</p>\n<p>假设我们现在有一个机器，如果你把一个里面装着东西的盒子从左边放进去，这个魔法机器会从右边吐出一个装着其它东西的盒子。</p>\n<p>【术语解析】这个机器实际叫作“哈希函数”，但是今天我们不讨论技术。所以我们暂且称它为“魔法机器”。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/6e3f892be4247730976be45fb1f1e270.png\"><img class=\"aligncenter wp-image-111777 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/6e3f892be4247730976be45fb1f1e270.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>魔法机器（即哈希函数）</p>\n<p>如果我们把装有数字4的盒子从左边放进去，它会从右边给出下列字符：dcbea。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/7f0d5928f1188ea21c9480dcff258578.png\"><img class=\"aligncenter wp-image-111778 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/7f0d5928f1188ea21c9480dcff258578.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>如果已知条件是输出结果为“dcbea”，要想知道从左边输入的是什么非常困难。但是每次如果你把4放进去，最终的输出结果“dcbea”是肯定的。</p>\n<p>我们来试试发送其它数字。如果放入26会得到什么呢？</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/1e6ae033a33080a677a6191ea391e5f0.png\"><img class=\"aligncenter wp-image-111779 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/1e6ae033a33080a677a6191ea391e5f0.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>哈希（26）=94c8e</p>\n<p>这次我们得到的是“94c8e”。从26的输出结果来看，结果也可以包含数字。</p>\n<p>了解到这儿，我们可以开始思考下一个更加深入的问题了：</p>\n<p>“如果我想从右边得到一个以3个零为开头的结果（如000ab、00098、000fa等），那么我应该从机器的左边放入什么内容？”</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/0b5094d27681e08d4fd51ff4fe96457f.png\"><img class=\"aligncenter wp-image-111780 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0b5094d27681e08d4fd51ff4fe96457f.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>预测输入的内容</p>\n<p>这个机器有一个单向性的属性：给出右边的预期结果后，我们无法计算出左边放入的内容。那是不是意味着这个问题无解？倒也未必。</p>\n<p>我能想到一种方法——把每个数字都输入一遍，直到机器输出以3个零为开头的结果。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/f8de38b5d93b04da9c1cef1bf1857e6c.png\"><img class=\"aligncenter wp-image-111781 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/f8de38b5d93b04da9c1cef1bf1857e6c.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>把每个数字都尝试一遍</p>\n<p>有耐心的人试上几千次可能也就找到了这个符合我们输出要求的数字。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/772ab83f8b259605193ef6eafda2b66e.png\"><img class=\"aligncenter wp-image-111782 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/772ab83f8b259605193ef6eafda2b66e.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>通过输出结果来获得输入数字这种逆向计算的确非常困难。但是如果我们得到了预测的输入内容，验证该输入是否能得出我们想要的结果就非常非常容易了。记住，这个机器最大的特点就是每个结果只对应一个数字，绝无例外的“一夫一妻制”。</p>\n<p>如果我给你72533这个数字，然后问你：“这个数字输入魔法机器后会不会输出以3个零为开头的结果？”这个问题就简单到简直在侮辱我们的智商了。</p>\n<p>因此这个机器最最最重要的属性是——知道结果，要想算出输出非常困难，但是如果我们知道输入的数字和输出结果，验证两者是否匹配很简单。</p>\n<p><strong>如何利用这个机器密封纸张？</strong></p>\n<p>怎样利用魔法机器生成每张纸独有的封印？还是老办法，采用情境模拟的方法展开解释。</p>\n<p>假设我给了你两个盒子。第一个盒子里面有数字20893，你能不能想出一个数字，这个数字与第一个盒子里的数字相加后的结果放入魔法机器后，我们能够得到一个以3个零为开头的字符结果。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/21d6fade61921245e50fb1a30147c031.png\"><img class=\"aligncenter wp-image-111783 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/21d6fade61921245e50fb1a30147c031.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>这个情景和之前的难题几乎相同。唯一的办法就是把每个数字都放入机器尝试一遍。</p>\n<p>经过几千次的尝试，我们会在21191这个数字这里停下，21191+20893=42084，把42084放入这个机器后所得到的结果正是我们想要的。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/449e0679475edf81e6cbfc2a763db20d.png\"><img class=\"aligncenter wp-image-111784 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/449e0679475edf81e6cbfc2a763db20d.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>在这个案例中，21191这个数字就是20893这个数字的“封印”。假设有张纸上写着20893这个数字。为了密封这张纸（即没有人能够再对其内容作改动），我们把带有21191标签的徽章贴在纸上，密封完成。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/c01dc72fb256585c8432e1ca563ec34a.png\"><img class=\"aligncenter wp-image-111785 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c01dc72fb256585c8432e1ca563ec34a.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>被密封的数字</p>\n<p>【术语解析】用来密封的数字实际被称为“工作证明（Proof Of Work）”，因为这个数字是通过努力计算得来的。本文为了简单易懂，我们称它为“密封数字”。</p>\n<p>无论谁想验证这个页面是否被改动过，只要把页面上的内容与密封号码叠加后放入魔法机器。如果机器输出的内容是以3个零为开头的，那么该页面内容是没有被“污染”过的。但如果结果不满足这个特点，我们就应果断丢弃这个页面，因为上面的内容已经被改动、已经失效。</p>\n<p><strong>密封过程总结</strong></p>\n<p>要想密封记录整个交易网络中交易流水的页面，我们需要找到那个加入交易内容并输入机器后会得到以3个零为开头的字符的关键数字。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/acf9c1fe14e240e49751ed7852fcdaa1.png\"><img class=\"aligncenter wp-image-111786 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/acf9c1fe14e240e49751ed7852fcdaa1.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>注意：“以3个零为开头的字符”只是一个举例，简单地反应哈希函数的工作原理。实际问题处理起来会复杂得多。</p>\n<p>只要花费一定的时间，交易网络中的参与者就能够计算出这个数字，该页面也就随之密封。一旦有人更改了页面上的内容，任何人都能够通过这个密封号码来验证这个页面的完整性。</p>\n<p><strong>故事的高潮（二）</strong></p>\n<p>了解如何密封页面后，我们再把思绪拉回10个人用完了一张纸上所有空间的时候。</p>\n<p>当这个页面上记不下更多的交易记录时，交易网络中的每个人都会停下来计算该页面的密封数字，然后将其放入文件夹。如果第一个人算好了密封数字，他就会向所有人公布。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/a3985de89845392cf48ab2239b4615ea.png\"><img class=\"aligncenter wp-image-111787 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a3985de89845392cf48ab2239b4615ea.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>听到密封号码后，大家都去验证这个数字是否能满足输出需求。如是，则在他们的页面上贴上这个标签，再把这个页面放进文件夹。</p>\n<p>但是如果7号算出了密封号码并“昭告了天下”，但结果大家发现这个数字并不满足他们的输出需求怎么办？这样的情况也很常见。原因可能有以下几点：</p>\n<p>1. 公布交易信息时听错了；</p>\n<p>2. 记录交易信息时出现笔误；</p>\n<p>3. 为了一己之利，记录交易时故意犯错。</p>\n<p>不管出于什么原因，7号只有一种选择——丢弃自己这张纸，然后从别人那里复制一份副本放进他自己的文件夹。如果不把这个页面放进文件夹，他就不能继续记录接下来的交易记录，这也就相当于把他从这个交易网络中踢掉了。</p>\n<p>说到这里，我相信有的人脑海里又出现了一个疑惑：既然有人计算好密封号码后会公布，为什么我们每个人还要花费那么多时间都去计算一遍？其他人为什么不歇着、坐等公布？</p>\n<p>Good question!区块链包含特殊的奖励机制，网络中每个人都有资格获得奖励。第一个计算出密封号码的人能够获得一定奖励。</p>\n<p>我们再来简单地假设一下，如果5号第一个算出了页面的密封号码，并获得了1美元的金额奖励，那么这1美元就是凭空出现的。换句话说，假如他账户里本来余额5美元，现在增加了1元，但是这1元没有从其它任何人的账户里扣除，即没有减少任何人的账户余额。</p>\n<p>这就是比特币的起源。它是在区块链（分布式账目）上发生交易的第一种货币。如果在这个交易网络上持续努力，你同样也能获得回报，这个过程就是我们所说的“挖矿”。</p>\n<p>拥有比特币的人越来越多，这些人一刻不闲着地开始炒这种虚拟货币，不断扩大市场对比特币的需求，再进一步提高比特币的价值。就这样周而复始地把比特币的价格炒得很高。</p>\n<p>这种奖励机制让交易网络中的每个人都勤勤恳恳地劳作。</p>\n<p>他们把纸张放进文件夹后，拿出一张新的空白纸张，然后再次重复前面的过程——循环往复、永无止境。</p>\n<p>假设文件夹中已经有5个被密封的页面。如果我为了谋取私利修改了第二个页面的其中一笔交易会发生什么？前面已经提到过，所有人都可以通过密封号码查出交易内容已经发生改变。但是如果我根据修改的内容重新计算密封号码，然后把新号码贴在纸上，出现这样的情况怎么办？</p>\n<p>为了防止有人同时修改页面和密封号码，计算密封号码时有一个小技巧。</p>\n<p><strong>如何防止密封号码被重新计算、更改？</strong></p>\n<p>还记得之前我假设你有两个盒子，一个包含20893这个数字，一个是用于计算的空盒子吗？在区块链中计算密封号码，实际上存在三个盒子，而不是两个，其中两个是有内容的，一个是待计算填充的。</p>\n<p>当三个盒子的内容都填好放入机器后，机器右边输出的结果能够满足我们的需求。</p>\n<p>一个盒子里是交易记录、一个盒子是密封号码，第三个盒子是通过哈希函数计算出来的前一页的输出结果。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/e21b6b9e3ecaf688e7062ac64e85e53c.png\"><img class=\"aligncenter wp-image-111788 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e21b6b9e3ecaf688e7062ac64e85e53c.png\" alt=\"1\" width=\"800\" height=\"800\"></a></p>\n<p>通过这个小技巧，我们能够确保每一页的密封号码都与前一页的内容相关联。因此如果有人修改了历史页面的内容，他需要改动接下来每一页的密封号码，从而保证整个链路的一致性。</p>\n<p>我们假设十个人中有一个人想要恶意修改区块链中的内容（包含记录了交易历史页面的文件夹），那么他需要调整很多页面，计算改动页面之后所有页面的密封号码。我们都知道计算密封号码的工作非常困难。因此，整个交易网络中的一个叛徒最终还是会输个剩下的9个好人。</p>\n<p>从这个叛徒想要更改内容的页面开始，他就需要在整个网络中创建另一个区块链，但是这个区块链几乎不可能赶上好人们创建的链路——一个人的力量赶不上剩下9个人的共同努力。因此，有一点非常明确，区块链规模越大，安全性和可信度越高。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/0cccd45985994d1e22ee95332fe1fb1c.png\"><img class=\"aligncenter wp-image-111789 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0cccd45985994d1e22ee95332fe1fb1c.png\" alt=\"1\" width=\"1000\" height=\"637\"></a></p>\n<p>但是如果10个人中有6个人都叛变了怎么办？</p>\n<p>如果出现这样的情况，这个协议就有点打脸了。这种情况被称为“51%攻击”。如果整个网络中的大多数人都决定叛变，欺骗剩下不到半数的人，那么整个协议就自然而然地走向了灭亡。</p>\n<p>这是区块链最大的弱点。尽管这样的情况不可能出现，但我们还是要谨记这个系统的弱点。整个体系都是基于一个假设：整个交易网络中的大多数人都不会叛变。</p>\n<p><strong>结 局</strong></p>\n<p>解释到这里也就差不多了。还请亲爱的们再回头看看百度百科给出的定义，现在是不是理解起来容易很多了？</p>\n<p>如果还有人问起到底什么是区块链，比特币的运作机制是怎样的，我相信本文的读者都能够解释给更多的小白们听啦。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111768\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111768votetotal\">3</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111768\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 11 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "人人都能读懂的设计模式（3）：行为型模式", "url": "http://blog.jobbole.com/111797/", "url_object_id": "cc276802ec74b5c8ad50fe746800ea7f", "create_date": "2017/07/17 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/03/ef9bd8829d4a02c071feb1af9522d6ab.png"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 0, "tags": "IT技术,设计模式", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/justin_ygg\">Justin_YGG</a> 翻译。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://github.com/kamranahmedse/design-patterns-for-humans/blob/master/README.md#behavioral-design-patterns\">kamranahmedse</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>用最简单的语言，解释设计模式。</p>\n<p>虽然示例代码是用 PHP7 实现的，但因为概念是一样的，所以语言并不会阻碍大家理解设计模式。</p>\n<ul>\n<li>《<a href=\"http://blog.jobbole.com/111799/\" target=\"_blank\">人人都能读懂的设计模式（1）：创建型模式</a>》</li>\n<li>《<a href=\"http://blog.jobbole.com/111798/\" target=\"_blank\">人人都能读懂的设计模式（2）：结构型模式</a>》</li>\n</ul>\n<h3>概述</h3>\n<p>行为型设计模式关心对象之间的责任分配。与结构型设计模式不同的是，行为型设计模式不仅仅指定结构，而且还概述了它们之间的消息传递/通信的模式。或者换句话说，行为型模式帮助回答了“软件组件是如何运行的？”</p>\n<h3>维基百科</h3>\n<p>在软件工程中，行为型设计模式为设计模式的一种类型，用来识别对象之间的常用交流模式并加以实现。如此，可以在交流时增强灵活性。</p>\n<p><strong>分类</strong></p>\n<ul>\n<li>责任链模式</li>\n<li>命令模式</li>\n<li>迭代器模式</li>\n<li>中介者模式</li>\n<li>备忘录模式</li>\n<li>观察者模式</li>\n<li>访问者模式</li>\n<li>策略模式</li>\n<li>状态模式</li>\n<li>模板方法模式</li>\n</ul>\n<h3>🔗 责任链模式</h3>\n<h4>现实生活示例</h4>\n<p>例如，你的帐户中有三种付款方式（A，B 和 C）; 每种方式付款额不同。 A 可支付 100 美元，B 可支付 300 美元，C 可支付 1000 美元，支付的优先级为 A-&gt;B-&gt;C。现在想要购买价值 210 美元的东西。使用责任链模式，首先将检查帐户 A 是否可以进行购买，如果可以购买，链条将被破坏。如果不能购买，将继续检查账号 B 是否可以购买，如果可以购买，链条将被破坏，否则请求将继续转发，直到找到合适的处理程序。这里的 A、B 和 C 就是责任链的链条，整个现象就是责任链模式。</p>\n<h4>概述</h4>\n<p>责任链模式有助于建立一个对象链。请求从一端进入，在对象之间转发，直到找到合适的处理程序。</p>\n<h4>维基百科</h4>\n<p>责任链模式是面向对象程序设计的一种软件设计模式，它包含了一些命令对象和一系列的处理对象。每一个处理对象决定它能处理哪些命令对象，不能处理的命令对象传递给该链中的下一个处理对象。</p>\n<p><strong>程序示例</strong></p>\n<p>以上面的支付账号为例，首先给出账户基类，包含链接账号的逻辑以及一些不同类型的账户</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a43299056657\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nabstract class Account\r\n{\r\n    protected $successor;\r\n    protected $balance;\r\n\r\n    public function setNext(Account $account)\r\n    {\r\n        $this-&gt;successor = $account;\r\n    }\r\n\r\n    public function pay(float $amountToPay)\r\n    {\r\n        if ($this-&gt;canPay($amountToPay)) {\r\n            echo sprintf('Paid %s using %s' . PHP_EOL, $amountToPay, get_called_class());\r\n        } elseif ($this-&gt;successor) {\r\n            echo sprintf('Cannot pay using %s. Proceeding ..' . PHP_EOL, get_called_class());\r\n            $this-&gt;successor-&gt;pay($amountToPay);\r\n        } else {\r\n            throw new Exception('None of the accounts have enough balance');\r\n        }\r\n    }\r\n\r\n    public function canPay($amount): bool\r\n    {\r\n        return $this-&gt;balance &gt;= $amount;\r\n    }\r\n}\r\n\r\nclass Bank extends Account\r\n{\r\n    protected $balance;\r\n\r\n    public function __construct(float $balance)\r\n    {\r\n        $this-&gt;balance = $balance;\r\n    }\r\n}\r\n\r\nclass Paypal extends Account\r\n{\r\n    protected $balance;\r\n\r\n    public function __construct(float $balance)\r\n    {\r\n        $this-&gt;balance = $balance;\r\n    }\r\n}\r\n\r\nclass Bitcoin extends Account\r\n{\r\n    protected $balance;\r\n\r\n    public function __construct(float $balance)\r\n    {\r\n        $this-&gt;balance = $balance;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a43299056657-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a43299056657-57\">57</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-1\"><span class=\"crayon-m\">abstract</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Account</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">successor</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">balance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">setNext</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Account</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">account</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">successor</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">account</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-10\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">pay</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">amountToPay</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">canPay</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">amountToPay</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-14\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">echo </span><span class=\"crayon-e\">sprintf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Paid %s using %s'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PHP_EOL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">amountToPay</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_called_class</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">elseif</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">successor</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">echo </span><span class=\"crayon-e\">sprintf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Cannot pay using %s. Proceeding ..'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PHP_EOL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_called_class</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-17\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">successor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">pay</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">amountToPay</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-19\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">throw</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Exception</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'None of the accounts have enough balance'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-22\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">canPay</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">amount</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">bool</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">balance</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">amount</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-27\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-28\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-29\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Bank</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">extends</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Account</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-30\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">balance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-32\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-33\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">balance</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">balance</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">balance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-36\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-37\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-38\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-39\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Paypal</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">extends</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Account</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-40\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">balance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-42\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-43\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">balance</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-44\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-45\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">balance</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">balance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-46\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-47\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-48\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-49\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Bitcoin</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">extends</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Account</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-50\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-51\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">balance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-52\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-53\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">balance</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-54\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-55\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">balance</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">balance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a43299056657-56\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a43299056657-57\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0061 seconds] -->\r\n<p>然后通过上面定义的链接（即 Bank, Paypal, Bitcoin）形成责任链</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a4e244566926\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n// Let's prepare a chain like below\r\n//      $bank-&gt;$paypal-&gt;$bitcoin\r\n//\r\n// First priority bank\r\n//      If bank can't pay then paypal\r\n//      If paypal can't pay then bit coin\r\n\r\n$bank = new Bank(100);          // Bank with balance 100\r\n$paypal = new Paypal(200);      // Paypal with balance 200\r\n$bitcoin = new Bitcoin(300);    // Bitcoin with balance 300\r\n\r\n$bank-&gt;setNext($paypal);\r\n$paypal-&gt;setNext($bitcoin);\r\n\r\n// Let's try to pay using the first priority i.e. bank\r\n$bank-&gt;pay(259);\r\n\r\n// Output will be\r\n// ==============\r\n// Cannot pay using bank. Proceeding ..\r\n// Cannot pay using paypal. Proceeding ..:\r\n// Paid 259 using Bitcoin!</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a4e244566926-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a4e244566926-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a4e244566926-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a4e244566926-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a4e244566926-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a4e244566926-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a4e244566926-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a4e244566926-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a4e244566926-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a4e244566926-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a4e244566926-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a4e244566926-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a4e244566926-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a4e244566926-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a4e244566926-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a4e244566926-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a4e244566926-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a4e244566926-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a4e244566926-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a4e244566926-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a4e244566926-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a4e244566926-22\">22</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a4e244566926-1\"><span class=\"crayon-c\">// Let's prepare a chain like below</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a4e244566926-2\"><span class=\"crayon-c\">//      $bank-&gt;$paypal-&gt;$bitcoin</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a4e244566926-3\"><span class=\"crayon-c\">//</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a4e244566926-4\"><span class=\"crayon-c\">// First priority bank</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a4e244566926-5\"><span class=\"crayon-c\">//      If bank can't pay then paypal</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a4e244566926-6\"><span class=\"crayon-c\">//      If paypal can't pay then bit coin</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a4e244566926-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a4e244566926-8\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bank</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Bank</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">100</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">          </span><span class=\"crayon-c\">// Bank with balance 100</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a4e244566926-9\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">paypal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Paypal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">      </span><span class=\"crayon-c\">// Paypal with balance 200</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a4e244566926-10\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bitcoin</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Bitcoin</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">300</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span><span class=\"crayon-c\">// Bitcoin with balance 300</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a4e244566926-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a4e244566926-12\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bank</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">setNext</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">paypal</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a4e244566926-13\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">paypal</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">setNext</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bitcoin</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a4e244566926-14\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a4e244566926-15\"><span class=\"crayon-c\">// Let's try to pay using the first priority i.e. bank</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a4e244566926-16\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bank</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">pay</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">259</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a4e244566926-17\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a4e244566926-18\"><span class=\"crayon-c\">// Output will be</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a4e244566926-19\"><span class=\"crayon-c\">// ==============</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a4e244566926-20\"><span class=\"crayon-c\">// Cannot pay using bank. Proceeding ..</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a4e244566926-21\"><span class=\"crayon-c\">// Cannot pay using paypal. Proceeding ..:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a4e244566926-22\"><span class=\"crayon-c\">// Paid 259 using Bitcoin!</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0018 seconds] -->\r\n<p></p>\n<h3>👮 命令模式</h3>\n<h4>现实生活示例</h4>\n<p>一个典型的例子是你在餐厅点菜，你（即客户）向服务员（即 Invoker）点餐（即命令），服务员只需将需求转达给会烹饪的厨师。 另外一个例子是你（即客户端）使用遥控器（Invoker）打开（即命令）电视机（即接收器）。</p>\n<h4>概述</h4>\n<p>命令模式允许将操作封装在对象中，其背后的关键思想是提供客户端与接收器分离的方法。</p>\n<h4>维基百科</h4>\n<p>在面向对象程序设计的范畴中，命令模式是一种行为型设计模式。将所有需要的信息封装到对象中，用于之后的动作（action）或者事件触发。被封装的信息包括方法名以及拥有方法及参数的对象。</p>\n<p><strong>程序示例</strong></p>\n<p>首先给出一个接收器，实现了可能会执行的动作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a53108767175\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n// Receiver\r\nclass Bulb\r\n{\r\n    public function turnOn()\r\n    {\r\n        echo \"Bulb has been lit\";\r\n    }\r\n\r\n    public function turnOff()\r\n    {\r\n        echo \"Darkness!\";\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a53108767175-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a53108767175-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a53108767175-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a53108767175-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a53108767175-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a53108767175-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a53108767175-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a53108767175-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a53108767175-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a53108767175-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a53108767175-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a53108767175-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a53108767175-13\">13</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a53108767175-1\"><span class=\"crayon-c\">// Receiver</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a53108767175-2\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Bulb</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a53108767175-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a53108767175-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">turnOn</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a53108767175-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a53108767175-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Bulb has been lit\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a53108767175-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a53108767175-8\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a53108767175-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">turnOff</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a53108767175-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a53108767175-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Darkness!\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a53108767175-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a53108767175-13\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>然后给出一个接口，（Bulb）中的每个命令都要实现这个接口，得到一组命令集：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a57710286614\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface Command\r\n{\r\n    public function execute();\r\n    public function undo();\r\n    public function redo();\r\n}\r\n\r\n// Command\r\nclass TurnOn implements Command\r\n{\r\n    protected $bulb;\r\n\r\n    public function __construct(Bulb $bulb)\r\n    {\r\n        $this-&gt;bulb = $bulb;\r\n    }\r\n\r\n    public function execute()\r\n    {\r\n        $this-&gt;bulb-&gt;turnOn();\r\n    }\r\n\r\n    public function undo()\r\n    {\r\n        $this-&gt;bulb-&gt;turnOff();\r\n    }\r\n\r\n    public function redo()\r\n    {\r\n        $this-&gt;execute();\r\n    }\r\n}\r\n\r\nclass TurnOff implements Command\r\n{\r\n    protected $bulb;\r\n\r\n    public function __construct(Bulb $bulb)\r\n    {\r\n        $this-&gt;bulb = $bulb;\r\n    }\r\n\r\n    public function execute()\r\n    {\r\n        $this-&gt;bulb-&gt;turnOff();\r\n    }\r\n\r\n    public function undo()\r\n    {\r\n        $this-&gt;bulb-&gt;turnOn();\r\n    }\r\n\r\n    public function redo()\r\n    {\r\n        $this-&gt;execute();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a57710286614-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a57710286614-57\">57</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Command</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">execute</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">undo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">redo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-8\"><span class=\"crayon-c\">// Command</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-9\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TurnOn</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Command</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-12\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Bulb</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-17\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">execute</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">turnOn</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-22\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">undo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">turnOff</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-27\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">redo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">execute</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-32\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-33\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-34\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TurnOff</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Command</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-35\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-36\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-37\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-38\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Bulb</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-39\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-40\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-42\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-43\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">execute</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-44\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-45\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">turnOff</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-46\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-47\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-48\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">undo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-49\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">turnOn</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-51\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-52\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-53\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">redo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-54\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-55\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">execute</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a57710286614-56\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a57710286614-57\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0049 seconds] -->\r\n<p>然后是Invoker，客户端将与之交互以处理各种命令：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a5a704176841\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n// Invoker\r\nclass RemoteControl\r\n{\r\n    public function submit(Command $command)\r\n    {\r\n        $command-&gt;execute();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a5a704176841-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a5a704176841-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a5a704176841-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a5a704176841-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a5a704176841-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a5a704176841-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a5a704176841-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a5a704176841-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a5a704176841-1\"><span class=\"crayon-c\">// Invoker</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a5a704176841-2\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RemoteControl</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a5a704176841-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a5a704176841-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">submit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Command</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">command</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a5a704176841-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a5a704176841-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">command</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">execute</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a5a704176841-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a5a704176841-8\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>最后来看一下如何在客户端中使用：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a5e569523164\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$bulb = new Bulb();\r\n\r\n$turnOn = new TurnOn($bulb);\r\n$turnOff = new TurnOff($bulb);\r\n\r\n$remote = new RemoteControl();\r\n$remote-&gt;submit($turnOn); // Bulb has been lit!\r\n$remote-&gt;submit($turnOff); // Darkness!</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a5e569523164-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a5e569523164-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a5e569523164-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a5e569523164-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a5e569523164-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a5e569523164-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a5e569523164-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a5e569523164-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a5e569523164-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Bulb</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a5e569523164-2\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a5e569523164-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">turnOn</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TurnOn</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a5e569523164-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">turnOff</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TurnOff</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">bulb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a5e569523164-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a5e569523164-6\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remote</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RemoteControl</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a5e569523164-7\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remote</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">submit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">turnOn</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Bulb has been lit!</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a5e569523164-8\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remote</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">submit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">turnOff</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Darkness!</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0015 seconds] -->\r\n<p>命令模式也可用于实现基于事务的系统。在执行命令时，需要持续保存命令的历史，如果最后一条命令成功执行，皆大欢喜，否则遍历历史记录，并对所有执行过的命执行<code>撤销</code>。</p>\n<h3>➿ 迭代器模式</h3>\n<h4>现实生活示例</h4>\n<p>老式的无线电设备将是一个很好的迭代器示例，用户可以在某个频道上启动，然后使用下一个或上一个按钮来切换频道。或者以 MP3 播放器或电视机为例，你可以按下一个按钮和上一个按钮进行连续的频道切换。换句话说，它们都提供了一个界面来遍历相应的频道，歌曲或广播电台。</p>\n<h4>概述</h4>\n<p>迭代器模式提供了一种方法，可以访问对象的元素而不暴露底层实现。</p>\n<h4>维基百科</h4>\n<p>在面向对象程序设计中，迭代器模式是一种设计模式，其中迭代器用于遍历容器并访问容器的元素。迭代器模式将算法与容器解耦; 在某些情况下，算法是特定容器必需的，因此不能解耦。</p>\n<p><strong>程序示例</strong></p>\n<p>通过PHP，使用 SPL（PHP标准库）可以轻松实现迭代器模式，以上述收音机为例，首先给出 <code>RadioStation</code> 类</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a61852622394\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass RadioStation\r\n{\r\n    protected $frequency;\r\n\r\n    public function __construct(float $frequency)\r\n    {\r\n        $this-&gt;frequency = $frequency;\r\n    }\r\n\r\n    public function getFrequency(): float\r\n    {\r\n        return $this-&gt;frequency;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a61852622394-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a61852622394-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a61852622394-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a61852622394-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a61852622394-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a61852622394-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a61852622394-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a61852622394-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a61852622394-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a61852622394-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a61852622394-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a61852622394-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a61852622394-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a61852622394-14\">14</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a61852622394-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RadioStation</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a61852622394-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a61852622394-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">frequency</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a61852622394-4\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a61852622394-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">frequency</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a61852622394-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a61852622394-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">frequency</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">frequency</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a61852622394-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a61852622394-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a61852622394-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getFrequency</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a61852622394-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a61852622394-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">frequency</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a61852622394-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a61852622394-14\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p>然后是 迭代器</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a65433805247\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nuse Countable;\r\nuse Iterator;\r\n\r\nclass StationList implements Countable, Iterator\r\n{\r\n    /** [@var](http://www.jobbole.com/members/variable) RadioStation[] $stations */\r\n    protected $stations = [];\r\n\r\n    /** [@var](http://www.jobbole.com/members/variable) int $counter */\r\n    protected $counter;\r\n\r\n    public function addStation(RadioStation $station)\r\n    {\r\n        $this-&gt;stations[] = $station;\r\n    }\r\n\r\n    public function removeStation(RadioStation $toRemove)\r\n    {\r\n        $toRemoveFrequency = $toRemove-&gt;getFrequency();\r\n        $this-&gt;stations = array_filter($this-&gt;stations, function (RadioStation $station) use ($toRemoveFrequency) {\r\n            return $station-&gt;getFrequency() !== $toRemoveFrequency;\r\n        });\r\n    }\r\n\r\n    public function count(): int\r\n    {\r\n        return count($this-&gt;stations);\r\n    }\r\n\r\n    public function current(): RadioStation\r\n    {\r\n        return $this-&gt;stations[$this-&gt;counter];\r\n    }\r\n\r\n    public function key()\r\n    {\r\n        return $this-&gt;counter;\r\n    }\r\n\r\n    public function next()\r\n    {\r\n        $this-&gt;counter++;\r\n    }\r\n\r\n    public function rewind()\r\n    {\r\n        $this-&gt;counter = 0;\r\n    }\r\n\r\n    public function valid(): bool\r\n    {\r\n        return isset($this-&gt;stations[$this-&gt;counter]);\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a65433805247-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a65433805247-54\">54</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-1\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Countable</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-2\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Iterator</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-4\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StationList </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Countable</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Iterator</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-5\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/** [@var](http://www.jobbole.com/members/variable) RadioStation[] $stations */</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">stations</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-8\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/** [@var](http://www.jobbole.com/members/variable) int $counter */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">counter</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">addStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">RadioStation</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">station</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">stations</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">station</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-16\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">removeStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">RadioStation</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">toRemove</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">toRemoveFrequency</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">toRemove</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getFrequency</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">stations</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">array_filter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">stations</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">RadioStation</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">station</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">toRemoveFrequency</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-21\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">station</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getFrequency</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!==</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">toRemoveFrequency</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-24\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">count</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">count</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">stations</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-29\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">current</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RadioStation</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">stations</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">counter</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-33\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-34\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">key</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-36\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-37\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">counter</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-38\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-39\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-40\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">next</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-42\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">counter</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-43\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-44\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-45\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">rewind</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-46\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-47\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">counter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-48\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-49\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-50\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">valid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">bool</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-51\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-52\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">isset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">stations</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">counter</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a65433805247-53\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a65433805247-54\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0059 seconds] -->\r\n<p>可以这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a69365369050\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$stationList = new StationList();\r\n\r\n$stationList-&gt;addStation(new RadioStation(89));\r\n$stationList-&gt;addStation(new RadioStation(101));\r\n$stationList-&gt;addStation(new RadioStation(102));\r\n$stationList-&gt;addStation(new RadioStation(103.2));\r\n\r\nforeach($stationList as $station) {\r\n    echo $station-&gt;getFrequency() . PHP_EOL;\r\n}\r\n\r\n$stationList-&gt;removeStation(new RadioStation(89)); // Will remove station 89</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a69365369050-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a69365369050-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a69365369050-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a69365369050-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a69365369050-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a69365369050-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a69365369050-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a69365369050-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a69365369050-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a69365369050-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a69365369050-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a69365369050-12\">12</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a69365369050-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">stationList</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StationList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a69365369050-2\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a69365369050-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">stationList</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">addStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RadioStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">89</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a69365369050-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">stationList</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">addStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RadioStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">101</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a69365369050-5\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">stationList</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">addStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RadioStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">102</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a69365369050-6\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">stationList</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">addStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RadioStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">103.2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a69365369050-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a69365369050-8\"><span class=\"crayon-st\">foreach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-e\">stationList </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">station</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a69365369050-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">station</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getFrequency</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PHP_EOL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a69365369050-10\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a69365369050-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a69365369050-12\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">stationList</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">removeStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RadioStation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">89</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Will remove station 89</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0022 seconds] -->\r\n<p></p>\n<h3>👽 中介者模式</h3>\n<h4>现实生活示例</h4>\n<p>典型的例子是你通过手机与他人通话，你与通话者之间有一个网络供应商，对话将通过供应商传递而非直接传递。这种情况下网络供应商就是中介者。</p>\n<h4>概述</h4>\n<p>中介者模式添加了第三方对象（称为中介者）来控制两个对象（称为 colleague）之间的交互。中介者模式有助于减少通信类之间的耦合，因为类之间无需知道对方的实现。</p>\n<h4>维基百科</h4>\n<p>在软件工程中，中介者模式包装了一系列对象相互作用的方式。这种模式被认为是一种行为模式，因为它可以改变程序的运行时行为。</p>\n<p><strong>程序示例</strong></p>\n<p>下面是一个最简单的用户（即 colleague）在聊天室（中介者）中互相发送消息的示例</p>\n<p>首先给出中介者及聊天室</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a6d044096697\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface ChatRoomMediator \r\n{\r\n    public function showMessage(User $user, string $message);\r\n}\r\n\r\n// Mediator\r\nclass ChatRoom implements ChatRoomMediator\r\n{\r\n    public function showMessage(User $user, string $message)\r\n    {\r\n        $time = date('M d, y H:i');\r\n        $sender = $user-&gt;getName();\r\n\r\n        echo $time . '[' . $sender . ']:' . $message;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a6d044096697-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a6d044096697-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a6d044096697-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a6d044096697-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a6d044096697-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a6d044096697-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a6d044096697-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a6d044096697-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a6d044096697-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a6d044096697-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a6d044096697-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a6d044096697-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a6d044096697-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a6d044096697-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a6d044096697-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a6d044096697-16\">16</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a6d044096697-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ChatRoomMediator</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a6d044096697-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a6d044096697-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">showMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">User</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a6d044096697-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a6d044096697-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a6d044096697-6\"><span class=\"crayon-c\">// Mediator</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a6d044096697-7\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ChatRoom</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ChatRoomMediator</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a6d044096697-8\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a6d044096697-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">showMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">User</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a6d044096697-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a6d044096697-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">time</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">date</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'M d, y H:i'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a6d044096697-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">sender</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a6d044096697-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a6d044096697-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">time</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'['</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">sender</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">']:'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a6d044096697-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a6d044096697-16\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0022 seconds] -->\r\n<p>然后是用户即 colleague</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a71434537238\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass User {\r\n    protected $name;\r\n    protected $chatMediator;\r\n\r\n    public function __construct(string $name, ChatRoomMediator $chatMediator) {\r\n        $this-&gt;name = $name;\r\n        $this-&gt;chatMediator = $chatMediator;\r\n    }\r\n\r\n    public function getName() {\r\n        return $this-&gt;name;\r\n    }\r\n\r\n    public function send($message) {\r\n        $this-&gt;chatMediator-&gt;showMessage($this, $message);\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a71434537238-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a71434537238-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a71434537238-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a71434537238-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a71434537238-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a71434537238-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a71434537238-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a71434537238-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a71434537238-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a71434537238-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a71434537238-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a71434537238-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a71434537238-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a71434537238-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a71434537238-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a71434537238-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a71434537238-17\">17</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a71434537238-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">User</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a71434537238-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a71434537238-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">chatMediator</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a71434537238-4\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a71434537238-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">ChatRoomMediator</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">chatMediator</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a71434537238-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a71434537238-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">chatMediator</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">chatMediator</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a71434537238-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a71434537238-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a71434537238-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a71434537238-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a71434537238-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a71434537238-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a71434537238-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">send</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a71434537238-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">chatMediator</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">showMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a71434537238-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a71434537238-17\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0024 seconds] -->\r\n<p>用法</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a74968747753\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$mediator = new ChatRoom();\r\n\r\n$john = new User('John Doe', $mediator);\r\n$jane = new User('Jane Doe', $mediator);\r\n\r\n$john-&gt;send('Hi there!');\r\n$jane-&gt;send('Hey!');\r\n\r\n// Output will be\r\n// Feb 14, 10:58 [John]: Hi there!\r\n// Feb 14, 10:58 [Jane]: Hey!</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a74968747753-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a74968747753-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a74968747753-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a74968747753-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a74968747753-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a74968747753-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a74968747753-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a74968747753-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a74968747753-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a74968747753-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a74968747753-11\">11</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a74968747753-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">mediator</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ChatRoom</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a74968747753-2\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a74968747753-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">john</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">User</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'John Doe'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">mediator</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a74968747753-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jane</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">User</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Jane Doe'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">mediator</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a74968747753-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a74968747753-6\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">john</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">send</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Hi there!'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a74968747753-7\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jane</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">send</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Hey!'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a74968747753-8\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a74968747753-9\"><span class=\"crayon-c\">// Output will be</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a74968747753-10\"><span class=\"crayon-c\">// Feb 14, 10:58 [John]: Hi there!</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a74968747753-11\"><span class=\"crayon-c\">// Feb 14, 10:58 [Jane]: Hey!</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p></p>\n<h3>💾 备忘录模式</h3>\n<h4>现实生活示例</h4>\n<p>以计算器（即发起者）为例，每当执行一些计算时，最后一次计算结果将保存在内存中（即备忘录），以便数据可以恢复，也可以使用某些操作按钮（即临时代理）来恢复数据。</p>\n<h4>概述</h4>\n<p>备忘录模式以一种稍后可平滑恢复的方式捕捉并存储对象的当前状态。</p>\n<h4>维基百科</h4>\n<p>备忘录模式是一种软件设计模式，可以将对象恢复到之前的状态（通过回滚来撤销）</p>\n<p>需要提供撤销操作时，备忘录模式通常很有用。</p>\n<p><strong>程序示例</strong></p>\n<p>首先给出可以存储编辑器状态的备忘录对象</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a78085092517\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass EditorMemento\r\n{\r\n    protected $content;\r\n\r\n    public function __construct(string $content)\r\n    {\r\n        $this-&gt;content = $content;\r\n    }\r\n\r\n    public function getContent()\r\n    {\r\n        return $this-&gt;content;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a78085092517-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a78085092517-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a78085092517-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a78085092517-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a78085092517-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a78085092517-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a78085092517-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a78085092517-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a78085092517-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a78085092517-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a78085092517-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a78085092517-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a78085092517-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a78085092517-14\">14</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a78085092517-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">EditorMemento</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a78085092517-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a78085092517-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a78085092517-4\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a78085092517-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a78085092517-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a78085092517-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">content</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a78085092517-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a78085092517-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a78085092517-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getContent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a78085092517-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a78085092517-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a78085092517-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a78085092517-14\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p>然后是使用备忘录对象的编辑器及发起者</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a7b414143005\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass Editor\r\n{\r\n    protected $content = '';\r\n\r\n    public function type(string $words)\r\n    {\r\n        $this-&gt;content = $this-&gt;content . ' ' . $words;\r\n    }\r\n\r\n    public function getContent()\r\n    {\r\n        return $this-&gt;content;\r\n    }\r\n\r\n    public function save()\r\n    {\r\n        return new EditorMemento($this-&gt;content);\r\n    }\r\n\r\n    public function restore(EditorMemento $memento)\r\n    {\r\n        $this-&gt;content = $memento-&gt;getContent();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7b414143005-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7b414143005-24\">24</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Editor</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">content</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">''</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-4\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">type</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">words</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">content</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-i\">content</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">' '</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">words</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getContent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-14\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">save</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">EditorMemento</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-19\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">restore</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">EditorMemento</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">memento</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">content</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">memento</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getContent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7b414143005-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7b414143005-24\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0027 seconds] -->\r\n<p>这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a7e985368573\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$editor = new Editor();\r\n\r\n// Type some stuff\r\n$editor-&gt;type('This is the first sentence.');\r\n$editor-&gt;type('This is second.');\r\n\r\n// Save the state to restore to : This is the first sentence. This is second.\r\n$saved = $editor-&gt;save();\r\n\r\n// Type some more\r\n$editor-&gt;type('And this is third.');\r\n\r\n// Output: Content before Saving\r\necho $editor-&gt;getContent(); // This is the first sentence. This is second. And this is third.\r\n\r\n// Restoring to last saved state\r\n$editor-&gt;restore($saved);\r\n\r\n$editor-&gt;getContent(); // This is the first sentence. This is second.</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7e985368573-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7e985368573-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7e985368573-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7e985368573-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7e985368573-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7e985368573-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7e985368573-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7e985368573-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7e985368573-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7e985368573-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7e985368573-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7e985368573-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7e985368573-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7e985368573-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7e985368573-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7e985368573-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7e985368573-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a7e985368573-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a7e985368573-19\">19</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a7e985368573-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Editor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7e985368573-2\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a7e985368573-3\"><span class=\"crayon-c\">// Type some stuff</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7e985368573-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">type</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'This is the first sentence.'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7e985368573-5\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">type</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'This is second.'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7e985368573-6\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a7e985368573-7\"><span class=\"crayon-c\">// Save the state to restore to : This is the first sentence. This is second.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7e985368573-8\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">saved</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">save</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7e985368573-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7e985368573-10\"><span class=\"crayon-c\">// Type some more</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7e985368573-11\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">type</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'And this is third.'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7e985368573-12\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a7e985368573-13\"><span class=\"crayon-c\">// Output: Content before Saving</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7e985368573-14\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getContent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// This is the first sentence. This is second. And this is third.</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7e985368573-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7e985368573-16\"><span class=\"crayon-c\">// Restoring to last saved state</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a7e985368573-17\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">restore</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">saved</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a7e985368573-18\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a7e985368573-19\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getContent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// This is the first sentence. This is second.</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0019 seconds] -->\r\n<p></p>\n<h3>😎 观察者模式</h3>\n<h4>现实生活示例</h4>\n<p>一个很好的例子是，求职者订阅了一些招聘网站，每当有匹配的工作机会时，求职者就会收到通知。</p>\n<h4>概述</h4>\n<p>定义了对象之间的依赖，一旦其中一个对象的状态发生改变，依赖它的对象都会收到通知。</p>\n<h4>维基百科</h4>\n<p>观察者模式是软件设计模式的一种。在此种模式中，一个目标对象管理所有相依于它的观察者对象，并且在它本身的状态改变时主动发出通知。通常通过调用目标对象所提供的方法来实现。</p>\n<p><strong>程序示例</strong></p>\n<p>以上述求职订阅为例，首先给出求职者，有职位发布时会收到通知</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a82642924536\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass JobPost\r\n{\r\n    protected $title;\r\n\r\n    public function __construct(string $title)\r\n    {\r\n        $this-&gt;title = $title;\r\n    }\r\n\r\n    public function getTitle()\r\n    {\r\n        return $this-&gt;title;\r\n    }\r\n}\r\n\r\nclass JobSeeker implements Observer\r\n{\r\n    protected $name;\r\n\r\n    public function __construct(string $name)\r\n    {\r\n        $this-&gt;name = $name;\r\n    }\r\n\r\n    public function onJobPosted(JobPost $job)\r\n    {\r\n        // Do something with the job posting\r\n        echo 'Hi ' . $this-&gt;name . '! New job posted: '. $job-&gt;getTitle();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a82642924536-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a82642924536-30\">30</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">JobPost</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">title</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-4\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">title</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">title</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">title</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getTitle</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">title</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-14\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-16\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">JobSeeker</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Observer</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-17\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-19\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-24\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">onJobPosted</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">JobPost</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">job</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// Do something with the job posting</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Hi '</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-i\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'! New job posted: '</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">job</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getTitle</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a82642924536-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a82642924536-30\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0030 seconds] -->\r\n<p>然后是求职者订阅的职位发布类</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a86405550277\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass JobPostings implements Observable\r\n{\r\n    protected $observers = [];\r\n\r\n    protected function notify(JobPost $jobPosting)\r\n    {\r\n        foreach ($this-&gt;observers as $observer) {\r\n            $observer-&gt;onJobPosted($jobPosting);\r\n        }\r\n    }\r\n\r\n    public function attach(Observer $observer)\r\n    {\r\n        $this-&gt;observers[] = $observer;\r\n    }\r\n\r\n    public function addJob(JobPost $jobPosting)\r\n    {\r\n        $this-&gt;notify($jobPosting);\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a86405550277-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a86405550277-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a86405550277-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a86405550277-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a86405550277-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a86405550277-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a86405550277-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a86405550277-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a86405550277-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a86405550277-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a86405550277-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a86405550277-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a86405550277-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a86405550277-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a86405550277-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a86405550277-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a86405550277-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a86405550277-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a86405550277-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a86405550277-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a86405550277-21\">21</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a86405550277-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">JobPostings</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Observable</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a86405550277-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a86405550277-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">observers</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a86405550277-4\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a86405550277-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">notify</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">JobPost</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jobPosting</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a86405550277-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a86405550277-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">foreach</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">observers </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">observer</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a86405550277-8\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">observer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">onJobPosted</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jobPosting</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a86405550277-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a86405550277-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a86405550277-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a86405550277-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">attach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Observer</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">observer</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a86405550277-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a86405550277-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">observers</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">observer</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a86405550277-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a86405550277-16\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a86405550277-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">addJob</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">JobPost</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jobPosting</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a86405550277-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a86405550277-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">notify</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jobPosting</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a86405550277-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a86405550277-21\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0026 seconds] -->\r\n<p>这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a89738182500\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n// Create subscribers\r\n$johnDoe = new JobSeeker('John Doe');\r\n$janeDoe = new JobSeeker('Jane Doe');\r\n\r\n// Create publisher and attach subscribers\r\n$jobPostings = new JobPostings();\r\n$jobPostings-&gt;attach($johnDoe);\r\n$jobPostings-&gt;attach($janeDoe);\r\n\r\n// Add a new job and see if subscribers get notified\r\n$jobPostings-&gt;addJob(new JobPost('Software Engineer'));\r\n\r\n// Output\r\n// Hi John Doe! New job posted: Software Engineer\r\n// Hi Jane Doe! New job posted: Software Engineer</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a89738182500-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a89738182500-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a89738182500-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a89738182500-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a89738182500-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a89738182500-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a89738182500-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a89738182500-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a89738182500-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a89738182500-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a89738182500-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a89738182500-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a89738182500-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a89738182500-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a89738182500-15\">15</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a89738182500-1\"><span class=\"crayon-c\">// Create subscribers</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a89738182500-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">johnDoe</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">JobSeeker</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'John Doe'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a89738182500-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">janeDoe</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">JobSeeker</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Jane Doe'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a89738182500-4\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a89738182500-5\"><span class=\"crayon-c\">// Create publisher and attach subscribers</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a89738182500-6\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jobPostings</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">JobPostings</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a89738182500-7\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jobPostings</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">attach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">johnDoe</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a89738182500-8\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jobPostings</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">attach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">janeDoe</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a89738182500-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a89738182500-10\"><span class=\"crayon-c\">// Add a new job and see if subscribers get notified</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a89738182500-11\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jobPostings</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">addJob</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">JobPost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Software Engineer'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a89738182500-12\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a89738182500-13\"><span class=\"crayon-c\">// Output</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a89738182500-14\"><span class=\"crayon-c\">// Hi John Doe! New job posted: Software Engineer</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a89738182500-15\"><span class=\"crayon-c\">// Hi Jane Doe! New job posted: Software Engineer</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0018 seconds] -->\r\n<p></p>\n<h3>🏃 访问者模式</h3>\n<h4>现实生活示例</h4>\n<p>假如有人前往迪拜，他们需要有证件（比如签证）就可进入迪拜。到达后，无需获得许可或做一些跑腿工作，他们便可以自由前往迪拜的任何地方; 只要是知道的地方，就能游览。访问者模式可以做到这一点，它可以帮助你添加访问地点，以便在无需跑腿的情况下，可以尽可能多地访问。</p>\n<h4>概述</h4>\n<p>访问者模式可以在无需修改对象的情况下增加一些额外操作。</p>\n<h4>维基百科</h4>\n<p>在面向对象编程和软件工程中，访问者设计模式是一种从对象结构中分离算法的方式。这种分离的实际结果是能够向现有的对象结构添加新的操作，而无需修改这些结构。这是遵循开放/封闭原则的一种方式。</p>\n<p><strong>编程示例</strong></p>\n<p>以模拟动物园为例，动物园里有几种不同种类的动物，我们需要让它们发出叫声，下面使用访问者模式实现</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a8d713271848\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n// Visitee\r\ninterface Animal\r\n{\r\n    public function accept(AnimalOperation $operation);\r\n}\r\n\r\n// Visitor\r\ninterface AnimalOperation\r\n{\r\n    public function visitMonkey(Monkey $monkey);\r\n    public function visitLion(Lion $lion);\r\n    public function visitDolphin(Dolphin $dolphin);\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a8d713271848-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a8d713271848-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a8d713271848-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a8d713271848-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a8d713271848-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a8d713271848-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a8d713271848-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a8d713271848-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a8d713271848-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a8d713271848-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a8d713271848-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a8d713271848-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a8d713271848-13\">13</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a8d713271848-1\"><span class=\"crayon-c\">// Visitee</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a8d713271848-2\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Animal</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a8d713271848-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a8d713271848-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">AnimalOperation</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">operation</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a8d713271848-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a8d713271848-6\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a8d713271848-7\"><span class=\"crayon-c\">// Visitor</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a8d713271848-8\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AnimalOperation</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a8d713271848-9\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a8d713271848-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">visitMonkey</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Monkey</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">monkey</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a8d713271848-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">visitLion</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Lion</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lion</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a8d713271848-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">visitDolphin</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Dolphin</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dolphin</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a8d713271848-13\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p>然后实现各种动物</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a90450773291\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass Monkey implements Animal\r\n{\r\n    public function shout()\r\n    {\r\n        echo 'Ooh oo aa aa!';\r\n    }\r\n\r\n    public function accept(AnimalOperation $operation)\r\n    {\r\n        $operation-&gt;visitMonkey($this);\r\n    }\r\n}\r\n\r\nclass Lion implements Animal\r\n{\r\n    public function roar()\r\n    {\r\n        echo 'Roaaar!';\r\n    }\r\n\r\n    public function accept(AnimalOperation $operation)\r\n    {\r\n        $operation-&gt;visitLion($this);\r\n    }\r\n}\r\n\r\nclass Dolphin implements Animal\r\n{\r\n    public function speak()\r\n    {\r\n        echo 'Tuut tuttu tuutt!';\r\n    }\r\n\r\n    public function accept(AnimalOperation $operation)\r\n    {\r\n        $operation-&gt;visitDolphin($this);\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a90450773291-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a90450773291-38\">38</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Monkey</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Animal</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shout</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Ooh oo aa aa!'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">AnimalOperation</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">operation</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">operation</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">visitMonkey</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-14\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Lion</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Animal</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-15\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">roar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Roaaar!'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-20\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">AnimalOperation</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">operation</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">operation</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">visitLion</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-25\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-26\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-27\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Dolphin</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Animal</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-28\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">speak</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-31\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Tuut tuttu tuutt!'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-33\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">AnimalOperation</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">operation</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">operation</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">visitDolphin</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a90450773291-37\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a90450773291-38\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0034 seconds] -->\r\n<p>接下来实现访问者</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a94229817684\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass Speak implements AnimalOperation\r\n{\r\n    public function visitMonkey(Monkey $monkey)\r\n    {\r\n        $monkey-&gt;shout();\r\n    }\r\n\r\n    public function visitLion(Lion $lion)\r\n    {\r\n        $lion-&gt;roar();\r\n    }\r\n\r\n    public function visitDolphin(Dolphin $dolphin)\r\n    {\r\n        $dolphin-&gt;speak();\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a94229817684-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a94229817684-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a94229817684-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a94229817684-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a94229817684-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a94229817684-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a94229817684-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a94229817684-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a94229817684-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a94229817684-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a94229817684-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a94229817684-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a94229817684-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a94229817684-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a94229817684-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a94229817684-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a94229817684-17\">17</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a94229817684-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Speak</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AnimalOperation</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a94229817684-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a94229817684-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">visitMonkey</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Monkey</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">monkey</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a94229817684-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a94229817684-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">monkey</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">shout</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a94229817684-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a94229817684-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a94229817684-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">visitLion</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Lion</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lion</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a94229817684-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a94229817684-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lion</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">roar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a94229817684-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a94229817684-12\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a94229817684-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">visitDolphin</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Dolphin</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dolphin</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a94229817684-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a94229817684-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dolphin</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">speak</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a94229817684-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a94229817684-17\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0019 seconds] -->\r\n<p>可以这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a97495637457\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$monkey = new Monkey();\r\n$lion = new Lion();\r\n$dolphin = new Dolphin();\r\n\r\n$speak = new Speak();\r\n\r\n$monkey-&gt;accept($speak);    // Ooh oo aa aa!    \r\n$lion-&gt;accept($speak);      // Roaaar!\r\n$dolphin-&gt;accept($speak);   // Tuut tutt tuutt!</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a97495637457-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a97495637457-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a97495637457-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a97495637457-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a97495637457-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a97495637457-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a97495637457-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a97495637457-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a97495637457-9\">9</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a97495637457-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">monkey</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Monkey</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a97495637457-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lion</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Lion</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a97495637457-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dolphin</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Dolphin</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a97495637457-4\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a97495637457-5\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">speak</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Speak</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a97495637457-6\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a97495637457-7\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">monkey</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">speak</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span><span class=\"crayon-c\">// Ooh oo aa aa!    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a97495637457-8\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lion</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">speak</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">      </span><span class=\"crayon-c\">// Roaaar!</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a97495637457-9\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dolphin</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">speak</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">// Tuut tutt tuutt!</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p>当需要为动物添加新动作时，我们本可以通过动物支持继承来实现，但是需要修改动物类。但现在就不必修改动物类了。例如，假设需要向动物添加跳跃行为，我们可以通过创建一个新的访问者来简单地添加此行为，即：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a9a207331759\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass Jump implements AnimalOperation\r\n{\r\n    public function visitMonkey(Monkey $monkey)\r\n    {\r\n        echo 'Jumped 20 feet high! on to the tree!';\r\n    }\r\n\r\n    public function visitLion(Lion $lion)\r\n    {\r\n        echo 'Jumped 7 feet! Back on the ground!';\r\n    }\r\n\r\n    public function visitDolphin(Dolphin $dolphin)\r\n    {\r\n        echo 'Walked on water a little and disappeared';\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9a207331759-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9a207331759-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9a207331759-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9a207331759-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9a207331759-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9a207331759-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9a207331759-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9a207331759-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9a207331759-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9a207331759-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9a207331759-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9a207331759-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9a207331759-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9a207331759-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9a207331759-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9a207331759-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9a207331759-17\">17</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a9a207331759-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Jump</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AnimalOperation</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9a207331759-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a9a207331759-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">visitMonkey</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Monkey</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">monkey</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9a207331759-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a9a207331759-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Jumped 20 feet high! on to the tree!'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9a207331759-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a9a207331759-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9a207331759-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">visitLion</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Lion</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lion</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a9a207331759-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9a207331759-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Jumped 7 feet! Back on the ground!'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a9a207331759-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9a207331759-12\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a9a207331759-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">visitDolphin</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Dolphin</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dolphin</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9a207331759-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a9a207331759-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Walked on water a little and disappeared'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9a207331759-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a9a207331759-17\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0018 seconds] -->\r\n<p>这样使用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080a9d254962215\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$jump = new Jump();\r\n\r\n$monkey-&gt;accept($speak);   // Ooh oo aa aa!\r\n$monkey-&gt;accept($jump);    // Jumped 20 feet high! on to the tree!\r\n\r\n$lion-&gt;accept($speak);     // Roaaar!\r\n$lion-&gt;accept($jump);      // Jumped 7 feet! Back on the ground!\r\n\r\n$dolphin-&gt;accept($speak);  // Tuut tutt tuutt!\r\n$dolphin-&gt;accept($jump);   // Walked on water a little and disappeared</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9d254962215-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9d254962215-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9d254962215-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9d254962215-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9d254962215-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9d254962215-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9d254962215-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9d254962215-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080a9d254962215-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080a9d254962215-10\">10</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080a9d254962215-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jump</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Jump</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9d254962215-2\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a9d254962215-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">monkey</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">speak</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">// Ooh oo aa aa!</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9d254962215-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">monkey</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jump</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span><span class=\"crayon-c\">// Jumped 20 feet high! on to the tree!</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a9d254962215-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9d254962215-6\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lion</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">speak</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">     </span><span class=\"crayon-c\">// Roaaar!</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080a9d254962215-7\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">lion</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jump</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">      </span><span class=\"crayon-c\">// Jumped 7 feet! Back on the ground!</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9d254962215-8\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080a9d254962215-9\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dolphin</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">speak</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">// Tuut tutt tuutt!</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080a9d254962215-10\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dolphin</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">accept</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">jump</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">// Walked on water a little and disappeared</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0018 seconds] -->\r\n<p></p>\n<h3>💡 策略模式</h3>\n<h4>现实生活示例</h4>\n<p>考虑排序的例子，我们实现了冒泡排序，但数据开始增长，冒泡排序开始变得非常慢。为了解决这个问题，我们实现了快速排序。尽管快速排序算法对于大型数据集来说效果很好，但对于较小的数据集却非常慢。为了解决这个问题，我们实施了一个策略，小数据集使用冒泡排序，大数据集使用快速排序。</p>\n<h4>概述</h4>\n<p>策略模式允许你基于场景转换算法或策略。</p>\n<h4>维基百科</h4>\n<p>在计算机编程中，策略模式是一种行为设计模式，可以在运行时选择算法的行为。</p>\n<p><strong>编程示例</strong></p>\n<p>以上述排序为例，首先给出策略接口及不同的策略实现</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080aa1036657044\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface SortStrategy\r\n{\r\n    public function sort(array $dataset): array;\r\n}\r\n\r\nclass BubbleSortStrategy implements SortStrategy\r\n{\r\n    public function sort(array $dataset): array\r\n    {\r\n        echo \"Sorting using bubble sort\";\r\n\r\n        // Do sorting\r\n        return $dataset;\r\n    }\r\n}\r\n\r\nclass QuickSortStrategy implements SortStrategy\r\n{\r\n    public function sort(array $dataset): array\r\n    {\r\n        echo \"Sorting using quick sort\";\r\n\r\n        // Do sorting\r\n        return $dataset;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa1036657044-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa1036657044-26\">26</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SortStrategy</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sort</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">array</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dataset</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-6\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BubbleSortStrategy</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SortStrategy</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-7\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sort</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">array</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dataset</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Sorting using bubble sort\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// Do sorting</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dataset</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-15\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-16\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-17\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">QuickSortStrategy</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SortStrategy</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-18\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sort</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">array</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dataset</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Sorting using quick sort\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-22\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">// Do sorting</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dataset</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa1036657044-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa1036657044-26\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0023 seconds] -->\r\n<p>客户端可以使用任意策略</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080aa5260195790\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass Sorter\r\n{\r\n    protected $sorter;\r\n\r\n    public function __construct(SortStrategy $sorter)\r\n    {\r\n        $this-&gt;sorter = $sorter;\r\n    }\r\n\r\n    public function sort(array $dataset): array\r\n    {\r\n        return $this-&gt;sorter-&gt;sort($dataset);\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa5260195790-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa5260195790-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa5260195790-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa5260195790-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa5260195790-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa5260195790-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa5260195790-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa5260195790-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa5260195790-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa5260195790-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa5260195790-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa5260195790-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa5260195790-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa5260195790-14\">14</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080aa5260195790-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Sorter</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa5260195790-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa5260195790-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">sorter</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa5260195790-4\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080aa5260195790-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">SortStrategy</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">sorter</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa5260195790-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa5260195790-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sorter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">sorter</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa5260195790-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa5260195790-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa5260195790-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sort</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">array</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dataset</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa5260195790-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa5260195790-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sorter</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sort</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dataset</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa5260195790-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa5260195790-14\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p>用法</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080aa8145054584\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$dataset = [1, 5, 4, 3, 2, 8];\r\n\r\n$sorter = new Sorter(new BubbleSortStrategy());\r\n$sorter-&gt;sort($dataset); // Output : Sorting using bubble sort\r\n\r\n$sorter = new Sorter(new QuickSortStrategy());\r\n$sorter-&gt;sort($dataset); // Output : Sorting using quick sort</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa8145054584-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa8145054584-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa8145054584-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa8145054584-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa8145054584-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aa8145054584-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aa8145054584-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080aa8145054584-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dataset</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">5</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">4</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">8</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa8145054584-2\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080aa8145054584-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">sorter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Sorter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BubbleSortStrategy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa8145054584-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">sorter</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sort</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dataset</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Output : Sorting using bubble sort</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa8145054584-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aa8145054584-6\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">sorter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Sorter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">QuickSortStrategy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aa8145054584-7\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">sorter</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sort</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">dataset</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Output : Sorting using quick sort</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p></p>\n<h3>💢 状态模式</h3>\n<h4>现实生活示例</h4>\n<p>想象一下，你正在使用一些绘图应用程序，你可以选择笔刷来绘画，刷子根据所选颜色改变其行为，即如果选择红色，它将绘制为红色，如果选择蓝色，那么它将绘制蓝色等。</p>\n<h4>概述</h4>\n<p>当状态改变时，类的行为也发生改变。</p>\n<h4>维基百科</h4>\n<p>状态模式是以面向对象的方式实现状态机的行为设计模式。对于状态模式，通过将每个单独状态实现为派生类的状态模式接口, 来实现一个状态机，并通过调用模式超类的方法来实现状态转换。状态模式可以被解释为一种策略模式，它能够通过调用模式接口定义的方法来切换当前策略。</p>\n<p><strong>程序示例</strong></p>\n<p>以文本编辑器为例，编辑器可以改变文本的状态如选中粗体，就会以粗体输入文本，选中斜体便以斜体输入。</p>\n<p>首先是状态接口和一些状态实现</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080aac461172909\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninterface WritingState\r\n{\r\n    public function write(string $words);\r\n}\r\n\r\nclass UpperCase implements WritingState\r\n{\r\n    public function write(string $words)\r\n    {\r\n        echo strtoupper($words);\r\n    }\r\n}\r\n\r\nclass LowerCase implements WritingState\r\n{\r\n    public function write(string $words)\r\n    {\r\n        echo strtolower($words);\r\n    }\r\n}\r\n\r\nclass Default implements WritingState\r\n{\r\n    public function write(string $words)\r\n    {\r\n        echo $words;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aac461172909-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aac461172909-28\">28</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-1\"><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WritingState</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">words</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-6\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">UpperCase</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WritingState</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-7\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">words</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">echo </span><span class=\"crayon-e\">strtoupper</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">words</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-14\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">LowerCase</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WritingState</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-15\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">words</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">echo </span><span class=\"crayon-e\">strtolower</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">words</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-20\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-22\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">Default</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WritingState</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-23\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">words</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">words</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aac461172909-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aac461172909-28\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0025 seconds] -->\r\n<p>然后是文本编辑器</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080aaf276231610\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass TextEditor\r\n{\r\n    protected $state;\r\n\r\n    public function __construct(WritingState $state)\r\n    {\r\n        $this-&gt;state = $state;\r\n    }\r\n\r\n    public function setState(WritingState $state)\r\n    {\r\n        $this-&gt;state = $state;\r\n    }\r\n\r\n    public function type(string $words)\r\n    {\r\n        $this-&gt;state-&gt;write($words);\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080aaf276231610-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aaf276231610-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aaf276231610-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aaf276231610-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aaf276231610-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aaf276231610-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aaf276231610-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aaf276231610-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aaf276231610-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aaf276231610-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aaf276231610-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aaf276231610-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aaf276231610-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aaf276231610-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aaf276231610-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aaf276231610-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aaf276231610-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080aaf276231610-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080aaf276231610-19\">19</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080aaf276231610-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TextEditor</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aaf276231610-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aaf276231610-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">state</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aaf276231610-4\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080aaf276231610-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">WritingState</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">state</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aaf276231610-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aaf276231610-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">state</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">state</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aaf276231610-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aaf276231610-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aaf276231610-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">setState</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">WritingState</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">state</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aaf276231610-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aaf276231610-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">state</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">state</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aaf276231610-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aaf276231610-14\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080aaf276231610-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">type</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">words</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aaf276231610-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aaf276231610-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">state</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">words</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080aaf276231610-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080aaf276231610-19\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0021 seconds] -->\r\n<p>用法</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080ab2213908878\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$editor = new TextEditor(new Default());\r\n\r\n$editor-&gt;type('First line');\r\n\r\n$editor-&gt;setState(new UpperCase());\r\n\r\n$editor-&gt;type('Second line');\r\n$editor-&gt;type('Third line');\r\n\r\n$editor-&gt;setState(new LowerCase());\r\n\r\n$editor-&gt;type('Fourth line');\r\n$editor-&gt;type('Fifth line');\r\n\r\n// Output:\r\n// First line\r\n// SECOND LINE\r\n// THIRD LINE\r\n// fourth line\r\n// fifth line</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab2213908878-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab2213908878-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab2213908878-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab2213908878-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab2213908878-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab2213908878-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab2213908878-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab2213908878-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab2213908878-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab2213908878-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab2213908878-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab2213908878-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab2213908878-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab2213908878-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab2213908878-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab2213908878-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab2213908878-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab2213908878-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab2213908878-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab2213908878-20\">20</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080ab2213908878-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TextEditor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">Default</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab2213908878-2\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080ab2213908878-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">type</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'First line'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab2213908878-4\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080ab2213908878-5\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">setState</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">UpperCase</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab2213908878-6\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080ab2213908878-7\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">type</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Second line'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab2213908878-8\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">type</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Third line'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab2213908878-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab2213908878-10\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">setState</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">LowerCase</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab2213908878-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab2213908878-12\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">type</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Fourth line'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab2213908878-13\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">editor</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">type</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Fifth line'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab2213908878-14\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080ab2213908878-15\"><span class=\"crayon-c\">// Output:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab2213908878-16\"><span class=\"crayon-c\">// First line</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab2213908878-17\"><span class=\"crayon-c\">// SECOND LINE</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab2213908878-18\"><span class=\"crayon-c\">// THIRD LINE</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab2213908878-19\"><span class=\"crayon-c\">// fourth line</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab2213908878-20\"><span class=\"crayon-c\">// fifth line</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0019 seconds] -->\r\n<p></p>\n<h3>📒 模板方法模式</h3>\n<h4>现实生活示例</h4>\n<p>假设我们要造一座房子，建造的大体步骤如下：</p>\n<ul>\n<li>打地基</li>\n<li>垒墙</li>\n<li>封顶</li>\n<li>铺地板</li>\n</ul>\n<p>这些步骤的顺序不能被打乱，比如说，你不能在垒墙之前先封顶。但是其中的每一步可以定制，比如墙的材料可以使用木头、聚酯纤维或者石头。</p>\n<h4>概述</h4>\n<p>模板方法模式定义了如何执行某种算法的框架，但是将这些步骤的实现推迟到子类中。</p>\n<h4>维基百科</h4>\n<p>在软件工程中，模板方法模式是一种行为设计模式，用于定义操作中算法的程序框架，将一些步骤推迟到子类实现。它允许在不改变算法结构的情况下重新定义算法的某些步骤。</p>\n<p><strong>程序示例</strong></p>\n<p>假如我们有一个构建工具，可以帮助我们测试，构建并生成构建报告（即代码覆盖报告，linting报告等），并将应用程序部署到测试服务器上。</p>\n<p>首先是用于确定构建算法框架的基类</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080ab6458354117\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nabstract class Builder\r\n{\r\n\r\n    // Template method\r\n    final public function build()\r\n    {\r\n        $this-&gt;test();\r\n        $this-&gt;lint();\r\n        $this-&gt;assemble();\r\n        $this-&gt;deploy();\r\n    }\r\n\r\n    abstract public function test();\r\n    abstract public function lint();\r\n    abstract public function assemble();\r\n    abstract public function deploy();\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab6458354117-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab6458354117-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab6458354117-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab6458354117-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab6458354117-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab6458354117-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab6458354117-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab6458354117-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab6458354117-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab6458354117-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab6458354117-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab6458354117-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab6458354117-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab6458354117-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab6458354117-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab6458354117-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab6458354117-17\">17</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080ab6458354117-1\"><span class=\"crayon-m\">abstract</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Builder</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab6458354117-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab6458354117-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab6458354117-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">// Template method</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab6458354117-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">build</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab6458354117-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab6458354117-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab6458354117-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">lint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab6458354117-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">assemble</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab6458354117-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">deploy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab6458354117-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab6458354117-12\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080ab6458354117-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">abstract</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab6458354117-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">abstract</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">lint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab6458354117-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">abstract</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">assemble</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab6458354117-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">abstract</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">deploy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab6458354117-17\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0022 seconds] -->\r\n<p>然后提供一些基类的实现</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080ab9250919872\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass AndroidBuilder extends Builder\r\n{\r\n    public function test()\r\n    {\r\n        echo 'Running android tests';\r\n    }\r\n\r\n    public function lint()\r\n    {\r\n        echo 'Linting the android code';\r\n    }\r\n\r\n    public function assemble()\r\n    {\r\n        echo 'Assembling the android build';\r\n    }\r\n\r\n    public function deploy()\r\n    {\r\n        echo 'Deploying android build to server';\r\n    }\r\n}\r\n\r\nclass IosBuilder extends Builder\r\n{\r\n    public function test()\r\n    {\r\n        echo 'Running ios tests';\r\n    }\r\n\r\n    public function lint()\r\n    {\r\n        echo 'Linting the ios code';\r\n    }\r\n\r\n    public function assemble()\r\n    {\r\n        echo 'Assembling the ios build';\r\n    }\r\n\r\n    public function deploy()\r\n    {\r\n        echo 'Deploying ios build to server';\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080ab9250919872-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080ab9250919872-45\">45</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-1\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AndroidBuilder</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">extends</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Builder</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Running android tests'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">lint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Linting the android code'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-12\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">assemble</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Assembling the android build'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-17\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">deploy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Deploying android build to server'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-22\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-23\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-24\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IosBuilder</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">extends</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Builder</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-25\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Running ios tests'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-30\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">lint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Linting the ios code'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-35\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-36\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">assemble</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-37\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-38\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Assembling the ios build'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-39\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-40\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">deploy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-42\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Deploying ios build to server'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080ab9250919872-44\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080ab9250919872-45\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0034 seconds] -->\r\n<p>用法</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bd54080abd018981488\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$androidBuilder = new AndroidBuilder();\r\n$androidBuilder-&gt;build();\r\n\r\n// Output:\r\n// Running android tests\r\n// Linting the android code\r\n// Assembling the android build\r\n// Deploying android build to server\r\n\r\n$iosBuilder = new IosBuilder();\r\n$iosBuilder-&gt;build();\r\n\r\n// Output:\r\n// Running ios tests\r\n// Linting the ios code\r\n// Assembling the ios build\r\n// Deploying ios build to server</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bd54080abd018981488-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080abd018981488-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080abd018981488-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080abd018981488-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080abd018981488-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080abd018981488-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080abd018981488-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080abd018981488-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080abd018981488-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080abd018981488-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080abd018981488-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080abd018981488-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080abd018981488-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080abd018981488-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080abd018981488-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bd54080abd018981488-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bd54080abd018981488-17\">17</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bd54080abd018981488-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">androidBuilder</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AndroidBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080abd018981488-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">androidBuilder</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">build</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080abd018981488-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080abd018981488-4\"><span class=\"crayon-c\">// Output:</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080abd018981488-5\"><span class=\"crayon-c\">// Running android tests</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080abd018981488-6\"><span class=\"crayon-c\">// Linting the android code</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080abd018981488-7\"><span class=\"crayon-c\">// Assembling the android build</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080abd018981488-8\"><span class=\"crayon-c\">// Deploying android build to server</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080abd018981488-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080abd018981488-10\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">iosBuilder</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IosBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080abd018981488-11\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">iosBuilder</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">build</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080abd018981488-12\"> </div><div class=\"crayon-line\" id=\"crayon-596bd54080abd018981488-13\"><span class=\"crayon-c\">// Output:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080abd018981488-14\"><span class=\"crayon-c\">// Running ios tests</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080abd018981488-15\"><span class=\"crayon-c\">// Linting the ios code</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bd54080abd018981488-16\"><span class=\"crayon-c\">// Assembling the ios build</span></div><div class=\"crayon-line\" id=\"crayon-596bd54080abd018981488-17\"><span class=\"crayon-c\">// Deploying ios build to server</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p></p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/06/a9e67955472c1afcad111aa202984192.jpg\">\n            \n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111797\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111797votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111797\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/justin_ygg\">Justin_YGG</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/justin_ygg\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2016/06/4302cabf679254e36d325f1d9185b6c72.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            Python工程师一枚，对go、docker感兴趣，还在成长ing~~        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/justin_ygg\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/justin_ygg/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/justin_ygg/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 15</a>        </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "减轻服务器负载的建议和技巧", "url": "http://blog.jobbole.com/111725/", "url_object_id": "9098565e7972c6d0a1a0f5f75c2f05cb", "create_date": "2017/07/04 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/06/48bf315aeeae9f3a7ce0b11b7c6ce31e.png"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 1, "tags": "IT技术,服务器", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/haowang1989\">王浩</a> 翻译，<a href=\"http://www.jobbole.com/members/8zjl8\">周进林</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://www.lucidchart.com/techblog/2017/06/02/tips-tricks-for-reducing-server-load/\">lucidchart</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>我们公司有个面向服务的架构。其中一个服务是字体服务，字体体系和 unicode 编码范围（unicode range）提供字体数据，为用户上传的字体验证权限。我们没想到这个字体服务会有很高的负载<sup>1</sup>（负载是指线程消耗和 CPU 等待的平均值）。但是去年我们注意到字体服务出人意料地出现高负载，尤其是晚上我们没什么流量的时候。幸运的是，我们发现了这一问题的根本原因，并大幅提升了字体服务的性能和系统整体的稳定性。以下内容是我们的优化过程。</p>\n<figure><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/48bf315aeeae9f3a7ce0b11b7c6ce31e.png\"><img class=\" wp-image-64903 aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/48bf315aeeae9f3a7ce0b11b7c6ce31e.png\" alt=\"Figure 1: Server load before and after change. (Fix was released Dec 21.)\" width=\"661\" height=\"191\"></a><br>\n<figcaption style=\"text-align: center;\">图1：修改前后系统复制（12 月 21 日发布修复版本）</figcaption>\n</figure>\n<h3>用火焰图调试</h3>\n<p>我一个同事从 Netflix 公司的 Brendan Gregg 那里发现并部署了一个小巧的火焰图工具。这个工具可以把多个性能检测工具的数据结合起来，生成一张本地方法和 JVM 方法资源使用情况的图象。图里每一个矩形都代表一个栈帧，矩形的宽度代表资源的使用情况，如 CPU 时间，y 轴代表调用栈。你可以简单地通过找出比较宽的矩形来定位出问题所在。这个工具对于调试字体服务的性能是非常宝贵的。</p>\n<figure><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/092148cc9b6180af009d4a106022a936.png\"><img class=\"wp-image-64904 aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/092148cc9b6180af009d4a106022a936.png\" alt=\"Figure 2: A flame graph from a font server during high load.\" width=\"556\" height=\"485\"></a><br>\n<figcaption style=\"text-align: center;\">图2：字体服务器高负载情况下的一张火焰图</figcaption>\n</figure>\n<p>我们收集了几张字体服务高负载状态下的火焰图。下面展示了其中一张，图里有一处 JVM 部分几乎到顶。我们很快注意到这些图的规律。绝大部分时间都是消耗在 libz.so（用于 gzip 压缩和解压）上，而 JVM 里的绝大部分时间都是消耗在 XML 转义和 UTF-8 编码上。</p>\n<figure><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/00be5bb53f79bfbbc30d7eebd570113a.png\"><img class=\"wp-image-64905 aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/00be5bb53f79bfbbc30d7eebd570113a.png\" alt=\"Figure 3: A flame graph zoomed in to the JVM portion.\" width=\"555\" height=\"485\"></a><br>\n<figcaption style=\"text-align: center;\">图3：在 JVM 部分放大的火焰图</figcaption>\n</figure>\n<h3>为什么这么慢</h3>\n<p>首先，介绍一点关于我们字体服务如何工作的背景。我们将字体数据保存在 Amazon S3 容器中，每一种字体的每一 unicode 编码范围（unicode range）是一个独立的对象。其他服务会为字体体系、一系列 unicode 编码范围（unicode range）或者用户来请求字体数据。字体服务会下载用户请求的字体体系中特定 unicode 编码范围（unicode range）的数据，并返回包含这所有数据的 XML。</p>\n<p>这一功能非常简单，并没有什么明显密集计算的东西。然而，我们遇到了高负载。我们在火焰图的帮助下发现 libz、XML 转义和 UTF8 编码占用了 CPU 大量资源。但是为什么我们花了这么多时间在编码和压缩上呢？记得我刚才说的，晚上负载最高吗？我们的晚上（美国山区标准时）在亚洲是白天。每当晚上我们本地没什么流量的时候，大量其他地区的用户正在用亚洲语言的 unicode 编码范围（unicode range），比如中文、日语和韩语。事实上，相比起来这些类别的字体数据是非常庞大的。这些数据通过 gzip 解压、UTF-8 解码然后 XML 转义、UTF-8 编码最后 gzip 压缩。对于体积很小的基本拉丁文类别，这一过程没什么。然而，CJK 类别比基本拉丁文类别大了两个数量级（1MB 对比 60KB）。对于这些体积大的字体类别，这所有的转换都使得 CPU 吃不消。Gzip 压缩和解压相对很耗资源，XML 转义也没有那么快。</p>\n<h3>怎样加速</h3>\n<p>字体服务响应的内容本质上只是来自 S3 的原始数据。字体服务的确做了其他重要的工作，比如权限验证，查找字体关键字。但是没有理由必须让字体服务从 S3 转发字体数据。我们的解决方案非常简单粗暴，直接返回一系列包含字体数据的 S3 对象的链接，而不是通过字体服务下载然后重新编码字体数据。</p>\n<p>这一修改几乎将字体服务器的负载降为 0（见图1）。客户端服务器也察觉不到任何影响。尽管我们第一次尝试非常成功，但我也应该记住，我们部署的同时增加了功能发布控制，它可以让我们在 100% 启用前，先启用一定比例的请求来测试它能够正常工作。</p>\n<h3>结论</h3>\n<p>通过对生产环境服务器的监控，我们能够定位并删除服务器上没必要的功能。下面是我们这次经历中几个关键的步骤：</p>\n<ol>\n<li>用火焰图等性能检测工具定位那些霸占 CPU 的功能方法。</li>\n<li>压缩和其他编码也会非常耗资源。</li>\n<li>如果客户端能够直接获取到数据，那么直接发给它一个连接而非转发数据会提升整体的性能。（声明：这并不是灵丹妙药，有些情况下会对客户端性能造成损失，因为它必须要做二次请求）。</li>\n</ol>\n<p>#1: 负载是指线程消耗和 CPU 等待的平均值。见 <a href=\"https://en.wikipedia.org/wiki/Load_%28computing%29\">Wikipedia</a>。</p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>任选一种支付方式</p>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/05/19b948cb00fa062128f45b2b53fa09e2.png\">\n            \n                            <img src=\"http://jbcdn2.b0.upaiyun.com/2016/05/d327bdec80a27c733bd7b9edb35d30f4.jpg\">\n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111725\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111725votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111725\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/haowang1989\">王浩</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/haowang1989\">\r\n\t\t\t<img src=\"http://www.jobbole.com/wp-content/uploads/2016/03/47586e0af10336a9ced0cb16d851200f.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            phper @深圳        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/haowang1989\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/haowang1989/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/haowang1989/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 13</a> · <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/ontheroads\"><i class=\"fa fa-weibo\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "用 C 语言写一个简单的 Unix Shell（1）", "url": "http://blog.jobbole.com/111738/", "url_object_id": "b7afdd1e2e7420b9ab8f1ad96f32df50", "create_date": "2017/07/06 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2015/11/746b03c66c6e4568ab9770632e5c69e9.jpg"], "praise_nums": "1", "comment_nums": 0, "fav_nums": 2, "tags": "C/C++,开发,C语言,shell", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/qdoverture\">效楚</a> 翻译，<a href=\"http://www.jobbole.com/members/upanblack\">Panblack</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://indradhanush.github.io/blog/writing-a-unix-shell-part-1/\">Indradhanush Gupta</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>【导读】：作者用 C 语言实现了一个简易的unix shell，通过本文可加深对 shell 和 Unix 系统原理的理解。</p>\n<hr>\n<p>写 Unix shell 是我正在 RC 研究的一个项目。这是第一部分，后续会有一系列的文章。</p>\n<p><strong>免责声明：我不是编写 shell 这个课题的专家，我是一边自学一边分享我的发现。</strong></p>\n<h2>shell 是什么？</h2>\n<p>关于这一点已经有很多书面资料，所以对于它的定义我不会探讨太多细节。只用一句话说明：</p>\n<blockquote><p>shell 是允许你与操作系统的核心作交互的一个界面（interface）。</p></blockquote>\n<h2 id=\"how-does-a-shell-work\">shell 是怎样工作的？</h2>\n<p>shell解析用户输入的命令并执行它。为了能做到这一点，shell的工作流程看起来像这样：</p>\n<ol>\n<li style=\"padding-left: 30px;\">启动shell</li>\n<li style=\"padding-left: 30px;\">等待用户输入</li>\n<li style=\"padding-left: 30px;\">解析用户输入</li>\n<li style=\"padding-left: 30px;\">执行命令并返回结果</li>\n<li style=\"padding-left: 30px;\">回到<span style=\"color: #808080;\">第 2 步</span>。</li>\n</ol>\n<p>但在这整个流程中有一个重要的部分：<strong>进程</strong>。shell是父进程。这是我们的程序的<span style=\"color: #808080;\">主</span>线程，它等待用户输入。然而，由于以下原因，我们不能在<span style=\"color: #808080;\">主</span>线程自身中执行命令：</p>\n<ol>\n<li style=\"padding-left: 30px;\">一个错误的命令会导致整个shell停止工作。我们要避免此情况。</li>\n<li style=\"padding-left: 30px;\">独立的命令应该有他们自己的进程块。这被称为隔离，属于容错（机制）。</li>\n</ol>\n<h2 id=\"fork\">Fork</h2>\n<p>为了能避免此情况，我们使用系统调用 <span style=\"color: #808080;\">fork</span>。我曾以为我理解了 <span style=\"color: #808080;\">fork</span>，直到我用它写了大约4行代码（才发现我没有理解）。</p>\n<p><code class=\"highlighter-rouge\"></code><span style=\"color: #808080;\">fork</span> 创建当前进程的一份拷贝。这份拷贝被称为<span style=\"color: #808080;\">“子进程”</span>，系统中的每个进程都有与它联系在一起的唯一的进程 id（pid）。让我们看以下代码片段：</p>\n<p><a href=\"https://indradhanush.github.io/code/shell-part-1/fork.c\"><i>fork.c</i></a></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c44dc9c517779791879\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#include &lt;unistd.h&gt;\r\n\r\nint\r\nmain() {\r\n    pid_t child_pid = fork();\r\n        \r\n    // The child process\r\n    if (child_pid == 0) {\r\n        printf(\"### Child ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n    } else {\r\n        printf(\"### Parent ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n    }\r\n \r\n    return 0;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c517779791879-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c517779791879-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c517779791879-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c517779791879-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c517779791879-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c517779791879-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c517779791879-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c517779791879-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c517779791879-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c517779791879-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c517779791879-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c517779791879-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c517779791879-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c517779791879-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c517779791879-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c517779791879-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c517779791879-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c517779791879-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c517779791879-19\">19</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c44dc9c517779791879-1\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c517779791879-2\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c517779791879-3\"><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c517779791879-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c44dc9c517779791879-5\"><span class=\"crayon-t\">int</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c517779791879-6\"><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c517779791879-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pid_t </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">fork</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c517779791879-8\"><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c517779791879-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">// The child process</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c517779791879-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c517779791879-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Child ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c517779791879-12\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c517779791879-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c517779791879-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Parent ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c517779791879-15\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c517779791879-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c517779791879-17\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c517779791879-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c517779791879-19\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0018 seconds] -->\r\n<p><span style=\"color: #808080;\">fork</span> 系统调用返回两次，每个进程一次。这一开始听起来是反直觉的。但让我们看一下在底层发生了什么。</p>\n<ol>\n<li style=\"padding-left: 30px;\">通过调用 <span style=\"color: #808080;\">fork</span>，我们在程序中创建了一个新的分支。这与传统的 <span style=\"color: #808080;\">if-else</span> 分支不同。<span style=\"color: #808080;\">fork</span> 对当前进程创建一份拷贝并从中创建了一个新的进程。最终系统调用返回子进程的进程 id。</li>\n<li style=\"padding-left: 30px;\">一旦 <span style=\"color: #808080;\">fork</span> 调用成功，子进程和父进程（我们的代码的主线程）会同时运行。</li>\n</ol>\n<p>为了让你更好理解程序流程，看这个图：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/309a7a84764a07033c28b6ce5511c45c.jpg\"><img class=\"alignnone wp-image-65028 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/309a7a84764a07033c28b6ce5511c45c.jpg\" alt=\"fork\" width=\"594\" height=\"442\"></a></p>\n<p><span style=\"color: #808080;\">fork()</span> 创建了一个新的子进程，但与此同时，父进程的执行并没有停止。子进程执行的开始和结束独立于父进程，反之亦然。</p>\n<p>更进一步讨论以前，先说明一点：<span style=\"color: #808080;\">getpid</span> 系统调用返回当前的进程 id。</p>\n<p>如果你编译并执行这段代码，会得到类似于下面的输出：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c44dc9c522218929037\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n### Parent ###\r\nCurrent PID: 85247 and Child PID: 85248\r\n### Child ###\r\nCurrent PID: 85248 and Child PID: 0</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c522218929037-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c522218929037-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c522218929037-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c522218929037-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c44dc9c522218929037-1\"><span class=\"crayon-p\">### Parent ###</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c522218929037-2\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">85247</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">85248</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c522218929037-3\"><span class=\"crayon-p\">### Child ###</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c522218929037-4\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">85248</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>在 <span style=\"color: #808080;\">### Parent ###</span> 下面的片段中，当前进程 ID 是 <span style=\"color: #808080;\">85247</span>，子进程 ID 是 <span style=\"color: #808080;\">85248</span>。注意，子进程的 pid 比父进程的大，表明子进程是在父进程之后创建的。（更新：正如某人在 <a href=\"https://news.ycombinator.com/item?id=14439781\">Hacker News</a> 上正确指出的，这并不是确定的，虽然往往是这样。原因在于，操作系统可能回收无用的老进程 id。）</p>\n<p>在 <span style=\"color: #808080;\">### Child ###</span> 下面的片段中，当前进程 ID 是 <span style=\"color: #808080;\">85248</span>，这与前面片段中子进程的 pid 相同。然而，这里的子进程 pid 为 <span style=\"color: #808080;\">0</span>。</p>\n<p>实际的数字会随着每一次执行而变化。</p>\n<p>你可能在想，我们已经在<span style=\"color: #808080;\">第 9 行</span>明确的给 child_pid 赋了一个值<span style=\"color: #808080;\">（译者注：应该是第7行）</span>，那么 <span style=\"color: #808080;\">child_pid</span> 怎么会在同一个执行流程中呈现两个不同的值，这种想法值得原谅。但是，回想一下，调用 <span style=\"color: #808080;\">fork</span> 创建了一个新进程，这个新进程与当前进程相同。因此，在父进程中，<span style=\"color: #808080;\">child_pid</span> 是刚创建的子进程的实际值，而子进程本身没有自己的子进程，所以 <span style=\"color: #808080;\">child_pid</span> 的值为 <span style=\"color: #808080;\">0</span>。</p>\n<p>因此，为了控制哪些代码在子进程中执行，哪些又在父进程中执行，需要我们在 12 到 16 行定义的 <span style=\"color: #808080;\">if-else</span> 块<span style=\"color: #0000ff;\">（译者注：应该是 10 到 16 行）</span>。当 <span style=\"color: #808080;\">child_pid</span> 为 <span style=\"color: #808080;\">0</span> 时，代码块将在子进程下执行，而 else 块却会在父进程下执行。这些块被执行的顺序是不确定的，取决于操作系统的调度程序。</p>\n<h2>引入确定性</h2>\n<p>让我向你介绍系统调用 <span style=\"color: #808080;\">sleep</span>。引用 linux man 页面的话：</p>\n<blockquote><p>sleep – 暂停执行一段时间</p></blockquote>\n<p>时间间隔以秒为单位。</p>\n<p>让我们给父进程，即我们代码中的 else 块，加一个 sleep(1) 调用：</p>\n<p><a href=\"https://indradhanush.github.io/code/shell-part-1/sleep_parent.c\"><i>sleep_parent.c</i></a></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c44dc9c52d403858040\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#include &lt;unistd.h&gt;\r\n\r\nint\r\nmain() {\r\n    pid_t child_pid = fork();\r\n\r\n    // The child process\r\n    if (child_pid == 0) {\r\n        printf(\"### Child ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n    } else {\r\n        sleep(1); // Sleep for one second\r\n        printf(\"### Parent ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n    }\r\n \r\n    return 0;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c52d403858040-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c52d403858040-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c52d403858040-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c52d403858040-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c52d403858040-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c52d403858040-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c52d403858040-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c52d403858040-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c52d403858040-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c52d403858040-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c52d403858040-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c52d403858040-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c52d403858040-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c52d403858040-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c52d403858040-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c52d403858040-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c52d403858040-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c52d403858040-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c52d403858040-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c52d403858040-20\">20</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c44dc9c52d403858040-1\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c52d403858040-2\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c52d403858040-3\"><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c52d403858040-4\"> </div><div class=\"crayon-line\" id=\"crayon-596c44dc9c52d403858040-5\"><span class=\"crayon-t\">int</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c52d403858040-6\"><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c52d403858040-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pid_t </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">fork</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c52d403858040-8\"> </div><div class=\"crayon-line\" id=\"crayon-596c44dc9c52d403858040-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">// The child process</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c52d403858040-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c52d403858040-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Child ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c52d403858040-12\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c52d403858040-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c52d403858040-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">sleep</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Sleep for one second</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c52d403858040-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Parent ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c52d403858040-16\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c52d403858040-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c52d403858040-18\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c52d403858040-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c52d403858040-20\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0019 seconds] -->\r\n<p>当你执行这段代码时，输出将类似这样：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c44dc9c534262277200\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n### Child ###\r\nCurrent PID: 89743 and Child PID: 0</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c534262277200-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c534262277200-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c44dc9c534262277200-1\"><span class=\"crayon-p\">### Child ###</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c534262277200-2\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">89743</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>1秒钟以后，你将看到</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c44dc9c537165017818\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n### Parent ###\r\nCurrent PID: 89742 and Child PID: 89743</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c537165017818-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c537165017818-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c44dc9c537165017818-1\"><span class=\"crayon-p\">### Parent ###</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c537165017818-2\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">89742</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">89743</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>每次执行这段代码时你会看到同样的表现。这是因为：我们在父进程中做了一个阻塞性的 <span style=\"color: #808080;\">sleep</span> 调用，与此同时，操作系统调度程序发现有空闲的 CPU 时间可以给子进程执行。</p>\n<p>类似的，如果你反过来，把 <span style=\"color: #808080;\">sleep(1)</span> 调用加到子进程，也就是我们代码中的 <span style=\"color: #808080;\">if</span> 块里面，你会发现父进程块立刻输出到控制台上。但你也会发现程序终止了。子进程块的输出被转存到<span style=\"color: #808080;\">标准输出</span>。看起来是这样：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c44dc9c53b999700444\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ gcc -lreadline blog/sleep_child.c -o sleep_child &amp;&amp; ./sleep_child\r\n### Parent ###\r\nCurrent PID: 23011 and Child PID: 23012\r\n$ ### Child ###\r\nCurrent PID: 23012 and Child PID: 0</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53b999700444-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53b999700444-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53b999700444-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53b999700444-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53b999700444-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c44dc9c53b999700444-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gcc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">lreadline </span><span class=\"crayon-v\">blog</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sleep_child</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">c</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">o</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sleep_child</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sleep_child</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53b999700444-2\"><span class=\"crayon-p\">### Parent ###</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53b999700444-3\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">23011</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">23012</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53b999700444-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">### Child ###</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53b999700444-5\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">23012</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p>这段源代码可在 <a href=\"https://indradhanush.github.io/code/shell-part-1/sleep_child.c\">sleep_child.c</a> 获取。</p>\n<p>这是因为父进程在 <span style=\"color: #808080;\">printf</span> 语句之后无事可做，被终止了。然而，子进程在 <span style=\"color: #808080;\">sleep</span> 调用处被阻塞了 1 秒钟，之后才执行 <span style=\"color: #808080;\">printf</span> 语句。</p>\n<h2>正确实现的确定性</h2>\n<p>然而，使用 <span style=\"color: #808080;\">sleep</span> 来控制进程的执行流程不是最好的方法，因为你做了一个 <span style=\"color: #808080;\">n 秒</span>的 <span style=\"color: #808080;\">sleep</span> 调用：</p>\n<ol>\n<li style=\"padding-left: 30px;\">你怎么确保不管你等待的是什么，都会在 <span style=\"color: #808080;\">n 秒</span>内完成执行呢？</li>\n<li style=\"padding-left: 30px;\">不管你等待的是什么，要是它在远远早于 <span style=\"color: #808080;\">n 秒</span>时就结束了呢？在此情况下你不必要地闲置了。</li>\n</ol>\n<p>有一种更好的方法是，使用 <span style=\"color: #808080;\">wait</span> 系统调用（或一种变体）来代替。我们将使用 <span style=\"color: #808080;\">waitpid</span> 系统调用。它带有以下参数：</p>\n<ol>\n<li style=\"padding-left: 30px;\">你想要程序等待的进程的进程 ID。</li>\n<li style=\"padding-left: 30px;\">一个变量，用来保存进程如何终止的相关信息。</li>\n<li style=\"padding-left: 30px;\">选项标志，用来定制 <span style=\"color: #808080;\">waitpid</span> 的行为</li>\n</ol>\n<p><a href=\"https://indradhanush.github.io/code/shell-part-1/wait.c\"><i>wait.c</i></a></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c44dc9c53f780401962\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#include &lt;unistd.h&gt;\r\n#include &lt;sys/wait.h&gt;\r\n\r\nint\r\nmain() {\r\n    pid_t child_pid;\r\n    pid_t wait_result;\r\n    int stat_loc;\r\n\r\n    child_pid = fork();\r\n        \r\n    // The child process\r\n    if (child_pid == 0) {\r\n        printf(\"### Child ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n        sleep(1); // Sleep for one second\r\n    } else {\r\n        wait_result = waitpid(child_pid, &amp;stat_loc, WUNTRACED);\r\n        printf(\"### Parent ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n    }\r\n \r\n    return 0;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c44dc9c53f780401962-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c44dc9c53f780401962-26\">26</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-1\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-2\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-3\"><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-4\"><span class=\"crayon-p\">#include &lt;sys/wait.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-6\"><span class=\"crayon-t\">int</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-7\"><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pid_t </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pid_t </span><span class=\"crayon-v\">wait_result</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">stat_loc</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">fork</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-13\"><span class=\"crayon-h\">        </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">// The child process</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Child ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-17\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">sleep</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Sleep for one second</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">wait_result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">waitpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">stat_loc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">WUNTRACED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Parent ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-22\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-24\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596c44dc9c53f780401962-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c44dc9c53f780401962-26\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0025 seconds] -->\r\n<p>当你执行这段代码，你会发现子进程块立刻被打印，然后等待很短的一段时间（这里我们在 <span style=\"color: #808080;\">printf</span> 后面加了 <span style=\"color: #808080;\">sleep</span>）。父进程等待子进程执行结束，之后就有空执行它自己的命令。</p>\n<p>第一部分到此结束。这篇博客中的所有代码示例可以在<a href=\"https://github.com/indradhanush/indradhanush.github.io/tree/master/code/shell-part-1/\">这里</a>获取。在<a href=\"https://indradhanush.github.io/blog/writing-a-unix-shell-part-2/\">下一篇</a>中，我们将研究怎样在用户输入时接受命令并执行它。敬请期待。</p>\n<p><strong>致谢</strong></p>\n<p>谢谢 <a href=\"https://github.com/saulpw\">Saul Pwanson</a> 帮助我理解 <span style=\"color: #808080;\">fork</span> 的表现方式，谢谢 <a href=\"https://github.com/jaseemabid\">Jaseem Abid</a> 阅读草稿并提出编辑建议。</p>\n<p id=\"resources\"><strong>参考资料</strong></p>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=k6TTj4C0LF0\">EnthusiastiCon – Stefanie Schirmer：《天哪！在 10 分中内构建一个 shell”</a>》</li>\n<li><a href=\"https://linux.die.net/man/\">Linux man 页面</a></li>\n</ul>\n<p>99e05c43dc61c56cbc182203.jpeg”&gt;</p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>任选一种支付方式</p>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/8204a635b9f0335c5b2e27498c3d5c97.jpg\">\n            \n                            <img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/0fbc02d33dc26bbfebc27f81bea9cdf9.jpg\">\n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111738\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111738votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111738\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/qdoverture\">效楚</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/qdoverture\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/72a13d3690f7c6edc018286f0ae732f6.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            本职工作是IC设计，工作中也经常做脚本编写、嵌入式编程等，对软件和文字翻译亦有浓厚的兴趣。        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/qdoverture\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/qdoverture/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/qdoverture/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 12</a>        </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "漫画算法：什么是跳跃表？", "url": "http://blog.jobbole.com/111731/", "url_object_id": "a7e761864e16693a072a866a8afdabb1", "create_date": "2017/07/04 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/07/daab64eb4fff66513ac482d07e5ae054.jpeg"], "praise_nums": "1", "comment_nums": 5, "fav_nums": 8, "tags": "趣文小说,算法,跳跃表", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文作者： <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/bjweimengshu\">玻璃猫</a> 。未经作者许可，禁止转载！<br>欢迎加入伯乐在线 <a href=\"http://blog.jobbole.com/99322\" target=\"_blank\">专栏作者</a>。</div><p>这是发生在很多年以前的故事……</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/daab64eb4fff66513ac482d07e5ae054.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/890d2a8f840ed95165dcd3df24ed584c.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/1ec995966632cc86d75a2511bba11c5c.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/b0c602dc9acb987c129f35169341b74d.jpeg\"></p>\n<p>几天以前……</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/53f3319b898ce41a545b29d930946a2a.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/5f1e257214c48a4d8246b9395bb0f0df.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/10dd099feb00060dad6b1339e0db8799.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/45606dfe47cc5586318007d1970f26e5.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0716a40761dbfdbf797543bb24b58945.jpeg\"></p>\n<p>几天之后……</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/5f5785668595f59e8ba4778cae9f2d6a.jpeg\"></p>\n<p>拍卖行的商品总数量有几十万件，对应数据库商品表的几十万条记录。</p>\n<p>如果是按照商品名称精确查询还好办，可以直接从数据库查出来，最多也就上百条记录。</p>\n<p>如果是没有商品名称的全量查询怎么办？总不可能把数据库里的所有记录全查出来吧，而且还要支持不同字段的排序。</p>\n<p>所以，只能提前在内存中存储有序的全量商品集合，每一种排序方式都保存成独立的集合，每次请求的时候按照请求的排序种类，返回对应的集合。</p>\n<p>比如按价格字段排序的集合：</p>\n<p>比如按等级字段排序的集合：</p>\n<p>需要注意的是，当时还没有Redis这样的内存数据库，所以小灰只能自己实现一套合适的数据结构来存储。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/8eadcb96909cbebc38292974d5216fab.jpeg\"></p>\n<p>拍卖行商品列表是线性的，最容易表达线性结构的自然是数组和链表。可是，无论是数组还是链表，在插入新商品的时候，都会存在性能问题。</p>\n<p>按照商品等级排序的集合为例，如果使用数组，插入新商品的方式如下：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/af7f12cccfbda80b967d515acebe79d9.jpeg\"></p>\n<p>如果要插入一个等级是3的商品，首先要知道这个商品应该插入的位置。使用二分查找可以最快定位，这一步时间复杂度是O（logN）。</p>\n<p>插入过程中，原数组中所有大于3的商品都要右移，这一步时间复杂度是O（N）。所以总体时间复杂度是O（N）。</p>\n<p>如果使用链表，插入新商品的方式如下：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/1bce6be23668647edf9eff28d305c84f.jpeg\"></p>\n<p>如果要插入一个等级是3的商品，首先要知道这个商品应该插入的位置。链表无法使用二分查找，只能和原链表中的节点逐一比较大小来确定位置。这一步的时间复杂度是O（N）。</p>\n<p>插入的过程倒是很容易，直接改变节点指针的目标，时间复杂度O（1）。因此总体的时间复杂度也是O（N）。</p>\n<p>这对于拥有几十万商品的集合来说，这两种方法显然都太慢了。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e3be5ef6ac109306ee1dd169fb6b8df3.jpeg\"></p>\n<p>——————————————</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/00e8f84563ba3fc4e926f4b8b2f5fe7a.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e795edb90cf7d598d733592920657a97.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/d3cd2a28c4e3e48550d33f7fe4a47fd0.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/02717bbe18ec7d1034580481ffa22e7e.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9bfe1887ff9177a8c0f303de054c79fe.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/377693e7b3f37892f42e4e144f92c362.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0b9b3c90dc0681f0af4963d783dff24d.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/15ece5c25170a528131c4e7803c8e0e8.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a58d35069f85e181659f2c8dc98cffbc.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/325af9d7f350486e58b41b32bd254227.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c708e4a0c267b5e9f3a37ad309e6c3e8.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/fa5f0684ada4d509f3e978c104f576ac.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4d469cbe0d0afb9bb7cf2c99f266a5f9.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/d972154799e05c43dc61c56cbc182203.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e0ef1f5c4cbfa110713984f06904c97a.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bb33df3e70571a35b0d38cfa2aa0f719.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c66bd9b6ba634f5df05dfb4931201217.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/757e77b87645239013108a7eac7cac78.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a502d32bad14a5943b78e5ec283eb6a3.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/ea99ed67b7cdb47d04c3703f12a64bc4.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e98cfa966bb1cfa58a5e8a11505a3e0f.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/6e5972f05c028476a0b2eb43850a1432.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/ea50cbc49ca84c72b94cb693d121c017.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/3063e527ca511c457824b146b3047fb2.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/ad1e060829476ef9de94d33ea246009d.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/f0fed037f81a07b51108a6d6468e4235.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/6f7628b9803eaae385222da353b34b83.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0b69b19d022c8a75aa2d83fca3d10066.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a327ac84038bdf376496a07a5d61d23d.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/98b8caa7a5b7da9aaf7999a7f502fd92.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/df485893afb0b40cfec65ce19233faa6.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0c38e0ee3659932960bbc9b3c310fab8.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/dedddf4bf8ad251e479ce73ef0f628c9.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4b8a95bfc81b232d79b2c8056ca454ec.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4f6bafe8717d30780a0bc7ae1110c37d.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9e92dc231f4069da54a71fa6be3bd12e.jpeg\"></p>\n<p>新节点和各层索引节点逐一比较，确定原链表的插入位置。O（logN）</p>\n<p>把索引插入到原链表。O（1）</p>\n<p>利用抛硬币的随机方式，决定新节点是否提升为上一级索引。结果为“正”则提升并继续抛硬币，结果为“负”则停止。O（logN）</p>\n<p>总体上，跳跃表插入操作的时间复杂度是O（logN），而这种数据结构所占空间是2N，既空间复杂度是 O（N）。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/95b14789cf228b85159be05aa93cbaa4.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0a64ff5e6453328bf1360416339c0adb.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0da2ce061fbca4790c93b0139e66d289.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/86a6084f88fa592dd304e890b72409eb.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/7c32aa5ab5f2c936078f16840eabf1b2.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/41d9de8c654dc43b0f1703b0e29c6590.jpeg\"></p>\n<p>自上而下，查找第一次出现节点的索引，并逐层找到每一层对应的节点。O（logN）</p>\n<p>删除每一层查找到的节点，如果该层只剩下1个节点，删除整个一层（原链表除外）。O（logN）</p>\n<p>总体上，跳跃表删除操作的时间复杂度是O（logN）。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/24f060f88decdf946d1069ce4c82f57d.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e7566dee2274eb9bfcefcc13c1a7494c.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/869228a1933d8e4a9e8ec81afc0603d5.jpeg\"></p>\n<p>小灰和大黄并不知道，他们的这一解决方案和若干年后Redis当中的Sorted-set不谋而合。而Sorted-set这种有序集合，正是对于跳跃表的改进和应用。</p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我写出更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏作者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我写出更多好文章，谢谢！</h4>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/10/2df4a3ede6e684f78858dfde0e7b118f.jpeg\">\n            \n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111731\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111731votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111731\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 8 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 5 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/bjweimengshu\">玻璃猫</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/bjweimengshu\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2016/09/7ce4028f2cece3294efcb3e5caa73af1.jpeg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            互联网公司的码农一枚，喜欢算法和面向对象设计。个人微信号：13522239721 个人订阅号：dreamsee321欢迎一起交流讨论！        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/bjweimengshu\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/bjweimengshu/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/bjweimengshu/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 94</a> · <a title=\"个人微信：bjweimengshu\" target=\"_blank\" href=\"#\"><i class=\"fa fa-weixin\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "数据结构中各种树", "url": "http://blog.jobbole.com/111680/", "url_object_id": "02798e0da54694b76c5f84ea9e994105", "create_date": "2017/07/03 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/07/bc42d6b7087d92bf57edac612206395f.jpg"], "praise_nums": "1", "comment_nums": 2, "fav_nums": 7, "tags": "IT技术,数据结构,树", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/maybe2030/p/4732377.html\">Poll的笔记</a>   </div><p>数据结构中有很多树的结构，其中包括二叉树、二叉搜索树、2-3树、红黑树等等。本文中对数据结构中常见的几种树的概念和用途进行了汇总，不求严格精准，但求简单易懂。</p>\n<h1 class=\"First\"><strong>1. 二叉树</strong></h1>\n<p>二叉树是数据结构中一种重要的数据结构，也是树表家族最为基础的结构。</p>\n<p><strong>二叉树的定义：</strong>二叉树的每个结点至多只有二棵子树(不存在度大于2的结点)，二叉树的子树有左右之分，次序不能颠倒。二叉树的第i层至多有2<sup>i-1</sup>个结点；深度为k的二叉树至多有2<sup>k-1</sup>个结点；对任何一棵二叉树T，如果其终端结点数为n<sub>0</sub>，度为2的结点数为n<sub>2</sub>，则n<sub>0</sub>=n<sub>2</sub>+1。</p>\n<p><strong>二叉树的示例</strong>：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/bc42d6b7087d92bf57edac612206395f.jpg\"><img class=\"aligncenter wp-image-111682 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bc42d6b7087d92bf57edac612206395f.jpg\" alt=\"2009050402\" width=\"390\" height=\"312\"></a></p>\n<p><strong>满二叉树和完全二叉树：</strong></p>\n<p>满二叉树：除最后一层无任何子节点外，每一层上的所有结点都有两个子结点。也可以这样理解，除叶子结点外的所有结点均有两个子结点。节点数达到最大值，所有叶子结点必须在同一层上。</p>\n<p>满二叉树的性质：</p>\n<p>1) 一颗树深度为h，最大层数为k，深度与最大层数相同，k=h;</p>\n<p>2) 叶子数为2<sup>h</sup>;</p>\n<p>3) 第k层的结点数是：2<sup>k-1</sup>;</p>\n<p>4) 总结点数是：2<sup>k-1</sup>，且总节点数一定是奇数。</p>\n<p>完全二叉树：若设二叉树的深度为h，除第 h 层外，其它各层 (1～(h-1)层) 的结点数都达到最大个数，第h层所有的结点都连续集中在最左边，这就是完全二叉树。</p>\n<p><strong>注：</strong>完全二叉树是效率很高的数据结构，堆是一种完全二叉树或者近似完全二叉树，所以效率极高，像十分常用的排序算法、Dijkstra算法、Prim算法等都要用堆才能优化，二叉排序树的效率也要借助平衡性来提高，而平衡性基于完全二叉树。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/a5952ec741b60202c7b377bfb8e8f368.png\"><img class=\"aligncenter wp-image-111683 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a5952ec741b60202c7b377bfb8e8f368.png\" alt=\"141749056837546\" width=\"534\" height=\"180\"></a></p>\n<p><strong>二叉树的性质</strong>：</p>\n<p>1) 在非空二叉树中，第i层的结点总数不超过2<sup>i-1</sup>, i&gt;=1;</p>\n<p>2) 深度为h的二叉树最多有2<sup>h</sup>-1个结点(h&gt;=1)，最少有h个结点;</p>\n<p>3) 对于任意一棵二叉树，如果其叶结点数为N<sub>0</sub>，而度数为2的结点总数为N<sub>2</sub>，则N<sub>0</sub>=N<sub>2</sub>+1;</p>\n<p>4) 具有n个结点的完全二叉树的深度为log<sub>2</sub>(n+1);</p>\n<p>5)有N个结点的完全二叉树各结点如果用顺序方式存储，则结点之间有如下关系：</p>\n<p>若I为结点编号则 如果I&gt;1，则其父结点的编号为I/2；</p>\n<p>如果2I&lt;=N，则其左儿子（即左子树的根结点）的编号为2I；若2I&gt;N，则无左儿子；</p>\n<p>如果2I+1&lt;=N，则其右儿子的结点编号为2I+1；若2I+1&gt;N，则无右儿子。</p>\n<p>6)给定N个节点，能构成h(N)种不同的二叉树，其中h(N)为卡特兰数的第N项，h(n)=C(2*n, n)/(n+1)。</p>\n<p>7)设有i个枝点，I为所有枝点的道路长度总和，J为叶的道路长度总和J=I+2<sup>i</sup>。</p>\n<h1 class=\"First\">2. 二叉查找树</h1>\n<p><strong>二叉查找树定义</strong>：又称为是二叉排序树（Binary Sort Tree）或二叉搜索树。二叉排序树或者是一棵空树，或者是具有下列性质的二叉树：</p>\n<p>1) 若左子树不空，则左子树上所有结点的值均小于它的根结点的值；</p>\n<p>2) 若右子树不空，则右子树上所有结点的值均大于或等于它的根结点的值；</p>\n<p>3) 左、右子树也分别为二叉排序树；</p>\n<p>4) 没有键值相等的节点。</p>\n<p><strong>二叉查找树的性质：</strong><strong>对二叉查找树进行中序遍历，即可得到有序的数列。</strong></p>\n<p><strong>二叉查找树的时间复杂度：<strong>它和二分查找一样，插入和查找的时间复杂度均为O(logn)，<span style=\"color: #ff0000\">但是在最坏的情况下仍然会有O(n)的时间复杂度。</span>原因在于插入和删除元素的时候，树没有保持平衡（比如，我们查找上图（b）中的“93”，我们需要进行n次查找操作）。我们追求的是在最坏的情况下仍然有较好的时间复杂度，这就是平衡查找树设计的初衷。</strong></strong></p>\n<p><span style=\"color: #ff0000\"><strong><strong>二叉查找树的高度决定了二叉查找树的查找效率。</strong></strong></span></p>\n<p><strong>二叉查找树的插入过程如下：</strong></p>\n<p>1) 若当前的二叉查找树为空，则插入的元素为根节点;</p>\n<p>2) 若插入的元素值小于根节点值，则将元素插入到左子树中;</p>\n<p>3) 若插入的元素值不小于根节点值，则将元素插入到右子树中。</p>\n<p><strong>二叉查找树的删除，分三种情况进行处理：</strong></p>\n<p>1) p为叶子节点，直接删除该节点，再修改其父节点的指针（注意分是根节点和不是根节点），如图a;</p>\n<p>2) p为单支节点（即只有左子树或右子树）。让p的子树与p的父亲节点相连，删除p即可（注意分是根节点和不是根节点），如图b;</p>\n<p>3) p的左子树和右子树均不空。找到p的后继y，因为y一定没有左子树，所以可以删除y，并让y的父亲节点成为y的右子树的父亲节点，并用y的值代替p的值；或者方法二是找到p的前驱x，x一定没有右子树，所以可以删除x，并让x的父亲节点成为y的左子树的父亲节点。如图c。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/2361a6d889a036b92d6fa44c8984d27e.png\"><img class=\"aligncenter wp-image-111684 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2361a6d889a036b92d6fa44c8984d27e.png\" alt=\"2012032717571645\" width=\"572\" height=\"205\"></a></p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/05b0ae29caf51cf3aeb26e30ee6996ec.png\"><img class=\"aligncenter wp-image-111685 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/05b0ae29caf51cf3aeb26e30ee6996ec.png\" alt=\"2012032717583358\" width=\"611\" height=\"210\"></a><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/2c51f44d9bfb87f38f9bf040552b6b31.png\"><img class=\"aligncenter wp-image-111686 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2c51f44d9bfb87f38f9bf040552b6b31.png\" alt=\"2012032717584562\" width=\"553\" height=\"148\"></a></p>\n<p>二叉树相关实现源码：</p>\n<p>插入操作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c7f3872ab9421298804\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstruct node\r\n{\r\n    int val;\r\n    pnode lchild;\r\n    pnode rchild;\r\n};\r\n\r\npnode BT = NULL;\r\n\r\n\r\n//递归方法插入节点 \r\npnode insert(pnode root, int x)\r\n{\r\n    pnode p = (pnode)malloc(LEN);\r\n    p-&gt;val = x;\r\n    p-&gt;lchild = NULL;\r\n    p-&gt;rchild = NULL;\r\n    if(root == NULL){\r\n        root = p;    \r\n    }    \r\n    else if(x &lt; root-&gt;val){\r\n        root-&gt;lchild = insert(root-&gt;lchild, x);    \r\n    }\r\n    else{\r\n        root-&gt;rchild = insert(root-&gt;rchild, x);    \r\n    }\r\n    return root;\r\n}\r\n\r\n//非递归方法插入节点 \r\nvoid insert_BST(pnode q, int x)\r\n{\r\n    pnode p = (pnode)malloc(LEN);\r\n    p-&gt;val = x;\r\n    p-&gt;lchild = NULL;\r\n    p-&gt;rchild = NULL;\r\n    if(q == NULL){\r\n        BT = p;\r\n        return ;    \r\n    }        \r\n    while(q-&gt;lchild != p &amp;&amp; q-&gt;rchild != p){\r\n        if(x &lt; q-&gt;val){\r\n            if(q-&gt;lchild){\r\n                q = q-&gt;lchild;    \r\n            }    \r\n            else{\r\n                q-&gt;lchild = p;\r\n            }        \r\n        }    \r\n        else{\r\n            if(q-&gt;rchild){\r\n                q = q-&gt;rchild;    \r\n            }    \r\n            else{\r\n                q-&gt;rchild = p;    \r\n            }\r\n        }\r\n    }\r\n    return;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ab9421298804-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ab9421298804-60\">60</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-1\"><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">node</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-6\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-8\"><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-10\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-11\"><span class=\"crayon-c\">//递归方法插入节点 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-12\"><span class=\"crayon-e\">pnode </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-13\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">pnode</span><span class=\"crayon-sy\">)</span><span class=\"crayon-e\">malloc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">LEN</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-28\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-29\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-30\"><span class=\"crayon-c\">//非递归方法插入节点 </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-31\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert_BST</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-32\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-33\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">pnode</span><span class=\"crayon-sy\">)</span><span class=\"crayon-e\">malloc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">LEN</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-36\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-37\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-38\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-39\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-40\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-42\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-43\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-44\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-45\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-46\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-47\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-48\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-49\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-51\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-52\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-54\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-55\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-56\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-58\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ab9421298804-59\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ab9421298804-60\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0072 seconds] -->\r\n<p>删除操作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c7f3872ac4736893465\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbool delete_BST(pnode p, int x) //返回一个标志，表示是否找到被删元素 \r\n{\r\n    bool find = false;\r\n    pnode q;\r\n    p = BT;\r\n    while(p &amp;&amp; !find){  //寻找被删元素 \r\n        if(x == p-&gt;val){  //找到被删元素 \r\n            find = true;    \r\n        }    \r\n        else if(x &lt; p-&gt;val){ //沿左子树找 \r\n            q = p;\r\n            p = p-&gt;lchild;    \r\n        }\r\n        else{   //沿右子树找 \r\n            q = p;\r\n            p = p-&gt;rchild;    \r\n        }\r\n    }\r\n    if(p == NULL){   //没找到 \r\n        cout &lt;&lt; \"没有找到\" &lt;&lt; x &lt;&lt; endl;    \r\n    }\r\n    \r\n    if(p-&gt;lchild == NULL &amp;&amp; p-&gt;rchild == NULL){  //p为叶子节点 \r\n        if(p == BT){  //p为根节点 \r\n            BT = NULL;    \r\n        }\r\n        else if(q-&gt;lchild == p){   \r\n            q-&gt;lchild = NULL;\r\n        }        \r\n        else{\r\n            q-&gt;rchild = NULL;    \r\n        }\r\n        free(p);  //释放节点p \r\n    }\r\n    else if(p-&gt;lchild == NULL || p-&gt;rchild == NULL){ //p为单支子树 \r\n        if(p == BT){  //p为根节点 \r\n            if(p-&gt;lchild == NULL){\r\n                BT = p-&gt;rchild;    \r\n            }    \r\n            else{\r\n                BT = p-&gt;lchild;    \r\n            }\r\n        }    \r\n        else{\r\n            if(q-&gt;lchild == p &amp;&amp; p-&gt;lchild){ //p是q的左子树且p有左子树 \r\n                q-&gt;lchild = p-&gt;lchild;    //将p的左子树链接到q的左指针上 \r\n            }    \r\n            else if(q-&gt;lchild == p &amp;&amp; p-&gt;rchild){\r\n                q-&gt;lchild = p-&gt;rchild;    \r\n            }\r\n            else if(q-&gt;rchild == p &amp;&amp; p-&gt;lchild){\r\n                q-&gt;rchild = p-&gt;lchild;    \r\n            }\r\n            else{\r\n                q-&gt;rchild = p-&gt;rchild;\r\n            }\r\n        }\r\n        free(p);\r\n    }\r\n    else{ //p的左右子树均不为空 \r\n        pnode t = p;\r\n        pnode s = p-&gt;lchild;  //从p的左子节点开始 \r\n        while(s-&gt;rchild){  //找到p的前驱，即p左子树中值最大的节点 \r\n            t = s;   \r\n            s = s-&gt;rchild;    \r\n        }\r\n        p-&gt;val = s-&gt;val;   //把节点s的值赋给p \r\n        if(t == p){\r\n            p-&gt;lchild = s-&gt;lchild;    \r\n        }    \r\n        else{\r\n            t-&gt;rchild = s-&gt;lchild;    \r\n        }\r\n        free(s); \r\n    }\r\n    return find;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac4736893465-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac4736893465-77\">77</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-1\"><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_BST</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//返回一个标志，表示是否找到被删元素 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">find</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BT</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">find</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//寻找被删元素 </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//找到被删元素 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-8\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">find</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//沿左子树找 </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-11\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-12\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">//沿右子树找 </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">//没找到 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"没有找到\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">endl</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-22\"><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//p为叶子节点 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//p为根节点 </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-25\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">   </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-28\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">        </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-31\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//释放节点p </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//p为单支子树 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//p为根节点 </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-37\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-38\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-39\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-40\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-41\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-42\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-45\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//p是q的左子树且p有左子树 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-46\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//将p的左子树链接到q的左指针上 </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-47\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-48\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-49\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-50\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-51\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-52\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-54\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-55\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-56\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-58\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-59\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-60\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//p的左右子树均不为空 </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-61\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-62\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//从p的左子节点开始 </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-63\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//找到p的前驱，即p左子树中值最大的节点 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-64\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">   </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-65\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-66\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-67\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">//把节点s的值赋给p </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-68\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-69\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-70\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-71\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-72\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">t</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-73\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-74\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-75\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac4736893465-76\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">find</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac4736893465-77\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0117 seconds] -->\r\n<p>查找操作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c7f3872ac9459354894\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npnode search_BST(pnode p, int x)\r\n{\r\n    bool solve = false;\r\n    while(p &amp;&amp; !solve){\r\n        if(x == p-&gt;val){\r\n            solve = true;    \r\n        }    \r\n        else if(x &lt; p-&gt;val){\r\n            p = p-&gt;lchild;    \r\n        }\r\n        else{\r\n            p = p-&gt;rchild;    \r\n        }\r\n    }\r\n    if(p == NULL){\r\n        cout &lt;&lt; \"没有找到\" &lt;&lt; x &lt;&lt; endl;    \r\n    } \r\n    return p;\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac9459354894-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac9459354894-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac9459354894-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac9459354894-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac9459354894-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac9459354894-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac9459354894-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac9459354894-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac9459354894-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac9459354894-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac9459354894-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac9459354894-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac9459354894-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac9459354894-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac9459354894-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac9459354894-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac9459354894-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ac9459354894-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ac9459354894-19\">19</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c7f3872ac9459354894-1\"><span class=\"crayon-e\">pnode </span><span class=\"crayon-e\">search_BST</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac9459354894-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac9459354894-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">solve</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac9459354894-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">solve</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac9459354894-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac9459354894-6\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">solve</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac9459354894-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac9459354894-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac9459354894-9\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac9459354894-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac9459354894-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac9459354894-12\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac9459354894-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac9459354894-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac9459354894-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac9459354894-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"没有找到\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">endl</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac9459354894-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ac9459354894-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ac9459354894-19\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0028 seconds] -->\r\n<p></p>\n<h1 class=\"First\">3. 平衡二叉树</h1>\n<p>我们知道，对于一般的二叉搜索树（Binary Search Tree），其期望高度（即为一棵平衡树时）为log<sub>2</sub>n，其各操作的时间复杂度O(log<sub>2</sub>n)同时也由此而决定。但是，在某些极端的情况下（如在插入的序列是有序的时），二叉搜索树将退化成近似链或链，此时，其操作的时间复杂度将退化成线性的，即O(n)。我们可以通过随机化建立二叉搜索树来尽量的避免这种情况，但是在进行了多次的操作之后，由于在删除时，我们总是选择将待删除节点的后继代替它本身，这样就会造成总是右边的节点数目减少，以至于树向左偏沉。这同时也会造成树的平衡性受到破坏，提高它的操作的时间复杂度。于是就有了我们下边介绍的平衡二叉树。</p>\n<p><strong>平衡二叉树定义：</strong>平衡二叉树（Balanced Binary Tree）又被称为AVL树（有别于AVL算法），且具有以下性质：它是一 棵空树或它的左右两个子树的高度差的绝对值不超过1，并且左右两个子树都是一棵平衡二叉树。平衡二叉树的常用算法有红黑树、AVL树等。在平衡二叉搜索树中，我们可以看到，其高度一般都良好地维持在O(log<sub>2</sub>n)，大大降低了操作的时间复杂度。</p>\n<p>最小二叉平衡树的节点的公式如下：</p>\n<p>F(n)=F(n-1)+F(n-2)+1</p>\n<p>这个类似于一个递归的数列，可以参考Fibonacci数列，1是根节点，F(n-1)是左子树的节点数量，F(n-2)是右子树的节点数量。</p>\n<h2 class=\"First\">3.1 平衡查找树之AVL树</h2>\n<p>有关AVL树的具体实现，可以参考<a href=\"http://www.cppblog.com/cxiaojia/archive/2012/08/20/187776.html\" target=\"_blank\">C小加的博客《一步一步写平衡二叉树（AVL）》</a>。</p>\n<p><strong>AVL树定义：</strong>AVL树是最先发明的自平衡二叉查找树。AVL树得名于它的发明者 G.M. Adelson-Velsky 和 E.M. Landis，他们在 1962 年的论文 “An algorithm for the organization of information” 中发表了它。在AVL中任何节点的两个儿子子树的高度最大差别为1，所以它也被称为高度平衡树，n个结点的AVL树最大深度约1.44log<sub>2</sub>n。查找、插入和删除在平均和最坏情况下都是O(logn)。增加和删除可能需要通过一次或多次树旋转来重新平衡这个树。<strong>这个方案很好的解决了二叉查找树退化成链表的问题，把插入，查找，删除的时间复杂度最好情况和最坏情况都维持在O(logN)。但是频繁旋转会使插入和删除牺牲掉O(logN)左右的时间，不过相对二叉查找树来说，时间上稳定了很多。</strong></p>\n<p><strong>AVL树的自平衡操作——旋转：</strong></p>\n<p>AVL树最关键的也是最难的一步操作就是<strong>旋转</strong>。旋转主要是为了实现AVL树在实施了插入和删除操作以后，树重新回到平衡的方法。下面我们重点研究一下AVL树的旋转。</p>\n<p>对于一个平衡的节点，由于任意节点最多有两个儿子，因此高度不平衡时，此节点的两颗子树的高度差2.容易看出，这种不平衡出现在下面四种情况：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/bbc1d195a4adf1a9cc10bb85b0f1c2c6.jpg\"><img class=\"aligncenter wp-image-111687 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bbc1d195a4adf1a9cc10bb85b0f1c2c6.jpg\" alt=\"2012082016021366\" width=\"785\" height=\"306\"></a></p>\n<p>1) 6节点的左子树3节点高度比右子树7节点大2，左子树3节点的左子树1节点高度大于右子树4节点，这种情况成为左左。</p>\n<p>2) 6节点的左子树2节点高度比右子树7节点大2，左子树2节点的左子树1节点高度小于右子树4节点，这种情况成为左右。</p>\n<p>3) 2节点的左子树1节点高度比右子树5节点小2，右子树5节点的左子树3节点高度大于右子树6节点，这种情况成为右左。</p>\n<p>4) 2节点的左子树1节点高度比右子树4节点小2，右子树4节点的左子树3节点高度小于右子树6节点，这种情况成为右右。</p>\n<p>从图2中可以可以看出，1和4两种情况是对称的，这两种情况的旋转算法是一致的，只需要经过一次旋转就可以达到目标，我们称之为单旋转。2和3两种情况也是对称的，这两种情况的旋转算法也是一致的，需要进行两次旋转，我们称之为双旋转。</p>\n<p><strong>单旋转</strong></p>\n<p>单旋转是针对于左左和右右这两种情况的解决方案，这两种情况是对称的，只要解决了左左这种情况，右右就很好办了。图3是左左情况的解决方案，节点k2不满足平衡特性，因为它的左子树k1比右子树Z深2层，而且k1子树中，更深的一层的是k1的左子树X子树，所以属于左左情况。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/61ee0c83b3783cb05eac2ed3528eae3b.jpg\"><img class=\"aligncenter wp-image-111688 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/61ee0c83b3783cb05eac2ed3528eae3b.jpg\" alt=\"avltree35\" width=\"530\" height=\"229\"></a></p>\n<p>为使树恢复平衡，我们把k2变成这棵树的根节点，因为k2大于k1，把k2置于k1的右子树上，而原本在k1右子树的Y大于k1，小于k2，就把Y置于k2的左子树上，这样既满足了二叉查找树的性质，又满足了平衡二叉树的性质。</p>\n<p>这样的操作只需要一部分指针改变，结果我们得到另外一颗二叉查找树，它是一棵AVL树，因为X向上一移动了一层，Y还停留在原来的层面上，Z向下移动了一层。整棵树的新高度和之前没有在左子树上插入的高度相同，插入操作使得X高度长高了。因此，由于这颗子树高度没有变化，所以通往根节点的路径就不需要继续旋转了。</p>\n<p><strong>双旋转</strong></p>\n<p>对于左右和右左这两种情况，单旋转不能使它达到一个平衡状态，要经过两次旋转。双旋转是针对于这两种情况的解决方案，同样的，这样两种情况也是对称的，只要解决了左右这种情况，右左就很好办了。图4是左右情况的解决方案，节点k3不满足平衡特性，因为它的左子树k1比右子树Z深2层，而且k1子树中，更深的一层的是k1的右子树k2子树，所以属于左右情况。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/2ad609dadbff982036a8e32c792436d7.jpg\"><img class=\"aligncenter wp-image-111690 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2ad609dadbff982036a8e32c792436d7.jpg\" alt=\"2012082016534455\" width=\"785\" height=\"247\"></a></p>\n<p>为使树恢复平衡，我们需要进行两步，第一步，把k1作为根，进行一次右右旋转，旋转之后就变成了左左情况，所以第二步再进行一次左左旋转，最后得到了一棵以k2为根的平衡二叉树。</p>\n<p><strong>AVL树实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c7f3872ad1253702623\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//AVL树节点信息\r\ntemplate&lt;class T&gt;\r\nclass TreeNode\r\n{\r\n    public:\r\n        TreeNode():lson(NULL),rson(NULL),freq(1),hgt(0){}\r\n        T data;//值\r\n        int hgt;//高度\r\n        unsigned int freq;//频率\r\n        TreeNode* lson;//指向左儿子的地址\r\n        TreeNode* rson;//指向右儿子的地址\r\n};\r\n//AVL树类的属性和方法声明\r\ntemplate&lt;class T&gt;\r\nclass AVLTree\r\n{\r\n    private:\r\n        TreeNode&lt;T&gt;* root;//根节点\r\n        void insertpri(TreeNode&lt;T&gt;* &amp;node,T x);//插入\r\n        TreeNode&lt;T&gt;* findpri(TreeNode&lt;T&gt;* node,T x);//查找\r\n        void insubtree(TreeNode&lt;T&gt;* node);//中序遍历\r\n        void Deletepri(TreeNode&lt;T&gt;* &amp;node,T x);//删除\r\n        int height(TreeNode&lt;T&gt;* node);//求树的高度\r\n        void SingRotateLeft(TreeNode&lt;T&gt;* &amp;k2);//左左情况下的旋转\r\n        void SingRotateRight(TreeNode&lt;T&gt;* &amp;k2);//右右情况下的旋转\r\n        void DoubleRotateLR(TreeNode&lt;T&gt;* &amp;k3);//左右情况下的旋转\r\n        void DoubleRotateRL(TreeNode&lt;T&gt;* &amp;k3);//右左情况下的旋转\r\n        int Max(int cmpa,int cmpb);//求最大值\r\n\r\n    public:\r\n        AVLTree():root(NULL){}\r\n        void insert(T x);//插入接口\r\n        TreeNode&lt;T&gt;* find(T x);//查找接口\r\n        void Delete(T x);//删除接口\r\n        void traversal();//遍历接口\r\n\r\n};\r\n//计算节点的高度\r\ntemplate&lt;class T&gt;\r\nint AVLTree&lt;T&gt;::height(TreeNode&lt;T&gt;* node)\r\n{\r\n    if(node!=NULL)\r\n        return node-&gt;hgt;\r\n    return -1;\r\n}\r\n//求最大值\r\ntemplate&lt;class T&gt;\r\nint AVLTree&lt;T&gt;::Max(int cmpa,int cmpb)\r\n{\r\n    return cmpa&gt;cmpb?cmpa:cmpb;\r\n}\r\n//左左情况下的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::SingRotateLeft(TreeNode&lt;T&gt;* &amp;k2)\r\n{\r\n    TreeNode&lt;T&gt;* k1;\r\n    k1=k2-&gt;lson;\r\n    k2-&gt;lson=k1-&gt;rson;\r\n    k1-&gt;rson=k2;\r\n\r\n    k2-&gt;hgt=Max(height(k2-&gt;lson),height(k2-&gt;rson))+1;\r\n    k1-&gt;hgt=Max(height(k1-&gt;lson),k2-&gt;hgt)+1;\r\n}\r\n//右右情况下的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::SingRotateRight(TreeNode&lt;T&gt;* &amp;k2)\r\n{\r\n    TreeNode&lt;T&gt;* k1;\r\n    k1=k2-&gt;rson;\r\n    k2-&gt;rson=k1-&gt;lson;\r\n    k1-&gt;lson=k2;\r\n\r\n    k2-&gt;hgt=Max(height(k2-&gt;lson),height(k2-&gt;rson))+1;\r\n    k1-&gt;hgt=Max(height(k1-&gt;rson),k2-&gt;hgt)+1;\r\n}\r\n//左右情况的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::DoubleRotateLR(TreeNode&lt;T&gt;* &amp;k3)\r\n{\r\n    SingRotateRight(k3-&gt;lson);\r\n    SingRotateLeft(k3);\r\n}\r\n//右左情况的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::DoubleRotateRL(TreeNode&lt;T&gt;* &amp;k3)\r\n{\r\n    SingRotateLeft(k3-&gt;rson);\r\n    SingRotateRight(k3);\r\n}\r\n//插入\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::insertpri(TreeNode&lt;T&gt;* &amp;node,T x)\r\n{\r\n    if(node==NULL)//如果节点为空,就在此节点处加入x信息\r\n    {\r\n        node=new TreeNode&lt;T&gt;();\r\n        node-&gt;data=x;\r\n        return;\r\n    }\r\n    if(node-&gt;data&gt;x)//如果x小于节点的值,就继续在节点的左子树中插入x\r\n    {\r\n        insertpri(node-&gt;lson,x);\r\n        if(2==height(node-&gt;lson)-height(node-&gt;rson))\r\n            if(x&lt;node-&gt;lson-&gt;data)\r\n                SingRotateLeft(node);\r\n            else\r\n                DoubleRotateLR(node);\r\n    }\r\n    else if(node-&gt;data&lt;x)//如果x大于节点的值,就继续在节点的右子树中插入x\r\n    {\r\n        insertpri(node-&gt;rson,x);\r\n        if(2==height(node-&gt;rson)-height(node-&gt;lson))//如果高度之差为2的话就失去了平衡,需要旋转\r\n            if(x&gt;node-&gt;rson-&gt;data)\r\n                SingRotateRight(node);\r\n            else\r\n                DoubleRotateRL(node);\r\n    }\r\n    else ++(node-&gt;freq);//如果相等,就把频率加1\r\n    node-&gt;hgt=Max(height(node-&gt;lson),height(node-&gt;rson));\r\n}\r\n//插入接口\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::insert(T x)\r\n{\r\n    insertpri(root,x);\r\n}\r\n//查找\r\ntemplate&lt;class T&gt;\r\nTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::findpri(TreeNode&lt;T&gt;* node,T x)\r\n{\r\n    if(node==NULL)//如果节点为空说明没找到,返回NULL\r\n    {\r\n        return NULL;\r\n    }\r\n    if(node-&gt;data&gt;x)//如果x小于节点的值,就继续在节点的左子树中查找x\r\n    {\r\n        return findpri(node-&gt;lson,x);\r\n    }\r\n    else if(node-&gt;data&lt;x)//如果x大于节点的值,就继续在节点的左子树中查找x\r\n    {\r\n        return findpri(node-&gt;rson,x);\r\n    }\r\n    else return node;//如果相等,就找到了此节点\r\n}\r\n//查找接口\r\ntemplate&lt;class T&gt;\r\nTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::find(T x)\r\n{\r\n    return findpri(root,x);\r\n}\r\n//删除\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::Deletepri(TreeNode&lt;T&gt;* &amp;node,T x)\r\n{\r\n    if(node==NULL) return ;//没有找到值是x的节点\r\n    if(x &lt; node-&gt;data)\r\n    {\r\n         Deletepri(node-&gt;lson,x);//如果x小于节点的值,就继续在节点的左子树中删除x\r\n         if(2==height(node-&gt;rson)-height(node-&gt;lson))\r\n            if(node-&gt;rson-&gt;lson!=NULL&amp;&amp;(height(node-&gt;rson-&gt;lson)&gt;height(node-&gt;rson-&gt;rson)) )\r\n                DoubleRotateRL(node);\r\n            else\r\n                SingRotateRight(node);\r\n    }\r\n\r\n    else if(x &gt; node-&gt;data)\r\n    {\r\n         Deletepri(node-&gt;rson,x);//如果x大于节点的值,就继续在节点的右子树中删除x\r\n         if(2==height(node-&gt;lson)-height(node-&gt;rson))\r\n            if(node-&gt;lson-&gt;rson!=NULL&amp;&amp; (height(node-&gt;lson-&gt;rson)&gt;height(node-&gt;lson-&gt;lson) ))\r\n                DoubleRotateLR(node);\r\n            else\r\n                SingRotateLeft(node);\r\n    }\r\n\r\n    else//如果相等,此节点就是要删除的节点\r\n    {\r\n        if(node-&gt;lson&amp;&amp;node-&gt;rson)//此节点有两个儿子\r\n        {\r\n            TreeNode&lt;T&gt;* temp=node-&gt;rson;//temp指向节点的右儿子\r\n            while(temp-&gt;lson!=NULL) temp=temp-&gt;lson;//找到右子树中值最小的节点\r\n            //把右子树中最小节点的值赋值给本节点\r\n            node-&gt;data=temp-&gt;data;\r\n            node-&gt;freq=temp-&gt;freq;\r\n            Deletepri(node-&gt;rson,temp-&gt;data);//删除右子树中最小值的节点\r\n            if(2==height(node-&gt;lson)-height(node-&gt;rson))\r\n            {\r\n                if(node-&gt;lson-&gt;rson!=NULL&amp;&amp; (height(node-&gt;lson-&gt;rson)&gt;height(node-&gt;lson-&gt;lson) ))\r\n                    DoubleRotateLR(node);\r\n                else\r\n                    SingRotateLeft(node);\r\n            }\r\n        }\r\n        else//此节点有1个或0个儿子\r\n        {\r\n            TreeNode&lt;T&gt;* temp=node;\r\n            if(node-&gt;lson==NULL)//有右儿子或者没有儿子\r\n            node=node-&gt;rson;\r\n            else if(node-&gt;rson==NULL)//有左儿子\r\n            node=node-&gt;lson;\r\n            delete(temp);\r\n            temp=NULL;\r\n        }\r\n    }\r\n    if(node==NULL) return;\r\n    node-&gt;hgt=Max(height(node-&gt;lson),height(node-&gt;rson))+1;\r\n    return;\r\n}\r\n//删除接口\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::Delete(T x)\r\n{\r\n    Deletepri(root,x);\r\n}\r\n//中序遍历函数\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::insubtree(TreeNode&lt;T&gt;* node)\r\n{\r\n    if(node==NULL) return;\r\n    insubtree(node-&gt;lson);//先遍历左子树\r\n    cout&lt;&lt;node-&gt;data&lt;&lt;\" \";//输出根节点\r\n    insubtree(node-&gt;rson);//再遍历右子树\r\n}\r\n//中序遍历接口\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::traversal()\r\n{\r\n    insubtree(root);\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-77\">77</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-78\">78</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-79\">79</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-80\">80</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-81\">81</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-82\">82</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-83\">83</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-84\">84</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-85\">85</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-86\">86</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-87\">87</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-88\">88</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-89\">89</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-90\">90</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-91\">91</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-92\">92</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-93\">93</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-94\">94</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-95\">95</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-96\">96</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-97\">97</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-98\">98</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-99\">99</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-100\">100</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-101\">101</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-102\">102</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-103\">103</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-104\">104</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-105\">105</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-106\">106</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-107\">107</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-108\">108</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-109\">109</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-110\">110</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-111\">111</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-112\">112</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-113\">113</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-114\">114</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-115\">115</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-116\">116</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-117\">117</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-118\">118</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-119\">119</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-120\">120</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-121\">121</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-122\">122</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-123\">123</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-124\">124</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-125\">125</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-126\">126</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-127\">127</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-128\">128</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-129\">129</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-130\">130</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-131\">131</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-132\">132</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-133\">133</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-134\">134</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-135\">135</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-136\">136</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-137\">137</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-138\">138</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-139\">139</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-140\">140</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-141\">141</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-142\">142</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-143\">143</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-144\">144</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-145\">145</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-146\">146</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-147\">147</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-148\">148</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-149\">149</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-150\">150</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-151\">151</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-152\">152</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-153\">153</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-154\">154</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-155\">155</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-156\">156</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-157\">157</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-158\">158</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-159\">159</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-160\">160</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-161\">161</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-162\">162</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-163\">163</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-164\">164</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-165\">165</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-166\">166</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-167\">167</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-168\">168</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-169\">169</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-170\">170</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-171\">171</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-172\">172</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-173\">173</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-174\">174</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-175\">175</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-176\">176</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-177\">177</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-178\">178</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-179\">179</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-180\">180</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-181\">181</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-182\">182</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-183\">183</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-184\">184</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-185\">185</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-186\">186</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-187\">187</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-188\">188</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-189\">189</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-190\">190</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-191\">191</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-192\">192</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-193\">193</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-194\">194</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-195\">195</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-196\">196</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-197\">197</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-198\">198</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-199\">199</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-200\">200</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-201\">201</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-202\">202</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-203\">203</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-204\">204</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-205\">205</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-206\">206</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-207\">207</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-208\">208</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-209\">209</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-210\">210</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-211\">211</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-212\">212</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-213\">213</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-214\">214</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-215\">215</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-216\">216</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-217\">217</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-218\">218</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-219\">219</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-220\">220</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-221\">221</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-222\">222</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-223\">223</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-224\">224</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-225\">225</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-226\">226</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-227\">227</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ad1253702623-228\">228</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ad1253702623-229\">229</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-1\"><span class=\"crayon-c\">//AVL树节点信息</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-2\"><span class=\"crayon-e\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-3\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TreeNode</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-4\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">TreeNode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">lson</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">rson</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">freq</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">hgt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//值</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//高度</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">freq</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//频率</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">TreeNode*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//指向左儿子的地址</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">TreeNode*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//指向右儿子的地址</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-12\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-13\"><span class=\"crayon-c\">//AVL树类的属性和方法声明</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-14\"><span class=\"crayon-e\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-15\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AVLTree</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-16\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//根节点</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//插入</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//查找</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//中序遍历</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//删除</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//求树的高度</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//左左情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//右右情况下的旋转</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//左右情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//右左情况下的旋转</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-sy\">,</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//求最大值</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-29\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-31\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">AVLTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">root</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//插入接口</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">find</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//查找接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-34\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//删除接口</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">traversal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//遍历接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-36\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-37\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-38\"><span class=\"crayon-c\">//计算节点的高度</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-39\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-40\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-41\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-42\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-44\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-45\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-46\"><span class=\"crayon-c\">//求最大值</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-47\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-48\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-sy\">,</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-49\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-50\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">?</span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-51\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-52\"><span class=\"crayon-c\">//左左情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-53\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-54\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-55\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-56\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-57\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-58\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-59\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-60\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-61\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-62\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-63\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-64\"><span class=\"crayon-c\">//右右情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-65\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-66\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-67\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-68\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-69\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-70\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-71\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-72\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-73\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-74\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-75\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-76\"><span class=\"crayon-c\">//左右情况的旋转</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-77\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-78\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-79\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-80\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-81\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-82\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-83\"><span class=\"crayon-c\">//右左情况的旋转</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-84\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-85\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-86\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-87\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-88\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-89\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-90\"><span class=\"crayon-c\">//插入</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-91\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-92\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-93\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-94\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果节点为空,就在此节点处加入x信息</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-95\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-96\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">=</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-97\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-98\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-99\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-100\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x小于节点的值,就继续在节点的左子树中插入x</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-101\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-102\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-103\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-104\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-105\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-106\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-107\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-108\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-109\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x大于节点的值,就继续在节点的右子树中插入x</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-110\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-111\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-112\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果高度之差为2的话就失去了平衡,需要旋转</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-113\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-114\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-115\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-116\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-117\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-118\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">freq</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果相等,就把频率加1</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-119\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-120\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-121\"><span class=\"crayon-c\">//插入接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-122\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-123\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-124\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-125\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-126\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-127\"><span class=\"crayon-c\">//查找</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-128\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-129\"><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-130\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-131\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果节点为空说明没找到,返回NULL</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-132\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-133\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-134\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-135\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x小于节点的值,就继续在节点的左子树中查找x</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-136\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-137\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-138\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-139\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x大于节点的值,就继续在节点的左子树中查找x</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-140\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-141\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-142\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-143\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果相等,就找到了此节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-144\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-145\"><span class=\"crayon-c\">//查找接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-146\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-147\"><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">find</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-148\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-149\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-150\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-151\"><span class=\"crayon-c\">//删除</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-152\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-153\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-154\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-155\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//没有找到值是x的节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-156\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-157\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-158\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果x小于节点的值,就继续在节点的左子树中删除x</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-159\"><span class=\"crayon-h\">         </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-160\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-161\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-162\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-163\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-164\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-165\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-166\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-167\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-168\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果x大于节点的值,就继续在节点的右子树中删除x</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-169\"><span class=\"crayon-h\">         </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-170\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-171\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-172\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-173\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-174\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-175\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-176\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-c\">//如果相等,此节点就是要删除的节点</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-177\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-178\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//此节点有两个儿子</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-179\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-180\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//temp指向节点的右儿子</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-181\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//找到右子树中值最小的节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-182\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">//把右子树中最小节点的值赋值给本节点</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-183\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-184\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">freq</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">freq</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-185\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//删除右子树中最小值的节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-186\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-187\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-188\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-189\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-190\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-191\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-192\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-193\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-194\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-c\">//此节点有1个或0个儿子</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-195\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-196\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-197\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//有右儿子或者没有儿子</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-198\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-199\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//有左儿子</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-200\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-201\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-202\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-203\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-204\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-205\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-206\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-207\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-208\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-209\"><span class=\"crayon-c\">//删除接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-210\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-211\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">Delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-212\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-213\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-214\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-215\"><span class=\"crayon-c\">//中序遍历函数</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-216\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-217\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-218\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-219\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-220\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//先遍历左子树</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-221\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">cout</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-s\">\" \"</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//输出根节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-222\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//再遍历右子树</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-223\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-224\"><span class=\"crayon-c\">//中序遍历接口</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-225\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-226\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">traversal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-227\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ad1253702623-228\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ad1253702623-229\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0329 seconds] -->\r\n<p></p>\n<h2 class=\"First\">3.2 平衡二叉树之红黑树</h2>\n<p><strong>红黑树的定义：</strong>红黑树是一种自平衡二叉查找树，是在计算机科学中用到的一种数据结构，典型的用途是实现关联数组。它是在1972年由鲁道夫·贝尔发明的，称之为”对称二叉B树”，它现代的名字是在 Leo J. Guibas 和 Robert Sedgewick 于1978年写的一篇论文中获得的。<strong>它是复杂的，但它的操作有着良好的最坏情况运行时间，并且在实践中是高效的: 它可以在O(logn)时间内做查找，插入和删除，这里的n是树中元素的数目。</strong></p>\n<p>红黑树和AVL树一样都对插入时间、删除时间和查找时间提供了最好可能的最坏情况担保。这不只是使它们在时间敏感的应用如实时应用（real time application）中有价值，而且使它们有在提供最坏情况担保的其他数据结构中作为建造板块的价值；例如，在计算几何中使用的很多数据结构都可以基于红黑树。此外，红黑树还是2-3-4树的一种等同，它们的思想是一样的，只不过红黑树是2-3-4树用二叉树的形式表示的。</p>\n<p><strong>红黑树的性质：</strong></p>\n<p>红黑树是每个节点都带有颜色属性的二叉查找树，颜色为红色或黑色。在二叉查找树强制的一般要求以外，对于任何有效的红黑树我们增加了如下的额外要求:</p>\n<p>性质1. 节点是红色或黑色。</p>\n<p>性质2. 根是黑色。</p>\n<p>性质3. 所有叶子都是黑色（叶子是NIL节点）。</p>\n<p>性质4. 每个红色节点必须有两个黑色的子节点。(从每个叶子到根的所有路径上不能有两个连续的红色节点。)</p>\n<p>性质5. 从任一节点到其每个叶子的所有简单路径都包含相同数目的黑色节点。</p>\n<p>下面是一个具体的红黑树的图例：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/9fd5e683147961431e0ecfcffbe5805b.png\"><img class=\"aligncenter wp-image-111691 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9fd5e683147961431e0ecfcffbe5805b.png\" alt=\"450px-Red-black_tree_example.svg\" width=\"450\" height=\"217\"></a></p>\n<p>这些约束确保了红黑树的关键特性: 从根到叶子的最长的可能路径不多于最短的可能路径的两倍长。结果是这个树大致上是平衡的。因为操作比如插入、删除和查找某个值的最坏情况时间都要求与树的高度成比例，这个在高度上的理论上限允许红黑树在最坏情况下都是高效的，而不同于普通的二叉查找树。</p>\n<p>要知道为什么这些性质确保了这个结果，注意到性质4导致了路径不能有两个毗连的红色节点就足够了。最短的可能路径都是黑色节点，最长的可能路径有交替的红色和黑色节点。因为根据性质5所有最长的路径都有相同数目的黑色节点，这就表明了没有路径能多于任何其他路径的两倍长。</p>\n<p>以下内容整理自<a href=\"https://zh.wikipedia.org/wiki/%E7%BA%A2%E9%BB%91%E6%A0%91\" target=\"_blank\">wiki百科之红黑树</a>。</p>\n<p><strong>红黑树的自平衡操作：</strong></p>\n<p>因为每一个红黑树也是一个特化的二叉查找树，因此红黑树上的只读操作与普通二叉查找树上的只读操作相同。然而，在红黑树上进行插入操作和删除操作会导致不再符合红黑树的性质。恢复红黑树的性质需要少量(O(logn))的颜色变更(实际是非常快速的)和不超过三次树旋转(对于插入操作是两次)。虽然插入和删除很复杂，但操作时间仍可以保持为O(logn) 次。</p>\n<p><strong>我们首先以二叉查找树的方法增加节点并标记它为红色。如果设为黑色，就会导致根到叶子的路径上有一条路上，多一个额外的黑节点，这个是很难调整的（违背性质5）。</strong>但是设为红色节点后，可能会导致出现两个连续红色节点的冲突，那么可以通过颜色调换（color flips）和树旋转来调整。下面要进行什么操作取决于其他临近节点的颜色。同人类的家族树中一样，我们将使用术语叔父节点来指一个节点的父节点的兄弟节点。注意:</p>\n<ul>\n<li>性质1和性质3总是保持着。</li>\n<li>性质4只在增加红色节点、重绘黑色节点为红色，或做旋转时受到威胁。</li>\n<li>性质5只在增加黑色节点、重绘红色节点为黑色，或做旋转时受到威胁。</li>\n</ul>\n<p><strong>插入操作：</strong></p>\n<p>假设，将要插入的节点标为<strong>N</strong>，N的父节点标为<strong>P</strong>，N的祖父节点标为<strong>G</strong>，N的叔父节点标为<strong>U</strong>。在图中展示的任何颜色要么是由它所处情形这些所作的假定，要么是假定所暗含的。</p>\n<p><strong>情形1: </strong>该树为空树，直接插入根结点的位置，违反性质1，把节点颜色有红改为黑即可。</p>\n<p><strong>情形2:</strong> 插入节点N的父节点P为黑色，不违反任何性质，无需做任何修改。在这种情形下，树仍是有效的。性质5也未受到威胁，尽管新节点N有两个黑色叶子子节点；但由于新节点N是红色，通过它的每个子节点的路径就都有同通过它所取代的黑色的叶子的路径同样数目的黑色节点，所以依然满足这个性质。</p>\n<p>注： 情形1很简单，情形2中P为黑色，一切安然无事，但P为红就不一样了，下边是P为红的各种情况，也是真正难懂的地方。</p>\n<p><strong>情形3: </strong>如果父节点P和叔父节点U二者都是红色，(此时新插入节点N做为P的左子节点或右子节点都属于情形3,这里右图仅显示N做为P左子的情形)则我们可以将它们两个重绘为黑色并重绘祖父节点G为红色(用来保持性质4)。现在我们的新节点N有了一个黑色的父节点P。因为通过父节点P或叔父节点U的任何路径都必定通过祖父节点G，在这些路径上的黑节点数目没有改变。但是，红色的祖父节点G的父节点也有可能是红色的，这就违反了性质4。为了解决这个问题，我们在祖父节点G上递归地进行上述情形的整个过程（把G当成是新加入的节点进行各种情形的检查）。比如，G为根节点，那我们就直接将G变为黑色（情形1）；如果G不是根节点，而它的父节点为黑色，那符合所有的性质，直接插入即可（情形2）；如果G不是根节点，而它的父节点为红色，则递归上述过程（情形3）。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/dc3747336812e9055f958c56ade89eb8.png\"><img class=\"aligncenter wp-image-111692 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/dc3747336812e9055f958c56ade89eb8.png\" alt=\"2011120116425251\" width=\"300\" height=\"139\"></a></p>\n<p><strong>情形4:</strong> 父节点P是红色而叔父节点U是黑色或缺少，新节点N是其父节点的左子节点，而父节点P又是其父节点G的左子节点。在这种情形下，我们进行针对祖父节点G的一次右旋转; 在旋转产生的树中，以前的父节点P现在是新节点N和以前的祖父节点G的父节点。我们知道以前的祖父节点G是黑色，否则父节点P就不可能是红色(如果P和G都是红色就违反了性质4，所以G必须是黑色)。我们切换以前的父节点P和祖父节点G的颜色，结果的树满足性质4。性质5也仍然保持满足，因为通过这三个节点中任何一个的所有路径以前都通过祖父节点G，现在它们都通过以前的父节点P。在各自的情形下，这都是三个节点中唯一的黑色节点。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/4986c959603100e41cba2669d9e3ce0c.png\"><img class=\"aligncenter wp-image-111693 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4986c959603100e41cba2669d9e3ce0c.png\" alt=\"Red-black_tree_insert_case_5\" width=\"310\" height=\"138\"></a></p>\n<p><strong>情形5:</strong> 父节点P是红色而叔父节点U是黑色或缺少，并且新节点N是其父节点P的右子节点而父节点P又是其父节点的左子节点。在这种情形下，我们进行一次左旋转调换新节点和其父节点的角色; 接着，我们按<strong>情形4</strong>处理以前的父节点P以解决仍然失效的性质4。注意这个改变会导致某些路径通过它们以前不通过的新节点N（比如图中1号叶子节点）或不通过节点P（比如图中3号叶子节点），但由于这两个节点都是红色的，所以性质5仍有效。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/9cfbf62dfdefe5891347de95a976758f.png\"><img class=\"aligncenter wp-image-111694 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9cfbf62dfdefe5891347de95a976758f.png\" alt=\"Red-black_tree_insert_case_5\" width=\"283\" height=\"138\"></a></p>\n<p><strong>注: 插入实际上是原地算法，因为上述所有调用都使用了尾部递归。</strong></p>\n<p><strong>删除操作：</strong></p>\n<p><strong>如果需要删除的节点有两个儿子，那么问题可以被转化成删除另一个只有一个儿子的节点的问题</strong>。对于二叉查找树，在删除带有两个非叶子儿子的节点的时候，我们找到要么在它的左子树中的最大元素、要么在它的右子树中的最小元素，并把它的值转移到要删除的节点中。我们接着删除我们从中复制出值的那个节点，它必定有少于两个非叶子的儿子。因为只是复制了一个值，不违反任何性质，这就把问题简化为如何删除最多有一个儿子的节点的问题。它不关心这个节点是最初要删除的节点还是我们从中复制出值的那个节点。</p>\n<p><strong>我们只需要讨论删除只有一个儿子的节点</strong>(如果它两个儿子都为空，即均为叶子，我们任意将其中一个看作它的儿子)。如果我们删除一个红色节点（此时该节点的儿子将都为叶子节点），它的父亲和儿子一定是黑色的。所以我们可以简单的用它的黑色儿子替换它，并不会破坏性质3和性质4。通过被删除节点的所有路径只是少了一个红色节点，这样可以继续保证性质5。另一种简单情况是在被删除节点是黑色而它的儿子是红色的时候。如果只是去除这个黑色节点，用它的红色儿子顶替上来的话，会破坏性质5，但是如果我们重绘它的儿子为黑色，则曾经通过它的所有路径将通过它的黑色儿子，这样可以继续保持性质5。</p>\n<p><strong>需要进一步讨论的是在要删除的节点和它的儿子二者都是黑色的时候</strong>，这是一种复杂的情况。我们首先把要删除的节点替换为它的儿子。出于方便，称呼这个儿子为<strong>N</strong>(在新的位置上)，称呼它的兄弟(它父亲的另一个儿子)为<strong>S</strong>。在下面的示意图中，我们还是使用<strong>P</strong>称呼N的父亲，<strong>S<sub>L</sub></strong>称呼S的左儿子，<strong>S<sub>R</sub></strong>称呼S的右儿子。</p>\n<p>如果N和它初始的父亲是黑色，则删除它的父亲导致通过N的路径都比不通过它的路径少了一个黑色节点。因为这违反了性质5，树需要被重新平衡。有几种情形需要考虑:</p>\n<p><strong>情形1:</strong> N是新的根。在这种情形下，我们就做完了。我们从所有路径去除了一个黑色节点，而新根是黑色的，所以性质都保持着。</p>\n<p><strong>注意</strong>: 在情形2、5和6下，我们假定N是它父亲的左儿子。如果它是右儿子，则在这些情形下的左和右应当对调。</p>\n<p><strong>情形2:</strong> S是红色。在这种情形下我们在N的父亲上做左旋转，把红色兄弟转换成N的祖父，我们接着对调N的父亲和祖父的颜色。完成这两个操作后，尽管所有路径上黑色节点的数目没有改变，但现在N有了一个黑色的兄弟和一个红色的父亲（它的新兄弟是黑色因为它是红色S的一个儿子），所以我们可以接下去按<strong>情形4</strong>、<strong>情形5</strong>或<strong>情形6</strong>来处理。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/ce86b0e24e64c35067f5d087dc4c90ae.png\"><img class=\"aligncenter wp-image-111695 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/ce86b0e24e64c35067f5d087dc4c90ae.png\" alt=\"Red-black_tree_insert_case_5\" width=\"298\" height=\"136\"></a></p>\n<p><strong>情形3:</strong> N的父亲、S和S的儿子都是黑色的。在这种情形下，我们简单的重绘S为红色。结果是通过S的所有路径，它们就是以前<em>不</em>通过N的那些路径，都少了一个黑色节点。因为删除N的初始的父亲使通过N的所有路径少了一个黑色节点，这使事情都平衡了起来。但是，通过P的所有路径现在比不通过P的路径少了一个黑色节点，所以仍然违反性质5。要修正这个问题，我们要从<strong>情形1</strong>开始，在P上做重新平衡处理。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/30759b4136b3cd56ba31eb8d06a434d2.png\"><img class=\"aligncenter wp-image-111696 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/30759b4136b3cd56ba31eb8d06a434d2.png\" alt=\"Red-black_tree_insert_case_5\" width=\"313\" height=\"132\"></a></p>\n<p><strong>情形4:</strong> S和S的儿子都是黑色，但是N的父亲是红色。在这种情形下，我们简单的交换N的兄弟和父亲的颜色。这不影响不通过N的路径的黑色节点的数目，但是它在通过N的路径上对黑色节点数目增加了一，添补了在这些路径上删除的黑色节点。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/61bda9c9a89a3f9ea5f01ed990070a39.png\"><img class=\"aligncenter wp-image-111697 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/61bda9c9a89a3f9ea5f01ed990070a39.png\" alt=\"Red-black_tree_insert_case_5\" width=\"313\" height=\"132\"></a></p>\n<p><strong>情形5:</strong> S是黑色，S的左儿子是红色，S的右儿子是黑色，而N是它父亲的左儿子。在这种情形下我们在S上做右旋转，这样S的左儿子成为S的父亲和N的新兄弟。我们接着交换S和它的新父亲的颜色。所有路径仍有同样数目的黑色节点，但是现在N有了一个黑色兄弟，他的右儿子是红色的，所以我们进入了<strong>情形6</strong>。N和它的父亲都不受这个变换的影响。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/9f411d70951995007ad2a59fb747d160.png\"><img class=\"aligncenter wp-image-111698 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9f411d70951995007ad2a59fb747d160.png\" alt=\"Red-black_tree_insert_case_5\" width=\"247\" height=\"133\"></a></p>\n<p> </p>\n<p><strong>情形6:</strong> S是黑色，S的右儿子是红色，而N是它父亲的左儿子。在这种情形下我们在N的父亲上做左旋转，这样S成为N的父亲（P）和S的右儿子的父亲。我们接着交换N的父亲和S的颜色，并使S的右儿子为黑色。子树在它的根上的仍是同样的颜色，所以性质3没有被违反。但是，N现在增加了一个黑色祖先: 要么N的父亲变成黑色，要么它是黑色而S被增加为一个黑色祖父。所以，通过N的路径都增加了一个黑色节点。</p>\n<p>此时，如果一个路径不通过N，则有两种可能性:</p>\n<ul>\n<li>它通过N的新兄弟。那么它以前和现在都必定通过S和N的父亲，而它们只是交换了颜色。所以路径保持了同样数目的黑色节点。</li>\n<li>它通过N的新叔父，S的右儿子。那么它以前通过S、S的父亲和S的右儿子，但是现在只通过S，它被假定为它以前的父亲的颜色，和S的右儿子，它被从红色改变为黑色。合成效果是这个路径通过了同样数目的黑色节点。</li>\n</ul>\n<p>在任何情况下，在这些路径上的黑色节点数目都没有改变。所以我们恢复了性质4。在示意图中的白色节点可以是红色或黑色，但是在变换前后都必须指定相同的颜色。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/c0ea423eef5e175e0ba92e43ad17270d.png\"><img class=\"aligncenter wp-image-111699 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c0ea423eef5e175e0ba92e43ad17270d.png\" alt=\"Red-black_tree_insert_case_5\" width=\"299\" height=\"143\"></a></p>\n<p><strong>红黑树实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596c7f3872ae3953174496\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#define BLACK 1\r\n#define RED 0\r\n\r\nusing namespace std;\r\n\r\nclass bst {\r\nprivate:\r\n\r\n    struct Node {\r\n        int value;\r\n        bool color;\r\n        Node *leftTree, *rightTree, *parent;\r\n\r\n        Node() {\r\n            color = RED;\r\n            leftTree = NULL;\r\n            rightTree = NULL;\r\n            parent = NULL;\r\n            value = 0;\r\n        }\r\n\r\n        Node* grandparent() {\r\n            if (parent == NULL) {\r\n                return NULL;\r\n            }\r\n            return parent-&gt;parent;\r\n        }\r\n\r\n        Node* uncle() {\r\n            if (grandparent() == NULL) {\r\n                return NULL;\r\n            }\r\n            if (parent == grandparent()-&gt;rightTree)\r\n                return grandparent()-&gt;leftTree;\r\n            else\r\n                return grandparent()-&gt;rightTree;\r\n        }\r\n\r\n        Node* sibling() {\r\n            if (parent-&gt;leftTree == this)\r\n                return parent-&gt;rightTree;\r\n            else\r\n                return parent-&gt;leftTree;\r\n        }\r\n    };\r\n\r\n    void rotate_right(Node *p) {\r\n        Node *gp = p-&gt;grandparent();\r\n        Node *fa = p-&gt;parent;\r\n        Node *y = p-&gt;rightTree;\r\n\r\n        fa-&gt;leftTree = y;\r\n\r\n        if (y != NIL)\r\n            y-&gt;parent = fa;\r\n        p-&gt;rightTree = fa;\r\n        fa-&gt;parent = p;\r\n\r\n        if (root == fa)\r\n            root = p;\r\n        p-&gt;parent = gp;\r\n\r\n        if (gp != NULL) {\r\n            if (gp-&gt;leftTree == fa)\r\n                gp-&gt;leftTree = p;\r\n            else\r\n                gp-&gt;rightTree = p;\r\n        }\r\n\r\n    }\r\n\r\n    void rotate_left(Node *p) {\r\n        if (p-&gt;parent == NULL) {\r\n            root = p;\r\n            return;\r\n        }\r\n        Node *gp = p-&gt;grandparent();\r\n        Node *fa = p-&gt;parent;\r\n        Node *y = p-&gt;leftTree;\r\n\r\n        fa-&gt;rightTree = y;\r\n\r\n        if (y != NIL)\r\n            y-&gt;parent = fa;\r\n        p-&gt;leftTree = fa;\r\n        fa-&gt;parent = p;\r\n\r\n        if (root == fa)\r\n            root = p;\r\n        p-&gt;parent = gp;\r\n\r\n        if (gp != NULL) {\r\n            if (gp-&gt;leftTree == fa)\r\n                gp-&gt;leftTree = p;\r\n            else\r\n                gp-&gt;rightTree = p;\r\n        }\r\n    }\r\n\r\n    void inorder(Node *p) {\r\n        if (p == NIL)\r\n            return;\r\n\r\n        if (p-&gt;leftTree)\r\n            inorder(p-&gt;leftTree);\r\n\r\n        cout &lt;&lt; p-&gt;value &lt;&lt; \" \";\r\n                \r\n        if (p-&gt;rightTree)\r\n            inorder(p-&gt;rightTree);\r\n    }\r\n\r\n    string outputColor(bool color) {\r\n        return color ? \"BLACK\" : \"RED\";\r\n    }\r\n\r\n    Node* getSmallestChild(Node *p) {\r\n        if (p-&gt;leftTree == NIL)\r\n            return p;\r\n        return getSmallestChild(p-&gt;leftTree);\r\n    }\r\n\r\n    bool delete_child(Node *p, int data) {\r\n        if (p-&gt;value &gt; data) {\r\n            if (p-&gt;leftTree == NIL) {\r\n                return false;\r\n            }\r\n            return delete_child(p-&gt;leftTree, data);\r\n        } else if (p-&gt;value &lt; data) {\r\n            if (p-&gt;rightTree == NIL) {\r\n                return false;\r\n            }\r\n            return delete_child(p-&gt;rightTree, data);\r\n        } else if (p-&gt;value == data) {\r\n            if (p-&gt;rightTree == NIL) {\r\n                delete_one_child(p);\r\n                return true;\r\n            }\r\n            Node *smallest = getSmallestChild(p-&gt;rightTree);\r\n            swap(p-&gt;value, smallest-&gt;value);\r\n            delete_one_child(smallest);\r\n\r\n            return true;\r\n        }\r\n    }\r\n\r\n    void delete_one_child(Node *p) {\r\n        Node *child = p-&gt;leftTree == NIL ? p-&gt;rightTree : p-&gt;leftTree;\r\n        if (p-&gt;parent == NULL &amp;&amp; p-&gt;leftTree == NIL &amp;&amp; p-&gt;rightTree == NIL) {\r\n            p = NULL;\r\n            root = p;\r\n            return;\r\n        }\r\n        \r\n        if (p-&gt;parent == NULL) {\r\n            delete  p;\r\n            child-&gt;parent = NULL;\r\n            root = child;\r\n            root-&gt;color = BLACK;\r\n            return;\r\n        }\r\n        \r\n        if (p-&gt;parent-&gt;leftTree == p) {\r\n            p-&gt;parent-&gt;leftTree = child;\r\n        } else {\r\n            p-&gt;parent-&gt;rightTree = child;\r\n        }\r\n        child-&gt;parent = p-&gt;parent;\r\n\r\n        if (p-&gt;color == BLACK) {\r\n            if (child-&gt;color == RED) {\r\n                child-&gt;color = BLACK;\r\n            } else\r\n                delete_case(child);\r\n        }\r\n\r\n        delete p;\r\n    }\r\n\r\n    void delete_case(Node *p) {\r\n        if (p-&gt;parent == NULL) {\r\n            p-&gt;color = BLACK;\r\n            return;\r\n        }\r\n        if (p-&gt;sibling()-&gt;color == RED) {\r\n            p-&gt;parent-&gt;color = RED;\r\n            p-&gt;sibling()-&gt;color = BLACK;\r\n            if (p == p-&gt;parent-&gt;leftTree)\r\n                rotate_left(p-&gt;sibling());\r\n            else\r\n                rotate_right(p-&gt;sibling());\r\n        }\r\n        if (p-&gt;parent-&gt;color == BLACK &amp;&amp; p-&gt;sibling()-&gt;color == BLACK\r\n                &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == BLACK &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == BLACK) {\r\n            p-&gt;sibling()-&gt;color = RED;\r\n            delete_case(p-&gt;parent);\r\n        } else if (p-&gt;parent-&gt;color == RED &amp;&amp; p-&gt;sibling()-&gt;color == BLACK\r\n                &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == BLACK &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == BLACK) {\r\n            p-&gt;sibling()-&gt;color = RED;\r\n            p-&gt;parent-&gt;color = BLACK;\r\n        } else {\r\n            if (p-&gt;sibling()-&gt;color == BLACK) {\r\n                if (p == p-&gt;parent-&gt;leftTree &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == RED\r\n                        &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == BLACK) {\r\n                    p-&gt;sibling()-&gt;color = RED;\r\n                    p-&gt;sibling()-&gt;leftTree-&gt;color = BLACK;\r\n                    rotate_right(p-&gt;sibling()-&gt;leftTree);\r\n                } else if (p == p-&gt;parent-&gt;rightTree &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == BLACK\r\n                        &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == RED) {\r\n                    p-&gt;sibling()-&gt;color = RED;\r\n                    p-&gt;sibling()-&gt;rightTree-&gt;color = BLACK;\r\n                    rotate_left(p-&gt;sibling()-&gt;rightTree);\r\n                }\r\n            }\r\n            p-&gt;sibling()-&gt;color = p-&gt;parent-&gt;color;\r\n            p-&gt;parent-&gt;color = BLACK;\r\n            if (p == p-&gt;parent-&gt;leftTree) {\r\n                p-&gt;sibling()-&gt;rightTree-&gt;color = BLACK;\r\n                rotate_left(p-&gt;sibling());\r\n            } else {\r\n                p-&gt;sibling()-&gt;leftTree-&gt;color = BLACK;\r\n                rotate_right(p-&gt;sibling());\r\n            }\r\n        }\r\n    }\r\n\r\n    void insert(Node *p, int data) {\r\n        if (p-&gt;value &gt;= data) {\r\n            if (p-&gt;leftTree != NIL)\r\n                insert(p-&gt;leftTree, data);\r\n            else {\r\n                Node *tmp = new Node();\r\n                tmp-&gt;value = data;\r\n                tmp-&gt;leftTree = tmp-&gt;rightTree = NIL;\r\n                tmp-&gt;parent = p;\r\n                p-&gt;leftTree = tmp;\r\n                insert_case(tmp);\r\n            }\r\n        } else {\r\n            if (p-&gt;rightTree != NIL)\r\n                insert(p-&gt;rightTree, data);\r\n            else {\r\n                Node *tmp = new Node();\r\n                tmp-&gt;value = data;\r\n                tmp-&gt;leftTree = tmp-&gt;rightTree = NIL;\r\n                tmp-&gt;parent = p;\r\n                p-&gt;rightTree = tmp;\r\n                insert_case(tmp);\r\n            }\r\n        }\r\n    }\r\n\r\n    void insert_case(Node *p) {\r\n        if (p-&gt;parent == NULL) {\r\n            root = p;\r\n            p-&gt;color = BLACK;\r\n            return;\r\n        }\r\n        if (p-&gt;parent-&gt;color == RED) {\r\n            if (p-&gt;uncle()-&gt;color == RED) {\r\n                p-&gt;parent-&gt;color = p-&gt;uncle()-&gt;color = BLACK;\r\n                p-&gt;grandparent()-&gt;color = RED;\r\n                insert_case(p-&gt;grandparent());\r\n            } else {\r\n                if (p-&gt;parent-&gt;rightTree == p &amp;&amp; p-&gt;grandparent()-&gt;leftTree == p-&gt;parent) {\r\n                    rotate_left(p);\r\n                    rotate_right(p);\r\n                    p-&gt;color = BLACK;\r\n                    p-&gt;leftTree-&gt;color = p-&gt;rightTree-&gt;color = RED;\r\n                } else if (p-&gt;parent-&gt;leftTree == p &amp;&amp; p-&gt;grandparent()-&gt;rightTree == p-&gt;parent) {\r\n                    rotate_right(p);\r\n                    rotate_left(p);\r\n                    p-&gt;color = BLACK;\r\n                    p-&gt;leftTree-&gt;color = p-&gt;rightTree-&gt;color = RED;\r\n                } else if (p-&gt;parent-&gt;leftTree == p &amp;&amp; p-&gt;grandparent()-&gt;leftTree == p-&gt;parent) {\r\n                    p-&gt;parent-&gt;color = BLACK;\r\n                    p-&gt;grandparent()-&gt;color = RED;\r\n                    rotate_right(p-&gt;parent);\r\n                } else if (p-&gt;parent-&gt;rightTree == p &amp;&amp; p-&gt;grandparent()-&gt;rightTree == p-&gt;parent) {\r\n                    p-&gt;parent-&gt;color = BLACK;\r\n                    p-&gt;grandparent()-&gt;color = RED;\r\n                    rotate_left(p-&gt;parent);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    void DeleteTree(Node *p) {\r\n        if (!p || p == NIL) {\r\n            return;\r\n        }\r\n        DeleteTree(p-&gt;leftTree);\r\n        DeleteTree(p-&gt;rightTree);\r\n        delete p;\r\n    }\r\npublic:\r\n\r\n    bst() {\r\n        NIL = new Node();\r\n        NIL-&gt;color = BLACK;\r\n        root = NULL;\r\n    }\r\n\r\n    ~bst() {\r\n        if (root)\r\n            DeleteTree(root);\r\n        delete NIL;\r\n    }\r\n\r\n    void inorder() {\r\n        if (root == NULL)\r\n            return;\r\n        inorder(root);\r\n        cout &lt;&lt; endl;\r\n    }\r\n\r\n    void insert(int x) {\r\n        if (root == NULL) {\r\n            root = new Node();\r\n            root-&gt;color = BLACK;\r\n            root-&gt;leftTree = root-&gt;rightTree = NIL;\r\n            root-&gt;value = x;\r\n        } else {\r\n            insert(root, x);\r\n        }\r\n    }\r\n\r\n    bool delete_value(int data) {\r\n        return delete_child(root, data);\r\n    }\r\nprivate:\r\n    Node *root, *NIL;\r\n};</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-77\">77</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-78\">78</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-79\">79</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-80\">80</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-81\">81</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-82\">82</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-83\">83</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-84\">84</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-85\">85</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-86\">86</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-87\">87</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-88\">88</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-89\">89</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-90\">90</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-91\">91</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-92\">92</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-93\">93</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-94\">94</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-95\">95</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-96\">96</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-97\">97</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-98\">98</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-99\">99</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-100\">100</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-101\">101</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-102\">102</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-103\">103</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-104\">104</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-105\">105</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-106\">106</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-107\">107</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-108\">108</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-109\">109</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-110\">110</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-111\">111</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-112\">112</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-113\">113</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-114\">114</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-115\">115</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-116\">116</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-117\">117</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-118\">118</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-119\">119</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-120\">120</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-121\">121</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-122\">122</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-123\">123</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-124\">124</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-125\">125</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-126\">126</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-127\">127</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-128\">128</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-129\">129</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-130\">130</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-131\">131</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-132\">132</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-133\">133</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-134\">134</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-135\">135</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-136\">136</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-137\">137</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-138\">138</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-139\">139</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-140\">140</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-141\">141</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-142\">142</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-143\">143</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-144\">144</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-145\">145</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-146\">146</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-147\">147</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-148\">148</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-149\">149</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-150\">150</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-151\">151</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-152\">152</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-153\">153</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-154\">154</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-155\">155</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-156\">156</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-157\">157</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-158\">158</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-159\">159</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-160\">160</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-161\">161</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-162\">162</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-163\">163</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-164\">164</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-165\">165</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-166\">166</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-167\">167</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-168\">168</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-169\">169</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-170\">170</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-171\">171</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-172\">172</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-173\">173</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-174\">174</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-175\">175</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-176\">176</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-177\">177</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-178\">178</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-179\">179</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-180\">180</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-181\">181</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-182\">182</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-183\">183</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-184\">184</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-185\">185</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-186\">186</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-187\">187</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-188\">188</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-189\">189</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-190\">190</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-191\">191</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-192\">192</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-193\">193</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-194\">194</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-195\">195</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-196\">196</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-197\">197</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-198\">198</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-199\">199</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-200\">200</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-201\">201</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-202\">202</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-203\">203</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-204\">204</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-205\">205</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-206\">206</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-207\">207</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-208\">208</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-209\">209</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-210\">210</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-211\">211</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-212\">212</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-213\">213</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-214\">214</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-215\">215</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-216\">216</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-217\">217</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-218\">218</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-219\">219</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-220\">220</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-221\">221</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-222\">222</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-223\">223</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-224\">224</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-225\">225</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-226\">226</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-227\">227</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-228\">228</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-229\">229</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-230\">230</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-231\">231</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-232\">232</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-233\">233</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-234\">234</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-235\">235</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-236\">236</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-237\">237</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-238\">238</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-239\">239</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-240\">240</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-241\">241</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-242\">242</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-243\">243</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-244\">244</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-245\">245</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-246\">246</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-247\">247</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-248\">248</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-249\">249</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-250\">250</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-251\">251</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-252\">252</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-253\">253</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-254\">254</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-255\">255</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-256\">256</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-257\">257</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-258\">258</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-259\">259</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-260\">260</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-261\">261</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-262\">262</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-263\">263</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-264\">264</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-265\">265</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-266\">266</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-267\">267</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-268\">268</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-269\">269</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-270\">270</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-271\">271</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-272\">272</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-273\">273</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-274\">274</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-275\">275</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-276\">276</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-277\">277</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-278\">278</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-279\">279</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-280\">280</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-281\">281</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-282\">282</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-283\">283</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-284\">284</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-285\">285</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-286\">286</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-287\">287</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-288\">288</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-289\">289</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-290\">290</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-291\">291</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-292\">292</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-293\">293</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-294\">294</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-295\">295</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-296\">296</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-297\">297</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-298\">298</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-299\">299</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-300\">300</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-301\">301</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-302\">302</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-303\">303</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-304\">304</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-305\">305</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-306\">306</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-307\">307</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-308\">308</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-309\">309</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-310\">310</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-311\">311</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-312\">312</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-313\">313</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-314\">314</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-315\">315</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-316\">316</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-317\">317</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-318\">318</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-319\">319</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-320\">320</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-321\">321</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-322\">322</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-323\">323</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-324\">324</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-325\">325</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-326\">326</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-327\">327</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-328\">328</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-329\">329</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-330\">330</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-331\">331</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596c7f3872ae3953174496-332\">332</div><div class=\"crayon-num\" data-line=\"crayon-596c7f3872ae3953174496-333\">333</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-1\"><span class=\"crayon-p\">#define BLACK 1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-2\"><span class=\"crayon-p\">#define RED 0</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-4\"><span class=\"crayon-e\">using </span><span class=\"crayon-t\">namespace</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">std</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-6\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bst</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-7\"><span class=\"crayon-m\">private</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-8\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">color</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-17\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-18\"><span class=\"crayon-h\">            </span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-19\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-23\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-24\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-25\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-26\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-28\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">uncle</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-30\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-31\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-32\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-33\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-34\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-35\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-36\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-37\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-38\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-39\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-40\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-41\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-42\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-43\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-45\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-46\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-47\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-48\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-49\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">fa</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-51\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-52\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">y</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-53\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-54\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-55\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">y</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-56\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-58\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-59\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-60\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-61\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-62\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-63\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-64\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-65\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-66\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-67\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-68\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-69\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-70\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-71\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-72\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-73\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-74\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-75\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-76\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-77\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-78\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">fa</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-79\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-80\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-81\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">y</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-82\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-83\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-84\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">y</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-85\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-86\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-87\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-88\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-89\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-90\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-91\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-92\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-93\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-94\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-95\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-96\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-97\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-98\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-99\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-100\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-101\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-102\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-103\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-104\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-105\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-106\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-107\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\" \"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-108\"><span class=\"crayon-h\">                </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-109\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-110\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-111\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-112\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-113\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">outputColor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">color</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-114\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"BLACK\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"RED\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-115\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-116\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-117\"><span class=\"crayon-h\">    </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSmallestChild</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-118\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-119\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-120\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSmallestChild</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-121\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-122\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-123\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-124\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-125\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-126\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-127\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-128\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-129\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-130\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-131\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-132\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-133\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-134\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-135\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-136\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">delete_one_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-137\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-138\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-139\"><span class=\"crayon-h\">            </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">smallest</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSmallestChild</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-140\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">swap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">smallest</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-141\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">delete_one_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">smallest</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-142\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-143\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-144\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-145\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-146\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-147\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_one_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-148\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-r\">child</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">NIL</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-149\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-150\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-151\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-152\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-153\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-154\"><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-155\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-156\"><span class=\"crayon-h\">            </span><span class=\"crayon-i\">delete</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-157\"><span class=\"crayon-h\">            </span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-158\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-159\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-160\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-161\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-162\"><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-163\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-164\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-165\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-166\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-167\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-168\"><span class=\"crayon-h\">        </span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-169\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-170\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-171\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-172\"><span class=\"crayon-h\">                </span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-173\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-174\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">delete_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-175\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-176\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-177\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-178\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-179\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-180\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-181\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-182\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-183\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-184\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-185\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-186\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-187\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-188\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-189\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-190\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-191\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-192\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-193\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-194\"><span class=\"crayon-h\">                </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-195\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-196\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">delete_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-197\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-198\"><span class=\"crayon-h\">                </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-199\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-200\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-201\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-202\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-203\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-204\"><span class=\"crayon-h\">                        </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-205\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-206\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-207\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-208\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-209\"><span class=\"crayon-h\">                        </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-210\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-211\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-212\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-213\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-214\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-215\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-216\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-217\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-218\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-219\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-220\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-221\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-222\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-223\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-224\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-225\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-226\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-227\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-228\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-229\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-230\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-231\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-232\"><span class=\"crayon-h\">                </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-233\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-234\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-235\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-236\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-237\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-238\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-239\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-240\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-241\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-242\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-243\"><span class=\"crayon-h\">                </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-244\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-245\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-246\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-247\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-248\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-249\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-250\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-251\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-252\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-253\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-254\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-255\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-256\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-257\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-258\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-259\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-260\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">uncle</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-261\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">uncle</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-262\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-263\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-264\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-265\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-266\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-267\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-268\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-269\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-270\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-271\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-272\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-273\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-274\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-275\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-276\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-277\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-278\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-279\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-280\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-281\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-282\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-283\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-284\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-285\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-286\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-287\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-288\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-289\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-290\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-291\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-292\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-293\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-294\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-295\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-296\"><span class=\"crayon-m\">public</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-297\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-298\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">bst</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-299\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-300\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-301\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-302\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-303\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-304\"><span class=\"crayon-h\">    </span><span class=\"crayon-o\">~</span><span class=\"crayon-e\">bst</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-305\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-306\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-307\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">delete </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-308\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-309\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-310\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-311\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-312\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-313\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-314\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">endl</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-315\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-316\"> </div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-317\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-318\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-319\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-320\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-321\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-322\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-323\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-324\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-325\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-326\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-327\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-328\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_value</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-329\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-330\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-331\"><span class=\"crayon-m\">private</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596c7f3872ae3953174496-332\"><span class=\"crayon-h\">    </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596c7f3872ae3953174496-333\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0505 seconds] -->\r\n<p></p>\n<h1 class=\"First\">4. B树</h1>\n<p>B树也是一种用于查找的平衡树，但是它不是二叉树。</p>\n<p><strong>B树的定义：</strong>B树（<span class=\"LangWithName\"><span lang=\"en\" xml:lang=\"en\">B-tree）是一种树状数据结构，能够用来存储排序后的数据。这种数据结构能够让查找数据、循序存取、插入数据及删除的动作，都在对数时间内完成。B树，概括来说是一个一般化的二叉查找树，可以拥有多于2个子节点。与自平衡二叉查找树不同，B-树为系统最优化大块数据的读和写操作。B-tree算法减少定位记录时所经历的中间过程，从而加快存取速度。这种数据结构常被应用在数据库和文件系统的实作上。</span></span></p>\n<p>在B树中查找给定关键字的方法是，首先把根结点取来，在根结点所包含的关键字K1,…,Kn查找给定的关键字（可用顺序查找或二分查找法），若找到等于给定值的关键字，则查找成功；否则，一定可以确定要查找的关键字在Ki与Ki+1之间，Pi为指向子树根节点的指针，此时取指针Pi所指的结点继续查找，直至找到，或指针Pi为空时查找失败。</p>\n<p>B树作为一种多路搜索树（并不是二叉的）：</p>\n<p>1) 定义任意非叶子结点最多只有M个儿子；且M&gt;2；</p>\n<p>2) 根结点的儿子数为[2, M]；</p>\n<p>3) 除根结点以外的非叶子结点的儿子数为[M/2, M]；</p>\n<p>4) 每个结点存放至少M/2-1（取上整）和至多M-1个关键字；（至少2个关键字）</p>\n<p>5) 非叶子结点的关键字个数=指向儿子的指针个数-1；</p>\n<p>6) 非叶子结点的关键字：K[1], K[2], …, K[M-1]；且K[i] &lt; K[i+1]；</p>\n<p>7) 非叶子结点的指针：P[1], P[2], …, P[M]；其中P[1]指向关键字小于K[1]的子树，P[M]指向关键字大于K[M-1]的子树，其它P[i]指向关键字属于(K[i-1], K[i])的子树；</p>\n<p>8) 所有叶子结点位于同一层；</p>\n<p>如下图为一个M=3的B树示例：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/0178191b698ab75a98fa1d0bb03cc51f.jpg\"><img class=\"aligncenter wp-image-111700 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0178191b698ab75a98fa1d0bb03cc51f.jpg\" alt=\"4\" width=\"624\" height=\"268\"></a></p>\n<p>B树创建的示意图：</p>\n<p><img class=\"aligncenter\" src=\"http://wx3.sinaimg.cn/large/7cc829d3gy1fh5p12mz57g20qm06d4qq.gif\" width=\"958\" height=\"229\"></p>\n<h1 class=\"First\">5. B+树</h1>\n<p>B+树是B树的变体，也是一种多路搜索树：</p>\n<p>1) 其定义基本与B-树相同，除了：</p>\n<p>2) 非叶子结点的子树指针与关键字个数相同；</p>\n<p>3) 非叶子结点的子树指针P[i]，指向关键字值属于[K[i], K[i+1])的子树（B-树是开区间）；</p>\n<p>4) 为所有叶子结点增加一个链指针；</p>\n<p>5) 所有关键字都在叶子结点出现；</p>\n<p>下图为M=3的B+树的示意图：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/0972ef809f286cc29cd2d94687b2ef2d.jpg\"><img class=\"aligncenter wp-image-111701 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0972ef809f286cc29cd2d94687b2ef2d.jpg\" alt=\"4\" width=\"569\" height=\"345\"></a></p>\n<p>B+树的搜索与B树也基本相同，区别是B+树只有达到叶子结点才命中（B树可以在非叶子结点命中），其性能也等价于在关键字全集做一次二分查找；</p>\n<p><strong>B+的性质：</strong></p>\n<p>1.所有关键字都出现在叶子结点的链表中（稠密索引），且链表中的关键字恰好是有序的；</p>\n<p>2.不可能在非叶子结点命中；</p>\n<p>3.非叶子结点相当于是叶子结点的索引（稀疏索引），叶子结点相当于是存储（关键字）数据的数据层；</p>\n<p>4.更适合文件索引系统。</p>\n<p>下面为一个B+树创建的示意图：</p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/large/7cc829d3gy1fh5p2ef94jg20rz05i7wi.gif\" width=\"1007\" height=\"198\"></p>\n<h1 class=\"First\">6. B*树</h1>\n<p>B*树是B+树的变体，在B+树的非根和非叶子结点再增加指向兄弟的指针，将结点的最低利用率从1/2提高到2/3。</p>\n<p>B*树如下图所示：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/eb5835f421e029240105ccb8e80279ee.jpg\"><img class=\"aligncenter wp-image-111702 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/eb5835f421e029240105ccb8e80279ee.jpg\" alt=\"4\" width=\"569\" height=\"345\"></a></p>\n<p>B*树定义了非叶子结点关键字个数至少为(2/3)*M，即块的最低使用率为2/3（代替B+树的1/2）；</p>\n<p>B+树的分裂：当一个结点满时，分配一个新的结点，并将原结点中1/2的数据复制到新结点，最后在父结点中增加新结点的指针；B+树的分裂只影响原结点和父结点，而不会影响兄弟结点，所以它不需要指向兄弟的指针；</p>\n<p>B*树的分裂：当一个结点满时，如果它的下一个兄弟结点未满，那么将一部分数据移到兄弟结点中，再在原结点插入关键字，最后修改父结点中兄弟结点的关键字（因为兄弟结点的关键字范围改变了）；如果兄弟也满了，则在原结点与兄弟结点之间增加新结点，并各复制1/3的数据到新结点，最后在父结点增加新结点的指针；</p>\n<p>所以，B*树分配新结点的概率比B+树要低，空间使用率更高。</p>\n<h1 class=\"First\">7. Trie树</h1>\n<p>Tire树称为字典树，又称单词查找树，Trie树，是一种树形结构，是一种哈希树的变种。典型应用是用于统计，排序和保存大量的字符串（但不仅限于字符串），所以经常被搜索引擎系统用于文本词频统计。<strong>它的优点是：利用字符串的公共前缀来减少查询时间，最大限度地减少无谓的字符串比较，查询效率比哈希树高。</strong></p>\n<div class=\"para\"><strong>Tire树的三个基本性质：</strong></div>\n<div class=\"para\">1) 根节点不包含字符，除根节点外每一个节点都只包含一个字符；</div>\n<div class=\"para\">2) 从根节点到某一节点，路径上经过的字符连接起来，为该节点对应的字符串；</div>\n<div class=\"para\">3) 每个节点的所有子节点包含的字符都不相同。</div>\n<p><strong>Tire树的应用：</strong></p>\n<p>1) <span class=\"headline-content\">串的快速检索</span></p>\n<p class=\"para\">给出N个单词组成的熟词表，以及一篇全用小写英文书写的文章，请你按最早出现的顺序写出所有不在熟词表中的生词。在这道题中，我们可以用数组枚举，用哈希，用字典树，先把熟词建一棵树，然后读入文章进行比较，这种方法效率是比较高的。</p>\n<p class=\"para\"><span class=\"headline-content\">2) “串”排序</span></p>\n<p class=\"para\">给定N个互不相同的仅由一个单词构成的英文名，让你将他们按字典序从小到大输出。用字典树进行排序，采用数组的方式创建字典树，这棵树的每个结点的所有儿子很显然地按照其字母大小排序。对这棵树进行先序遍历即可。</p>\n<p class=\"para\"><span class=\"headline-content\">3) 最长公共前缀</span></p>\n<p class=\"para\">对所有串建立字典树，对于两个串的最长公共前缀的长度即他们所在的结点的公共祖先个数，于是，问题就转化为求公共祖先的问题。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111680\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111680votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111680\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 7 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 2 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "我是如何开始踏上 bash 脚本编程之路的？", "url": "http://blog.jobbole.com/111509/", "url_object_id": "f65b12bcb444cfbc3d0109311fbdd75c", "create_date": "2017/06/19 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/05/77d80105fd15f2465894827e23cc4842.jpeg"], "praise_nums": "2", "comment_nums": 1, "fav_nums": 1, "tags": "IT技术,Bash", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://opensource.com/article/17/5/how-i-learned-bash-scripting\">Sandra Mccann</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-8617-1.html\">Linux中国/xllc</a>   </div><p>我前几天写了一个脚本。对于一些人来说，这句话听起来没什么了不起的。而对于另一些人来说，这句话意义重大。要知道，我不是一个程序员，而是一个作家。</p>\n<h3 id=\"toc_1\">我需要解决什么？</h3>\n<p>我的问题相当简单：我需要将工程文件进行分类。这些文件可以从一个网站 URL 以 .zip 的格式下载。当我正手工将它们拷贝到我的电脑桌面，并移动到一个已按照我文件分类的需要进行了结构化的目录时，一位作家同事给我提了建议：<em>“不就是写个脚本的事吗？”</em></p>\n<p>我心想：<em>“就写个脚本？”</em>——说得好像这是世界上最容易做的事情一样。</p>\n<h3 id=\"toc_2\">Google 是如何解救我的？</h3>\n<p>同事的问题促使我思考，并且经过思考后，我进行了 Google 搜索。</p>\n<p><strong>Linux 上使用的是什么脚本编程语言？</strong></p>\n<p>这是我第一个 Google 搜索的准则。也许很多人心里会想：“她太笨了！”是的，我很笨。不过，这的确使我走上了一条解决问题的道路。最常见的搜索结果是 Bash 。嗯，我听说过 Bash 。呃，我要分类的文件中有一个里面就有 Bash，那无处不在的 <code>#!/bin/bash</code> 。我重新看了下那个文件，我知道它的用途，因为我需要将它分类。</p>\n<p>这引导我进行了下一个 Google 搜索。</p>\n<p><strong>如何从一个 URL 下载 zip 文件？</strong></p>\n<p>那确实是我的基本任务。我有一个带有 .zip 文件的 URL ，它包含有所有我需要分类的文件，所以我寻求万能的 Google 的帮助。搜索到的精华内容和其它一些结果引导我使用 Curl 。但最重要的是：我不仅找到了 Curl ，其中一条置顶的搜索结果还展示了一个使用 Curl 去下载并解压 .zip 文件的 Bash 脚本。这超出了我本来想寻求的答案，但那也使我意识到在 Google 搜索具体的请求可以得到我写这个脚本需要的信息。所以，在这个收获的推动下，我写了最简单的脚本：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce6bfa01578139457\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#!/bin/sh\r\ncurl http://rather.long.url | tar -xz -C my_directory --strip-components=1</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce6bfa01578139457-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce6bfa01578139457-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce6bfa01578139457-1\"><span class=\"crayon-p\">#!/bin/sh</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce6bfa01578139457-2\"><span class=\"crayon-e\">curl </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//rather.long.url | tar -xz -C my_directory --strip-components=1</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>我迫不及待地运行看看。但我发现一个问题： URL 是会变的，根据我要访问的文件的分组不同而不同。我有新的问题需要解决，这使我进行了下一轮搜索。</p>\n<p><strong>参数如何传递给 Bash 脚本？</strong></p>\n<p>我需要以不同的 URL 和不同的最终目录来运行此脚本。 Google 向我展示了如何使用 <code>$1</code>、<code>$2</code> 等等来替换我在命令行中运行脚本时输入的内容。比如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce6bfa0b317719837\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbash myscript.sh http://rather.long.url my_directory</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce6bfa0b317719837-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce6bfa0b317719837-1\"><span class=\"crayon-e\">bash </span><span class=\"crayon-v\">myscript</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sh </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//rather.long.url my_directory</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>这就好多了。一切如我所愿，灵活，实用。最重要的是我只要输入一条简短的命令就可以节省 30 分钟无聊的复制、粘贴工作。这个早上的时间花得值得。</p>\n<p>然后我发现还有一个问题：我很健忘，并且我知道我几个月才运行一次这个脚本。这留给我两个疑问：</p>\n<ul>\n<li>我要如何记得运行脚本时输入什么（URL 先，还是目录先）？</li>\n<li>如果我被货车撞了，其它作家如何知道该怎样运行我的脚本？</li>\n</ul>\n<p>我需要一个使用说明 —— 如果我使用不正确，则脚本会提示。比如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce6bfa0f878395865\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nusage: bash yaml-fetch.sh &lt;'snapshot_url'&gt; &lt;directory&gt;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce6bfa0f878395865-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce6bfa0f878395865-1\"><span class=\"crayon-v\">usage</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bash </span><span class=\"crayon-v\">yaml</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">fetch</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">sh</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-s\">'snapshot_url'</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">directory</span><span class=\"crayon-o\">&gt;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>否则，则直接运行脚本。我的下一个搜索是：</p>\n<p><strong>如何在 Bash 脚本里使用 “if/then/else”?</strong></p>\n<p>幸运的是，我已经知道编程中 <code>if/then/else</code> 的存在。我只要找出如何使用它的方法。在这个过程中，我也学到了如何在 Bash 脚本里使用 <code>echo</code> 打印。我的最终成果如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce6bfa13002775062\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#!/bin/sh\r\nURL=$1\r\nDIRECTORY=$2\r\nif [ $# -eq 0 ];\r\n then\r\n echo \"usage: bash yaml-fetch.sh &lt;'snapshot_url'&gt; &lt;directory&gt;\".\r\n else\r\n# 如果目录不存在则创建它\r\n echo 'create directory'\r\n mkdir $DIRECTORY\r\n # 下载并解压 yaml 文件\r\n echo 'fetch and untar the yaml files'\r\n curl $URL | tar -xz -C $DIRECTORY --strip-components=1\r\nfi</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce6bfa13002775062-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce6bfa13002775062-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce6bfa13002775062-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce6bfa13002775062-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce6bfa13002775062-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce6bfa13002775062-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce6bfa13002775062-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce6bfa13002775062-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce6bfa13002775062-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce6bfa13002775062-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce6bfa13002775062-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce6bfa13002775062-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce6bfa13002775062-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce6bfa13002775062-14\">14</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce6bfa13002775062-1\"><span class=\"crayon-p\">#!/bin/sh</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce6bfa13002775062-2\"><span class=\"crayon-v\">URL</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line\" id=\"crayon-596bfce6bfa13002775062-3\"><span class=\"crayon-v\">DIRECTORY</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">2</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce6bfa13002775062-4\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-p\"># -eq 0 ];</span></div><div class=\"crayon-line\" id=\"crayon-596bfce6bfa13002775062-5\"><span class=\"crayon-h\"> </span><span class=\"crayon-st\">then</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce6bfa13002775062-6\"><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"usage: bash yaml-fetch.sh &lt;'snapshot_url'&gt; &lt;directory&gt;\"</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596bfce6bfa13002775062-7\"><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce6bfa13002775062-8\"><span class=\"crayon-p\"># 如果目录不存在则创建它</span></div><div class=\"crayon-line\" id=\"crayon-596bfce6bfa13002775062-9\"><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'create directory'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce6bfa13002775062-10\"><span class=\"crayon-h\"> </span><span class=\"crayon-i\">mkdir</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">DIRECTORY</span></div><div class=\"crayon-line\" id=\"crayon-596bfce6bfa13002775062-11\"><span class=\"crayon-h\"> </span><span class=\"crayon-p\"># 下载并解压 yaml 文件</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce6bfa13002775062-12\"><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'fetch and untar the yaml files'</span></div><div class=\"crayon-line\" id=\"crayon-596bfce6bfa13002775062-13\"><span class=\"crayon-h\"> </span><span class=\"crayon-i\">curl</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">URL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tar</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">xz</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">C</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">DIRECTORY</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">strip</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">components</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce6bfa13002775062-14\"><span class=\"crayon-v\">fi</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p></p>\n<h3 id=\"toc_3\">Google 和脚本编程如何颠覆我的世界？</h3>\n<p>好吧，这稍微有点夸大，不过现在是 21 世纪，学习新东西（特别是稍微简单的东西）比以前简单多了。我所学到的（除了如何写一个简短的、自动分类的 Bash 脚本之外）是如果我有疑问，那么有很大可能性是其它人在之前也有过相同的疑问。当我困惑时，我可以问下一个问题，再下一个问题。最后，我不仅拥有了脚本，还拥有了可以一直拥有并可以简化其它任务的新技能，这是我之前所没有的。</p>\n<p>别止步于第一个脚本（或者编程的第一步）。这是一个技能，和其它的技能并无不同，有大量的信息可以在这一路上帮助你。你无需阅读大量的书或参加一个月的课程。你可以像婴儿学步那样简单地开始写脚本，然后掌握技能并建立自信。人们总有写成千上万行代码的需求，并对它进行分支、合并、修复错误。但是，通过简单的脚本或其它方式来自动化、简单化任务的需求也一样强烈。这样的一个小脚本和小小的自信就能够让你启程脚本编程之路。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111509\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111509votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111509\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 1 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"},{"title": "性能优化知多少", "url": "http://blog.jobbole.com/111734/", "url_object_id": "a59acd84141cd48da7828b24421ff6cb", "create_date": "2017/07/05 ·", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/07/7e8f770aaadb755d790b921b68fb2214.png"], "praise_nums": "3", "comment_nums": 0, "fav_nums": 6, "tags": "IT技术,性能", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/sheng-jie/p/7109385.html\">『圣杰』</a>   </div><p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/7e8f770aaadb755d790b921b68fb2214.png\"></p>\n<div id=\"cnblogs_post_body\">\n<h1 id=\"引言\">1. 引言</h1>\n<p>最近一段时间，系统新版本要发布，在beta客户测试期间，暴露了很多问题，除了一些业务和异常问题外，其他都集中在性能上。有幸接触到这些性能调优的机会，当然要学习总结了。</p>\n<p>性能优化是一个老生常谈的问题了，典型的性能问题如页面响应慢、接口超时，服务器负载高、并发数低，数据库频繁死锁等。而造成性能问题又有很多种，比如磁盘I/O、内存、网络、算法、大数据量等等。我们可以大致把性能问题分为四个层次：代码层次、数据库层次、算法层次、架构层次。<br>\n所以下面我会结合实际性能优化案例，和大家分享下性能调优的工具、方法和技巧。</p>\n<h1 id=\"先说心态\">2. 先说心态</h1>\n<p>说到性能问题，你可能首先就想到的是麻烦或者头大，因为一般性能问题都比较紧急，轻则影响客户体验，重则宕机导致财务损失，而且性能问题比较隐蔽，不易发现。因此一时间无从下手，而这时我们就很容易从心底开始去排斥它，不愿接这烫手的山芋。</p>\n<p>而恰巧，性能调优是体现程序员水平的一个重要指标。</p>\n<blockquote><p>因为处理bug、崩溃、调优、入侵等突发事件比编程本身更能体现平庸程序员与理想程序员的差距。当面对一个未知的问题时，如何定位复杂条件下的核心问题、如何抽丝剥茧地分析问题的潜在原因、如何排除干扰还原一个最小的可验证场景、如何抓住关键数据验证自己的猜测与实验，都是体现程序员思考力的最好场景。是的，在衡量理想程序员的标准上，思考力比经验更加重要。</p></blockquote>\n<p>所以，若你不甘平庸，请拥抱性能调优的每一个机会。当你拥有一个正确的心态，你所面对的性能问题就已经解决了一半。</p>\n<h1 id=\"再说技巧\">3. 再说技巧</h1>\n<p>拿到一个性能问题，不要忙着先上工具，先了解问题出现的背景，问题的严重程度。然后大致根据自己的经验积累作出预估。比如客户来了个性能问题说系统宕机了，已经造成资金损失了。这种涉及到钱的问题，大家都比较敏感，根据自己的level，决定是否要接这个锅。这不是逃避，而是自知之明。</p>\n<p>了解问题背景之后，下一步就来尝试问题重现。如果在测试环境能够重现，那这种问题就很好跟踪分析。如果问题不能稳定重现或仅能在生产环境重现，那问题就相对比较棘手，这时要立刻收集现场证据，包括但不限于抓dump、收集应用程序以及系统日志、关注CPU内存情况、数据库备份等等，之后不妨再尝试重现，比如恢复客户数据库到测试环境重现。</p>\n<p>不管问题能否重现，下一步，我们就要大致对问题进行分类，是代码层次的业务逻辑问题还是数据库层次的操作耗时问题，又或是系统架构的吞吐量问题。那如何确定呢？而我倾向于先从数据库动手。我的习惯做法是，使用数据库监控工具，先跟踪下Sql耗时情况。如果监控到耗时较长的SQL语句，那基本上就是数据库层次的问题，否则就是代码层次。若为代码层次，再研究完代码后，再细化为算法或架构层次问题。</p>\n<p>确定问题种类后，是时候上工具来精准定位问题点了：</p>\n<ul>\n<li>Sql耗时问题，推荐使用免费的<a href=\"https://www.sentryone.com/plan-explorer\">Plan Explorer</a>分析执行计划。</li>\n<li>代码问题定位，优先推荐使用VS自带的Performance Analysis，其次是RedGate的性能分析套件<a href=\"http://www.red-gate.com/products/dotnet-development/dotnet-developer-bundle/\">.NET Developer Bundle</a>；然后还有Jet Brains的<a href=\"http://www.jetbrains.com/profiler/?fromMenu\">dotTrace — .NET performance profiler</a>，<a href=\"http://www.jetbrains.com/dotmemory/?fromMenu\">dotMemory– .NET memory profiler</a>；再然后就是反人类的Windbg；等等。</li>\n</ul>\n<p>精准定位问题点后，就是着手优化了。相信到这一步，就是优化策略的选择了，这里就不展开了。</p>\n<p>优化后，最后当然要进行测试了，毕竟优化了多少，我们也要做到心里有谱才行。</p>\n<p>以上啰啰嗦嗦有点多，下面我们直接上案例。</p>\n<h1 id=\"案例分享\">4. 案例分享</h1>\n<p>下面就分享下我针对代码层面、数据库层面和算法层面的优化案例。</p>\n<h1 id=\"sql优化案例\">4.1. SQL优化案例</h1>\n<blockquote><p>案例1：客户反馈某结算报表统计十天内的数据耗时10mins左右。</p></blockquote>\n<p>由于前几天刚学会用RedGate的分析工具，拿到这个问题，本地尝试重现后，就直接想使用工具分析。然而，这工具在使用webdev模式起站点时，总是报错，而当时时一根筋，老是想解决这个工具的报错问题。结果，白白搞了半天也没搞定。最后不得已放弃工具，转而选择使用sql server profiler去监控sql语句耗时。一跟踪不要紧，问题就直接暴露了，整个全屏的重复sql语句，如下图。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/06c352459b736d66075fe293d43e97f3.png\" alt=\"Sql Profiler监控结果\"></p>\n<p>这下问题就很明显了，八成是代码在循环拼接sql执行语句。根据抓取到sql关键字往代码中去搜索，果然如此。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce40a5f4399625726\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#region更新三张表数据结合的中间临时表数据，有上游单据的直接调拨单分多次下推时，只计算一次的调拨数量和价税合计\r\nstring sSql = string.Format(@\r\n\"SELECT FENTRYID FROM {0} GROUP BY FENTRYID HAVING COUNT(FENTRYID) &gt; 1\", sJoinDataTempTable);\r\nusing(IDataReader reader = DBUtils.ExecuteReader(this.Context, sSql)) {\r\n    while (reader.Read()) {\r\n        sbSql.AppendFormat(@\"\r\nUPDATE {0} SET FDIRECTQTY = 0,FALLAMOUNT = 0 \r\nWHERE FSEQ NOT IN (\r\nSELECT TOP 1 FSEQ FROM {0} WHERE FENTRYID = {1}) AND FENTRYID = ({1});\"\r\n, sJoinDataTempTable, Convert.ToInt32(reader[\"FENTRYID\"]));\r\n        listSqlObj.Add(new SqlObject(sbSql.ToString(), new List &lt; SqlParam &gt; ()));\r\n        sbSql.Clear();\r\n    }\r\n}\r\n#endregion</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce40a5f4399625726-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a5f4399625726-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a5f4399625726-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a5f4399625726-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a5f4399625726-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a5f4399625726-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a5f4399625726-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a5f4399625726-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a5f4399625726-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a5f4399625726-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a5f4399625726-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a5f4399625726-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a5f4399625726-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a5f4399625726-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a5f4399625726-15\">15</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce40a5f4399625726-1\"><span class=\"crayon-p\">#region更新三张表数据结合的中间临时表数据，有上游单据的直接调拨单分多次下推时，只计算一次的调拨数量和价税合计</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a5f4399625726-2\"><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sSql</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Format</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a5f4399625726-3\"><span class=\"crayon-s\">\"SELECT FENTRYID FROM {0} GROUP BY FENTRYID HAVING COUNT(FENTRYID) &gt; 1\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sJoinDataTempTable</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a5f4399625726-4\"><span class=\"crayon-e\">using</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IDataReader </span><span class=\"crayon-v\">reader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DBUtils</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ExecuteReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Context</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sSql</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a5f4399625726-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">reader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Read</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a5f4399625726-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AppendFormat</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-s\">\"</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a5f4399625726-7\"><span class=\"crayon-s\">UPDATE {0} SET FDIRECTQTY = 0,FALLAMOUNT = 0 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a5f4399625726-8\"><span class=\"crayon-s\">WHERE FSEQ NOT IN (</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a5f4399625726-9\"><span class=\"crayon-s\">SELECT TOP 1 FSEQ FROM {0} WHERE FENTRYID = {1}) AND FENTRYID = ({1});\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a5f4399625726-10\"><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sJoinDataTempTable</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Convert</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToInt32</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">reader</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">\"FENTRYID\"</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a5f4399625726-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">listSqlObj</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SqlObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">List</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SqlParam</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a5f4399625726-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Clear</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a5f4399625726-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a5f4399625726-14\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a5f4399625726-15\"><span class=\"crayon-p\">#endregion</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0026 seconds] -->\r\n<p>看到这段代码，咱先不评判这段代码的优劣，因为毕竟代码注释清晰，省了我们理清业务的功夫。这段sql主要是想做去重处理，很显然选用了错误的方案。改后代码如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce40a60a936797609\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstring sqlMerge = string.Format(@\"\r\nmerge into {0} t1\r\nusing(\r\nselect min(Fseq) fseq,Fentryid from {0} t2 group by fentryid\r\n) t3 on (t1.fentryid = t3.fentryid and t1.fseq &lt;&gt; t3.fseq)\r\nwhen matched then\r\nupdate set t1.FDIRECTQTY = 0, t1.FALLAMOUNT = 0\r\n\", sJoinDataTempTable);\r\n\r\nlistSqlObj.Add(new SqlObject(sqlMerge, new List &lt; SqlParam &gt; ()));\r\nsbSql.Clear();</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce40a60a936797609-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a60a936797609-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a60a936797609-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a60a936797609-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a60a936797609-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a60a936797609-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a60a936797609-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a60a936797609-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a60a936797609-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a60a936797609-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a60a936797609-11\">11</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce40a60a936797609-1\"><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sqlMerge</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Format</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-s\">\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a60a936797609-2\"><span class=\"crayon-s\">merge into {0} t1</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a60a936797609-3\"><span class=\"crayon-s\">using(</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a60a936797609-4\"><span class=\"crayon-s\">select min(Fseq) fseq,Fentryid from {0} t2 group by fentryid</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a60a936797609-5\"><span class=\"crayon-s\">) t3 on (t1.fentryid = t3.fentryid and t1.fseq &lt;&gt; t3.fseq)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a60a936797609-6\"><span class=\"crayon-s\">when matched then</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a60a936797609-7\"><span class=\"crayon-s\">update set t1.FDIRECTQTY = 0, t1.FALLAMOUNT = 0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a60a936797609-8\"><span class=\"crayon-s\">\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sJoinDataTempTable</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a60a936797609-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a60a936797609-10\"><span class=\"crayon-v\">listSqlObj</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SqlObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sqlMerge</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">List</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SqlParam</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a60a936797609-11\"><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Clear</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p>改后测试相同数据量，耗时由10mins降到10s左右。</p>\n<h1 id=\"代码优化案例\">4.2. 代码优化案例</h1>\n<blockquote><p>案例2：客户反馈销售订单100条分录行，保存进行可发量校验时，耗时7mins左右。</p></blockquote>\n<p>拿到这个问题后，本地重现后，监控sql耗时没有异常，那就着重分析代码了。因为可发量校验的业务逻辑极其复杂，又加上又直接再一个类文件实现该功能，3500+行的代码，加上零星注释，真是让人避之不及。逃避不是办法，还是上工具分析一把。<br>\n这次我选用的时VS自带的<strong><a href=\"https://msdn.microsoft.com/en-us/library/ms182372.aspx\">Performance Profiler</a></strong>，开发环境下极其强大的性能调优工具。针对我们当前案例，我们仅需要跟踪指定服务对应的dll即可，使用步骤如下：</p>\n<ol>\n<li>Analyze–&gt;Profiler–&gt;New Performance Session</li>\n<li>打开Performance Explorer</li>\n<li>找到新添加的Performance Session，右键Targets，然后选择Add Target Binary，添加要跟踪的dll文件即可</li>\n<li>将应用跑起来</li>\n<li>选中Performance Session，右键Attach对应进程即可跟踪分析性能了</li>\n<li>在跟踪过程中，可随时暂停跟踪和停止跟踪</li>\n</ol>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/864dcb9eca7c345f430a8da89eac5fd1.png\" alt=\"图示步骤\"></p>\n<p>跟踪结束后本案例跟踪到的采样结果如下图：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9647efb1b254108019ea972563dc630f.png\" alt=\"VS Performance Profiler分析报告\"></p>\n<p>同时Performance Profiler也给出了问题的建议，如下图：<br>\n<img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/88c42b11fa5d0dd0e4471c3d0bccaf10.png\" alt=\"VS Performance Profiler分析提示\"></p>\n<p>其中第1、4条大致说明程序I/O消耗大，第一代的GC上存在未及时释放的垃圾占比过高。而根据上图的采样结果，我们可以直接看出是由于再代码中频繁操作DataTable引起的性能瓶颈。走读代码发现的确如此，所有的数量统计都是在代码中循环遍历DataTable进行处理的。而最终的优化策略，就相当于一次大的重构，将所有代码中通过遍历DataTable的计算逻辑全部挪到SQL中去做。由于代码过多，就不再放出。</p>\n<blockquote><p>案例3：客户反馈批量引入1000张订单，耗时40mins左右，且容易中断。</p></blockquote>\n<p>同样，我们还是先尝试本地重写。经测试批量引入101张单据，就耗时5mins左右。下一步打开Sql监控工具也未发现耗时语句。但考虑到是批量导入操作，虽然单个耗时不多，但乘以100这个基数，就明显了。下面我们就使用RedGate的<a href=\"http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/\">Ants Performance Profiler</a>跟踪一下。</p>\n<p>该工具比较直观，可以同时监控代码和SQL执行情况。第一步，New Profiler Session，第二步进行设置，如下图。根据自己的应用程序类别，选择相应的跟踪方式。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/12d765271a5c2637c6242b6a4df95256.png\" alt=\"跟踪设置\"></p>\n<p>针对这个问题，我们跟踪到的调用堆栈和SQL耗时结果如下图：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9610679af9557a4ae695b8b1c675c787.png\" alt=\"调用堆栈监控结果\"></p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/754712efddfa3eb40a7eb32b192db06c.png\" alt=\"SQL监控结果\"></p>\n<p>首先从调用堆栈中的Hit Count，我们可以首先看出它是一个批量过程，因为入口函数仅调用一次；第二个我们可以代码中是循环处理每一个单据，因为Hit Count与我们批量引入的单据数量相符；第三个，突然来了个10201，如果有一定的数字敏感性的话，这次性能问题的原因就被你找到了。这里就不卖关子了，101 x 101 = 10201。<br>\n是不是明白了什么，存在循环嵌套循环的情况。我们走读代码确定一下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-596bfce40a61b060832727\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//Save.cs\r\npublic override void EndOperationTransaction(EndOperationTransactionArgs e) {\r\n    //省略其他代码\r\n    foreach(DynamicObject dyItem in e.DataEntitys) {\r\n        //反写收款单\r\n        WriteBackReceiveBill wb = new WriteBackReceiveBill();\r\n        wb.WriteBackForSave(e, this.Context);\r\n    }\r\n}\r\n\r\n//WriteBackReceiveBill .cs\r\npublic void WriteBackForSave(EndOperationTransactionArgs e, Context contx) {\r\n    //省略其他代码：\r\n    foreach(DynamicObject item in e.DataEntitys) {\r\n        //do something \r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596bfce40a61b060832727-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a61b060832727-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a61b060832727-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a61b060832727-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a61b060832727-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a61b060832727-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a61b060832727-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a61b060832727-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a61b060832727-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a61b060832727-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a61b060832727-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a61b060832727-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a61b060832727-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a61b060832727-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a61b060832727-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596bfce40a61b060832727-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596bfce40a61b060832727-17\">17</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596bfce40a61b060832727-1\"><span class=\"crayon-c\">//Save.cs</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a61b060832727-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">override </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">EndOperationTransaction</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">EndOperationTransactionArgs</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a61b060832727-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//省略其他代码</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a61b060832727-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">foreach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">DynamicObject </span><span class=\"crayon-e\">dyItem </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">DataEntitys</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a61b060832727-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">//反写收款单</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a61b060832727-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">WriteBackReceiveBill </span><span class=\"crayon-v\">wb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WriteBackReceiveBill</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a61b060832727-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">wb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteBackForSave</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Context</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a61b060832727-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a61b060832727-9\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a61b060832727-10\"> </div><div class=\"crayon-line\" id=\"crayon-596bfce40a61b060832727-11\"><span class=\"crayon-c\">//WriteBackReceiveBill .cs</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a61b060832727-12\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WriteBackForSave</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">EndOperationTransactionArgs</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Context </span><span class=\"crayon-v\">contx</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a61b060832727-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//省略其他代码：</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a61b060832727-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">foreach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">DynamicObject </span><span class=\"crayon-e\">item </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">DataEntitys</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a61b060832727-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">//do something </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596bfce40a61b060832727-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596bfce40a61b060832727-17\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0022 seconds] -->\r\n<p>好嘛，外层套了一个空循环却什么也没做。修改就很简单了，删除无效外层循环即可。</p>\n<h1 id=\"算法优化案例\">4.3. 算法优化案例</h1>\n<blockquote><p>案例4：某全流程跟踪报表超时。</p></blockquote>\n<p>这个报表是用来跟踪所有单据从下单到出库的业务流程数据流转情况。而所有的流程数据都是按照树形结果存储在数据库表中的，类似这样：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/1a5f6eb8189dc0b3c9fa092e00488f2e.png\" alt=\"流程树表\"></p>\n<p>图中的流程为：<br>\n销售合同–&gt;销售订单–&gt;发货通知单–&gt;销售出库单</p>\n<p>为了构造流程图，之前的处理方法是把流程数据取回来，通过代码构造流程图。这也就是性能差的原因。</p>\n<p>而针对这种情况，就是考验我们平时经验积累了。对于树形结构的表，我们也是可以通过SQL来进行直接查询的，这就要用到了SQL Server的CTE语法来进行递归查询。关于递归查询，可参考我这篇文章：<a href=\"http://www.jianshu.com/p/ab9d268aa54c\">SQL递归查询知多少</a>。这里就不展开了。</p>\n<h1 id=\"总结\">5.总结</h1>\n<p>性能调优是一个循序渐进的过程，不可能一蹴而就，重在平时的点滴积累。关于工具的选择和使用，本文并未展开，也希望读者也不要纠结与此。当你真正想解决一个问题的时候，相信工具的使用是难不住你的。</p>\n<p>最后就大致总结下我的调优思路：</p>\n<ol>\n<li>调整心态，积极应对</li>\n<li>了解性能背景， 收集证据， 尝试重现</li>\n<li>问题分类，先监控SQL耗时，大致确定是SQL或是代码层次原因</li>\n<li>使用性能分析工具，确定问题点</li>\n<li>调优测试</li>\n</ol>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111734\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111734votetotal\">3</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111734\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 6 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>"}